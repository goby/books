<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/core/ngx_resolver.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>src/core/ngx_resolver.c - Nginx 1.11.2</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L51">ngx_resolver_an_t</a></li>
<li><a href="#L32">ngx_resolver_hdr_t</a></li>
<li><a href="#L40">ngx_resolver_qs_t</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L910">ngx_resolve_addr</a></li>
<li><a href="#L1141">ngx_resolve_addr_done</a></li>
<li><a href="#L403">ngx_resolve_name</a></li>
<li><a href="#L483">ngx_resolve_name_done</a></li>
<li><a href="#L574">ngx_resolve_name_locked</a></li>
<li><a href="#L364">ngx_resolve_start</a></li>
<li><a href="#L4082">ngx_resolver_alloc</a></li>
<li><a href="#L4097">ngx_resolver_calloc</a></li>
<li><a href="#L281">ngx_resolver_cleanup</a></li>
<li><a href="#L335">ngx_resolver_cleanup_tree</a></li>
<li><a href="#L4636">ngx_resolver_cmp_srvs</a></li>
<li><a href="#L3930">ngx_resolver_copy</a></li>
<li><a href="#L133">ngx_resolver_create</a></li>
<li><a href="#L3834">ngx_resolver_create_addr_query</a></li>
<li><a href="#L3622">ngx_resolver_create_name_query</a></li>
<li><a href="#L3746">ngx_resolver_create_srv_query</a></li>
<li><a href="#L4130">ngx_resolver_dup</a></li>
<li><a href="#L1230">ngx_resolver_expire</a></li>
<li><a href="#L4147">ngx_resolver_export</a></li>
<li><a href="#L4112">ngx_resolver_free</a></li>
<li><a href="#L4123">ngx_resolver_free_locked</a></li>
<li><a href="#L4037">ngx_resolver_free_node</a></li>
<li><a href="#L4346">ngx_resolver_log_error</a></li>
<li><a href="#L3459">ngx_resolver_lookup_addr</a></li>
<li><a href="#L3492">ngx_resolver_lookup_addr6</a></li>
<li><a href="#L3377">ngx_resolver_lookup_name</a></li>
<li><a href="#L3418">ngx_resolver_lookup_srv</a></li>
<li><a href="#L1889">ngx_resolver_process_a</a></li>
<li><a href="#L3060">ngx_resolver_process_ptr</a></li>
<li><a href="#L1709">ngx_resolver_process_response</a></li>
<li><a href="#L2544">ngx_resolver_process_srv</a></li>
<li><a href="#L3579">ngx_resolver_rbtree_insert_addr6_value</a></li>
<li><a href="#L3536">ngx_resolver_rbtree_insert_value</a></li>
<li><a href="#L4230">ngx_resolver_report_srv</a></li>
<li><a href="#L1498">ngx_resolver_resend</a></li>
<li><a href="#L1548">ngx_resolver_resend_empty</a></li>
<li><a href="#L1427">ngx_resolver_resend_handler</a></li>
<li><a href="#L2927">ngx_resolver_resolve_srv_names</a></li>
<li><a href="#L1267">ngx_resolver_send_query</a></li>
<li><a href="#L1341">ngx_resolver_send_tcp_query</a></li>
<li><a href="#L1310">ngx_resolver_send_udp_query</a></li>
<li><a href="#L2993">ngx_resolver_srv_names_handler</a></li>
<li><a href="#L4323">ngx_resolver_strerror</a></li>
<li><a href="#L1640">ngx_resolver_tcp_read</a></li>
<li><a href="#L1583">ngx_resolver_tcp_write</a></li>
<li><a href="#L4024">ngx_resolver_timeout_handler</a></li>
<li><a href="#L1559">ngx_resolver_udp_read</a></li>
<li><a href="#L4453">ngx_tcp_connect</a></li>
<li><a href="#L4369">ngx_udp_connect</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L15">NGX_RESOLVER_TCP_RSIZE</a></li>
<li><a href="#L16">NGX_RESOLVER_TCP_WSIZE</a></li>
<li><a href="#L13">NGX_RESOLVER_UDP_SIZE</a></li>
<li><a href="#L54">ngx_resolver_node</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_event.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L13">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_RESOLVER_UDP_SIZE</span>&nbsp;&nbsp; </span><span class="Constant">4096<br/></li>
<li></span><br/></li>
<li><a id="L15">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_RESOLVER_TCP_RSIZE</span>&nbsp; (</span><span class="Constant">2</span><span class="PreProc"> + </span><span class="Constant">65535</span><span class="PreProc">)<br/></li>
<li><a id="L16">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_RESOLVER_TCP_WSIZE</span>&nbsp; </span><span class="Constant">8192<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; ident_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; ident_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; flags_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; flags_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nqs_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nqs_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nan_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nan_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nns_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nns_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nar_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; nar_lo;<br/></li>
<li><a id="L32">&#x200c;</a>} <span class="linkable">ngx_resolver_hdr_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; type_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; type_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; class_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; class_lo;<br/></li>
<li><a id="L40">&#x200c;</a>} <span class="linkable">ngx_resolver_qs_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; type_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; type_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; class_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; class_lo;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; ttl[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; len_hi;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; len_lo;<br/></li>
<li><a id="L51">&#x200c;</a>} <span class="linkable">ngx_resolver_an_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L54">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_resolver_node</span>(n)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; (<a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; ((u_char *) (n) - offsetof(<a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>, node))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L4369" title="src/core/ngx_resolver.c:4369">ngx_udp_connect</a>(<a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a> *rec);<br/></li>
<li><a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L4453" title="src/core/ngx_resolver.c:4453">ngx_tcp_connect</a>(<a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a> *rec);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L281" title="src/core/ngx_resolver.c:281">ngx_resolver_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L335" title="src/core/ngx_resolver.c:335">ngx_resolver_cleanup_tree</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L574" title="src/core/ngx_resolver.c:574">ngx_resolve_name_locked</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx, <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1230" title="src/core/ngx_resolver.c:1230">ngx_resolver_expire</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a> *queue);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1267" title="src/core/ngx_resolver.c:1267">ngx_resolver_send_query</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1310" title="src/core/ngx_resolver.c:1310">ngx_resolver_send_udp_query</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a> *rec, u_char *query, u_short qlen);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1341" title="src/core/ngx_resolver.c:1341">ngx_resolver_send_tcp_query</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a> *rec, u_char *query, u_short qlen);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3622" title="src/core/ngx_resolver.c:3622">ngx_resolver_create_name_query</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn, <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3746" title="src/core/ngx_resolver.c:3746">ngx_resolver_create_srv_query</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn, <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3834" title="src/core/ngx_resolver.c:3834">ngx_resolver_create_addr_query</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn, <a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a> *addr);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1427" title="src/core/ngx_resolver.c:1427">ngx_resolver_resend_handler</a>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span> <a href="#L1498" title="src/core/ngx_resolver.c:1498">ngx_resolver_resend</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a> *queue);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> <a href="#L1548" title="src/core/ngx_resolver.c:1548">ngx_resolver_resend_empty</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1559" title="src/core/ngx_resolver.c:1559">ngx_resolver_udp_read</a>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1583" title="src/core/ngx_resolver.c:1583">ngx_resolver_tcp_write</a>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *wev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1640" title="src/core/ngx_resolver.c:1640">ngx_resolver_tcp_read</a>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1709" title="src/core/ngx_resolver.c:1709">ngx_resolver_process_response</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, u_char *buf,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> n, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> tcp);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1889" title="src/core/ngx_resolver.c:1889">ngx_resolver_process_a</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> qtype,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> nan, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> trunc, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ans);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2544" title="src/core/ngx_resolver.c:2544">ngx_resolver_process_srv</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> nan,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> trunc, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ans);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3060" title="src/core/ngx_resolver.c:3060">ngx_resolver_process_ptr</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> nan);<br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *<a href="#L3377" title="src/core/ngx_resolver.c:3377">ngx_resolver_lookup_name</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name, <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span> hash);<br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *<a href="#L3418" title="src/core/ngx_resolver.c:3418">ngx_resolver_lookup_srv</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name, <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span> hash);<br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *<a href="#L3459" title="src/core/ngx_resolver.c:3459">ngx_resolver_lookup_addr</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_win32_config.h.html#L192" title="src/os/win32/ngx_win32_config.h:192">in_addr_t</a> addr);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3536" title="src/core/ngx_resolver.c:3536">ngx_resolver_rbtree_insert_value</a>(<a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3930" title="src/core/ngx_resolver.c:3930">ngx_resolver_copy</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name,<br/></li>
<li>&nbsp; &nbsp; u_char *buf, u_char *src, u_char *last);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4024" title="src/core/ngx_resolver.c:4024">ngx_resolver_timeout_handler</a>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4037" title="src/core/ngx_resolver.c:4037">ngx_resolver_free_node</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">size_t</span> size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">size_t</span> size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">void</span> *p);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">void</span> *p);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L4130" title="src/core/ngx_resolver.c:4130">ngx_resolver_dup</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">void</span> *src, <span class="Type">size_t</span> size);<br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a> *<a href="#L4147" title="src/core/ngx_resolver.c:4147">ngx_resolver_export</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> rotate);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4230" title="src/core/ngx_resolver.c:4230">ngx_resolver_report_srv</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L4346" title="src/core/ngx_resolver.c:4346">ngx_resolver_log_error</a>(<a href="ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2927" title="src/core/ngx_resolver.c:2927">ngx_resolver_resolve_srv_names</a>(<a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2993" title="src/core/ngx_resolver.c:2993">ngx_resolver_srv_names_handler</a>(<a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L4636" title="src/core/ngx_resolver.c:4636">ngx_resolver_cmp_srvs</a>(<span class="Type">const</span> <span class="Type">void</span> *one, <span class="Type">const</span> <span class="Type">void</span> *two);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void</span> <a href="#L3579" title="src/core/ngx_resolver.c:3579">ngx_resolver_rbtree_insert_addr6_value</a>(<a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel);<br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *<a href="#L3492" title="src/core/ngx_resolver.c:3492">ngx_resolver_lookup_addr6</a>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr *addr, <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span> hash);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *<br/></li>
<li><a id="L133">&#x200c;</a><span class="linkable">ngx_resolver_create</span>(<a href="ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *names, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_inet.h.html#L104" title="src/core/ngx_inet.h:104">ngx_url_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, j;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_palloc.h.html#L32" title="src/core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="ngx_palloc.c.html#L315" title="src/core/ngx_palloc.c:315">ngx_pool_cleanup_add</a>(cf-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L281" title="src/core/ngx_resolver.c:281">ngx_resolver_cleanup</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = <a href="../os/win32/ngx_alloc.c.html#L33" title="src/os/win32/ngx_alloc.c:33">ngx_calloc</a>(<span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>), cf-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;event = <a href="../os/win32/ngx_alloc.c.html#L33" title="src/os/win32/ngx_alloc.c:33">ngx_calloc</a>(<span class="Statement">sizeof</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>), cf-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L44" title="src/core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;r-&gt;name_rbtree, &amp;r-&gt;name_sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3536" title="src/core/ngx_resolver.c:3536">ngx_resolver_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L44" title="src/core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;r-&gt;srv_rbtree, &amp;r-&gt;srv_sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3536" title="src/core/ngx_resolver.c:3536">ngx_resolver_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L44" title="src/core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;r-&gt;addr_rbtree, &amp;r-&gt;addr_sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L97" title="src/core/ngx_rbtree.c:97">ngx_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;name_resend_queue);<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;srv_resend_queue);<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;addr_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;name_expire_queue);<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;srv_expire_queue);<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;addr_expire_queue);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; r-&gt;ipv6 = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L44" title="src/core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;r-&gt;addr6_rbtree, &amp;r-&gt;addr6_sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3579" title="src/core/ngx_resolver.c:3579">ngx_resolver_rbtree_insert_addr6_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;addr6_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;r-&gt;addr6_expire_queue);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; r-&gt;event-&gt;handler = <a href="#L1427" title="src/core/ngx_resolver.c:1427">ngx_resolver_resend_handler</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;event-&gt;data = r;<br/></li>
<li>&nbsp; &nbsp; r-&gt;event-&gt;log = &amp;cf-&gt;cycle-&gt;new_log;<br/></li>
<li>&nbsp; &nbsp; r-&gt;ident = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;resend_timeout = <span class="Constant">5</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;tcp_timeout = <span class="Constant">5</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;expire = <span class="Constant">30</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;valid = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;log = &amp;cf-&gt;cycle-&gt;new_log;<br/></li>
<li>&nbsp; &nbsp; r-&gt;log_level = <a href="ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_array.h.html#L32" title="src/core/ngx_array.h:32">ngx_array_init</a>(&amp;r-&gt;connections, cf-&gt;pool, n,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(names[i].data, <span class="Constant">&quot;valid=&quot;</span>, <span class="Constant">6</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = names[i].len - <span class="Constant">6</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = names[i].data + <span class="Constant">6</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;valid = <a href="ngx_parse.c.html#L102" title="src/core/ngx_parse.c:102">ngx_parse_time</a>(&amp;s, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;valid == (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter: %V&quot;</span>, &amp;names[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(names[i].data, <span class="Constant">&quot;ipv6=&quot;</span>, <span class="Constant">5</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(&amp;names[i].data[<span class="Constant">5</span>], <span class="Constant">&quot;on&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;ipv6 = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(&amp;names[i].data[<span class="Constant">5</span>], <span class="Constant">&quot;off&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;ipv6 = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter: %V&quot;</span>, &amp;names[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;u, <span class="Statement">sizeof</span>(<a href="ngx_inet.h.html#L104" title="src/core/ngx_inet.h:104">ngx_url_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u.url = names[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u.default_port = <span class="Constant">53</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_inet.c.html#L591" title="src/core/ngx_inet.c:591">ngx_parse_url</a>(cf-&gt;pool, &amp;u) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u.err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> in resolver </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; u.err, &amp;u.url);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec = <a href="ngx_array.c.html#L95" title="src/core/ngx_array.c:95">ngx_array_push_n</a>(&amp;r-&gt;connections, u.naddrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rec == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(rec, u.naddrs * <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = <span class="Constant">0</span>; j &lt; u.naddrs; j++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rec[j].sockaddr = u.addrs[j].sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rec[j].socklen = u.addrs[j].socklen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rec[j].server = u.addrs[j].name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rec[j].resolver = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L281">&#x200c;</a></span><span class="linkable">ngx_resolver_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; *r = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, <a href="ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;cleanup resolver&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L335" title="src/core/ngx_resolver.c:335">ngx_resolver_cleanup_tree</a>(r, &amp;r-&gt;name_rbtree);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L335" title="src/core/ngx_resolver.c:335">ngx_resolver_cleanup_tree</a>(r, &amp;r-&gt;srv_rbtree);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L335" title="src/core/ngx_resolver.c:335">ngx_resolver_cleanup_tree</a>(r, &amp;r-&gt;addr_rbtree);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L335" title="src/core/ngx_resolver.c:335">ngx_resolver_cleanup_tree</a>(r, &amp;r-&gt;addr6_rbtree);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(r-&gt;event);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec = r-&gt;connections.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; r-&gt;connections.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rec[i].udp) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(rec[i].udp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rec[i].tcp) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(rec[i].tcp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rec[i].read_buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rec[i].read_buf-&gt;start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rec[i].read_buf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rec[i].write_buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rec[i].write_buf-&gt;start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rec[i].write_buf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L335">&#x200c;</a></span><span class="linkable">ngx_resolver_cleanup_tree</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *ctx, *next;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (tree-&gt;root != tree-&gt;sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L54" title="src/core/ngx_resolver.c:54">ngx_resolver_node</a>(<a href="ngx_rbtree.h.html#L72" title="src/core/ngx_rbtree.h:72">ngx_rbtree_min</a>(tree-&gt;root, tree-&gt;sentinel));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (ctx = rn-&gt;waiting; ctx; ctx = next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4037" title="src/core/ngx_resolver.c:4037">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *<br/></li>
<li><a id="L364">&#x200c;</a><span class="linkable">ngx_resolve_start</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *temp)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_win32_config.h.html#L192" title="src/os/win32/ngx_win32_config.h:192">in_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (temp) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr = <a href="ngx_inet.c.html#L18" title="src/core/ngx_inet.c:18">ngx_inet_addr</a>(temp-&gt;name.data, temp-&gt;name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr != <a href="ngx_config.h.html#L118" title="src/core/ngx_config.h:118">INADDR_NONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;resolver = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;state = <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;naddrs = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;addrs = &amp;temp-&gt;addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;addr.sockaddr = (<span class="Type">struct</span> sockaddr *) &amp;temp-&gt;sin;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;addr.socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;temp-&gt;sin, <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;sin.sin_family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;sin.sin_addr.s_addr = addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; temp-&gt;quick = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> temp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;connections.nelts == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_resolver.h.html#L35" title="src/core/ngx_resolver.h:35">NGX_NO_RESOLVER</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;resolver = r;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ctx;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L403">&#x200c;</a><span class="linkable">ngx_resolve_name</span>(<a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; slen;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; name;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;name.len &gt; <span class="Constant">0</span> &amp;&amp; ctx-&gt;name.data[ctx-&gt;name.len - <span class="Constant">1</span>] == <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name.len--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;ctx-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;quick) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;service.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; slen = ctx-&gt;service.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.h.html#L66" title="src/core/ngx_string.h:66">ngx_strlchr</a>(ctx-&gt;service.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;service.data + ctx-&gt;service.len, <span class="Constant">'.'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slen += <span class="Statement">sizeof</span>(<span class="Constant">&quot;_._tcp&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.len = slen + <span class="Constant">1</span> + ctx-&gt;name.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.data = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, name.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (slen == ctx-&gt;service.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(name.data, <span class="Constant">&quot;%V.%V&quot;</span>, &amp;ctx-&gt;service, &amp;ctx-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(name.data, <span class="Constant">&quot;_%V._tcp.%V&quot;</span>, &amp;ctx-&gt;service, &amp;ctx-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L574" title="src/core/ngx_resolver.c:574">ngx_resolve_name_locked</a>(r, ctx, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L574" title="src/core/ngx_resolver.c:574">ngx_resolve_name_locked</a>(r, ctx, &amp;ctx-&gt;name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L483">&#x200c;</a></span><span class="linkable">ngx_resolve_name_done</span>(<a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *w, **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve name done: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, ctx-&gt;state);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;quick) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event &amp;&amp; ctx-&gt;event-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;nsrvs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; ctx-&gt;nsrvs; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;srvs[i].ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L483" title="src/core/ngx_resolver.c:483">ngx_resolve_name_done</a>(ctx-&gt;srvs[i].ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;srvs[i].addrs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx-&gt;srvs[i].addrs-&gt;sockaddr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx-&gt;srvs[i].addrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx-&gt;srvs[i].name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx-&gt;srvs);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;state == <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a> || ctx-&gt;state == <a href="ngx_resolver.h.html#L32" title="src/core/ngx_resolver.h:32">NGX_RESOLVE_TIMEDOUT</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = ctx-&gt;node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = rn-&gt;waiting;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (w) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (w == ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = w-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;w-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = w-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;could not cancel %V resolving&quot;</span>, &amp;ctx-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;service.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1230" title="src/core/ngx_resolver.c:1230">ngx_resolver_expire</a>(r, &amp;r-&gt;srv_rbtree, &amp;r-&gt;srv_expire_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1230" title="src/core/ngx_resolver.c:1230">ngx_resolver_expire</a>(r, &amp;r-&gt;name_rbtree, &amp;r-&gt;name_expire_queue);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;event-&gt;timer_set &amp;&amp; <a href="#L1548" title="src/core/ngx_resolver.c:1548">ngx_resolver_resend_empty</a>(r)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(r-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L574">&#x200c;</a><span class="linkable">ngx_resolve_name_locked</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cname;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, naddrs;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *resend_queue, *expire_queue;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tree;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *next, *last;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a>&nbsp; *addrs;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.c.html#L21" title="src/core/ngx_string.c:21">ngx_strlow</a>(name-&gt;data, name-&gt;data, name-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="src/core/ngx_crc32.h:21">ngx_crc32_short</a>(name-&gt;data, name-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;service.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L3418" title="src/core/ngx_resolver.c:3418">ngx_resolver_lookup_srv</a>(r, name, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;srv_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resend_queue = &amp;r-&gt;srv_resend_queue;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;srv_expire_queue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L3377" title="src/core/ngx_resolver.c:3377">ngx_resolver_lookup_name</a>(r, name, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;name_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resend_queue = &amp;r-&gt;name_resend_queue;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;name_expire_queue;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ctx can be a list after <a href="ngx_resolver.h.html#L17" title="src/core/ngx_resolver.h:17">NGX_RESOLVE_CNAME</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (last = ctx; last-&gt;next; last = last-&gt;next);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;valid &gt;= <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>()) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolve cached&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs = (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) ? <span class="Constant">0</span> : rn-&gt;naddrs;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs += (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) ? <span class="Constant">0</span> : rn-&gt;naddrs6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs == <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs = <a href="#L4147" title="src/core/ngx_resolver.c:4147">ngx_resolver_export</a>(r, rn, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last-&gt;next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = rn-&gt;valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;naddrs = naddrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs = &amp;ctx-&gt;addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addr.sockaddr = (<span class="Type">struct</span> sockaddr *) &amp;ctx-&gt;sin;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addr.socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;ctx-&gt;sin, <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sin.sin_family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sin.sin_addr.s_addr = rn-&gt;u.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs = addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, addrs-&gt;sockaddr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, addrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;nsrvs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last-&gt;next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2927" title="src/core/ngx_resolver.c:2927">ngx_resolver_resolve_srv_names</a>(ctx, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="ngx_resolver.h.html#L17" title="src/core/ngx_resolver.h:17">NGX_RESOLVE_CNAME</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;recursion++ &lt; <a href="ngx_resolver.h.html#L37" title="src/core/ngx_resolver.h:37">NGX_RESOLVER_MAX_RECURSION</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cname.len = rn-&gt;cnlen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cname.data = rn-&gt;u.cname;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L574" title="src/core/ngx_resolver.c:574">ngx_resolve_name_locked</a>(r, ctx, &amp;cname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last-&gt;next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_resolver.h.html#L29" title="src/core/ngx_resolver.h:29">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : <span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;waiting) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span> &amp;&amp; ctx-&gt;timeout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;handler = <a href="#L4024" title="src/core/ngx_resolver.c:4024">ngx_resolver_timeout_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;log = r-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;ident = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(ctx-&gt;event, ctx-&gt;timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last-&gt;next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;node = rn;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = ctx-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;cnlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u.cname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs &gt; <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u.addrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 &gt; <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs6 != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u6.addrs6);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;nsrvs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; rn-&gt;nsrvs; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;u.srvs[i].name.data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u.srvs[i].name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u.srvs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;name = <a href="#L4130" title="src/core/ngx_resolver.c:4130">ngx_resolver_dup</a>(r, name-&gt;data, name-&gt;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;node.key = hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;nlen = (u_short) name-&gt;len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L25" title="src/core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(tree, &amp;rn-&gt;node);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;service.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L3746" title="src/core/ngx_resolver.c:3746">ngx_resolver_create_srv_query</a>(r, rn, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L3622" title="src/core/ngx_resolver.c:3622">ngx_resolver_create_name_query</a>(r, rn, name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_resolver.h.html#L29" title="src/core/ngx_resolver.h:29">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;last_connection = r-&gt;last_connection++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;last_connection == r-&gt;connections.nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;last_connection = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;naddrs = (u_short) -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;tcp = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; rn-&gt;naddrs6 = r-&gt;ipv6 ? (u_short) -<span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;tcp6 = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; rn-&gt;nsrvs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1267" title="src/core/ngx_resolver.c:1267">ngx_resolver_send_query</a>(r, rn) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span> &amp;&amp; ctx-&gt;timeout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;handler = <a href="#L4024" title="src/core/ngx_resolver.c:4024">ngx_resolver_timeout_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;log = r-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;ident = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(ctx-&gt;event, ctx-&gt;timeout);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(resend_queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(r-&gt;event, (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) (r-&gt;resend_timeout * <span class="Constant">1000</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;resend_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(resend_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;code = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;cnlen = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;valid = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;ttl = <a href="ngx_config.h.html#L128" title="src/core/ngx_config.h:128">NGX_MAX_UINT32_VALUE</a>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;waiting = ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;node = rn;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = ctx-&gt;next;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L910">&#x200c;</a><span class="linkable">ngx_resolve_addr</span>(<a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *name;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_win32_config.h.html#L192" title="src/os/win32/ngx_win32_config.h:192">in_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *resend_queue, *expire_queue;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tree;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp;&nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; *sin6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; addr = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; hash = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; sin6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) ctx-&gt;addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="src/core/ngx_crc32.h:21">ngx_crc32_short</a>(sin6-&gt;sin6_addr.s6_addr, <span class="Constant">16</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L3492" title="src/core/ngx_resolver.c:3492">ngx_resolver_lookup_addr6</a>(r, &amp;sin6-&gt;sin6_addr, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr6_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resend_queue = &amp;r-&gt;addr6_resend_queue;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr6_expire_queue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) ctx-&gt;addr.sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr = ntohl(sin-&gt;sin_addr.s_addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L3459" title="src/core/ngx_resolver.c:3459">ngx_resolver_lookup_addr</a>(r, addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resend_queue = &amp;r-&gt;addr_resend_queue;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr_expire_queue;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;valid &gt;= <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>()) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolve cached&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name = <a href="#L4130" title="src/core/ngx_resolver.c:4130">ngx_resolver_dup</a>(r, rn-&gt;name, rn-&gt;nlen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name.len = rn-&gt;nlen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name.data = name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = rn-&gt;valid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;waiting) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span> &amp;&amp; ctx-&gt;timeout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;handler = <a href="#L4024" title="src/core/ngx_resolver.c:4024">ngx_resolver_timeout_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;log = r-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;ident = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(ctx-&gt;event, ctx-&gt;timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;node = rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;addr6 = sin6-&gt;sin6_addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;node.key = hash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;node.key = addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L25" title="src/core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(tree, &amp;rn-&gt;node);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3834" title="src/core/ngx_resolver.c:3834">ngx_resolver_create_addr_query</a>(r, rn, &amp;ctx-&gt;addr) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;last_connection = r-&gt;last_connection++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;last_connection == r-&gt;connections.nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;last_connection = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;naddrs = (u_short) -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;tcp = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; rn-&gt;naddrs6 = (u_short) -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;tcp6 = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; rn-&gt;nsrvs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1267" title="src/core/ngx_resolver.c:1267">ngx_resolver_send_query</a>(r, rn) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span> &amp;&amp; ctx-&gt;timeout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;handler = <a href="#L4024" title="src/core/ngx_resolver.c:4024">ngx_resolver_timeout_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;event-&gt;log = r-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;ident = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(ctx-&gt;event, ctx-&gt;timeout);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(resend_queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(r-&gt;event, (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) (r-&gt;resend_timeout * <span class="Constant">1000</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;resend_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(resend_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;code = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;cnlen = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;name = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;nlen = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;valid = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;ttl = <a href="ngx_config.h.html#L128" title="src/core/ngx_config.h:128">NGX_MAX_UINT32_VALUE</a>;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;waiting = ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;node = rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L1141">&#x200c;</a></span><span class="linkable">ngx_resolve_addr_done</span>(<a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *expire_queue;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tree;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *w, **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;addr.sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr6_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr6_expire_queue;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr_expire_queue;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve addr done: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, ctx-&gt;state);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event &amp;&amp; ctx-&gt;event-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;state == <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a> || ctx-&gt;state == <a href="ngx_resolver.h.html#L32" title="src/core/ngx_resolver.h:32">NGX_RESOLVE_TIMEDOUT</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = ctx-&gt;node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = rn-&gt;waiting;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (w) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (w == ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = w-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;w-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = w-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; text[<a href="ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; addrtext;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrtext.data = text;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrtext.len = <a href="ngx_inet.c.html#L181" title="src/core/ngx_inet.c:181">ngx_sock_ntop</a>(ctx-&gt;addr.sockaddr, ctx-&gt;addr.socklen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; text, <a href="ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;could not cancel %V resolving&quot;</span>, &amp;addrtext);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1230" title="src/core/ngx_resolver.c:1230">ngx_resolver_expire</a>(r, tree, expire_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;event) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, ctx-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;event-&gt;timer_set &amp;&amp; <a href="#L1548" title="src/core/ngx_resolver.c:1548">ngx_resolver_resend_empty</a>(r)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(r-&gt;event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1230">&#x200c;</a></span><span class="linkable">ngx_resolver_expire</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree, <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a> *queue)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolver expire&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">2</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="ngx_queue.h.html#L54" title="src/core/ngx_queue.h:54">ngx_queue_last</a>(queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (now &lt;= rn-&gt;expire) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver expire </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>, (<span class="Type">size_t</span>) rn-&gt;nlen, rn-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4037" title="src/core/ngx_resolver.c:4037">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1267">&#x200c;</a><span class="linkable">ngx_resolver_send_query</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rec = r-&gt;connections.elts;<br/></li>
<li>&nbsp; &nbsp; rec = &amp;rec[rn-&gt;last_connection];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rec-&gt;log.handler == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;log = *r-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;log.handler = <a href="#L4346" title="src/core/ngx_resolver.c:4346">ngx_resolver_log_error</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;log.data = rec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;log.action = <span class="Constant">&quot;resolving&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = rn-&gt;tcp ? <a href="#L1341" title="src/core/ngx_resolver.c:1341">ngx_resolver_send_tcp_query</a>(r, rec, rn-&gt;query, rn-&gt;qlen)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : <a href="#L1310" title="src/core/ngx_resolver.c:1310">ngx_resolver_send_udp_query</a>(r, rec, rn-&gt;query, rn-&gt;qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query6 &amp;&amp; rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = rn-&gt;tcp6<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? <a href="#L1341" title="src/core/ngx_resolver.c:1341">ngx_resolver_send_tcp_query</a>(r, rec, rn-&gt;query6, rn-&gt;qlen)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : <a href="#L1310" title="src/core/ngx_resolver.c:1310">ngx_resolver_send_udp_query</a>(r, rec, rn-&gt;query6, rn-&gt;qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1310">&#x200c;</a><span class="linkable">ngx_resolver_send_udp_query</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec,<br/></li>
<li>&nbsp; &nbsp; u_char *query, u_short qlen)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rec-&gt;udp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L4369" title="src/core/ngx_resolver.c:4369">ngx_udp_connect</a>(rec) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;udp-&gt;data = rec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;udp-&gt;read-&gt;handler = <a href="#L1559" title="src/core/ngx_resolver.c:1559">ngx_resolver_udp_read</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;udp-&gt;read-&gt;resolver = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="../event/ngx_event.h.html#L422" title="src/event/ngx_event.h:422">ngx_send</a>(rec-&gt;udp, query, qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) n != (<span class="Type">size_t</span>) qlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, &amp;rec-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;send() incomplete&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1341">&#x200c;</a><span class="linkable">ngx_resolver_send_tcp_query</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a> *rec,<br/></li>
<li>&nbsp; &nbsp; u_char *query, u_short qlen)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp;&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rec-&gt;tcp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = rec-&gt;read_buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, <a href="#L15" title="src/core/ngx_resolver.c:15">NGX_RESOLVER_TCP_RSIZE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, b);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = b-&gt;start + <a href="#L15" title="src/core/ngx_resolver.c:15">NGX_RESOLVER_TCP_RSIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;read_buf = b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = rec-&gt;write_buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, <span class="Statement">sizeof</span>(<a href="ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, <a href="#L16" title="src/core/ngx_resolver.c:16">NGX_RESOLVER_TCP_WSIZE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, b);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = b-&gt;start + <a href="#L16" title="src/core/ngx_resolver.c:16">NGX_RESOLVER_TCP_WSIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;write_buf = b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L4453" title="src/core/ngx_resolver.c:4453">ngx_tcp_connect</a>(rec);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;tcp-&gt;data = rec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;tcp-&gt;write-&gt;handler = <a href="#L1583" title="src/core/ngx_resolver.c:1583">ngx_resolver_tcp_write</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;tcp-&gt;read-&gt;handler = <a href="#L1640" title="src/core/ngx_resolver.c:1640">ngx_resolver_tcp_read</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;tcp-&gt;read-&gt;resolver = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rec-&gt;tcp-&gt;write, (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) (r-&gt;tcp_timeout * <span class="Constant">1000</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = rec-&gt;write_buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;end - b-&gt;last &lt;&nbsp; <span class="Constant">2</span> + qlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, &amp;rec-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;buffer overflow&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *b-&gt;last++ = (u_char) (qlen &gt;&gt; <span class="Constant">8</span>);<br/></li>
<li>&nbsp; &nbsp; *b-&gt;last++ = (u_char) qlen;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last = <a href="ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(b-&gt;last, query, qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1583" title="src/core/ngx_resolver.c:1583">ngx_resolver_tcp_write</a>(rec-&gt;tcp-&gt;write);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1427">&#x200c;</a></span><span class="linkable">ngx_resolver_resend_handler</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timer, atimer, stimer, ntimer;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; a6timer;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ev-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver resend handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ntimer = <a href="#L1498" title="src/core/ngx_resolver.c:1498">ngx_resolver_resend</a>(r, &amp;r-&gt;name_rbtree, &amp;r-&gt;name_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stimer = <a href="#L1498" title="src/core/ngx_resolver.c:1498">ngx_resolver_resend</a>(r, &amp;r-&gt;srv_rbtree, &amp;r-&gt;srv_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; atimer = <a href="#L1498" title="src/core/ngx_resolver.c:1498">ngx_resolver_resend</a>(r, &amp;r-&gt;addr_rbtree, &amp;r-&gt;addr_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock addr6 mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; a6timer = <a href="#L1498" title="src/core/ngx_resolver.c:1498">ngx_resolver_resend</a>(r, &amp;r-&gt;addr6_rbtree, &amp;r-&gt;addr6_resend_queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr6 mutex */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; timer = ntimer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (timer == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = atimer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (atimer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = <a href="ngx_core.h.html#L102" title="src/core/ngx_core.h:102">ngx_min</a>(timer, atimer);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (timer == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = stimer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (stimer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = <a href="ngx_core.h.html#L102" title="src/core/ngx_core.h:102">ngx_min</a>(timer, stimer);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (timer == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = a6timer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (a6timer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = <a href="ngx_core.h.html#L102" title="src/core/ngx_core.h:102">ngx_min</a>(timer, a6timer);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (timer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(r-&gt;event, (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) (timer * <span class="Constant">1000</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a><br/></li>
<li><a id="L1498">&#x200c;</a></span><span class="linkable">ngx_resolver_resend</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a> *tree, <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a> *queue)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="ngx_queue.h.html#L54" title="src/core/ngx_queue.h:54">ngx_queue_last</a>(queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (now &lt; rn-&gt;expire) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rn-&gt;expire - now;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver resend </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant"> </span><span class="Special">%p</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">size_t</span>) rn-&gt;nlen, rn-&gt;name, rn-&gt;waiting);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;waiting) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++rn-&gt;last_connection == r-&gt;connections.nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;last_connection = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L1267" title="src/core/ngx_resolver.c:1267">ngx_resolver_send_query</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = now + r-&gt;resend_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(queue, q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4037" title="src/core/ngx_resolver.c:4037">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a><br/></li>
<li><a id="L1548">&#x200c;</a><span class="linkable">ngx_resolver_resend_empty</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;r-&gt;name_resend_queue)<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; <a href="ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;r-&gt;addr6_resend_queue)<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; <a href="ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;r-&gt;addr_resend_queue);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1559">&#x200c;</a></span><span class="linkable">ngx_resolver_udp_read</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf[<a href="#L13" title="src/core/ngx_resolver.c:13">NGX_RESOLVER_UDP_SIZE</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; rec = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../event/ngx_event.h.html#L421" title="src/event/ngx_event.h:421">ngx_udp_recv</a>(c, buf, <a href="#L13" title="src/core/ngx_resolver.c:13">NGX_RESOLVER_UDP_SIZE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1709" title="src/core/ngx_resolver.c:1709">ngx_resolver_process_response</a>(rec-&gt;resolver, buf, n, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (rev-&gt;ready);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1583">&#x200c;</a></span><span class="linkable">ngx_resolver_tcp_write</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *wev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sent;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = wev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; rec = c-&gt;data;<br/></li>
<li>&nbsp; &nbsp; b = rec-&gt;write_buf;<br/></li>
<li>&nbsp; &nbsp; r = rec-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sent = c-&gt;sent;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (wev-&gt;ready &amp;&amp; b-&gt;pos &lt; b-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../event/ngx_event.h.html#L422" title="src/event/ngx_event.h:422">ngx_send</a>(c, b-&gt;pos, b-&gt;last - b-&gt;pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos += n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos != b-&gt;start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = <a href="ngx_string.h.html#L140" title="src/core/ngx_string.h:140">ngx_movemem</a>(b-&gt;start, b-&gt;pos, b-&gt;last - b-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;sent != sent) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(wev, (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) (r-&gt;tcp_timeout * <span class="Constant">1000</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L332" title="src/event/ngx_event.c:332">ngx_handle_write_event</a>(wev, <span class="Constant">0</span>) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; rec-&gt;tcp = <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1640">&#x200c;</a></span><span class="linkable">ngx_resolver_tcp_read</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; qlen;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; rec = c-&gt;data;<br/></li>
<li>&nbsp; &nbsp; b = rec-&gt;read_buf;<br/></li>
<li>&nbsp; &nbsp; r = rec-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (rev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../event/ngx_event.h.html#L419" title="src/event/ngx_event.h:419">ngx_recv</a>(c, b-&gt;last, b-&gt;end - b-&gt;last);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> || n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = b-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;last - p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &lt; <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qlen = (u_short) *p++ &lt;&lt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qlen += *p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &lt; (<span class="Type">size_t</span>) (<span class="Constant">2</span> + qlen)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1709" title="src/core/ngx_resolver.c:1709">ngx_resolver_process_response</a>(r, p, qlen, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos += <span class="Constant">2</span> + qlen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos != b-&gt;start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = <a href="ngx_string.h.html#L140" title="src/core/ngx_string.h:140">ngx_movemem</a>(b-&gt;start, b-&gt;pos, b-&gt;last - b-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; rec-&gt;tcp = <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1709">&#x200c;</a></span><span class="linkable">ngx_resolver_process_response</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> tcp)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *err;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, times, ident, qident, flags, code, nqs, nan, trunc,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qtype, qclass;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qident6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>&nbsp; &nbsp; *qs;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>&nbsp;&nbsp; *response;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; response = (<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a> *) buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ident = (response-&gt;ident_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;ident_lo;<br/></li>
<li>&nbsp; &nbsp; flags = (response-&gt;flags_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;flags_lo;<br/></li>
<li>&nbsp; &nbsp; nqs = (response-&gt;nqs_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;nqs_lo;<br/></li>
<li>&nbsp; &nbsp; nan = (response-&gt;nan_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;nan_lo;<br/></li>
<li>&nbsp; &nbsp; trunc = flags &amp; <span class="Constant">0x0200</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L154" title="src/core/ngx_log.h:154">ngx_log_debug6</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver DNS response </span><span class="Special">%u</span><span class="Constant">i fl:</span><span class="Special">%04X</span><span class="Constant">i </span><span class="Special">%u</span><span class="Constant">i/</span><span class="Special">%u</span><span class="Constant">i/</span><span class="Special">%u</span><span class="Constant">d/</span><span class="Special">%u</span><span class="Constant">d&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ident, flags, nqs, nan,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (response-&gt;nns_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;nns_lo,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (response-&gt;nar_hi &lt;&lt; <span class="Constant">8</span>) + response-&gt;nar_lo);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* response to a standard query */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((flags &amp; <span class="Constant">0xf870</span>) != <span class="Constant">0x8000</span> || (trunc &amp;&amp; tcp)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid </span><span class="Special">%s</span><span class="Constant"> DNS response </span><span class="Special">%u</span><span class="Constant">i fl:</span><span class="Special">%04X</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp ? <span class="Constant">&quot;TCP&quot;</span> : <span class="Constant">&quot;UDP&quot;</span>, ident, flags);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; code = flags &amp; <span class="Constant">0xf</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <a href="ngx_resolver.h.html#L27" title="src/core/ngx_resolver.h:27">NGX_RESOLVE_FORMERR</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; times = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="ngx_queue.h.html#L50" title="src/core/ngx_queue.h:50">ngx_queue_head</a>(&amp;r-&gt;name_resend_queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="ngx_queue.h.html#L58" title="src/core/ngx_queue.h:58">ngx_queue_sentinel</a>(&amp;r-&gt;name_resend_queue) &amp;&amp; times++ &lt; <span class="Constant">100</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="ngx_queue.h.html#L62" title="src/core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>, queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qident = (rn-&gt;query[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (qident == ident) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> dns_error_name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qident6 = (rn-&gt;query6[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query6[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (qident6 == ident) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> dns_error_name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> dns_error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code &gt; <a href="ngx_resolver.h.html#L31" title="src/core/ngx_resolver.h:31">NGX_RESOLVE_REFUSED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> dns_error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nqs != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid number of questions in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (i &lt; (<a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] == <span class="Special">'\0'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">1</span> + buf[i];<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li><br/></li>
<li><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (i++ == <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;zero-length domain name in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Statement">sizeof</span>(<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>) + nan * (<span class="Constant">2</span> + <span class="Statement">sizeof</span>(<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &gt; (<a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) n)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qs = (<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a> *) &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qtype = (qs-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + qs-&gt;type_lo;<br/></li>
<li>&nbsp; &nbsp; qclass = (qs-&gt;class_hi &lt;&lt; <span class="Constant">8</span>) + qs-&gt;class_lo;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver DNS response qt:</span><span class="Special">%u</span><span class="Constant">i cl:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, qtype, qclass);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (qclass != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unknown query class </span><span class="Special">%u</span><span class="Constant">i in DNS response&quot;</span>, qclass);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a>:<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1889" title="src/core/ngx_resolver.c:1889">ngx_resolver_process_a</a>(r, buf, n, ident, code, qtype, nan, trunc,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i + <span class="Statement">sizeof</span>(<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L24" title="src/core/ngx_resolver.h:24">NGX_RESOLVE_SRV</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2544" title="src/core/ngx_resolver.c:2544">ngx_resolver_process_srv</a>(r, buf, n, ident, code, nan, trunc,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i + <span class="Statement">sizeof</span>(<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L18" title="src/core/ngx_resolver.h:18">NGX_RESOLVE_PTR</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3060" title="src/core/ngx_resolver.c:3060">ngx_resolver_process_ptr</a>(r, buf, n, ident, code, nan);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unknown query type </span><span class="Special">%u</span><span class="Constant">i in DNS response&quot;</span>, qtype);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">short_response</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; err = <span class="Constant">&quot;short DNS response&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">dns_error_name</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;DNS error (</span><span class="Special">%u</span><span class="Constant">i: </span><span class="Special">%s</span><span class="Constant">), query id:</span><span class="Special">%u</span><span class="Constant">i, name:</span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; code, <a href="#L4323" title="src/core/ngx_resolver.c:4323">ngx_resolver_strerror</a>(code), ident,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">size_t</span>) rn-&gt;nlen, rn-&gt;name);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">dns_error</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;DNS error (</span><span class="Special">%u</span><span class="Constant">i: </span><span class="Special">%s</span><span class="Constant">), query id:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; code, <a href="#L4323" title="src/core/ngx_resolver.c:4323">ngx_resolver_strerror</a>(code), ident);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1889">&#x200c;</a></span><span class="linkable">ngx_resolver_process_a</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> qtype,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> nan, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> trunc, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ans)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *err;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cname;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L133" title="src/os/win32/ngx_win32_config.h:133">int32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ttl;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_win32_config.h.html#L192" title="src/os/win32/ngx_win32_config.h:192">in_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; name;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type, class, qident, naddrs, a, i, j, start;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *addr6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *an;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ctx, *next;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *rn;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *addrs;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3930" title="src/core/ngx_resolver.c:3930">ngx_resolver_copy</a>(r, &amp;name, buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf + <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>), buf + n)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolver qs:%V&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="src/core/ngx_crc32.h:21">ngx_crc32_short</a>(name.data, name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rn = <a href="#L3377" title="src/core/ngx_resolver.c:3377">ngx_resolver_lookup_name</a>(r, &amp;name, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected response for %V&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query6 == <span class="Constant">NULL</span> || rn-&gt;naddrs6 != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected response for %V&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (trunc &amp;&amp; rn-&gt;tcp6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; qident = (rn-&gt;query6[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query6[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query == <span class="Constant">NULL</span> || rn-&gt;naddrs != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected response for %V&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (trunc &amp;&amp; rn-&gt;tcp) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; qident = (rn-&gt;query[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ident != qident) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;wrong ident </span><span class="Special">%u</span><span class="Constant">i response for %V, expect </span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ident, &amp;name, qident);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (trunc) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;waiting == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;r-&gt;name_rbtree, &amp;rn-&gt;node);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4037" title="src/core/ngx_resolver.c:4037">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec = r-&gt;connections.elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec = &amp;rec[rn-&gt;last_connection];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;tcp6 = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L1341" title="src/core/ngx_resolver.c:1341">ngx_resolver_send_tcp_query</a>(r, rec, rn-&gt;query6, rn-&gt;qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;tcp = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L1341" title="src/core/ngx_resolver.c:1341">ngx_resolver_send_tcp_query</a>(r, rec, rn-&gt;query, rn-&gt;qlen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;resend_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;name_resend_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <span class="Constant">0</span> &amp;&amp; rn-&gt;code) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; code = rn-&gt;code;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <span class="Constant">0</span> &amp;&amp; nan == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> export;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> export;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; code = <a href="ngx_resolver.h.html#L29" title="src/core/ngx_resolver.h:29">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;code = (u_char) code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;code = (u_char) code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;r-&gt;name_rbtree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : <span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4037" title="src/core/ngx_resolver.c:4037">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = ans;<br/></li>
<li>&nbsp; &nbsp; naddrs = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; cname = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (a = <span class="Constant">0</span>; a &lt; nan; a++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start = i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (i &lt; n) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> test_length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">1</span> + buf[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">test_length</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i - start &lt; <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid name in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Statement">sizeof</span>(<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>) &gt;= n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; an = (<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a> *) &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type = (an-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;type_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; class = (an-&gt;class_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;class_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = (an-&gt;len_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;len_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ttl = (an-&gt;ttl[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">24</span>) + (an-&gt;ttl[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (an-&gt;ttl[<span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + (an-&gt;ttl[<span class="Constant">3</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (class != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected RR class </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, class);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ttl &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ttl = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;ttl = <a href="ngx_core.h.html#L102" title="src/core/ngx_core.h:102">ngx_min</a>(rn-&gt;ttl, (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>) ttl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (type) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (qtype != <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;unexpected A record in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len != <span class="Constant">4</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid A record in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Constant">4</span> &gt; n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (qtype != <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;unexpected AAAA record in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len != <span class="Constant">16</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid AAAA record in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Constant">16</span> &gt; n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L17" title="src/core/ngx_resolver.h:17">NGX_RESOLVE_CNAME</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cname = &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L25" title="src/core/ngx_resolver.h:25">NGX_RESOLVE_DNAME</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected RR type </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, type);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver naddrs:</span><span class="Special">%u</span><span class="Constant">i cname:</span><span class="Special">%p</span><span class="Constant"> ttl:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; naddrs, cname, rn-&gt;ttl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (naddrs) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = &amp;rn-&gt;u6.addr6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, naddrs * <span class="Statement">sizeof</span>(<span class="Type">struct</span> in6_addr));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr6 == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;u6.addrs6 = addr6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = (u_short) naddrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = &amp;rn-&gt;u.addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, naddrs * <span class="Statement">sizeof</span>(<a href="../os/win32/ngx_win32_config.h.html#L192" title="src/os/win32/ngx_win32_config.h:192">in_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;u.addrs = addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = (u_short) naddrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6 &amp;&amp; NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; j = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = ans;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (a = <span class="Constant">0</span>; a &lt; nan; a++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">1</span> + buf[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; an = (<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a> *) &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type = (an-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;type_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = (an-&gt;len_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;len_lo;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr[j] = htonl((buf[i] &lt;&lt; <span class="Constant">24</span>) + (buf[i + <span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (buf[i + <span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + (buf[i + <span class="Constant">3</span>]));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++j == naddrs) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (type == <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(addr6[j].s6_addr, &amp;buf[i], <span class="Constant">16</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++j == naddrs) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (qtype) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs6 = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;naddrs = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs != (u_short) -<span class="Constant">1<br/></li>
<li></span><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; rn-&gt;naddrs6 != (u_short) -<span class="Constant">1<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; rn-&gt;naddrs<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + rn-&gt;naddrs6<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">export</span><span class="cUserCont">:<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; naddrs = rn-&gt;naddrs;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; naddrs += rn-&gt;naddrs6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (naddrs == <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs = <a href="#L4147" title="src/core/ngx_resolver.c:4147">ngx_resolver_export</a>(r, rn, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) rn-&gt;ttl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;name_expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = rn-&gt;valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;naddrs = naddrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs = &amp;ctx-&gt;addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addr.sockaddr = (<span class="Type">struct</span> sockaddr *) &amp;ctx-&gt;sin;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addr.socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;ctx-&gt;sin, <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sin.sin_family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;sin.sin_addr.s_addr = rn-&gt;u.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs = addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, addrs-&gt;sockaddr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, addrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cname) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* CNAME only */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs == (u_short) -<span class="Constant">1<br/></li>
<li></span><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || rn-&gt;naddrs6 == (u_short) -<span class="Constant">1<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3930" title="src/core/ngx_resolver.c:3930">ngx_resolver_copy</a>(r, &amp;name, buf, cname, buf + n) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver cname:</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;cnlen = (u_short) name.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;u.cname = name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) rn-&gt;ttl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;name_expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;recursion++ &gt;= <a href="ngx_resolver.h.html#L37" title="src/core/ngx_resolver.h:37">NGX_RESOLVER_MAX_RECURSION</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_resolver.h.html#L29" title="src/core/ngx_resolver.h:29">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (next = ctx; next; next = next-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next-&gt;node = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L574" title="src/core/ngx_resolver.c:574">ngx_resolve_name_locked</a>(r, ctx, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no A or CNAME types in DNS response&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">short_response</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; err = <span class="Constant">&quot;short DNS response&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li><span class="Statement">next</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2544">&#x200c;</a></span><span class="linkable">ngx_resolver_process_srv</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> nan,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> trunc, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ans)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *err;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cname;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L133" title="src/os/win32/ngx_win32_config.h:133">int32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ttl;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; name;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type, qident, class, start, nsrvs, a, i, j;<br/></li>
<li>&nbsp; &nbsp; <a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *an;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ctx, *next;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L75" title="src/core/ngx_resolver.h:75">ngx_resolver_srv_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *srvs;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *rn;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3930" title="src/core/ngx_resolver.c:3930">ngx_resolver_copy</a>(r, &amp;name, buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf + <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>), buf + n)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolver qs:%V&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="src/core/ngx_crc32.h:21">ngx_crc32_short</a>(name.data, name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn = <a href="#L3418" title="src/core/ngx_resolver.c:3418">ngx_resolver_lookup_srv</a>(r, &amp;name, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn == <span class="Constant">NULL</span> || rn-&gt;query == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected response for %V&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (trunc &amp;&amp; rn-&gt;tcp) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qident = (rn-&gt;query[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ident != qident) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;wrong ident </span><span class="Special">%u</span><span class="Constant">i response for %V, expect </span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ident, &amp;name, qident);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (trunc) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;waiting == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;r-&gt;srv_rbtree, &amp;rn-&gt;node);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4037" title="src/core/ngx_resolver.c:4037">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec = r-&gt;connections.elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rec = &amp;rec[rn-&gt;last_connection];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;tcp = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L1341" title="src/core/ngx_resolver.c:1341">ngx_resolver_send_tcp_query</a>(r, rec, rn-&gt;query, rn-&gt;qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;resend_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;srv_resend_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <span class="Constant">0</span> &amp;&amp; rn-&gt;code) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; code = rn-&gt;code;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <span class="Constant">0</span> &amp;&amp; nan == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; code = <a href="ngx_resolver.h.html#L29" title="src/core/ngx_resolver.h:29">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;r-&gt;srv_rbtree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : <span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4037" title="src/core/ngx_resolver.c:4037">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = ans;<br/></li>
<li>&nbsp; &nbsp; nsrvs = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; cname = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (a = <span class="Constant">0</span>; a &lt; nan; a++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start = i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (i &lt; n) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> test_length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">1</span> + buf[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">test_length</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i - start &lt; <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid name DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Statement">sizeof</span>(<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>) &gt;= n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; an = (<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a> *) &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type = (an-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;type_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; class = (an-&gt;class_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;class_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = (an-&gt;len_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;len_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ttl = (an-&gt;ttl[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">24</span>) + (an-&gt;ttl[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (an-&gt;ttl[<span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + (an-&gt;ttl[<span class="Constant">3</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (class != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected RR class </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, class);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ttl &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ttl = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;ttl = <a href="ngx_core.h.html#L102" title="src/core/ngx_core.h:102">ngx_min</a>(rn-&gt;ttl, (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>) ttl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (type) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L24" title="src/core/ngx_resolver.h:24">NGX_RESOLVE_SRV</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Constant">6</span> &gt; n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3930" title="src/core/ngx_resolver.c:3930">ngx_resolver_copy</a>(r, <span class="Constant">NULL</span>, buf, &amp;buf[i + <span class="Constant">6</span>], buf + n)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nsrvs++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L17" title="src/core/ngx_resolver.h:17">NGX_RESOLVE_CNAME</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cname = &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L25" title="src/core/ngx_resolver.h:25">NGX_RESOLVE_DNAME</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected RR type </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, type);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver nsrvs:</span><span class="Special">%u</span><span class="Constant">i cname:</span><span class="Special">%p</span><span class="Constant"> ttl:</span><span class="Special">%u</span><span class="Constant">D&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; nsrvs, cname, rn-&gt;ttl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nsrvs) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; srvs = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, nsrvs * <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L75" title="src/core/ngx_resolver.h:75">ngx_resolver_srv_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (srvs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;u.srvs = srvs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;nsrvs = (u_short) nsrvs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; j = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = ans;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (a = <span class="Constant">0</span>; a &lt; nan; a++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">1</span> + buf[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; an = (<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a> *) &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type = (an-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;type_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = (an-&gt;len_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;len_lo;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == <a href="ngx_resolver.h.html#L24" title="src/core/ngx_resolver.h:24">NGX_RESOLVE_SRV</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srvs[j].priority = (buf[i] &lt;&lt; <span class="Constant">8</span>) + buf[i + <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srvs[j].weight = (buf[i + <span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + buf[i + <span class="Constant">3</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (srvs[j].weight == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srvs[j].weight = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srvs[j].port = (buf[i + <span class="Constant">4</span>] &lt;&lt; <span class="Constant">8</span>) + buf[i + <span class="Constant">5</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3930" title="src/core/ngx_resolver.c:3930">ngx_resolver_copy</a>(r, &amp;srvs[j].name, buf, &amp;buf[i + <span class="Constant">6</span>],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf + n)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L1933" title="src/core/ngx_string.c:1933">ngx_sort</a>(srvs, nsrvs, <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L75" title="src/core/ngx_resolver.h:75">ngx_resolver_srv_t</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L4636" title="src/core/ngx_resolver.c:4636">ngx_resolver_cmp_srvs</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) rn-&gt;ttl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;srv_expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2927" title="src/core/ngx_resolver.c:2927">ngx_resolver_resolve_srv_names</a>(ctx, rn);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;nsrvs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cname) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* CNAME only */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3930" title="src/core/ngx_resolver.c:3930">ngx_resolver_copy</a>(r, &amp;name, buf, cname, buf + n) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolver cname:</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;cnlen = (u_short) name.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;u.cname = name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) rn-&gt;ttl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;r-&gt;srv_expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;recursion++ &gt;= <a href="ngx_resolver.h.html#L37" title="src/core/ngx_resolver.h:37">NGX_RESOLVER_MAX_RECURSION</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_resolver.h.html#L29" title="src/core/ngx_resolver.h:29">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (next = ctx; next; next = next-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next-&gt;node = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L574" title="src/core/ngx_resolver.c:574">ngx_resolve_name_locked</a>(r, ctx, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;no SRV type in DNS response&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">short_response</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; err = <span class="Constant">&quot;short DNS response&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock name mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2927">&#x200c;</a></span><span class="linkable">ngx_resolver_resolve_srv_names</span>(<a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *cctx;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L88" title="src/core/ngx_resolver.h:88">ngx_resolver_srv_name_t</a>&nbsp; *srvs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;resolver;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;node = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;valid = rn-&gt;valid;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;count = rn-&gt;nsrvs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; srvs = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, rn-&gt;nsrvs * <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L88" title="src/core/ngx_resolver.h:88">ngx_resolver_srv_name_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (srvs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;srvs = srvs;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;nsrvs = rn-&gt;nsrvs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; rn-&gt;nsrvs; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; srvs[i].name.data = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, rn-&gt;u.srvs[i].name.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (srvs[i].name.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; srvs[i].name.len = rn-&gt;u.srvs[i].name.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(srvs[i].name.data, rn-&gt;u.srvs[i].name.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; srvs[i].name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cctx = <a href="#L364" title="src/core/ngx_resolver.c:364">ngx_resolve_start</a>(r, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cctx-&gt;name = srvs[i].name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cctx-&gt;handler = <a href="#L2993" title="src/core/ngx_resolver.c:2993">ngx_resolver_srv_names_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cctx-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cctx-&gt;srvs = &amp;srvs[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cctx-&gt;timeout = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; srvs[i].priority = rn-&gt;u.srvs[i].priority;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; srvs[i].weight = rn-&gt;u.srvs[i].weight;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; srvs[i].port = rn-&gt;u.srvs[i].port;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; srvs[i].ctx = cctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L403" title="src/core/ngx_resolver.c:403">ngx_resolve_name</a>(cctx) == <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srvs[i].ctx = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : <span class="Constant">10</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2993">&#x200c;</a></span><span class="linkable">ngx_resolver_srv_names_handler</span>(<a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *cctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_inet.h.html#L77" title="src/core/ngx_inet.h:77">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *addrs;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_inet.h.html#L43" title="src/core/ngx_inet.h:43">ngx_sockaddr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *sockaddr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L88" title="src/core/ngx_resolver.h:88">ngx_resolver_srv_name_t</a>&nbsp; *srv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = cctx-&gt;resolver;<br/></li>
<li>&nbsp; &nbsp; ctx = cctx-&gt;data;<br/></li>
<li>&nbsp; &nbsp; srv = cctx-&gt;srvs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;count--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; srv-&gt;ctx = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cctx-&gt;naddrs) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_core.h.html#L102" title="src/core/ngx_core.h:102">ngx_min</a>(ctx-&gt;valid, cctx-&gt;valid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addrs = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, cctx-&gt;naddrs * <span class="Statement">sizeof</span>(<a href="ngx_inet.h.html#L77" title="src/core/ngx_inet.h:77">ngx_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L483" title="src/core/ngx_resolver.c:483">ngx_resolve_name_done</a>(cctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : <span class="Constant">10</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sockaddr = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, cctx-&gt;naddrs * <span class="Statement">sizeof</span>(<a href="ngx_inet.h.html#L43" title="src/core/ngx_inet.h:43">ngx_sockaddr_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sockaddr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, addrs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L483" title="src/core/ngx_resolver.c:483">ngx_resolve_name_done</a>(cctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : <span class="Constant">10</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; cctx-&gt;naddrs; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs[i].sockaddr = &amp;sockaddr[i].sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs[i].socklen = cctx-&gt;addrs[i].socklen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(&amp;sockaddr[i], cctx-&gt;addrs[i].sockaddr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addrs[i].socklen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_inet.c.html#L1373" title="src/core/ngx_inet.c:1373">ngx_inet_set_port</a>(addrs[i].sockaddr, srv-&gt;port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; srv-&gt;addrs = addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; srv-&gt;naddrs = cctx-&gt;naddrs;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L483" title="src/core/ngx_resolver.c:483">ngx_resolve_name_done</a>(cctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;count == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4230" title="src/core/ngx_resolver.c:4230">ngx_resolver_report_srv</a>(r, ctx);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3060">&#x200c;</a></span><span class="linkable">ngx_resolver_process_ptr</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, u_char *buf, <span class="Type">size_t</span> n,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ident, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> code, <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> nan)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *err;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_win32_config.h.html#L192" title="src/os/win32/ngx_win32_config.h:192">in_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L133" title="src/os/win32/ngx_win32_config.h:133">int32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ttl;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; octet;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; name;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mask, type, class, qident, a, i, start;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *expire_queue;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L32" title="src/core/ngx_rbtree.h:32">ngx_rbtree_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tree;<br/></li>
<li>&nbsp; &nbsp; <a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>&nbsp; &nbsp; *an;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp;&nbsp; *ctx, *next;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; digit;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; &nbsp; &nbsp;&nbsp; addr6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3930" title="src/core/ngx_resolver.c:3930">ngx_resolver_copy</a>(r, &amp;name, buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf + <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>), buf + n)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolver qs:%V&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* AF_INET */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; addr = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; i = <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (mask = <span class="Constant">0</span>; mask &lt; <span class="Constant">32</span>; mask += <span class="Constant">8</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = buf[i++];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; octet = <a href="ngx_string.c.html#L902" title="src/core/ngx_string.c:902">ngx_atoi</a>(&amp;buf[i], len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (octet == <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> || octet &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_in_addr_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr += octet &lt;&lt; mask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.c.html#L571" title="src/core/ngx_string.c:571">ngx_strcasecmp</a>(&amp;buf[i], (u_char *) <span class="Constant">&quot;</span><span class="Special">\7</span><span class="Constant">in-addr</span><span class="Special">\4</span><span class="Constant">arpa&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<span class="Constant">&quot;</span><span class="Special">\7</span><span class="Constant">in-addr</span><span class="Special">\4</span><span class="Constant">arpa&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L3459" title="src/core/ngx_resolver.c:3459">ngx_resolver_lookup_addr</a>(r, addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr_expire_queue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> valid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">invalid_in_addr_arpa</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; i = <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (octet = <span class="Constant">15</span>; octet &gt;= <span class="Constant">0</span>; octet--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i++] != <span class="Special">'\1'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_ip6_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; digit = <a href="ngx_string.c.html#L1070" title="src/core/ngx_string.c:1070">ngx_hextoi</a>(&amp;buf[i++], <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (digit == <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_ip6_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[octet] = (u_char) digit;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i++] != <span class="Special">'\1'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_ip6_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; digit = <a href="ngx_string.c.html#L1070" title="src/core/ngx_string.c:1070">ngx_hextoi</a>(&amp;buf[i++], <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (digit == <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_ip6_arpa;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6.s6_addr[octet] += (u_char) (digit * <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_string.c.html#L571" title="src/core/ngx_string.c:571">ngx_strcasecmp</a>(&amp;buf[i], (u_char *) <span class="Constant">&quot;</span><span class="Special">\3</span><span class="Constant">ip6</span><span class="Special">\4</span><span class="Constant">arpa&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<span class="Constant">&quot;</span><span class="Special">\3</span><span class="Constant">ip6</span><span class="Special">\4</span><span class="Constant">arpa&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* lock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash = <a href="ngx_crc32.h.html#L21" title="src/core/ngx_crc32.h:21">ngx_crc32_short</a>(addr6.s6_addr, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L3492" title="src/core/ngx_resolver.c:3492">ngx_resolver_lookup_addr6</a>(r, &amp;addr6, hash);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tree = &amp;r-&gt;addr6_rbtree;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; expire_queue = &amp;r-&gt;addr6_expire_queue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> valid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">invalid_ip6_arpa</span><span class="cUserCont">:<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid in-addr.arpa or ip6.arpa name in DNS response&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">valid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn == <span class="Constant">NULL</span> || rn-&gt;query == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected response for %V&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qident = (rn-&gt;query[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">8</span>) + rn-&gt;query[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ident != qident) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;wrong ident </span><span class="Special">%u</span><span class="Constant">i response for %V, expect </span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ident, &amp;name, qident);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code == <span class="Constant">0</span> &amp;&amp; nan == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; code = <a href="ngx_resolver.h.html#L29" title="src/core/ngx_resolver.h:29">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (code) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(tree, &amp;rn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = code;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : <span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4037" title="src/core/ngx_resolver.c:4037">ngx_resolver_free_node</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (a = <span class="Constant">0</span>; a &lt; nan; a++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start = i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (i &lt; n) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[i] == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> test_length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Constant">1</span> + buf[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">test_length</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i - start &lt; <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;invalid name in DNS response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">found</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i + <span class="Statement">sizeof</span>(<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>) &gt;= n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> short_response;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; an = (<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a> *) &amp;buf[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; type = (an-&gt;type_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;type_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; class = (an-&gt;class_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;class_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = (an-&gt;len_hi &lt;&lt; <span class="Constant">8</span>) + an-&gt;len_lo;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ttl = (an-&gt;ttl[<span class="Constant">0</span>] &lt;&lt; <span class="Constant">24</span>) + (an-&gt;ttl[<span class="Constant">1</span>] &lt;&lt; <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (an-&gt;ttl[<span class="Constant">2</span>] &lt;&lt; <span class="Constant">8</span>) + (an-&gt;ttl[<span class="Constant">3</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (class != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected RR class </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, class);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ttl &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ttl = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;resolver qt:</span><span class="Special">%u</span><span class="Constant">i cl:</span><span class="Special">%u</span><span class="Constant">i len:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type, class, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += <span class="Statement">sizeof</span>(<a href="#L51" title="src/core/ngx_resolver.c:51">ngx_resolver_an_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (type) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L18" title="src/core/ngx_resolver.h:18">NGX_RESOLVE_PTR</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> ptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="ngx_resolver.h.html#L17" title="src/core/ngx_resolver.h:17">NGX_RESOLVE_CNAME</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unexpected RR type </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, type);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i += len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no PTR type in DNS response&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">ptr</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3930" title="src/core/ngx_resolver.c:3930">ngx_resolver_copy</a>(r, &amp;name, buf, buf + i, buf + n) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;resolver an:%V&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len != (<span class="Type">size_t</span>) rn-&gt;nlen<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || <a href="ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(name.data, rn-&gt;name, name.len) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;nlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, rn-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;nlen = (u_short) name.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;name = name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.data = <a href="#L4130" title="src/core/ngx_resolver.c:4130">ngx_resolver_dup</a>(r, rn-&gt;name, name.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : ttl);<br/></li>
<li>&nbsp; &nbsp; rn-&gt;expire = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + r-&gt;expire;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(expire_queue, &amp;rn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; next = rn-&gt;waiting;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;waiting = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = rn-&gt;valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;name = name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = ctx-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">short_response</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; err = <span class="Constant">&quot;short DNS response&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock addr mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *<br/></li>
<li><a id="L3377">&#x200c;</a><span class="linkable">ngx_resolver_lookup_name</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name, <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span> hash)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = r-&gt;name_rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = r-&gt;name_rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L54" title="src/core/ngx_resolver.c:54">ngx_resolver_node</a>(node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_string.c.html#L806" title="src/core/ngx_string.c:806">ngx_memn2cmp</a>(name-&gt;data, rn-&gt;name, name-&gt;len, rn-&gt;nlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rn;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not found */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *<br/></li>
<li><a id="L3418">&#x200c;</a><span class="linkable">ngx_resolver_lookup_srv</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name, <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span> hash)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = r-&gt;srv_rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = r-&gt;srv_rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L54" title="src/core/ngx_resolver.c:54">ngx_resolver_node</a>(node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_string.c.html#L806" title="src/core/ngx_string.c:806">ngx_memn2cmp</a>(name-&gt;data, rn-&gt;name, name-&gt;len, rn-&gt;nlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rn;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not found */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *<br/></li>
<li><a id="L3459">&#x200c;</a><span class="linkable">ngx_resolver_lookup_addr</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="../os/win32/ngx_win32_config.h.html#L192" title="src/os/win32/ngx_win32_config.h:192">in_addr_t</a> addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; *node, *sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = r-&gt;addr_rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = r-&gt;addr_rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* addr == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L54" title="src/core/ngx_resolver.c:54">ngx_resolver_node</a>(node);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not found */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *<br/></li>
<li><a id="L3492">&#x200c;</a><span class="linkable">ngx_resolver_lookup_addr6</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">struct</span> in6_addr *addr,<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span> hash)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp; *rn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = r-&gt;addr6_rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = r-&gt;addr6_rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hash &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* hash == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L54" title="src/core/ngx_resolver.c:54">ngx_resolver_node</a>(node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(addr, &amp;rn-&gt;addr6, <span class="Constant">16</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rn;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not found */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3536">&#x200c;</a></span><span class="linkable">ngx_resolver_rbtree_insert_value</span>(<a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp;&nbsp; *rn, *rn_temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;key &lt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;left;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (node-&gt;key &gt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;right;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* node-&gt;key == temp-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L54" title="src/core/ngx_resolver.c:54">ngx_resolver_node</a>(node);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn_temp = <a href="#L54" title="src/core/ngx_resolver.c:54">ngx_resolver_node</a>(temp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="ngx_string.c.html#L806" title="src/core/ngx_string.c:806">ngx_memn2cmp</a>(rn-&gt;name, rn_temp-&gt;name, rn-&gt;nlen, rn_temp-&gt;nlen)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &lt; <span class="Constant">0</span>) ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = node;<br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = temp;<br/></li>
<li>&nbsp; &nbsp; node-&gt;left = sentinel;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L59" title="src/core/ngx_rbtree.h:59">ngx_rbt_red</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3579">&#x200c;</a></span><span class="linkable">ngx_resolver_rbtree_insert_addr6_value</span>(<a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a>&nbsp;&nbsp; *rn, *rn_temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;key &lt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;left;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (node-&gt;key &gt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;right;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* node-&gt;key == temp-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn = <a href="#L54" title="src/core/ngx_resolver.c:54">ngx_resolver_node</a>(node);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rn_temp = <a href="#L54" title="src/core/ngx_resolver.c:54">ngx_resolver_node</a>(temp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(&amp;rn-&gt;addr6, &amp;rn_temp-&gt;addr6, <span class="Constant">16</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &lt; <span class="Constant">0</span>) ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = node;<br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = temp;<br/></li>
<li>&nbsp; &nbsp; node-&gt;left = sentinel;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_rbtree.h.html#L59" title="src/core/ngx_rbtree.h:59">ngx_rbt_red</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3622">&#x200c;</a><span class="linkable">ngx_resolver_create_name_query</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p, *s;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len, nlen;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ident;<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>&nbsp;&nbsp; *qs;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>&nbsp; *query;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; nlen = name-&gt;len ? (<span class="Constant">1</span> + name-&gt;len + <span class="Constant">1</span>) : <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>) + nlen + <span class="Statement">sizeof</span>(<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; p = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, r-&gt;ipv6 ? len * <span class="Constant">2</span> : len);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; p = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, len);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;qlen = (u_short) len;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;query = p;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;ipv6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rn-&gt;query6 = p + len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; query = (<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ident = <a href="../os/win32/ngx_win32_config.h.html#L261" title="src/os/win32/ngx_win32_config.h:261">ngx_random</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> A </span><span class="Special">%i</span><span class="Constant">&quot;</span>, name, ident &amp; <span class="Constant">0xffff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_hi = (u_char) ((ident &gt;&gt; <span class="Constant">8</span>) &amp; <span class="Constant">0xff</span>);<br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_lo = (u_char) (ident &amp; <span class="Constant">0xff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* recursion query */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;flags_hi = <span class="Constant">1</span>; query-&gt;flags_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* one question */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;nqs_hi = <span class="Constant">0</span>; query-&gt;nqs_lo = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nan_hi = <span class="Constant">0</span>; query-&gt;nan_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nns_hi = <span class="Constant">0</span>; query-&gt;nns_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nar_hi = <span class="Constant">0</span>; query-&gt;nar_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>) + nlen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qs = (<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* query type */<br/></li>
<li></span>&nbsp; &nbsp; qs-&gt;type_hi = <span class="Constant">0</span>; qs-&gt;type_lo = <a href="ngx_resolver.h.html#L16" title="src/core/ngx_resolver.h:16">NGX_RESOLVE_A</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* IN query class */<br/></li>
<li></span>&nbsp; &nbsp; qs-&gt;class_hi = <span class="Constant">0</span>; qs-&gt;class_lo = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* convert &quot;www.example.com&quot; to &quot;\3www\7example\3com\0&quot; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; p--;<br/></li>
<li>&nbsp; &nbsp; *p-- = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name-&gt;len == <span class="Constant">0</span>)&nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (s = name-&gt;data + name-&gt;len - <span class="Constant">1</span>; s &gt;= name-&gt;data; s--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*s != <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = *s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0</span> || len &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = (u_char) len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0</span> || len &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = (u_char) len;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;ipv6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = rn-&gt;query6;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(p, rn-&gt;query, rn-&gt;qlen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query = (<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ident = <a href="../os/win32/ngx_win32_config.h.html#L261" title="src/os/win32/ngx_win32_config.h:261">ngx_random</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> AAAA </span><span class="Special">%i</span><span class="Constant">&quot;</span>, name, ident &amp; <span class="Constant">0xffff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_hi = (u_char) ((ident &gt;&gt; <span class="Constant">8</span>) &amp; <span class="Constant">0xff</span>);<br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_lo = (u_char) (ident &amp; <span class="Constant">0xff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>) + nlen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qs = (<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qs-&gt;type_lo = <a href="ngx_resolver.h.html#L22" title="src/core/ngx_resolver.h:22">NGX_RESOLVE_AAAA</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3746">&#x200c;</a><span class="linkable">ngx_resolver_create_srv_query</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p, *s;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len, nlen;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ident;<br/></li>
<li>&nbsp; &nbsp; <a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>&nbsp;&nbsp; *qs;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>&nbsp; *query;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; nlen = name-&gt;len ? (<span class="Constant">1</span> + name-&gt;len + <span class="Constant">1</span>) : <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>) + nlen + <span class="Statement">sizeof</span>(<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;qlen = (u_short) len;<br/></li>
<li>&nbsp; &nbsp; rn-&gt;query = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query = (<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ident = <a href="../os/win32/ngx_win32_config.h.html#L261" title="src/os/win32/ngx_win32_config.h:261">ngx_random</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="ngx_log.h.html#L26" title="src/core/ngx_log.h:26">NGX_LOG_DEBUG_CORE</a>, r-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;resolve: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> SRV </span><span class="Special">%i</span><span class="Constant">&quot;</span>, name, ident &amp; <span class="Constant">0xffff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_hi = (u_char) ((ident &gt;&gt; <span class="Constant">8</span>) &amp; <span class="Constant">0xff</span>);<br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_lo = (u_char) (ident &amp; <span class="Constant">0xff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* recursion query */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;flags_hi = <span class="Constant">1</span>; query-&gt;flags_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* one question */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;nqs_hi = <span class="Constant">0</span>; query-&gt;nqs_lo = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nan_hi = <span class="Constant">0</span>; query-&gt;nan_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nns_hi = <span class="Constant">0</span>; query-&gt;nns_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nar_hi = <span class="Constant">0</span>; query-&gt;nar_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>) + nlen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qs = (<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* query type */<br/></li>
<li></span>&nbsp; &nbsp; qs-&gt;type_hi = <span class="Constant">0</span>; qs-&gt;type_lo = <a href="ngx_resolver.h.html#L24" title="src/core/ngx_resolver.h:24">NGX_RESOLVE_SRV</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* IN query class */<br/></li>
<li></span>&nbsp; &nbsp; qs-&gt;class_hi = <span class="Constant">0</span>; qs-&gt;class_lo = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* converts &quot;www.example.com&quot; to &quot;\3www\7example\3com\0&quot; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; p--;<br/></li>
<li>&nbsp; &nbsp; *p-- = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name-&gt;len == <span class="Constant">0</span>)&nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (s = name-&gt;data + name-&gt;len - <span class="Constant">1</span>; s &gt;= name-&gt;data; s--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*s != <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = *s;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0</span> || len &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = (u_char) len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0</span> || len &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = (u_char) len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3834">&#x200c;</a><span class="linkable">ngx_resolver_create_addr_query</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a> *addr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *d;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_win32_config.h.html#L192" title="src/os/win32/ngx_win32_config.h:192">in_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; inaddr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ident;<br/></li>
<li>&nbsp; &nbsp; <a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>&nbsp;&nbsp; *query;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp;&nbsp; *sin;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; *sin6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (addr-&gt;sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Constant">64</span> + <span class="Statement">sizeof</span>(<span class="Constant">&quot;.ip6.arpa.&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<span class="Constant">&quot;.255.255.255.255.in-addr.arpa.&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<a href="#L40" title="src/core/ngx_resolver.c:40">ngx_resolver_qs_t</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;query = p;<br/></li>
<li>&nbsp; &nbsp; query = (<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a> *) p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ident = <a href="../os/win32/ngx_win32_config.h.html#L261" title="src/os/win32/ngx_win32_config.h:261">ngx_random</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_hi = (u_char) ((ident &gt;&gt; <span class="Constant">8</span>) &amp; <span class="Constant">0xff</span>);<br/></li>
<li>&nbsp; &nbsp; query-&gt;ident_lo = (u_char) (ident &amp; <span class="Constant">0xff</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* recursion query */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;flags_hi = <span class="Constant">1</span>; query-&gt;flags_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* one question */<br/></li>
<li></span>&nbsp; &nbsp; query-&gt;nqs_hi = <span class="Constant">0</span>; query-&gt;nqs_lo = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nan_hi = <span class="Constant">0</span>; query-&gt;nan_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nns_hi = <span class="Constant">0</span>; query-&gt;nns_lo = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; query-&gt;nar_hi = <span class="Constant">0</span>; query-&gt;nar_lo = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p += <span class="Statement">sizeof</span>(<a href="#L32" title="src/core/ngx_resolver.c:32">ngx_resolver_hdr_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (addr-&gt;sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) addr-&gt;sockaddr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">15</span>; n &gt;= <span class="Constant">0</span>; n--) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(p, <span class="Constant">&quot;</span><span class="Special">\1%x</span><span class="Constant">d</span><span class="Special">\1%x</span><span class="Constant">d&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6-&gt;sin6_addr.s6_addr[n] &amp; <span class="Constant">0xf</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (sin6-&gt;sin6_addr.s6_addr[n] &gt;&gt; <span class="Constant">4</span>) &amp; <span class="Constant">0xf</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;</span><span class="Special">\3</span><span class="Constant">ip6</span><span class="Special">\4</span><span class="Constant">arpa</span><span class="Special">\0</span><span class="Constant">&quot;</span>, <span class="Constant">10</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) addr-&gt;sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; inaddr = ntohl(sin-&gt;sin_addr.s_addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; <span class="Constant">32</span>; n += <span class="Constant">8</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d = <a href="ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(&amp;p[<span class="Constant">1</span>], <span class="Constant">&quot;</span><span class="Special">%u</span><span class="Constant">d&quot;</span>, (inaddr &gt;&gt; n) &amp; <span class="Constant">0xff</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = (u_char) (d - &amp;p[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = d;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;</span><span class="Special">\7</span><span class="Constant">in-addr</span><span class="Special">\4</span><span class="Constant">arpa</span><span class="Special">\0</span><span class="Constant">&quot;</span>, <span class="Constant">14</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* query type &quot;PTR&quot;, IN query class */<br/></li>
<li></span>&nbsp; &nbsp; p = <a href="ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;</span><span class="Special">\0\14\0\1</span><span class="Constant">&quot;</span>, <span class="Constant">4</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rn-&gt;qlen = (u_short) (p - rn-&gt;query);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3930">&#x200c;</a><span class="linkable">ngx_resolver_copy</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name, u_char *buf, u_char *src,<br/></li>
<li>&nbsp; &nbsp; u_char *last)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; *err;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; *p, *dst;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; i, n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = src;<br/></li>
<li>&nbsp; &nbsp; len = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * compression pointers allow to create endless loop, so we set limit;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 128 pointers should be enough to store 255-byte name<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">128</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = *p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = ((n &amp; <span class="Constant">0x3f</span>) &lt;&lt; <span class="Constant">8</span>) + *p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;buf[n];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;p[n];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p &gt;= last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">&quot;name is out of response&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err = <span class="Constant">&quot;compression pointers loop&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(r-&gt;log_level, r-&gt;log, <span class="Constant">0</span>, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L44" title="src/core/ngx_string.h:44">ngx_str_null</a>(name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dst = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name-&gt;data = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = *src++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &amp; <span class="Constant">0xc0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = ((n &amp; <span class="Constant">0x3f</span>) &lt;&lt; <span class="Constant">8</span>) + *src;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src = &amp;buf[n];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = *src++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L21" title="src/core/ngx_string.c:21">ngx_strlow</a>(dst, src, n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = *src++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dst++ = <span class="Constant">'.'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name-&gt;len = dst - name-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4024">&#x200c;</a></span><span class="linkable">ngx_resolver_timeout_handler</span>(<a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = ev-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = <a href="ngx_resolver.h.html#L32" title="src/core/ngx_resolver.h:32">NGX_RESOLVE_TIMEDOUT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4037">&#x200c;</a></span><span class="linkable">ngx_resolver_free_node</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;query) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;query);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;name) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;cnlen) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u.cname);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs &gt; <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u.addrs);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6 &gt; <span class="Constant">1</span> &amp;&amp; rn-&gt;naddrs6 != (u_short) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u6.addrs6);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;nsrvs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; rn-&gt;nsrvs; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;u.srvs[i].name.data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u.srvs[i].name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn-&gt;u.srvs);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4123" title="src/core/ngx_resolver.c:4123">ngx_resolver_free_locked</a>(r, rn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L4082">&#x200c;</a><span class="linkable">ngx_resolver_alloc</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; p = <a href="../os/win32/ngx_alloc.c.html#L17" title="src/os/win32/ngx_alloc.c:17">ngx_alloc</a>(size, r-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L4097">&#x200c;</a><span class="linkable">ngx_resolver_calloc</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(p, size);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4112">&#x200c;</a></span><span class="linkable">ngx_resolver_free</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">void</span> *p)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock alloc mutex */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unlock alloc mutex */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4123">&#x200c;</a></span><span class="linkable">ngx_resolver_free_locked</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">void</span> *p)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(p);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L4130">&#x200c;</a><span class="linkable">ngx_resolver_dup</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <span class="Type">void</span> *src, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; *dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dst = <a href="#L4082" title="src/core/ngx_resolver.c:4082">ngx_resolver_alloc</a>(r, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> dst;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(dst, src, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> dst;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a> *<br/></li>
<li><a id="L4147">&#x200c;</a><span class="linkable">ngx_resolver_export</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L144" title="src/core/ngx_resolver.h:144">ngx_resolver_node_t</a> *rn,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> rotate)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d, i, j, n;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_win32_config.h.html#L192" title="src/os/win32/ngx_win32_config.h:192">in_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_inet.h.html#L43" title="src/core/ngx_inet.h:43">ngx_sockaddr_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *sockaddr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp;&nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a>&nbsp; *dst;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> in6_addr&nbsp; &nbsp; &nbsp; *addr6;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; *sin6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; n = rn-&gt;naddrs;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; n += rn-&gt;naddrs6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; dst = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, n * <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sockaddr = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, n * <span class="Statement">sizeof</span>(<a href="ngx_inet.h.html#L43" title="src/core/ngx_inet.h:43">ngx_sockaddr_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sockaddr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, dst);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; d = rotate ? <a href="../os/win32/ngx_win32_config.h.html#L261" title="src/os/win32/ngx_win32_config.h:261">ngx_random</a>() % n : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; j = rotate ? <a href="../os/win32/ngx_win32_config.h.html#L261" title="src/os/win32/ngx_win32_config.h:261">ngx_random</a>() % rn-&gt;naddrs : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr = (rn-&gt;naddrs == <span class="Constant">1</span>) ? &amp;rn-&gt;u.addr : rn-&gt;u.addrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin = &amp;sockaddr[d].sockaddr_in;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin-&gt;sin_family = AF_INET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin-&gt;sin_addr.s_addr = addr[j++];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst[d].sockaddr = (<span class="Type">struct</span> sockaddr *) sin;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst[d++].socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (d == n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (j == rn-&gt;naddrs) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (++i &lt; rn-&gt;naddrs);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (rn-&gt;naddrs6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; j = rotate ? <a href="../os/win32/ngx_win32_config.h.html#L261" title="src/os/win32/ngx_win32_config.h:261">ngx_random</a>() % rn-&gt;naddrs6 : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr6 = (rn-&gt;naddrs6 == <span class="Constant">1</span>) ? &amp;rn-&gt;u6.addr6 : rn-&gt;u6.addrs6;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6 = &amp;sockaddr[d].sockaddr_in6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6-&gt;sin6_family = AF_INET6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(sin6-&gt;sin6_addr.s6_addr, addr6[j++].s6_addr, <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst[d].sockaddr = (<span class="Type">struct</span> sockaddr *) sin6;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst[d++].socklen = <span class="Statement">sizeof</span>(<span class="Type">struct</span> sockaddr_in6);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (d == n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (j == rn-&gt;naddrs6) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (++i &lt; n);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> dst;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4230">&#x200c;</a></span><span class="linkable">ngx_resolver_report_srv</span>(<a href="ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *r, <a href="ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; naddrs, nsrvs, nw, i, j, k, l, m, n, w;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a>&nbsp; &nbsp; &nbsp; *addrs;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L88" title="src/core/ngx_resolver.h:88">ngx_resolver_srv_name_t</a>&nbsp; *srvs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; naddrs = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; ctx-&gt;nsrvs; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; naddrs += ctx-&gt;srvs[i].naddrs;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (naddrs == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_resolver.h.html#L29" title="src/core/ngx_resolver.h:29">NGX_RESOLVE_NXDOMAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : <span class="Constant">10</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addrs = <a href="#L4097" title="src/core/ngx_resolver.c:4097">ngx_resolver_calloc</a>(r, naddrs * <span class="Statement">sizeof</span>(<a href="ngx_resolver.h.html#L67" title="src/core/ngx_resolver.h:67">ngx_resolver_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;valid = <a href="ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (r-&gt;valid ? r-&gt;valid : <span class="Constant">10</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; srvs = ctx-&gt;srvs;<br/></li>
<li>&nbsp; &nbsp; nsrvs = ctx-&gt;nsrvs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; n = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nw = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = i; j &lt; nsrvs; j++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (srvs[j].priority != srvs[i].priority) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nw += srvs[j].naddrs * srvs[j].weight;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nw == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next_srv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; w = <a href="../os/win32/ngx_win32_config.h.html#L261" title="src/os/win32/ngx_win32_config.h:261">ngx_random</a>() % nw;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (k = i; k &lt; j; k++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (w &lt; srvs[k].naddrs * srvs[k].weight) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w -= srvs[k].naddrs * srvs[k].weight;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (l = i; l &lt; j; l++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (m = <span class="Constant">0</span>; m &lt; srvs[k].naddrs; m++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs[n].socklen = srvs[k].addrs[m].socklen;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs[n].sockaddr = srvs[k].addrs[m].sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs[n].name = srvs[k].name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs[n].priority = srvs[k].priority;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addrs[n].weight = srvs[k].weight;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++k == j) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k = i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">next_srv</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = j;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (i &lt; ctx-&gt;nsrvs);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;addrs = addrs;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;naddrs = naddrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4112" title="src/core/ngx_resolver.c:4112">ngx_resolver_free</a>(r, addrs);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">char</span> *<br/></li>
<li><a id="L4323">&#x200c;</a><span class="linkable">ngx_resolver_strerror</span>(<a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> err)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">char</span> *errors[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Format error&quot;</span>,&nbsp; &nbsp;&nbsp; <span class="Comment">/* FORMERR */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Server failure&quot;</span>,&nbsp;&nbsp; <span class="Comment">/* SERVFAIL */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Host not found&quot;</span>,&nbsp;&nbsp; <span class="Comment">/* NXDOMAIN */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Unimplemented&quot;</span>,&nbsp; &nbsp; <span class="Comment">/* NOTIMP */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Operation refused&quot;</span> <span class="Comment">/* REFUSED */<br/></li>
<li></span>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (err &gt; <span class="Constant">0</span> &amp;&amp; err &lt; <span class="Constant">6</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> errors[err - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (err == <a href="ngx_resolver.h.html#L32" title="src/core/ngx_resolver.h:32">NGX_RESOLVE_TIMEDOUT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;Operation timed out&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;Unknown error&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L4346">&#x200c;</a><span class="linkable">ngx_resolver_log_error</span>(<a href="ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a>&nbsp; *rec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (log-&gt;action) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot; while </span><span class="Special">%s</span><span class="Constant">&quot;</span>, log-&gt;action);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rec = log-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rec) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(p, len, <span class="Constant">&quot;, resolver: %V&quot;</span>, &amp;rec-&gt;server);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4369">&#x200c;</a><span class="linkable">ngx_udp_connect</span>(<a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a> *rec)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *rev, *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L19" title="src/os/win32/ngx_socket.h:19">ngx_socket_t</a>&nbsp; &nbsp; &nbsp;&nbsp; s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = <a href="../os/win32/ngx_socket.h.html#L23" title="src/os/win32/ngx_socket.h:23">ngx_socket</a>(rec-&gt;sockaddr-&gt;sa_family, SOCK_DGRAM, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, &amp;rec-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;UDP socket </span><span class="Special">%d</span><span class="Constant">&quot;</span>, s);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s == (<a href="../os/win32/ngx_socket.h.html#L19" title="src/os/win32/ngx_socket.h:19">ngx_socket_t</a>) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;rec-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L26" title="src/os/win32/ngx_socket.h:26">ngx_socket_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="ngx_connection.c.html#L1030" title="src/core/ngx_connection.c:1030">ngx_get_connection</a>(s, &amp;rec-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_socket.h.html#L37" title="src/os/win32/ngx_socket.h:37">ngx_close_socket</a>(s) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;rec-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L38" title="src/os/win32/ngx_socket.h:38">ngx_close_socket_n</a> <span class="Constant">&quot;failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_socket.c.html#L13" title="src/os/win32/ngx_socket.c:13">ngx_nonblocking</a>(s) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;rec-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L31" title="src/os/win32/ngx_socket.h:31">ngx_nonblocking_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li>&nbsp; &nbsp; wev = c-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev-&gt;log = &amp;rec-&gt;log;<br/></li>
<li>&nbsp; &nbsp; wev-&gt;log = &amp;rec-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rec-&gt;udp = c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;number = <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L48" title="src/event/ngx_event.c:48">ngx_connection_counter</a>, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, &amp;rec-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;connect to %V, fd:</span><span class="Special">%d</span><span class="Constant"> #</span><span class="Special">%u</span><span class="Constant">A&quot;</span>, &amp;rec-&gt;server, s, c-&gt;number);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = connect(s, rec-&gt;sockaddr, rec-&gt;socklen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: <a href="../event/modules/ngx_iocp_module.c.html#L101" title="src/event/modules/ngx_iocp_module.c:101">iocp</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, &amp;rec-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;connect() failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* UDP sockets are always ready to write */<br/></li>
<li></span>&nbsp; &nbsp; wev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; event = (<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L219" title="src/event/ngx_event.h:219">NGX_USE_CLEAR_EVENT</a>) ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* kqueue, epoll */</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../event/ngx_event.h.html#L342" title="src/event/ngx_event.h:342">NGX_CLEAR_EVENT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* select, poll, /dev/poll */</span>&nbsp; &nbsp; &nbsp;&nbsp; <a href="../event/ngx_event.h.html#L340" title="src/event/ngx_event.h:340">NGX_LEVEL_EVENT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* eventport event type has no meaning: oneshot only */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L406" title="src/event/ngx_event.h:406">ngx_add_event</a>(rev, <a href="../event/ngx_event.h.html#L318" title="src/event/ngx_event.h:318">NGX_READ_EVENT</a>, event) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; rec-&gt;udp = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4453">&#x200c;</a><span class="linkable">ngx_tcp_connect</span>(<a href="ngx_resolver.h.html#L53" title="src/core/ngx_resolver.h:53">ngx_resolver_connection_t</a> *rec)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; level;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L19" title="src/os/win32/ngx_socket.h:19">ngx_socket_t</a>&nbsp; &nbsp; &nbsp;&nbsp; s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *rev, *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = <a href="../os/win32/ngx_socket.h.html#L23" title="src/os/win32/ngx_socket.h:23">ngx_socket</a>(rec-&gt;sockaddr-&gt;sa_family, SOCK_STREAM, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, &amp;rec-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;TCP socket </span><span class="Special">%d</span><span class="Constant">&quot;</span>, s);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s == (<a href="../os/win32/ngx_socket.h.html#L19" title="src/os/win32/ngx_socket.h:19">ngx_socket_t</a>) -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;rec-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L26" title="src/os/win32/ngx_socket.h:26">ngx_socket_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="ngx_connection.c.html#L1030" title="src/core/ngx_connection.c:1030">ngx_get_connection</a>(s, &amp;rec-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_socket.h.html#L37" title="src/os/win32/ngx_socket.h:37">ngx_close_socket</a>(s) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;rec-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L38" title="src/os/win32/ngx_socket.h:38">ngx_close_socket_n</a> <span class="Constant">&quot;failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_socket.c.html#L13" title="src/os/win32/ngx_socket.c:13">ngx_nonblocking</a>(s) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;rec-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L31" title="src/os/win32/ngx_socket.h:31">ngx_nonblocking_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li>&nbsp; &nbsp; wev = c-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev-&gt;log = &amp;rec-&gt;log;<br/></li>
<li>&nbsp; &nbsp; wev-&gt;log = &amp;rec-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rec-&gt;tcp = c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;number = <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L48" title="src/event/ngx_event.c:48">ngx_connection_counter</a>, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L408" title="src/event/ngx_event.h:408">ngx_add_conn</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L408" title="src/event/ngx_event.h:408">ngx_add_conn</a>(c) == <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, &amp;rec-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;connect to %V, fd:</span><span class="Special">%d</span><span class="Constant"> #</span><span class="Special">%u</span><span class="Constant">A&quot;</span>, &amp;rec-&gt;server, s, c-&gt;number);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = connect(s, rec-&gt;sockaddr, rec-&gt;socklen);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>;<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err != <a href="../os/win32/ngx_errno.h.html#L42" title="src/os/win32/ngx_errno.h:42">NGX_EINPROGRESS</a><br/></li>
<li><span class="PreProc">#if (NGX_WIN32)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Winsock returns WSAEWOULDBLOCK (<a href="../os/win32/ngx_errno.h.html#L41" title="src/os/win32/ngx_errno.h:41">NGX_EAGAIN</a>) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; err != <a href="../os/win32/ngx_errno.h.html#L41" title="src/os/win32/ngx_errno.h:41">NGX_EAGAIN</a><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err == <a href="../os/win32/ngx_errno.h.html#L50" title="src/os/win32/ngx_errno.h:50">NGX_ECONNREFUSED</a><br/></li>
<li><span class="PreProc">#if (NGX_LINUX)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Linux returns EAGAIN instead of ECONNREFUSED<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * for unix sockets if listen queue is full<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/win32/ngx_errno.h.html#L41" title="src/os/win32/ngx_errno.h:41">NGX_EAGAIN</a><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/win32/ngx_errno.h.html#L47" title="src/os/win32/ngx_errno.h:47">NGX_ECONNRESET</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/win32/ngx_errno.h.html#L52" title="src/os/win32/ngx_errno.h:52">NGX_ENETDOWN</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/win32/ngx_errno.h.html#L53" title="src/os/win32/ngx_errno.h:53">NGX_ENETUNREACH</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/win32/ngx_errno.h.html#L54" title="src/os/win32/ngx_errno.h:54">NGX_EHOSTDOWN</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || err == <a href="../os/win32/ngx_errno.h.html#L55" title="src/os/win32/ngx_errno.h:55">NGX_EHOSTUNREACH</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <a href="ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <a href="ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(level, c-&gt;log, err, <span class="Constant">&quot;connect() to %V failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;rec-&gt;server);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rec-&gt;tcp = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L408" title="src/event/ngx_event.h:408">ngx_add_conn</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == -<span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../os/win32/ngx_errno.h.html#L42" title="src/os/win32/ngx_errno.h:42">NGX_EINPROGRESS</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, &amp;rec-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;connected&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L256" title="src/event/ngx_event.h:256">NGX_USE_IOCP_EVENT</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, &amp;rec-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;connect(): </span><span class="Special">%d</span><span class="Constant">&quot;</span>, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_socket.c.html#L22" title="src/os/win32/ngx_socket.c:22">ngx_blocking</a>(s) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, &amp;rec-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L32" title="src/os/win32/ngx_socket.h:32">ngx_blocking_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * FreeBSD's aio allows to post an operation on non-connected socket.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * NT does not support it.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * </span><span class="Todo">TODO</span><span class="Comment">: check in Win32, etc. As workaround we can use <a href="../event/ngx_event.h.html#L341" title="src/event/ngx_event.h:341">NGX_ONESHOT_EVENT</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L219" title="src/event/ngx_event.h:219">NGX_USE_CLEAR_EVENT</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* kqueue */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; event = <a href="../event/ngx_event.h.html#L342" title="src/event/ngx_event.h:342">NGX_CLEAR_EVENT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* select, poll, /dev/poll */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; event = <a href="../event/ngx_event.h.html#L340" title="src/event/ngx_event.h:340">NGX_LEVEL_EVENT</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L406" title="src/event/ngx_event.h:406">ngx_add_event</a>(rev, <a href="../event/ngx_event.h.html#L318" title="src/event/ngx_event.h:318">NGX_READ_EVENT</a>, event) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == -<span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../os/win32/ngx_errno.h.html#L42" title="src/os/win32/ngx_errno.h:42">NGX_EINPROGRESS</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L406" title="src/event/ngx_event.h:406">ngx_add_event</a>(wev, <a href="../event/ngx_event.h.html#L319" title="src/event/ngx_event.h:319">NGX_WRITE_EVENT</a>, event) != <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, &amp;rec-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;connected&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; rec-&gt;tcp = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4636">&#x200c;</a><span class="linkable">ngx_resolver_cmp_srvs</span>(<span class="Type">const</span> <span class="Type">void</span> *one, <span class="Type">const</span> <span class="Type">void</span> *two)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p1, p2;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_resolver.h.html#L75" title="src/core/ngx_resolver.h:75">ngx_resolver_srv_t</a>&nbsp; *first, *second;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; first = (<a href="ngx_resolver.h.html#L75" title="src/core/ngx_resolver.h:75">ngx_resolver_srv_t</a> *) one;<br/></li>
<li>&nbsp; &nbsp; second = (<a href="ngx_resolver.h.html#L75" title="src/core/ngx_resolver.h:75">ngx_resolver_srv_t</a> *) two;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p1 = first-&gt;priority;<br/></li>
<li>&nbsp; &nbsp; p2 = second-&gt;priority;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p1 - p2;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
