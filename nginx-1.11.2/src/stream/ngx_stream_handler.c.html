<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/stream/ngx_stream_handler.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>src/stream/ngx_stream_handler.c - Nginx 1.11.2</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L297">ngx_stream_close_connection</a></li>
<li><a href="#L24">ngx_stream_init_connection</a></li>
<li><a href="#L228">ngx_stream_init_session</a></li>
<li><a href="#L328">ngx_stream_log_error</a></li>
<li><a href="#L279">ngx_stream_ssl_handshake_handler</a></li>
<li><a href="#L251">ngx_stream_ssl_init_connection</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Roman Arutyunyan<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_event.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_stream.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<a href="#L328" title="src/stream/ngx_stream_handler.c:328">ngx_stream_log_error</a>(<a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L228" title="src/stream/ngx_stream_handler.c:228">ngx_stream_init_session</a>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void</span> <a href="#L251" title="src/stream/ngx_stream_handler.c:251">ngx_stream_ssl_init_connection</a>(<a href="../event/ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl, <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L279" title="src/stream/ngx_stream_handler.c:279">ngx_stream_ssl_handshake_handler</a>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L24">&#x200c;</a></span><span class="linkable">ngx_stream_init_connection</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tcp_nodelay;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text[<a href="../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *sa;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L92" title="src/stream/ngx_stream.h:92">ngx_stream_port_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *port;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L75" title="src/stream/ngx_stream.h:75">ngx_stream_in_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L70" title="src/stream/ngx_stream.h:70">ngx_stream_addr_conf_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *addr_conf;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *sin6;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L83" title="src/stream/ngx_stream.h:83">ngx_stream_in6_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *addr6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_stream.h.html#L144" title="src/stream/ngx_stream.h:144">ngx_stream_core_srv_conf_t</a>&nbsp;&nbsp; *cscf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L127" title="src/stream/ngx_stream.h:127">ngx_stream_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* find the server configuration for the address:port */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; port = c-&gt;listening-&gt;servers;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (port-&gt;naddrs &gt; <span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * There are several addresses on this port and one of them<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * is the &quot;*:port&quot; wildcard so getsockname() is needed to determine<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the server address.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * AcceptEx() and recvmsg() already gave this address.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_connection.c.html#L1276" title="src/core/ngx_connection.c:1276">ngx_connection_local_sockaddr</a>(c, <span class="Constant">NULL</span>, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sa = c-&gt;local_sockaddr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (sa-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) sa;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = port-&gt;addrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the last address is &quot;*&quot; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; port-&gt;naddrs - <span class="Constant">1</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(&amp;addr6[i].addr6, &amp;sin6-&gt;sin6_addr, <span class="Constant">16</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr_conf = &amp;addr6[i].conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) sa;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = port-&gt;addrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the last address is &quot;*&quot; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; port-&gt;naddrs - <span class="Constant">1</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr[i].addr == sin-&gt;sin_addr.s_addr) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr_conf = &amp;addr[i].conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (c-&gt;local_sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = port-&gt;addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr_conf = &amp;addr6[<span class="Constant">0</span>].conf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = port-&gt;addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr_conf = &amp;addr[<span class="Constant">0</span>].conf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(c-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;signature = <a href="ngx_stream.h.html#L185" title="src/stream/ngx_stream.h:185">NGX_STREAM_MODULE</a>;<br/></li>
<li>&nbsp; &nbsp; s-&gt;main_conf = addr_conf-&gt;ctx-&gt;main_conf;<br/></li>
<li>&nbsp; &nbsp; s-&gt;srv_conf = addr_conf-&gt;ctx-&gt;srv_conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;connection = c;<br/></li>
<li>&nbsp; &nbsp; c-&gt;data = s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="ngx_stream_core_module.c.html#L87" title="src/stream/ngx_stream_core_module.c:87">ngx_stream_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.h.html#L199" title="src/core/ngx_connection.h:199">ngx_set_connection_log</a>(c, cscf-&gt;error_log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <a href="../core/ngx_inet.c.html#L181" title="src/core/ngx_inet.c:181">ngx_sock_ntop</a>(c-&gt;sockaddr, c-&gt;socklen, text, <a href="../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;*</span><span class="Special">%u</span><span class="Constant">A </span><span class="Special">%s</span><span class="Constant">client </span><span class="Special">%*s</span><span class="Constant"> connected to %V&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;number, c-&gt;type == SOCK_DGRAM ? <span class="Constant">&quot;udp &quot;</span> : <span class="Constant">&quot;&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len, text, &amp;addr_conf-&gt;addr_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;connection = c-&gt;number;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;handler = <a href="#L328" title="src/stream/ngx_stream_handler.c:328">ngx_stream_log_error</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;data = s;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;initializing connection&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log_error = NGX_ERROR_INFO;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="ngx_stream.h.html#L201" title="src/stream/ngx_stream.h:201">ngx_stream_get_module_main_conf</a>(s, <a href="ngx_stream_core_module.c.html#L87" title="src/stream/ngx_stream_core_module.c:87">ngx_stream_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;variables = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(s-&gt;connection-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cmcf-&gt;variables.nelts<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <span class="Statement">sizeof</span>(<a href="ngx_stream_variables.h.html#L17" title="src/stream/ngx_stream_variables.h:17">ngx_stream_variable_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;variables == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cmcf-&gt;limit_conn_handler) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = cmcf-&gt;limit_conn_handler(s);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cmcf-&gt;access_handler) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = cmcf-&gt;access_handler(s);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a> &amp;&amp; rc != <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;type == SOCK_STREAM<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; cscf-&gt;tcp_nodelay<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; c-&gt;tcp_nodelay == NGX_TCP_NODELAY_UNSET)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;tcp_nodelay&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (setsockopt(c-&gt;fd, IPPROTO_TCP, TCP_NODELAY,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">const</span> <span class="Type">void</span> *) &amp;tcp_nodelay, <span class="Statement">sizeof</span>(<span class="Type">int</span>)) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;setsockopt(TCP_NODELAY) failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;tcp_nodelay = NGX_TCP_NODELAY_SET;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_ssl_module.h.html#L44" title="src/stream/ngx_stream_ssl_module.h:44">ngx_stream_ssl_conf_t</a>&nbsp; *sslcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sslcf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="ngx_stream_ssl_module.c.html#L156" title="src/stream/ngx_stream_ssl_module.c:156">ngx_stream_ssl_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addr_conf-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;SSL handshaking&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sslcf-&gt;ssl.ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no </span><span class="Special">\&quot;</span><span class="Constant">ssl_certificate</span><span class="Special">\&quot;</span><span class="Constant"> is defined &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;in server listening on SSL port&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L251" title="src/stream/ngx_stream_handler.c:251">ngx_stream_ssl_init_connection</a>(&amp;sslcf-&gt;ssl, c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L228" title="src/stream/ngx_stream_handler.c:228">ngx_stream_init_session</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L228">&#x200c;</a></span><span class="linkable">ngx_stream_init_session</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L144" title="src/stream/ngx_stream.h:144">ngx_stream_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = c-&gt;data;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;handling client connection&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="ngx_stream_core_module.c.html#L87" title="src/stream/ngx_stream_core_module.c:87">ngx_stream_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;ctx = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(c-&gt;pool, <span class="Statement">sizeof</span>(<span class="Type">void</span> *) * <a href="ngx_stream.c.html#L27" title="src/stream/ngx_stream.c:27">ngx_stream_max_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf-&gt;handler(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L251">&#x200c;</a></span><span class="linkable">ngx_stream_ssl_init_connection</span>(<a href="../event/ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl, <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a>&nbsp;&nbsp; *s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_ssl_module.h.html#L44" title="src/stream/ngx_stream_ssl_module.h:44">ngx_stream_ssl_conf_t</a>&nbsp; *sslcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L1125" title="src/event/ngx_event_openssl.c:1125">ngx_ssl_create_connection</a>(ssl, c, <span class="Constant">0</span>) == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L1184" title="src/event/ngx_event_openssl.c:1184">ngx_ssl_handshake</a>(c) == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sslcf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="ngx_stream_ssl_module.c.html#L156" title="src/stream/ngx_stream_ssl_module.c:156">ngx_stream_ssl_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(c-&gt;read, sslcf-&gt;handshake_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;handler = <a href="#L279" title="src/stream/ngx_stream_handler.c:279">ngx_stream_ssl_handshake_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L279" title="src/stream/ngx_stream_handler.c:279">ngx_stream_ssl_handshake_handler</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L279">&#x200c;</a></span><span class="linkable">ngx_stream_ssl_handshake_handler</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;ssl-&gt;handshaked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(c-&gt;read);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L228" title="src/stream/ngx_stream_handler.c:228">ngx_stream_init_session</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L297">&#x200c;</a></span><span class="linkable">ngx_stream_close_connection</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a>&nbsp; *pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;close stream connection: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, c-&gt;fd);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L1883" title="src/event/ngx_event_openssl.c:1883">ngx_ssl_shutdown</a>(c) == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;handler = <a href="#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_STAT_STUB)<br/></li>
<li></span>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L69" title="src/event/ngx_event.c:69">ngx_stat_active</a>, -<span class="Constant">1</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; pool = c-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(c);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(pool);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L328">&#x200c;</a><span class="linkable">ngx_stream_log_error</span>(<a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a>&nbsp; *s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (log-&gt;action) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot; while </span><span class="Special">%s</span><span class="Constant">&quot;</span>, log-&gt;action);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = log-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot;, </span><span class="Special">%s</span><span class="Constant">client: %V, server: %V&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; s-&gt;connection-&gt;type == SOCK_DGRAM ? <span class="Constant">&quot;udp &quot;</span> : <span class="Constant">&quot;&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;s-&gt;connection-&gt;addr_text,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;s-&gt;connection-&gt;listening-&gt;addr_text);<br/></li>
<li>&nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; buf = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;log_handler) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = s-&gt;log_handler(log, buf, len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
