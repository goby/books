<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/stream/ngx_stream_proxy_module.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>src/stream/ngx_stream_proxy_module.c - Nginx 1.11.2</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L108">ngx_conf_deprecated_proxy_downstream_buffer</a></li>
<li><a href="#L112">ngx_conf_deprecated_proxy_upstream_buffer</a></li>
<li><a href="#L117">ngx_stream_proxy_commands</a></li>
<li><a href="#L328">ngx_stream_proxy_module</a></li>
<li><a href="#L316">ngx_stream_proxy_module_ctx</a></li>
<li><a href="#L96">ngx_stream_proxy_ssl_protocols</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L55">ngx_stream_proxy_srv_conf_t</a></li>
<li><a href="#L19">ngx_stream_upstream_local_t</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L1699">ngx_stream_proxy_bind</a></li>
<li><a href="#L501">ngx_stream_proxy_connect</a></li>
<li><a href="#L1069">ngx_stream_proxy_connect_handler</a></li>
<li><a href="#L1460">ngx_stream_proxy_create_srv_conf</a></li>
<li><a href="#L972">ngx_stream_proxy_downstream_handler</a></li>
<li><a href="#L1386">ngx_stream_proxy_finalize</a></li>
<li><a href="#L345">ngx_stream_proxy_handler</a></li>
<li><a href="#L559">ngx_stream_proxy_init_upstream</a></li>
<li><a href="#L1429">ngx_stream_proxy_log_error</a></li>
<li><a href="#L1510">ngx_stream_proxy_merge_srv_conf</a></li>
<li><a href="#L1333">ngx_stream_proxy_next_upstream</a></li>
<li><a href="#L1664">ngx_stream_proxy_pass</a></li>
<li><a href="#L1142">ngx_stream_proxy_process</a></li>
<li><a href="#L986">ngx_stream_proxy_process_connection</a></li>
<li><a href="#L672">ngx_stream_proxy_send_proxy_protocol</a></li>
<li><a href="#L448">ngx_stream_proxy_set_local</a></li>
<li><a href="#L1593">ngx_stream_proxy_set_ssl</a></li>
<li><a href="#L821">ngx_stream_proxy_ssl_handshake</a></li>
<li><a href="#L768">ngx_stream_proxy_ssl_init_connection</a></li>
<li><a href="#L875">ngx_stream_proxy_ssl_name</a></li>
<li><a href="#L744">ngx_stream_proxy_ssl_password_file</a></li>
<li><a href="#L1098">ngx_stream_proxy_test_connect</a></li>
<li><a href="#L979">ngx_stream_proxy_upstream_handler</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Roman Arutyunyan<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_stream.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_inet.h.html#L77" title="src/core/ngx_inet.h:77">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_script.h.html#L59" title="src/stream/ngx_stream_script.h:59">ngx_stream_complex_value_t</a>&nbsp; &nbsp; &nbsp; *value;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_TRANSPARENT_PROXY)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; transparent; <span class="Comment">/* unsigned&nbsp; transparent:1; */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li><a id="L19">&#x200c;</a></span>} <span class="linkable">ngx_stream_upstream_local_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; connect_timeout;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timeout;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; next_upstream_timeout;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buffer_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; upload_rate;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; download_rate;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; responses;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; next_upstream_tries;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L80" title="src/core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; next_upstream;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L80" title="src/core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; proxy_protocol;<br/></li>
<li>&nbsp; &nbsp; <a href="#L19" title="src/stream/ngx_stream_proxy_module.c:19">ngx_stream_upstream_local_t</a>&nbsp; &nbsp;&nbsp; *local;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L80" title="src/core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ssl_enable;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L80" title="src/core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ssl_session_reuse;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ssl_protocols;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ssl_ciphers;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ssl_name;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L80" title="src/core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ssl_server_name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L80" title="src/core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ssl_verify;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ssl_verify_depth;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ssl_trusted_certificate;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ssl_crl;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ssl_certificate;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ssl_certificate_key;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ssl_passwords;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ssl;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L32" title="src/stream/ngx_stream_upstream.h:32">ngx_stream_upstream_srv_conf_t</a>&nbsp; *upstream;<br/></li>
<li><a id="L55">&#x200c;</a>} <span class="linkable">ngx_stream_proxy_srv_conf_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L345" title="src/stream/ngx_stream_proxy_module.c:345">ngx_stream_proxy_handler</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L448" title="src/stream/ngx_stream_proxy_module.c:448">ngx_stream_proxy_set_local</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a> *u, <a href="#L19" title="src/stream/ngx_stream_proxy_module.c:19">ngx_stream_upstream_local_t</a> *local);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L501" title="src/stream/ngx_stream_proxy_module.c:501">ngx_stream_proxy_connect</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L559" title="src/stream/ngx_stream_proxy_module.c:559">ngx_stream_proxy_init_upstream</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L979" title="src/stream/ngx_stream_proxy_module.c:979">ngx_stream_proxy_upstream_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L972" title="src/stream/ngx_stream_proxy_module.c:972">ngx_stream_proxy_downstream_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L986" title="src/stream/ngx_stream_proxy_module.c:986">ngx_stream_proxy_process_connection</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> from_upstream);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1069" title="src/stream/ngx_stream_proxy_module.c:1069">ngx_stream_proxy_connect_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1098" title="src/stream/ngx_stream_proxy_module.c:1098">ngx_stream_proxy_test_connect</a>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1142" title="src/stream/ngx_stream_proxy_module.c:1142">ngx_stream_proxy_process</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> from_upstream, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> do_write);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1333" title="src/stream/ngx_stream_proxy_module.c:1333">ngx_stream_proxy_next_upstream</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s, <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> rc);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1429" title="src/stream/ngx_stream_proxy_module.c:1429">ngx_stream_proxy_log_error</a>(<a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> len);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L1460" title="src/stream/ngx_stream_proxy_module.c:1460">ngx_stream_proxy_create_srv_conf</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1510" title="src/stream/ngx_stream_proxy_module.c:1510">ngx_stream_proxy_merge_srv_conf</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *child);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1664" title="src/stream/ngx_stream_proxy_module.c:1664">ngx_stream_proxy_pass</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1699" title="src/stream/ngx_stream_proxy_module.c:1699">ngx_stream_proxy_bind</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L672" title="src/stream/ngx_stream_proxy_module.c:672">ngx_stream_proxy_send_proxy_protocol</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L744" title="src/stream/ngx_stream_proxy_module.c:744">ngx_stream_proxy_ssl_password_file</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L768" title="src/stream/ngx_stream_proxy_module.c:768">ngx_stream_proxy_ssl_init_connection</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L821" title="src/stream/ngx_stream_proxy_module.c:821">ngx_stream_proxy_ssl_handshake</a>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *pc);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L875" title="src/stream/ngx_stream_proxy_module.c:875">ngx_stream_proxy_ssl_name</a>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1593" title="src/stream/ngx_stream_proxy_module.c:1593">ngx_stream_proxy_set_ssl</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a> *pscf);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L96">&#x200c;</a><span class="Type">static</span> <a href="../core/ngx_conf_file.h.html#L168" title="src/core/ngx_conf_file.h:168">ngx_conf_bitmask_t</a>&nbsp; <span class="linkable">ngx_stream_proxy_ssl_protocols</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;SSLv2&quot;</span>), <a href="../event/ngx_event_openssl.h.html#L128" title="src/event/ngx_event_openssl.h:128">NGX_SSL_SSLv2</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;SSLv3&quot;</span>), <a href="../event/ngx_event_openssl.h.html#L129" title="src/event/ngx_event_openssl.h:129">NGX_SSL_SSLv3</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;TLSv1&quot;</span>), <a href="../event/ngx_event_openssl.h.html#L130" title="src/event/ngx_event_openssl.h:130">NGX_SSL_TLSv1</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;TLSv1.1&quot;</span>), <a href="../event/ngx_event_openssl.h.html#L131" title="src/event/ngx_event_openssl.h:131">NGX_SSL_TLSv1_1</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;TLSv1.2&quot;</span>), <a href="../event/ngx_event_openssl.h.html#L132" title="src/event/ngx_event_openssl.h:132">NGX_SSL_TLSv1_2</a> },<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L41" title="src/core/ngx_string.h:41">ngx_null_string</a>, <span class="Constant">0</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L108">&#x200c;</a><span class="Type">static</span> <a href="../core/ngx_conf_file.h.html#L147" title="src/core/ngx_conf_file.h:147">ngx_conf_deprecated_t</a>&nbsp; <span class="linkable">ngx_conf_deprecated_proxy_downstream_buffer</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1404" title="src/core/ngx_conf_file.c:1404">ngx_conf_deprecated</a>, <span class="Constant">&quot;proxy_downstream_buffer&quot;</span>, <span class="Constant">&quot;proxy_buffer_size&quot;<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><a id="L112">&#x200c;</a><span class="Type">static</span> <a href="../core/ngx_conf_file.h.html#L147" title="src/core/ngx_conf_file.h:147">ngx_conf_deprecated_t</a>&nbsp; <span class="linkable">ngx_conf_deprecated_proxy_upstream_buffer</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1404" title="src/core/ngx_conf_file.c:1404">ngx_conf_deprecated</a>, <span class="Constant">&quot;proxy_upstream_buffer&quot;</span>, <span class="Constant">&quot;proxy_buffer_size&quot;<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L117">&#x200c;</a><span class="Type">static</span> <a href="../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a>&nbsp; <span class="linkable">ngx_stream_proxy_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_pass&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L1664" title="src/stream/ngx_stream_proxy_module.c:1664">ngx_stream_proxy_pass</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_bind&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L33" title="src/core/ngx_conf_file.h:33">NGX_CONF_TAKE12</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L1699" title="src/stream/ngx_stream_proxy_module.c:1699">ngx_stream_proxy_bind</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_connect_timeout&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1218" title="src/core/ngx_conf_file.c:1218">ngx_conf_set_msec_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, connect_timeout),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_timeout&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1218" title="src/core/ngx_conf_file.c:1218">ngx_conf_set_msec_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, timeout),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_buffer_size&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1156" title="src/core/ngx_conf_file.c:1156">ngx_conf_set_size_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, buffer_size),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_downstream_buffer&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1156" title="src/core/ngx_conf_file.c:1156">ngx_conf_set_size_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, buffer_size),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;<a href="#L108" title="src/stream/ngx_stream_proxy_module.c:108">ngx_conf_deprecated_proxy_downstream_buffer</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_upstream_buffer&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1156" title="src/core/ngx_conf_file.c:1156">ngx_conf_set_size_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, buffer_size),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;<a href="#L112" title="src/stream/ngx_stream_proxy_module.c:112">ngx_conf_deprecated_proxy_upstream_buffer</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_upload_rate&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1156" title="src/core/ngx_conf_file.c:1156">ngx_conf_set_size_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, upload_rate),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_download_rate&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1156" title="src/core/ngx_conf_file.c:1156">ngx_conf_set_size_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, download_rate),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_responses&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1125" title="src/core/ngx_conf_file.c:1125">ngx_conf_set_num_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, responses),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_next_upstream&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L44" title="src/core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L984" title="src/core/ngx_conf_file.c:984">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, next_upstream),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_next_upstream_tries&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1125" title="src/core/ngx_conf_file.c:1125">ngx_conf_set_num_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, next_upstream_tries),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_next_upstream_timeout&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1218" title="src/core/ngx_conf_file.c:1218">ngx_conf_set_msec_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, next_upstream_timeout),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_protocol&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L44" title="src/core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L984" title="src/core/ngx_conf_file.c:984">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, proxy_protocol),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L44" title="src/core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L984" title="src/core/ngx_conf_file.c:984">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_enable),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_session_reuse&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L44" title="src/core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L984" title="src/core/ngx_conf_file.c:984">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_session_reuse),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_protocols&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L46" title="src/core/ngx_conf_file.h:46">NGX_CONF_1MORE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1347" title="src/core/ngx_conf_file.c:1347">ngx_conf_set_bitmask_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_protocols),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;<a href="#L96" title="src/stream/ngx_stream_proxy_module.c:96">ngx_stream_proxy_ssl_protocols</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_ciphers&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1024" title="src/core/ngx_conf_file.c:1024">ngx_conf_set_str_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_ciphers),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_name&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1024" title="src/core/ngx_conf_file.c:1024">ngx_conf_set_str_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_name),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_server_name&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L44" title="src/core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L984" title="src/core/ngx_conf_file.c:984">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_server_name),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_verify&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L44" title="src/core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L984" title="src/core/ngx_conf_file.c:984">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_verify),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_verify_depth&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1125" title="src/core/ngx_conf_file.c:1125">ngx_conf_set_num_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_verify_depth),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_trusted_certificate&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1024" title="src/core/ngx_conf_file.c:1024">ngx_conf_set_str_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_trusted_certificate),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_crl&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1024" title="src/core/ngx_conf_file.c:1024">ngx_conf_set_str_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_crl),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_certificate&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1024" title="src/core/ngx_conf_file.c:1024">ngx_conf_set_str_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_certificate),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_certificate_key&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L1024" title="src/core/ngx_conf_file.c:1024">ngx_conf_set_str_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>, ssl_certificate_key),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;proxy_ssl_password_file&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L187" title="src/stream/ngx_stream.h:187">NGX_STREAM_MAIN_CONF</a>|<a href="ngx_stream.h.html#L188" title="src/stream/ngx_stream.h:188">NGX_STREAM_SRV_CONF</a>|<a href="../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L744" title="src/stream/ngx_stream_proxy_module.c:744">ngx_stream_proxy_ssl_password_file</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="ngx_stream.h.html#L193" title="src/stream/ngx_stream.h:193">NGX_STREAM_SRV_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L86" title="src/core/ngx_conf_file.h:86">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L316">&#x200c;</a><span class="Type">static</span> <a href="ngx_stream.h.html#L182" title="src/stream/ngx_stream.h:182">ngx_stream_module_t</a>&nbsp; <span class="linkable">ngx_stream_proxy_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create <a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1460" title="src/stream/ngx_stream_proxy_module.c:1460">ngx_stream_proxy_create_srv_conf</a>,&nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1510" title="src/stream/ngx_stream_proxy_module.c:1510">ngx_stream_proxy_merge_srv_conf</a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L328">&#x200c;</a><a href="../core/ngx_core.h.html#L15" title="src/core/ngx_core.h:15">ngx_module_t</a>&nbsp; <span class="linkable">ngx_stream_proxy_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_module.h.html#L230" title="src/core/ngx_module.h:230">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L316" title="src/stream/ngx_stream_proxy_module.c:316">ngx_stream_proxy_module_ctx</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L117" title="src/stream/ngx_stream_proxy_module.c:117">ngx_stream_proxy_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="ngx_stream.h.html#L185" title="src/stream/ngx_stream.h:185">NGX_STREAM_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../core/ngx_module.h.html#L234" title="src/core/ngx_module.h:234">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L345">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_handler</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; &nbsp;&nbsp; *pscf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L32" title="src/stream/ngx_stream_upstream.h:32">ngx_stream_upstream_srv_conf_t</a>&nbsp; *uscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = s-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;proxy connection handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(c-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;upstream = u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;log_handler = <a href="#L1429" title="src/stream/ngx_stream_proxy_module.c:1429">ngx_stream_proxy_log_error</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.log = c-&gt;log;<br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.log_error = NGX_ERROR_ERR;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L448" title="src/stream/ngx_stream_proxy_module.c:448">ngx_stream_proxy_set_local</a>(s, u, pscf-&gt;local) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.type = c-&gt;type;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uscf = pscf-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (uscf-&gt;peer.init(s, uscf) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.start_time = <a href="../core/ngx_times.c.html#L26" title="src/core/ngx_times.c:26">ngx_current_msec</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;next_upstream_tries<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; u-&gt;peer.tries &gt; pscf-&gt;next_upstream_tries)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.tries = pscf-&gt;next_upstream_tries;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;proxy_protocol = pscf-&gt;proxy_protocol;<br/></li>
<li>&nbsp; &nbsp; u-&gt;start_sec = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L972" title="src/stream/ngx_stream_proxy_module.c:972">ngx_stream_proxy_downstream_handler</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L972" title="src/stream/ngx_stream_proxy_module.c:972">ngx_stream_proxy_downstream_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;type == SOCK_DGRAM) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L501" title="src/stream/ngx_stream_proxy_module.c:501">ngx_stream_proxy_connect</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(c-&gt;pool, pscf-&gt;buffer_size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;downstream_buf.start = p;<br/></li>
<li>&nbsp; &nbsp; u-&gt;downstream_buf.end = p + pscf-&gt;buffer_size;<br/></li>
<li>&nbsp; &nbsp; u-&gt;downstream_buf.pos = p;<br/></li>
<li>&nbsp; &nbsp; u-&gt;downstream_buf.last = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;proxy_protocol<br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; pscf-&gt;ssl == <span class="Constant">NULL<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; pscf-&gt;buffer_size &gt;= <a href="../core/ngx_proxy_protocol.h.html#L16" title="src/core/ngx_proxy_protocol.h:16">NGX_PROXY_PROTOCOL_MAX_HEADER</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* optimization for a typical case */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;stream proxy send PROXY protocol header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_proxy_protocol.c.html#L128" title="src/core/ngx_proxy_protocol.c:128">ngx_proxy_protocol_write</a>(c, u-&gt;downstream_buf.last,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; u-&gt;downstream_buf.end);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;downstream_buf.last = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;proxy_protocol = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(c-&gt;read, &amp;<a href="../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L501" title="src/stream/ngx_stream_proxy_module.c:501">ngx_stream_proxy_connect</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L448">&#x200c;</a><span class="linkable">ngx_stream_proxy_set_local</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s, <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a> *u,<br/></li>
<li>&nbsp; &nbsp; <a href="#L19" title="src/stream/ngx_stream_proxy_module.c:19">ngx_stream_upstream_local_t</a> *local)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; val;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_inet.h.html#L77" title="src/core/ngx_inet.h:77">ngx_addr_t</a>&nbsp; *addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (local == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.local = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_TRANSPARENT_PROXY)<br/></li>
<li></span>&nbsp; &nbsp; u-&gt;peer.transparent = local-&gt;transparent;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (local-&gt;value == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.local = local-&gt;addr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_stream_script.c.html#L59" title="src/stream/ngx_stream_script.c:59">ngx_stream_complex_value</a>(s, local-&gt;value, &amp;val) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(s-&gt;connection-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_inet.h.html#L77" title="src/core/ngx_inet.h:77">ngx_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (addr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../core/ngx_inet.c.html#L529" title="src/core/ngx_inet.c:529">ngx_parse_addr_port</a>(s-&gt;connection-&gt;pool, addr, val.data, val.len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, s-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid local address </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr-&gt;name = val;<br/></li>
<li>&nbsp; &nbsp; u-&gt;peer.local = addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L501">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_connect</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c, *pc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *pscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = s-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;connecting to upstream&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../event/ngx_event_connect.c.html#L21" title="src/event/ngx_event_connect.c:21">ngx_event_connect_peer</a>(&amp;u-&gt;peer);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;proxy connect: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L39" title="src/core/ngx_core.h:39">NGX_BUSY</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;no live upstreams&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1333" title="src/stream/ngx_stream_proxy_module.c:1333">ngx_stream_proxy_next_upstream</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a> || rc == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a> || rc == <a href="../core/ngx_core.h.html#L40" title="src/core/ngx_core.h:40">NGX_DONE</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; pc = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pc-&gt;data = s;<br/></li>
<li>&nbsp; &nbsp; pc-&gt;log = c-&gt;log;<br/></li>
<li>&nbsp; &nbsp; pc-&gt;pool = c-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; pc-&gt;read-&gt;log = c-&gt;log;<br/></li>
<li>&nbsp; &nbsp; pc-&gt;write-&gt;log = c-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L559" title="src/stream/ngx_stream_proxy_module.c:559">ngx_stream_proxy_init_upstream</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pc-&gt;read-&gt;handler = <a href="#L1069" title="src/stream/ngx_stream_proxy_module.c:1069">ngx_stream_proxy_connect_handler</a>;<br/></li>
<li>&nbsp; &nbsp; pc-&gt;write-&gt;handler = <a href="#L1069" title="src/stream/ngx_stream_proxy_module.c:1069">ngx_stream_proxy_connect_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(pc-&gt;write, pscf-&gt;connect_timeout);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L559">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_init_upstream</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tcp_nodelay;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c, *pc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L45" title="src/core/ngx_log.h:45">ngx_log_handler_pt</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; handler;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L144" title="src/stream/ngx_stream.h:144">ngx_stream_core_srv_conf_t</a>&nbsp;&nbsp; *cscf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *pscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; pc = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="ngx_stream_core_module.c.html#L87" title="src/stream/ngx_stream_core_module.c:87">ngx_stream_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pc-&gt;type == SOCK_STREAM<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; cscf-&gt;tcp_nodelay<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; pc-&gt;tcp_nodelay == NGX_TCP_NODELAY_UNSET)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, pc-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;tcp_nodelay&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (setsockopt(pc-&gt;fd, IPPROTO_TCP, TCP_NODELAY,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">const</span> <span class="Type">void</span> *) &amp;tcp_nodelay, <span class="Statement">sizeof</span>(<span class="Type">int</span>)) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(pc, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;setsockopt(TCP_NODELAY) failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1333" title="src/stream/ngx_stream_proxy_module.c:1333">ngx_stream_proxy_next_upstream</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;tcp_nodelay = NGX_TCP_NODELAY_SET;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;proxy_protocol) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L672" title="src/stream/ngx_stream_proxy_module.c:672">ngx_stream_proxy_send_proxy_protocol</a>(s) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;proxy_protocol = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (pc-&gt;type == SOCK_STREAM &amp;&amp; pscf-&gt;ssl &amp;&amp; pc-&gt;ssl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L768" title="src/stream/ngx_stream_proxy_module.c:768">ngx_stream_proxy_ssl_init_connection</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c = s-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;log-&gt;log_level &gt;= <a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; str;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; addr[<a href="../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; str.len = <a href="../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; str.data = addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_connection.c.html#L1276" title="src/core/ngx_connection.c:1276">ngx_connection_local_sockaddr</a>(pc, &amp;str, <span class="Constant">1</span>) == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; handler = c-&gt;log-&gt;handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;handler = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">proxy %V connected to %V&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;type == SOCK_DGRAM ? <span class="Constant">&quot;udp &quot;</span> : <span class="Constant">&quot;&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;str, u-&gt;peer.name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;handler = handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;proxying connection&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;upstream_buf.start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(c-&gt;pool, pscf-&gt;buffer_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;upstream_buf.start = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;upstream_buf.end = p + pscf-&gt;buffer_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;upstream_buf.pos = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;upstream_buf.last = p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;type == SOCK_DGRAM) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s-&gt;received = c-&gt;buffer-&gt;last - c-&gt;buffer-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;downstream_buf = *c-&gt;buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;responses == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;read-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;read-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u-&gt;connected = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pc-&gt;read-&gt;handler = <a href="#L979" title="src/stream/ngx_stream_proxy_module.c:979">ngx_stream_proxy_upstream_handler</a>;<br/></li>
<li>&nbsp; &nbsp; pc-&gt;write-&gt;handler = <a href="#L979" title="src/stream/ngx_stream_proxy_module.c:979">ngx_stream_proxy_upstream_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pc-&gt;read-&gt;ready || pc-&gt;read-&gt;eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(pc-&gt;read, &amp;<a href="../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1142" title="src/stream/ngx_stream_proxy_module.c:1142">ngx_stream_proxy_process</a>(s, <span class="Constant">0</span>, <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L672">&#x200c;</a><span class="linkable">ngx_stream_proxy_send_proxy_protocol</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n, size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c, *pc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *pscf;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf[<a href="../core/ngx_proxy_protocol.h.html#L16" title="src/core/ngx_proxy_protocol.h:16">NGX_PROXY_PROTOCOL_MAX_HEADER</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = s-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;stream proxy send PROXY protocol header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_proxy_protocol.c.html#L128" title="src/core/ngx_proxy_protocol.c:128">ngx_proxy_protocol_write</a>(c, buf, buf + <a href="../core/ngx_proxy_protocol.h.html#L16" title="src/core/ngx_proxy_protocol.h:16">NGX_PROXY_PROTOCOL_MAX_HEADER</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pc = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = p - buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = pc-&gt;send(pc, buf, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L332" title="src/event/ngx_event.c:332">ngx_handle_write_event</a>(pc-&gt;write, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(pc-&gt;write, pscf-&gt;timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;write-&gt;handler = <a href="#L1069" title="src/stream/ngx_stream_proxy_module.c:1069">ngx_stream_proxy_connect_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != size) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * PROXY protocol specification:<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * The sender must always ensure that the header<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * is sent at once, so that the transport layer<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * maintains atomicity along the path to the receiver.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;could not send PROXY protocol header at once&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L744">&#x200c;</a><span class="linkable">ngx_stream_proxy_ssl_password_file</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a> *pscf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; *value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_passwords != <a href="../core/ngx_conf_file.h.html#L58" title="src/core/ngx_conf_file.h:58">NGX_CONF_UNSET_PTR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf-&gt;ssl_passwords = <a href="../event/ngx_event_openssl.c.html#L861" title="src/event/ngx_event_openssl.c:861">ngx_ssl_read_password_file</a>(cf, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_passwords == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L768">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_ssl_init_connection</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *pc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *pscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pc = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L1125" title="src/event/ngx_event_openssl.c:1125">ngx_ssl_create_connection</a>(pscf-&gt;ssl, pc, <a href="../event/ngx_event_openssl.h.html#L135" title="src/event/ngx_event_openssl.h:135">NGX_SSL_BUFFER</a>|<a href="../event/ngx_event_openssl.h.html#L136" title="src/event/ngx_event_openssl.h:136">NGX_SSL_CLIENT</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_server_name || pscf-&gt;ssl_verify) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L875" title="src/stream/ngx_stream_proxy_module.c:875">ngx_stream_proxy_ssl_name</a>(s) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_session_reuse) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.set_session(&amp;u-&gt;peer, u-&gt;peer.data) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s-&gt;connection-&gt;log-&gt;action = <span class="Constant">&quot;SSL handshaking to upstream&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../event/ngx_event_openssl.c.html#L1184" title="src/event/ngx_event_openssl.c:1184">ngx_ssl_handshake</a>(pc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!pc-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(pc-&gt;write, pscf-&gt;connect_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;ssl-&gt;handler = <a href="#L821" title="src/stream/ngx_stream_proxy_module.c:821">ngx_stream_proxy_ssl_handshake</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L821" title="src/stream/ngx_stream_proxy_module.c:821">ngx_stream_proxy_ssl_handshake</a>(pc);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L821">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_ssl_handshake</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *pc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">long</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *pscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = pc-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pc-&gt;ssl-&gt;handshaked) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_verify) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = SSL_get_verify_result(pc-&gt;ssl-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != X509_V_OK) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, pc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream SSL certificate verify error: (%l:</span><span class="Special">%s</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc, X509_verify_cert_error_string(rc));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L3079" title="src/event/ngx_event_openssl.c:3079">ngx_ssl_check_host</a>(pc, &amp;u-&gt;ssl_name) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, pc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;upstream SSL certificate does not match </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;u-&gt;ssl_name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_session_reuse) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.save_session(&amp;u-&gt;peer, u-&gt;peer.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pc-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(pc-&gt;write);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L559" title="src/stream/ngx_stream_proxy_module.c:559">ngx_stream_proxy_init_upstream</a>(s);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1333" title="src/stream/ngx_stream_proxy_module.c:1333">ngx_stream_proxy_next_upstream</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L875">&#x200c;</a><span class="linkable">ngx_stream_proxy_ssl_name</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *last;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; name;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *pscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name = pscf-&gt;ssl_name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name = pscf-&gt;upstream-&gt;host;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * ssl name here may contain port, strip it for compatibility<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * with the http module<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; p = name.data;<br/></li>
<li>&nbsp; &nbsp; last = name.data + name.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">'['</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L66" title="src/core/ngx_string.h:66">ngx_strlchr</a>(p, last, <span class="Constant">']'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = name.data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L66" title="src/core/ngx_string.h:66">ngx_strlchr</a>(p, last, <span class="Constant">':'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.len = p - name.data;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!pscf-&gt;ssl_server_name) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_SET_TLSEXT_HOSTNAME<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* as per RFC 6066, literal IPv4 and IPv6 addresses are not permitted */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len == <span class="Constant">0</span> || *name.data == <span class="Constant">'['</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_inet.c.html#L18" title="src/core/ngx_inet.c:18">ngx_inet_addr</a>(name.data, name.len) != <a href="../core/ngx_config.h.html#L118" title="src/core/ngx_config.h:118">INADDR_NONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * SSL_set_tlsext_host_name() needs a null-terminated string,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * hence we explicitly null-terminate name here<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(s-&gt;connection-&gt;pool, name.len + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../core/ngx_string.c.html#L33" title="src/core/ngx_string.c:33">ngx_cpystrn</a>(p, name.data, name.len + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name.data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, s-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;upstream SSL server name: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SSL_set_tlsext_host_name(u-&gt;peer.connection-&gt;ssl-&gt;connection, name.data)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, s-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_set_tlsext_host_name(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u-&gt;ssl_name = name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L972">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_downstream_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L986" title="src/stream/ngx_stream_proxy_module.c:986">ngx_stream_proxy_process_connection</a>(ev, ev-&gt;write);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L979">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_upstream_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L986" title="src/stream/ngx_stream_proxy_module.c:986">ngx_stream_proxy_process_connection</a>(ev, !ev-&gt;write);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L986">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_process_connection</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> from_upstream)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c, *pc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *pscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; s = c-&gt;data;<br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = s-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; pc = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ev-&gt;timedout = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ev-&gt;delayed = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!ev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(ev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;connected &amp;&amp; !c-&gt;read-&gt;delayed &amp;&amp; !pc-&gt;read-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(c-&gt;write, pscf-&gt;timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;connection-&gt;type == SOCK_DGRAM) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;responses == <a href="../core/ngx_config.h.html#L129" title="src/core/ngx_config.h:129">NGX_MAX_INT32_VALUE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * successfully terminate timed out UDP session<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * with unspecified number of responses<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;read-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;read-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1142" title="src/stream/ngx_stream_proxy_module.c:1142">ngx_stream_proxy_process</a>(s, <span class="Constant">1</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;received == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1333" title="src/stream/ngx_stream_proxy_module.c:1333">ngx_stream_proxy_next_upstream</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;connection timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (ev-&gt;delayed) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;stream connection delayed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(ev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (from_upstream &amp;&amp; !u-&gt;connected) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1142" title="src/stream/ngx_stream_proxy_module.c:1142">ngx_stream_proxy_process</a>(s, from_upstream, ev-&gt;write);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1069">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_connect_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a>&nbsp; *s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; s = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, c-&gt;log, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;upstream timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1333" title="src/stream/ngx_stream_proxy_module.c:1333">ngx_stream_proxy_next_upstream</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(c-&gt;write);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;stream proxy connect upstream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1098" title="src/stream/ngx_stream_proxy_module.c:1098">ngx_stream_proxy_test_connect</a>(c) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1333" title="src/stream/ngx_stream_proxy_module.c:1333">ngx_stream_proxy_next_upstream</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L559" title="src/stream/ngx_stream_proxy_module.c:559">ngx_stream_proxy_init_upstream</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1098">&#x200c;</a><span class="linkable">ngx_stream_proxy_test_connect</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L20" title="src/os/win32/ngx_socket.h:20">socklen_t</a>&nbsp; len;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_KQUEUE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L225" title="src/event/ngx_event.h:225">NGX_USE_KQUEUE_EVENT</a>)&nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = c-&gt;write-&gt;kq_errno ? c-&gt;write-&gt;kq_errno : c-&gt;read-&gt;kq_errno;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;kevent() reported that connect() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<span class="Type">int</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * BSDs and Linux return 0 and set a pending error in err<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Solaris returns -1 and sets errno<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (getsockopt(c-&gt;fd, SOL_SOCKET, SO_ERROR, (<span class="Type">void</span> *) &amp;err, &amp;len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, err, <span class="Constant">&quot;connect() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1142">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_process</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> from_upstream,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> do_write)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *received, limit;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size, limit_rate;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flags;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delay;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c, *pc, *src, *dst;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L45" title="src/core/ngx_log.h:45">ngx_log_handler_pt</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; handler;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *pscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = s-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; pc = u-&gt;connected ? u-&gt;peer.connection : <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;type == SOCK_DGRAM &amp;&amp; (<a href="../os/win32/ngx_process_cycle.c.html#L38" title="src/os/win32/ngx_process_cycle.c:38">ngx_terminate</a> || <a href="../os/win32/ngx_process_cycle.c.html#L42" title="src/os/win32/ngx_process_cycle.c:42">ngx_exiting</a>)) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* socket is already closed on worker shutdown */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; handler = c-&gt;log-&gt;handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;handler = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;disconnected on shutdown&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;handler = handler;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (from_upstream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; src = pc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = c;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = &amp;u-&gt;upstream_buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit_rate = pscf-&gt;download_rate;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; received = &amp;u-&gt;received;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; src = c;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = pc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = &amp;u-&gt;downstream_buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit_rate = pscf-&gt;upload_rate;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; received = &amp;s-&gt;received;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (do_write) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;last - b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &amp;&amp; dst &amp;&amp; dst-&gt;write-&gt;ready) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = dst-&gt;send(dst, b-&gt;pos, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a> &amp;&amp; dst-&gt;shared) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* cannot wait on a shared socket */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;type == SOCK_DGRAM &amp;&amp; !from_upstream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1333" title="src/stream/ngx_stream_proxy_module.c:1333">ngx_stream_proxy_next_upstream</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos == b-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;end - b-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &amp;&amp; src-&gt;read-&gt;ready &amp;&amp; !src-&gt;read-&gt;delayed) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (limit_rate) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; limit = (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) limit_rate * (<a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() - u-&gt;start_sec + <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - *received;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (limit &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src-&gt;read-&gt;delayed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delay = (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) (- limit * <span class="Constant">1000</span> / limit_rate + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(src-&gt;read, delay);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) size &gt; limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = (<span class="Type">size_t</span>) limit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = src-&gt;recv(src, b-&gt;last, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a> || n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (limit_rate) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; delay = (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) (n * <span class="Constant">1000</span> / limit_rate);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (delay &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src-&gt;read-&gt;delayed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(src-&gt;read, delay);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;type == SOCK_DGRAM &amp;&amp; ++u-&gt;responses == pscf-&gt;responses)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src-&gt;read-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src-&gt;read-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *received += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do_write = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;type == SOCK_DGRAM &amp;&amp; u-&gt;received == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1333" title="src/stream/ngx_stream_proxy_module.c:1333">ngx_stream_proxy_next_upstream</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src-&gt;read-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (src-&gt;read-&gt;eof &amp;&amp; (b-&gt;pos == b-&gt;last || (dst &amp;&amp; dst-&gt;read-&gt;eof))) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; handler = c-&gt;log-&gt;handler;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;handler = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%s%s</span><span class="Constant"> disconnected&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;, bytes from/to client:</span><span class="Special">%O</span><span class="Constant">/</span><span class="Special">%O</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;, bytes from/to upstream:</span><span class="Special">%O</span><span class="Constant">/</span><span class="Special">%O</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src-&gt;type == SOCK_DGRAM ? <span class="Constant">&quot;udp &quot;</span> : <span class="Constant">&quot;&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from_upstream ? <span class="Constant">&quot;upstream&quot;</span> : <span class="Constant">&quot;client&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s-&gt;received, c-&gt;sent, u-&gt;received, pc ? pc-&gt;sent : <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;handler = handler;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; flags = src-&gt;read-&gt;eof ? <a href="../event/ngx_event.h.html#L292" title="src/event/ngx_event.h:292">NGX_CLOSE_EVENT</a> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!src-&gt;shared &amp;&amp; <a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(src-&gt;read, flags) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dst) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!dst-&gt;shared &amp;&amp; <a href="../event/ngx_event.c.html#L332" title="src/event/ngx_event.c:332">ngx_handle_write_event</a>(dst-&gt;write, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;read-&gt;delayed &amp;&amp; !pc-&gt;read-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(c-&gt;write, pscf-&gt;timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (c-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(c-&gt;write);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1333">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_next_upstream</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *pc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *pscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, s-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;stream proxy next upstream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.sockaddr) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.free(&amp;u-&gt;peer, u-&gt;peer.data, <a href="../event/ngx_event_connect.h.html#L19" title="src/event/ngx_event_connect.h:19">NGX_PEER_FAILED</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.sockaddr = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf = <a href="ngx_stream.h.html#L203" title="src/stream/ngx_stream.h:203">ngx_stream_get_module_srv_conf</a>(s, <a href="#L328" title="src/stream/ngx_stream_proxy_module.c:328">ngx_stream_proxy_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; timeout = pscf-&gt;next_upstream_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.tries == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || !pscf-&gt;next_upstream<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || (timeout &amp;&amp; <a href="../core/ngx_times.c.html#L26" title="src/core/ngx_times.c:26">ngx_current_msec</a> - u-&gt;peer.start_time &gt;= timeout))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1386" title="src/stream/ngx_stream_proxy_module.c:1386">ngx_stream_proxy_finalize</a>(s, <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pc = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pc) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, s-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;close proxy upstream connection: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, pc-&gt;fd);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pc-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;ssl-&gt;no_wait_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;ssl-&gt;no_send_shutdown = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../event/ngx_event_openssl.c.html#L1883" title="src/event/ngx_event_openssl.c:1883">ngx_ssl_shutdown</a>(pc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(pc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.connection = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L501" title="src/stream/ngx_stream_proxy_module.c:501">ngx_stream_proxy_connect</a>(s);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1386">&#x200c;</a></span><span class="linkable">ngx_stream_proxy_finalize</span>(<a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a> *s, <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> rc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *pc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, s-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;finalize stream proxy: </span><span class="Special">%i</span><span class="Constant">&quot;</span>, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> noupstream;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.free &amp;&amp; u-&gt;peer.sockaddr) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.free(&amp;u-&gt;peer, u-&gt;peer.data, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.sockaddr = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pc = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pc) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L32" title="src/core/ngx_log.h:32">NGX_LOG_DEBUG_STREAM</a>, s-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;close stream proxy upstream connection: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, pc-&gt;fd);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pc-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pc-&gt;ssl-&gt;no_wait_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../event/ngx_event_openssl.c.html#L1883" title="src/event/ngx_event_openssl.c:1883">ngx_ssl_shutdown</a>(pc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(pc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u-&gt;peer.connection = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">noupstream</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_handler.c.html#L297" title="src/stream/ngx_stream_handler.c:297">ngx_stream_close_connection</a>(s-&gt;connection);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1429">&#x200c;</a><span class="linkable">ngx_stream_proxy_log_error</span>(<a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *pc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L20" title="src/stream/ngx_stream.h:20">ngx_stream_session_t</a>&nbsp;&nbsp; *s;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_upstream.h.html#L93" title="src/stream/ngx_stream_upstream.h:93">ngx_stream_upstream_t</a>&nbsp; *u;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = log-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = s-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.name) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(p, len, <span class="Constant">&quot;, upstream: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, u-&gt;peer.name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pc = u-&gt;peer.connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(p, len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;, bytes from/to client:</span><span class="Special">%O</span><span class="Constant">/</span><span class="Special">%O</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;, bytes from/to upstream:</span><span class="Special">%O</span><span class="Constant">/</span><span class="Special">%O</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; s-&gt;received, s-&gt;connection-&gt;sent,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; u-&gt;received, pc ? pc-&gt;sent : <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L1460">&#x200c;</a><span class="linkable">ngx_stream_proxy_create_srv_conf</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * set by <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>():<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;ssl_protocols = 0;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;ssl_ciphers = { 0, NULL };<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;ssl_name = { 0, NULL };<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;ssl_trusted_certificate = { 0, NULL };<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;ssl_crl = { 0, NULL };<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;ssl_certificate = { 0, NULL };<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;ssl_certificate_key = { 0, NULL };<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;ssl = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;upstream = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; conf-&gt;connect_timeout = <a href="../core/ngx_conf_file.h.html#L60" title="src/core/ngx_conf_file.h:60">NGX_CONF_UNSET_MSEC</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;timeout = <a href="../core/ngx_conf_file.h.html#L60" title="src/core/ngx_conf_file.h:60">NGX_CONF_UNSET_MSEC</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;next_upstream_timeout = <a href="../core/ngx_conf_file.h.html#L60" title="src/core/ngx_conf_file.h:60">NGX_CONF_UNSET_MSEC</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;buffer_size = <a href="../core/ngx_conf_file.h.html#L59" title="src/core/ngx_conf_file.h:59">NGX_CONF_UNSET_SIZE</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;upload_rate = <a href="../core/ngx_conf_file.h.html#L59" title="src/core/ngx_conf_file.h:59">NGX_CONF_UNSET_SIZE</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;download_rate = <a href="../core/ngx_conf_file.h.html#L59" title="src/core/ngx_conf_file.h:59">NGX_CONF_UNSET_SIZE</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;responses = <a href="../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;next_upstream_tries = <a href="../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;next_upstream = <a href="../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;proxy_protocol = <a href="../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;local = <a href="../core/ngx_conf_file.h.html#L58" title="src/core/ngx_conf_file.h:58">NGX_CONF_UNSET_PTR</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span>&nbsp; &nbsp; conf-&gt;ssl_enable = <a href="../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;ssl_session_reuse = <a href="../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;ssl_server_name = <a href="../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;ssl_verify = <a href="../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;ssl_verify_depth = <a href="../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;ssl_passwords = <a href="../core/ngx_conf_file.h.html#L58" title="src/core/ngx_conf_file.h:58">NGX_CONF_UNSET_PTR</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> conf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1510">&#x200c;</a><span class="linkable">ngx_stream_proxy_merge_srv_conf</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent, <span class="Type">void</span> *child)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a> *prev = parent;<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a> *conf = child;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L220" title="src/core/ngx_conf_file.h:220">ngx_conf_merge_msec_value</a>(conf-&gt;connect_timeout,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;connect_timeout, <span class="Constant">60000</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L220" title="src/core/ngx_conf_file.h:220">ngx_conf_merge_msec_value</a>(conf-&gt;timeout,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;timeout, <span class="Constant">10</span> * <span class="Constant">60000</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L220" title="src/core/ngx_conf_file.h:220">ngx_conf_merge_msec_value</a>(conf-&gt;next_upstream_timeout,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;next_upstream_timeout, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L230" title="src/core/ngx_conf_file.h:230">ngx_conf_merge_size_value</a>(conf-&gt;buffer_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;buffer_size, <span class="Constant">16384</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L230" title="src/core/ngx_conf_file.h:230">ngx_conf_merge_size_value</a>(conf-&gt;upload_rate,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;upload_rate, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L230" title="src/core/ngx_conf_file.h:230">ngx_conf_merge_size_value</a>(conf-&gt;download_rate,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;download_rate, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L215" title="src/core/ngx_conf_file.h:215">ngx_conf_merge_uint_value</a>(conf-&gt;responses,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;responses, <a href="../core/ngx_config.h.html#L129" title="src/core/ngx_config.h:129">NGX_MAX_INT32_VALUE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L215" title="src/core/ngx_conf_file.h:215">ngx_conf_merge_uint_value</a>(conf-&gt;next_upstream_tries,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;next_upstream_tries, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;next_upstream, prev-&gt;next_upstream, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;proxy_protocol, prev-&gt;proxy_protocol, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L210" title="src/core/ngx_conf_file.h:210">ngx_conf_merge_ptr_value</a>(conf-&gt;local, prev-&gt;local, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;ssl_enable, prev-&gt;ssl_enable, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;ssl_session_reuse,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;ssl_session_reuse, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L262" title="src/core/ngx_conf_file.h:262">ngx_conf_merge_bitmask_value</a>(conf-&gt;ssl_protocols, prev-&gt;ssl_protocols,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../core/ngx_conf_file.h.html#L163" title="src/core/ngx_conf_file.h:163">NGX_CONF_BITMASK_SET</a>|<a href="../event/ngx_event_openssl.h.html#L130" title="src/event/ngx_event_openssl.h:130">NGX_SSL_TLSv1</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<a href="../event/ngx_event_openssl.h.html#L131" title="src/event/ngx_event_openssl.h:131">NGX_SSL_TLSv1_1</a>|<a href="../event/ngx_event_openssl.h.html#L132" title="src/event/ngx_event_openssl.h:132">NGX_SSL_TLSv1_2</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L240" title="src/core/ngx_conf_file.h:240">ngx_conf_merge_str_value</a>(conf-&gt;ssl_ciphers, prev-&gt;ssl_ciphers, <span class="Constant">&quot;DEFAULT&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L240" title="src/core/ngx_conf_file.h:240">ngx_conf_merge_str_value</a>(conf-&gt;ssl_name, prev-&gt;ssl_name, <span class="Constant">&quot;&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;ssl_server_name, prev-&gt;ssl_server_name, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;ssl_verify, prev-&gt;ssl_verify, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L215" title="src/core/ngx_conf_file.h:215">ngx_conf_merge_uint_value</a>(conf-&gt;ssl_verify_depth,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;ssl_verify_depth, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L240" title="src/core/ngx_conf_file.h:240">ngx_conf_merge_str_value</a>(conf-&gt;ssl_trusted_certificate,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;ssl_trusted_certificate, <span class="Constant">&quot;&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L240" title="src/core/ngx_conf_file.h:240">ngx_conf_merge_str_value</a>(conf-&gt;ssl_crl, prev-&gt;ssl_crl, <span class="Constant">&quot;&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L240" title="src/core/ngx_conf_file.h:240">ngx_conf_merge_str_value</a>(conf-&gt;ssl_certificate,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;ssl_certificate, <span class="Constant">&quot;&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L240" title="src/core/ngx_conf_file.h:240">ngx_conf_merge_str_value</a>(conf-&gt;ssl_certificate_key,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;ssl_certificate_key, <span class="Constant">&quot;&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_conf_file.h.html#L210" title="src/core/ngx_conf_file.h:210">ngx_conf_merge_ptr_value</a>(conf-&gt;ssl_passwords, prev-&gt;ssl_passwords, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;ssl_enable &amp;&amp; <a href="#L1593" title="src/stream/ngx_stream_proxy_module.c:1593">ngx_stream_proxy_set_ssl</a>(cf, conf) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STREAM_SSL)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1593">&#x200c;</a><span class="linkable">ngx_stream_proxy_set_ssl</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a> *pscf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.h.html#L32" title="src/core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; *cln;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf-&gt;ssl = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="../event/ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf-&gt;ssl-&gt;log = cf-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L210" title="src/event/ngx_event_openssl.c:210">ngx_ssl_create</a>(pscf-&gt;ssl, pscf-&gt;ssl_protocols, <span class="Constant">NULL</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="../core/ngx_palloc.c.html#L315" title="src/core/ngx_palloc.c:315">ngx_pool_cleanup_add</a>(cf-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="../event/ngx_event_openssl.c.html#L3060" title="src/event/ngx_event_openssl.c:3060">ngx_ssl_cleanup_ctx</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = pscf-&gt;ssl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_certificate.len) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_certificate_key.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no </span><span class="Special">\&quot;</span><span class="Constant">proxy_ssl_certificate_key</span><span class="Special">\&quot;</span><span class="Constant"> is defined &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;for certificate </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;pscf-&gt;ssl_certificate);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L348" title="src/event/ngx_event_openssl.c:348">ngx_ssl_certificate</a>(cf, pscf-&gt;ssl, &amp;pscf-&gt;ssl_certificate,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;pscf-&gt;ssl_certificate_key, pscf-&gt;ssl_passwords)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L595" title="src/event/ngx_event_openssl.c:595">ngx_ssl_ciphers</a>(cf, pscf-&gt;ssl, &amp;pscf-&gt;ssl_ciphers, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_verify) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;ssl_trusted_certificate.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no proxy_ssl_trusted_certificate for proxy_ssl_verify&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L674" title="src/event/ngx_event_openssl.c:674">ngx_ssl_trusted_certificate</a>(cf, pscf-&gt;ssl,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;pscf-&gt;ssl_trusted_certificate,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pscf-&gt;ssl_verify_depth)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L708" title="src/event/ngx_event_openssl.c:708">ngx_ssl_crl</a>(cf, pscf-&gt;ssl, &amp;pscf-&gt;ssl_crl) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1664">&#x200c;</a><span class="linkable">ngx_stream_proxy_pass</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a> *pscf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_inet.h.html#L104" title="src/core/ngx_inet.h:104">ngx_url_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value, *url;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream.h.html#L144" title="src/stream/ngx_stream.h:144">ngx_stream_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;upstream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="ngx_stream.h.html#L208" title="src/stream/ngx_stream.h:208">ngx_stream_conf_get_module_srv_conf</a>(cf, <a href="ngx_stream_core_module.c.html#L87" title="src/stream/ngx_stream_core_module.c:87">ngx_stream_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf-&gt;handler = <a href="#L345" title="src/stream/ngx_stream_proxy_module.c:345">ngx_stream_proxy_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; url = &amp;value[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;u, <span class="Statement">sizeof</span>(<a href="../core/ngx_inet.h.html#L104" title="src/core/ngx_inet.h:104">ngx_url_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u.url = *url;<br/></li>
<li>&nbsp; &nbsp; u.no_resolve = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf-&gt;upstream = <a href="ngx_stream_upstream.c.html#L314" title="src/stream/ngx_stream_upstream.c:314">ngx_stream_upstream_add</a>(cf, &amp;u, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;upstream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1699">&#x200c;</a><span class="linkable">ngx_stream_proxy_bind</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="src/stream/ngx_stream_proxy_module.c:55">ngx_stream_proxy_srv_conf_t</a> *pscf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_script.h.html#L59" title="src/stream/ngx_stream_script.h:59">ngx_stream_complex_value_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cv;<br/></li>
<li>&nbsp; &nbsp; <a href="#L19" title="src/stream/ngx_stream_proxy_module.c:19">ngx_stream_upstream_local_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *local;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_stream_script.h.html#L70" title="src/stream/ngx_stream_script.h:70">ngx_stream_compile_complex_value_t</a>&nbsp;&nbsp; ccv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pscf-&gt;local != <a href="../core/ngx_conf_file.h.html#L58" title="src/core/ngx_conf_file.h:58">NGX_CONF_UNSET_PTR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts == <span class="Constant">2</span> &amp;&amp; <a href="../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">1</span>].data, <span class="Constant">&quot;off&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pscf-&gt;local = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;ccv, <span class="Statement">sizeof</span>(<a href="ngx_stream_script.h.html#L70" title="src/stream/ngx_stream_script.h:70">ngx_stream_compile_complex_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ccv.cf = cf;<br/></li>
<li>&nbsp; &nbsp; ccv.value = &amp;value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; ccv.complex_value = &amp;cv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_stream_script.c.html#L109" title="src/stream/ngx_stream_script.c:109">ngx_stream_compile_complex_value</a>(&amp;ccv) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; local = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L19" title="src/stream/ngx_stream_proxy_module.c:19">ngx_stream_upstream_local_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (local == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pscf-&gt;local = local;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cv.lengths) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; local-&gt;value = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_stream_script.h.html#L59" title="src/stream/ngx_stream_script.h:59">ngx_stream_complex_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (local-&gt;value == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *local-&gt;value = cv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; local-&gt;addr = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_inet.h.html#L77" title="src/core/ngx_inet.h:77">ngx_addr_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (local-&gt;addr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_inet.c.html#L529" title="src/core/ngx_inet.c:529">ngx_parse_addr_port</a>(cf-&gt;pool, local-&gt;addr, value[<span class="Constant">1</span>].data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; value[<span class="Constant">1</span>].len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (rc) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local-&gt;addr-&gt;name = value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid address </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fall through */<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts &gt; <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">2</span>].data, <span class="Constant">&quot;transparent&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_TRANSPARENT_PROXY)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local-&gt;transparent = <span class="Constant">1</span>;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;transparent proxying is not supported &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;on this platform, ignored&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">2</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
