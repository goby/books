<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/os/win32/ngx_files.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

  <h1>src/os/win32/ngx_files.c - Nginx 1.11.2</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L464">ngx_close_dir</a></li>
<li><a href="#L397">ngx_close_file_mapping</a></li>
<li><a href="#L574">ngx_close_glob</a></li>
<li><a href="#L327">ngx_create_file_mapping</a></li>
<li><a href="#L592">ngx_de_info</a></li>
<li><a href="#L599">ngx_de_link_info</a></li>
<li><a href="#L620">ngx_directio_off</a></li>
<li><a href="#L613">ngx_directio_on</a></li>
<li><a href="#L261">ngx_file_info</a></li>
<li><a href="#L627">ngx_fs_bsize</a></li>
<li><a href="#L427">ngx_open_dir</a></li>
<li><a href="#L22">ngx_open_file</a></li>
<li><a href="#L475">ngx_open_glob</a></li>
<li><a href="#L606">ngx_read_ahead</a></li>
<li><a href="#L447">ngx_read_dir</a></li>
<li><a href="#L165">ngx_read_fd</a></li>
<li><a href="#L62">ngx_read_file</a></li>
<li><a href="#L522">ngx_read_glob</a></li>
<li><a href="#L419">ngx_realpath</a></li>
<li><a href="#L306">ngx_set_file_time</a></li>
<li><a href="#L790">ngx_utf8_to_utf16</a></li>
<li><a href="#L646">ngx_win32_check_filename</a></li>
<li><a href="#L206">ngx_win32_rename_file</a></li>
<li><a href="#L128">ngx_write_chain_to_file</a></li>
<li><a href="#L191">ngx_write_console</a></li>
<li><a href="#L178">ngx_write_fd</a></li>
<li><a href="#L95">ngx_write_file</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L12">NGX_UTF16_BUFLEN</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L12">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_UTF16_BUFLEN</span>&nbsp; </span><span class="Constant">256<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L646" title="src/os/win32/ngx_files.c:646">ngx_win32_check_filename</a>(u_char *name, u_short *u,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> len);<br/></li>
<li><span class="Type">static</span> u_short *<a href="#L790" title="src/os/win32/ngx_files.c:790">ngx_utf8_to_utf16</a>(u_short *utf16, u_char *utf8, <span class="Type">size_t</span> *len);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* FILE_FLAG_BACKUP_SEMANTICS allows to obtain a handle to a directory */<br/></li>
<li></span><br/></li>
<li><a href="ngx_files.h.html#L16" title="src/os/win32/ngx_files.h:16">ngx_fd_t</a><br/></li>
<li><a id="L22">&#x200c;</a><span class="linkable">ngx_open_file</span>(u_char *name, u_long mode, u_long create, u_long access)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_files.h.html#L16" title="src/os/win32/ngx_files.h:16">ngx_fd_t</a>&nbsp; &nbsp; fd;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp;&nbsp; err;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp;&nbsp; utf16[<a href="#L12" title="src/os/win32/ngx_files.c:12">NGX_UTF16_BUFLEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <a href="#L12" title="src/os/win32/ngx_files.c:12">NGX_UTF16_BUFLEN</a>;<br/></li>
<li>&nbsp; &nbsp; u = <a href="#L790" title="src/os/win32/ngx_files.c:790">ngx_utf8_to_utf16</a>(utf16, name, &amp;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> INVALID_HANDLE_VALUE;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fd = INVALID_HANDLE_VALUE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (create == <a href="ngx_files.h.html#L82" title="src/os/win32/ngx_files.h:82">NGX_FILE_OPEN</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="#L646" title="src/os/win32/ngx_files.c:646">ngx_win32_check_filename</a>(name, u, len) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fd = CreateFileW(u, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FILE_SHARE_READ|FILE_SHARE_WRITE|FILE_SHARE_DELETE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>, create, FILE_FLAG_BACKUP_SEMANTICS, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u != utf16) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(u);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_errno.h.html#L19" title="src/os/win32/ngx_errno.h:19">ngx_set_errno</a>(err);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> fd;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type"><a href="ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a><br/></li>
<li><a id="L62">&#x200c;</a></span><span class="linkable">ngx_read_file</span>(<a href="../../core/ngx_core.h.html#L23" title="src/core/ngx_core.h:23">ngx_file_t</a> *file, u_char *buf, <span class="Type">size_t</span> size, <span class="Type"><a href="ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_long&nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp;&nbsp; err;<br/></li>
<li>&nbsp; &nbsp; OVERLAPPED&nbsp; ovlp, *povlp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ovlp.Internal = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; ovlp.InternalHigh = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; ovlp.Offset = (u_long) offset;<br/></li>
<li>&nbsp; &nbsp; ovlp.OffsetHigh = (u_long) (offset &gt;&gt; <span class="Constant">32</span>);<br/></li>
<li>&nbsp; &nbsp; ovlp.hEvent = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; povlp = &amp;ovlp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ReadFile(file-&gt;fd, buf, size, &amp;n, povlp) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err == ERROR_HANDLE_EOF) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, file-&gt;log, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;ReadFile() </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, file-&gt;name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;offset += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type"><a href="ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a><br/></li>
<li><a id="L95">&#x200c;</a></span><span class="linkable">ngx_write_file</span>(<a href="../../core/ngx_core.h.html#L23" title="src/core/ngx_core.h:23">ngx_file_t</a> *file, u_char *buf, <span class="Type">size_t</span> size, <span class="Type"><a href="ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_long&nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; OVERLAPPED&nbsp; ovlp, *povlp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ovlp.Internal = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; ovlp.InternalHigh = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; ovlp.Offset = (u_long) offset;<br/></li>
<li>&nbsp; &nbsp; ovlp.OffsetHigh = (u_long) (offset &gt;&gt; <span class="Constant">32</span>);<br/></li>
<li>&nbsp; &nbsp; ovlp.hEvent = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; povlp = &amp;ovlp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (WriteFile(file-&gt;fd, buf, size, &amp;n, povlp) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, file-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;WriteFile() </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, file-&gt;name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, file-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;WriteFile() </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> has written only </span><span class="Special">%u</span><span class="Constant">l of </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-&gt;name.data, n, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file-&gt;offset += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type"><a href="ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a><br/></li>
<li><a id="L128">&#x200c;</a></span><span class="linkable">ngx_write_chain_to_file</span>(<a href="../../core/ngx_core.h.html#L23" title="src/core/ngx_core.h:23">ngx_file_t</a> *file, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *cl, <span class="Type"><a href="ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span> offset,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp;&nbsp; *buf, *prev;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp;&nbsp; total, n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; total = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (cl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = cl-&gt;buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prev = buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* coalesce the neighbouring bufs */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (cl &amp;&amp; prev == cl-&gt;buf-&gt;pos) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size += cl-&gt;buf-&gt;last - cl-&gt;buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev = cl-&gt;buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = cl-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L95" title="src/os/win32/ngx_files.c:95">ngx_write_file</a>(file, buf, size, offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; total += n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset += n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> total;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type"><a href="ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a><br/></li>
<li><a id="L165">&#x200c;</a></span><span class="linkable">ngx_read_fd</span>(<a href="ngx_files.h.html#L16" title="src/os/win32/ngx_files.h:16">ngx_fd_t</a> fd, <span class="Type">void</span> *buf, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_long&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ReadFile(fd, buf, size, &amp;n, <span class="Constant">NULL</span>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Type">size_t</span>) n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type"><a href="ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a><br/></li>
<li><a id="L178">&#x200c;</a></span><span class="linkable">ngx_write_fd</span>(<a href="ngx_files.h.html#L16" title="src/os/win32/ngx_files.h:16">ngx_fd_t</a> fd, <span class="Type">void</span> *buf, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_long&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (WriteFile(fd, buf, size, &amp;n, <span class="Constant">NULL</span>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Type">size_t</span>) n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type"><a href="ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a><br/></li>
<li><a id="L191">&#x200c;</a></span><span class="linkable">ngx_write_console</span>(<a href="ngx_files.h.html#L16" title="src/os/win32/ngx_files.h:16">ngx_fd_t</a> fd, <span class="Type">void</span> *buf, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_long&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) CharToOemBuff(buf, buf, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (WriteFile(fd, buf, size, &amp;n, <span class="Constant">NULL</span>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<span class="Type">size_t</span>) n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a><br/></li>
<li><a id="L206">&#x200c;</a><span class="linkable">ngx_win32_rename_file</span>(<a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *from, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *to, <a href="../../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *name;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collision;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_atomic.h.html#L19" title="src/os/win32/ngx_atomic.h:19">ngx_atomic_uint_t</a>&nbsp;&nbsp; num;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name = <a href="ngx_alloc.c.html#L17" title="src/os/win32/ngx_alloc.c:17">ngx_alloc</a>(to-&gt;len + <span class="Constant">1</span> + <a href="ngx_atomic.h.html#L21" title="src/os/win32/ngx_atomic.h:21">NGX_ATOMIC_T_LEN</a> + <span class="Constant">1</span> + <span class="Statement">sizeof</span>(<span class="Constant">&quot;DELETE&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_errno.h.html#L26" title="src/os/win32/ngx_errno.h:26">NGX_ENOMEM</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(name, to-&gt;data, to-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; collision = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* mutex_lock() (per cache or single ?) */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; num = <a href="../../core/ngx_file.c.html#L326" title="src/core/ngx_file.c:326">ngx_next_temp_number</a>(collision);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(name + to-&gt;len, <span class="Constant">&quot;.%0muA.DELETE%Z&quot;</span>, num);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (MoveFile((<span class="Type">const</span> <span class="Type">char</span> *) to-&gt;data, (<span class="Type">const</span> <span class="Type">char</span> *) name) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; collision = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;MoveFile() </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> to </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, to-&gt;data, name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (MoveFile((<span class="Type">const</span> <span class="Type">char</span> *) from-&gt;data, (<span class="Type">const</span> <span class="Type">char</span> *) to-&gt;data) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (DeleteFile((<span class="Type">const</span> <span class="Type">char</span> *) name) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;DeleteFile() </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* mutex_unlock() */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> err;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L261">&#x200c;</a><span class="linkable">ngx_file_info</span>(u_char *file, <a href="ngx_files.h.html#L17" title="src/os/win32/ngx_files.h:17">ngx_file_info_t</a> *sb)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">long</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; err;<br/></li>
<li>&nbsp; &nbsp; WIN32_FILE_ATTRIBUTE_DATA&nbsp;&nbsp; fa;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; utf16[<a href="#L12" title="src/os/win32/ngx_files.c:12">NGX_UTF16_BUFLEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <a href="#L12" title="src/os/win32/ngx_files.c:12">NGX_UTF16_BUFLEN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = <a href="#L790" title="src/os/win32/ngx_files.c:790">ngx_utf8_to_utf16</a>(utf16, file, &amp;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L646" title="src/os/win32/ngx_files.c:646">ngx_win32_check_filename</a>(file, u, len) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = GetFileAttributesExW(u, GetFileExInfoStandard, &amp;fa);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sb-&gt;dwFileAttributes = fa.dwFileAttributes;<br/></li>
<li>&nbsp; &nbsp; sb-&gt;ftCreationTime = fa.ftCreationTime;<br/></li>
<li>&nbsp; &nbsp; sb-&gt;ftLastAccessTime = fa.ftLastAccessTime;<br/></li>
<li>&nbsp; &nbsp; sb-&gt;ftLastWriteTime = fa.ftLastWriteTime;<br/></li>
<li>&nbsp; &nbsp; sb-&gt;nFileSizeHigh = fa.nFileSizeHigh;<br/></li>
<li>&nbsp; &nbsp; sb-&gt;nFileSizeLow = fa.nFileSizeLow;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u != utf16) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(u);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_errno.h.html#L19" title="src/os/win32/ngx_errno.h:19">ngx_set_errno</a>(err);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L306">&#x200c;</a><span class="linkable">ngx_set_file_time</span>(u_char *name, <a href="ngx_files.h.html#L16" title="src/os/win32/ngx_files.h:16">ngx_fd_t</a> fd, <span class="Type"><a href="ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span> s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="ngx_win32_config.h.html#L152" title="src/os/win32/ngx_win32_config.h:152">uint64_t</a></span>&nbsp; intervals;<br/></li>
<li>&nbsp; &nbsp; FILETIME&nbsp; ft;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* 116444736000000000 is commented in src/os/win32/<a href="../../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>.c */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; intervals = s * <span class="Constant">10000000</span> + <span class="Constant">116444736000000000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ft.dwLowDateTime = (DWORD) intervals;<br/></li>
<li>&nbsp; &nbsp; ft.dwHighDateTime = (DWORD) (intervals &gt;&gt; <span class="Constant">32</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SetFileTime(fd, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, &amp;ft) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L327">&#x200c;</a><span class="linkable">ngx_create_file_mapping</span>(<a href="ngx_files.h.html#L28" title="src/os/win32/ngx_files.h:28">ngx_file_mapping_t</a> *fm)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; LARGE_INTEGER&nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fm-&gt;fd = <a href="#L22" title="src/os/win32/ngx_files.c:22">ngx_open_file</a>(fm-&gt;name, <a href="ngx_files.h.html#L77" title="src/os/win32/ngx_files.h:77">NGX_FILE_RDWR</a>, <a href="ngx_files.h.html#L83" title="src/os/win32/ngx_files.h:83">NGX_FILE_TRUNCATE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_files.h.html#L85" title="src/os/win32/ngx_files.h:85">NGX_FILE_DEFAULT_ACCESS</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fm-&gt;fd == <a href="ngx_files.h.html#L68" title="src/os/win32/ngx_files.h:68">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_files.h.html#L73" title="src/os/win32/ngx_files.h:73">ngx_open_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, fm-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fm-&gt;handle = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size.QuadPart = fm-&gt;size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SetFilePointerEx(fm-&gt;fd, size, <span class="Constant">NULL</span>, FILE_BEGIN) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SetFilePointerEx(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">, </span><span class="Special">%u</span><span class="Constant">z) failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fm-&gt;name, fm-&gt;size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SetEndOfFile(fm-&gt;fd) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SetEndOfFile() </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, fm-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fm-&gt;handle = CreateFileMapping(fm-&gt;fd, <span class="Constant">NULL</span>, PAGE_READWRITE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (u_long) ((<span class="Type"><a href="ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) fm-&gt;size &gt;&gt; <span class="Constant">32</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (u_long) ((<span class="Type"><a href="ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) fm-&gt;size &amp; <span class="Constant">0xffffffff</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fm-&gt;handle == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;CreateFileMapping(</span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%u</span><span class="Constant">z) failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fm-&gt;name, fm-&gt;size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fm-&gt;addr = MapViewOfFile(fm-&gt;handle, FILE_MAP_WRITE, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fm-&gt;addr != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;MapViewOfFile(</span><span class="Special">%u</span><span class="Constant">z) of file mapping </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fm-&gt;size, fm-&gt;name);<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fm-&gt;handle) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (CloseHandle(fm-&gt;handle) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;CloseHandle() of file mapping </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fm-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_files.h.html#L102" title="src/os/win32/ngx_files.h:102">ngx_close_file</a>(fm-&gt;fd) == <a href="ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_files.h.html#L103" title="src/os/win32/ngx_files.h:103">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, fm-&gt;name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L397">&#x200c;</a></span><span class="linkable">ngx_close_file_mapping</span>(<a href="ngx_files.h.html#L28" title="src/os/win32/ngx_files.h:28">ngx_file_mapping_t</a> *fm)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (UnmapViewOfFile(fm-&gt;addr) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;UnmapViewOfFile(</span><span class="Special">%p</span><span class="Constant">) of file mapping </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fm-&gt;addr, &amp;fm-&gt;name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (CloseHandle(fm-&gt;handle) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;CloseHandle() of file mapping </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;fm-&gt;name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_files.h.html#L102" title="src/os/win32/ngx_files.h:102">ngx_close_file</a>(fm-&gt;fd) == <a href="ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, fm-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_files.h.html#L103" title="src/os/win32/ngx_files.h:103">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, fm-&gt;name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li>u_char *<br/></li>
<li><a id="L419">&#x200c;</a><span class="linkable">ngx_realpath</span>(u_char *path, u_char *resolved)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* STUB */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> path;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L427">&#x200c;</a><span class="linkable">ngx_open_dir</span>(<a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name, <a href="ngx_files.h.html#L38" title="src/os/win32/ngx_files.h:38">ngx_dir_t</a> *dir)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L33" title="src/core/ngx_string.c:33">ngx_cpystrn</a>(name-&gt;data + name-&gt;len, <a href="ngx_files.h.html#L184" title="src/os/win32/ngx_files.h:184">NGX_DIR_MASK</a>, <a href="ngx_files.h.html#L185" title="src/os/win32/ngx_files.h:185">NGX_DIR_MASK_LEN</a> + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dir-&gt;dir = FindFirstFile((<span class="Type">const</span> <span class="Type">char</span> *) name-&gt;data, &amp;dir-&gt;finddata);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name-&gt;data[name-&gt;len] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dir-&gt;dir == INVALID_HANDLE_VALUE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dir-&gt;valid_info = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; dir-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L447">&#x200c;</a><span class="linkable">ngx_read_dir</span>(<a href="ngx_files.h.html#L38" title="src/os/win32/ngx_files.h:38">ngx_dir_t</a> *dir)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dir-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (FindNextFile(dir-&gt;dir, &amp;dir-&gt;finddata) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dir-&gt;type = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L464">&#x200c;</a><span class="linkable">ngx_close_dir</span>(<a href="ngx_files.h.html#L38" title="src/os/win32/ngx_files.h:38">ngx_dir_t</a> *dir)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (FindClose(dir-&gt;dir) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L475">&#x200c;</a><span class="linkable">ngx_open_glob</span>(<a href="ngx_files.h.html#L53" title="src/os/win32/ngx_files.h:53">ngx_glob_t</a> *gl)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp;&nbsp; err;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gl-&gt;dir = FindFirstFile((<span class="Type">const</span> <span class="Type">char</span> *) gl-&gt;pattern, &amp;gl-&gt;finddata);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gl-&gt;dir == INVALID_HANDLE_VALUE) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((err == ERROR_FILE_NOT_FOUND || err == ERROR_PATH_NOT_FOUND)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; gl-&gt;test)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gl-&gt;no_match = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = gl-&gt;pattern; *p; p++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">'/'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gl-&gt;last = p + <span class="Constant">1</span> - gl-&gt;pattern;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <a href="../../core/ngx_string.h.html#L61" title="src/core/ngx_string.h:61">ngx_strlen</a>(gl-&gt;finddata.cFileName);<br/></li>
<li>&nbsp; &nbsp; gl-&gt;name.len = gl-&gt;last + len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gl-&gt;name.data = <a href="ngx_alloc.c.html#L17" title="src/os/win32/ngx_alloc.c:17">ngx_alloc</a>(gl-&gt;name.len + <span class="Constant">1</span>, gl-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gl-&gt;name.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(gl-&gt;name.data, gl-&gt;pattern, gl-&gt;last);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L33" title="src/core/ngx_string.c:33">ngx_cpystrn</a>(gl-&gt;name.data + gl-&gt;last, (u_char *) gl-&gt;finddata.cFileName,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gl-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L522">&#x200c;</a><span class="linkable">ngx_read_glob</span>(<a href="ngx_files.h.html#L53" title="src/os/win32/ngx_files.h:53">ngx_glob_t</a> *gl, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp; err;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gl-&gt;no_match) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L40" title="src/core/ngx_core.h:40">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gl-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *name = gl-&gt;name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gl-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(gl-&gt;name.data);<br/></li>
<li>&nbsp; &nbsp; gl-&gt;name.data = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (FindNextFile(gl-&gt;dir, &amp;gl-&gt;finddata) != <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="../../core/ngx_string.h.html#L61" title="src/core/ngx_string.h:61">ngx_strlen</a>(gl-&gt;finddata.cFileName);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gl-&gt;name.len = gl-&gt;last + len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gl-&gt;name.data = <a href="ngx_alloc.c.html#L17" title="src/os/win32/ngx_alloc.c:17">ngx_alloc</a>(gl-&gt;name.len + <span class="Constant">1</span>, gl-&gt;log);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (gl-&gt;name.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(gl-&gt;name.data, gl-&gt;pattern, gl-&gt;last);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L33" title="src/core/ngx_string.c:33">ngx_cpystrn</a>(gl-&gt;name.data + gl-&gt;last, (u_char *) gl-&gt;finddata.cFileName,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *name = gl-&gt;name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err = <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (err == <a href="ngx_errno.h.html#L56" title="src/os/win32/ngx_errno.h:56">NGX_ENOMOREFILES</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L40" title="src/core/ngx_core.h:40">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, gl-&gt;log, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;FindNextFile(</span><span class="Special">%s</span><span class="Constant">) failed&quot;</span>, gl-&gt;pattern);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L574">&#x200c;</a></span><span class="linkable">ngx_close_glob</span>(<a href="ngx_files.h.html#L53" title="src/os/win32/ngx_files.h:53">ngx_glob_t</a> *gl)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gl-&gt;name.data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(gl-&gt;name.data);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (gl-&gt;dir == INVALID_HANDLE_VALUE) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (FindClose(gl-&gt;dir) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, gl-&gt;log, <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;FindClose(</span><span class="Special">%s</span><span class="Constant">) failed&quot;</span>, gl-&gt;pattern);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L592">&#x200c;</a><span class="linkable">ngx_de_info</span>(u_char *name, <a href="ngx_files.h.html#L38" title="src/os/win32/ngx_files.h:38">ngx_dir_t</a> *dir)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L599">&#x200c;</a><span class="linkable">ngx_de_link_info</span>(u_char *name, <a href="ngx_files.h.html#L38" title="src/os/win32/ngx_files.h:38">ngx_dir_t</a> *dir)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L606">&#x200c;</a><span class="linkable">ngx_read_ahead</span>(<a href="ngx_files.h.html#L16" title="src/os/win32/ngx_files.h:16">ngx_fd_t</a> fd, <span class="Type">size_t</span> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ~<a href="ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L613">&#x200c;</a><span class="linkable">ngx_directio_on</span>(<a href="ngx_files.h.html#L16" title="src/os/win32/ngx_files.h:16">ngx_fd_t</a> fd)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ~<a href="ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L620">&#x200c;</a><span class="linkable">ngx_directio_off</span>(<a href="ngx_files.h.html#L16" title="src/os/win32/ngx_files.h:16">ngx_fd_t</a> fd)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ~<a href="ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">size_t<br/></li>
<li><a id="L627">&#x200c;</a></span><span class="linkable">ngx_fs_bsize</span>(u_char *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; root[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; u_long&nbsp; sc, bs, nfree, ncl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name[<span class="Constant">2</span>] == <span class="Constant">':'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L33" title="src/core/ngx_string.c:33">ngx_cpystrn</a>(root, name, <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name = root;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (GetDiskFreeSpace((<span class="Type">const</span> <span class="Type">char</span> *) name, &amp;sc, &amp;bs, &amp;nfree, &amp;ncl) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">512</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> sc * bs;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L646">&#x200c;</a><span class="linkable">ngx_win32_check_filename</span>(u_char *name, u_short *u, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *p, ch;<br/></li>
<li>&nbsp; &nbsp; u_long&nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp; &nbsp; *lu;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp;&nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">enum</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_start = <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_normal,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_after_slash,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_after_colon,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_after_dot<br/></li>
<li>&nbsp; &nbsp; } state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* check for NTFS streams (&quot;:&quot;), trailing dots and spaces */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; lu = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; state = sw_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = name; *p; p++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ch = *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (state) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_start:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * skip till first &quot;/&quot; to allow paths starting with drive and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * relative path, like &quot;c:html/&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'/'</span> || ch == <span class="Special">'\\'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_after_slash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_normal:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">':'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_after_colon;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'.'</span> || ch == <span class="Constant">' '</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_after_dot;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'/'</span> || ch == <span class="Special">'\\'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_after_slash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_after_slash:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'/'</span> || ch == <span class="Special">'\\'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">':'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_after_colon;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_normal;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_after_colon:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'/'</span> || ch == <span class="Special">'\\'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_after_slash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_after_dot:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'/'</span> || ch == <span class="Special">'\\'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">':'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'.'</span> || ch == <span class="Constant">' '</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_normal;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (state == sw_after_dot) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* check if long name match */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; lu = malloc(len * <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lu == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = GetLongPathNameW(u, lu, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != len - <span class="Constant">1</span> || _wcsicmp(u, lu) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(lu);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">invalid</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_errno.h.html#L19" title="src/os/win32/ngx_errno.h:19">ngx_set_errno</a>(<a href="ngx_errno.h.html#L24" title="src/os/win32/ngx_errno.h:24">NGX_ENOENT</a>);<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lu) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(lu);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_errno.h.html#L19" title="src/os/win32/ngx_errno.h:19">ngx_set_errno</a>(err);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_short *<br/></li>
<li><a id="L790">&#x200c;</a><span class="linkable">ngx_utf8_to_utf16</span>(u_short *utf16, u_char *utf8, <span class="Type">size_t</span> *len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; u_short&nbsp;&nbsp; *u, *last;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp;&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = utf8;<br/></li>
<li>&nbsp; &nbsp; u = utf16;<br/></li>
<li>&nbsp; &nbsp; last = utf16 + *len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (u &lt; last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p &lt; <span class="Constant">0x80</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *u++ = (u_short) *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *len = u - utf16;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> utf16;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u + <span class="Constant">1</span> == last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *len = u - utf16;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../../core/ngx_string.c.html#L1295" title="src/core/ngx_string.c:1295">ngx_utf8_decode</a>(&amp;p, <span class="Constant">4</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0x10ffff</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_errno.h.html#L19" title="src/os/win32/ngx_errno.h:19">ngx_set_errno</a>(<a href="ngx_errno.h.html#L57" title="src/os/win32/ngx_errno.h:57">NGX_EILSEQ</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0xffff</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n -= <span class="Constant">0x10000</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *u++ = (u_short) (<span class="Constant">0xd800</span> + (n &gt;&gt; <span class="Constant">10</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *u++ = (u_short) (<span class="Constant">0xdc00</span> + (n &amp; <span class="Constant">0x03ff</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *u++ = (u_short) n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the given buffer is not enough, allocate a new one */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; u = malloc(((p - utf8) + <a href="../../core/ngx_string.h.html#L61" title="src/core/ngx_string.h:61">ngx_strlen</a>(p) + <span class="Constant">1</span>) * <span class="Statement">sizeof</span>(u_short));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(u, utf16, *len * <span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; utf16 = u;<br/></li>
<li>&nbsp; &nbsp; u += *len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p &lt; <span class="Constant">0x80</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *u++ = (u_short) *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *len = u - utf16;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> utf16;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../../core/ngx_string.c.html#L1295" title="src/core/ngx_string.c:1295">ngx_utf8_decode</a>(&amp;p, <span class="Constant">4</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0x10ffff</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(utf16);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_errno.h.html#L19" title="src/os/win32/ngx_errno.h:19">ngx_set_errno</a>(<a href="ngx_errno.h.html#L57" title="src/os/win32/ngx_errno.h:57">NGX_EILSEQ</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0xffff</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n -= <span class="Constant">0x10000</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *u++ = (u_short) (<span class="Constant">0xd800</span> + (n &gt;&gt; <span class="Constant">10</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *u++ = (u_short) (<span class="Constant">0xdc00</span> + (n &amp; <span class="Constant">0x03ff</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *u++ = (u_short) n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* unreachable */<br/></li>
<li></span>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
