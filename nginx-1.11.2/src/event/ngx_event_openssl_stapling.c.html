<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/event/ngx_event_openssl_stapling.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>src/event/ngx_event_openssl_stapling.c - Nginx 1.11.2</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L44">ngx_ssl_ocsp_ctx_s</a></li>
<li><a href="#L42">ngx_ssl_ocsp_ctx_t</a></li>
<li><a href="#L39">ngx_ssl_stapling_t</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L481">ngx_ssl_certificate_status_callback</a></li>
<li><a href="#L1003">ngx_ssl_ocsp_connect</a></li>
<li><a href="#L1185">ngx_ssl_ocsp_create_request</a></li>
<li><a href="#L843">ngx_ssl_ocsp_done</a></li>
<li><a href="#L1177">ngx_ssl_ocsp_dummy_handler</a></li>
<li><a href="#L857">ngx_ssl_ocsp_error</a></li>
<li><a href="#L1811">ngx_ssl_ocsp_log_error</a></li>
<li><a href="#L1609">ngx_ssl_ocsp_parse_header_line</a></li>
<li><a href="#L1335">ngx_ssl_ocsp_parse_status_line</a></li>
<li><a href="#L1796">ngx_ssl_ocsp_process_body</a></li>
<li><a href="#L1536">ngx_ssl_ocsp_process_headers</a></li>
<li><a href="#L1303">ngx_ssl_ocsp_process_status_line</a></li>
<li><a href="#L1101">ngx_ssl_ocsp_read_handler</a></li>
<li><a href="#L868">ngx_ssl_ocsp_request</a></li>
<li><a href="#L917">ngx_ssl_ocsp_resolve_handler</a></li>
<li><a href="#L804">ngx_ssl_ocsp_start</a></li>
<li><a href="#L1048">ngx_ssl_ocsp_write_handler</a></li>
<li><a href="#L124">ngx_ssl_stapling</a></li>
<li><a href="#L1837">ngx_ssl_stapling</a></li>
<li><a href="#L147">ngx_ssl_stapling_certificate</a></li>
<li><a href="#L789">ngx_ssl_stapling_cleanup</a></li>
<li><a href="#L212">ngx_ssl_stapling_file</a></li>
<li><a href="#L279">ngx_ssl_stapling_issuer</a></li>
<li><a href="#L567">ngx_ssl_stapling_ocsp_handler</a></li>
<li><a href="#L461">ngx_ssl_stapling_resolver</a></li>
<li><a href="#L1847">ngx_ssl_stapling_resolver</a></li>
<li><a href="#L374">ngx_ssl_stapling_responder</a></li>
<li><a href="#L755">ngx_ssl_stapling_time</a></li>
<li><a href="#L528">ngx_ssl_stapling_update</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Maxim Dounin<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_event.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_event_connect.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (!defined OPENSSL_NO_OCSP &amp;&amp; defined SSL_CTRL_SET_TLSEXT_STATUS_REQ_CB)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; staple;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *resolver;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; resolver_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_inet.h.html#L77" title="src/core/ngx_inet.h:77">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *addrs;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uri;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_win32_config.h.html#L193" title="src/os/win32/ngx_win32_config.h:193">in_port_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ssl_ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *issuer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; valid;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; refresh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; verify:<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; loading:<span class="Constant">1</span>;<br/></li>
<li><a id="L39">&#x200c;</a>} <span class="linkable">ngx_ssl_stapling_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L42">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <a href="#L44" title="src/event/ngx_event_openssl_stapling.c:44">ngx_ssl_ocsp_ctx_s</a>&nbsp; <span class="linkable">ngx_ssl_ocsp_ctx_t</span>;<br/></li>
<li><br/></li>
<li><a id="L44">&#x200c;</a><span class="Type">struct</span> <span class="linkable">ngx_ssl_ocsp_ctx_s</span> {<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *issuer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; naddrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_inet.h.html#L77" title="src/core/ngx_inet.h:77">ngx_addr_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *addrs;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uri;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_win32_config.h.html#L193" title="src/os/win32/ngx_win32_config.h:193">in_port_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *resolver;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; resolver_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (*handler)(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *r);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *request;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *response;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event_connect.h.html#L22" title="src/event/ngx_event_connect.h:22">ngx_peer_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; peer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (*process)(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; code;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; count;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; done;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *header_name_start;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *header_name_end;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *header_start;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *header_end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *pool;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *log;<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L147" title="src/event/ngx_event_openssl_stapling.c:147">ngx_ssl_stapling_certificate</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; X509 *cert, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *file, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *responder, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> verify);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L212" title="src/event/ngx_event_openssl_stapling.c:212">ngx_ssl_stapling_file</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a> *staple, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *file);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L279" title="src/event/ngx_event_openssl_stapling.c:279">ngx_ssl_stapling_issuer</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a> *staple);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L374" title="src/event/ngx_event_openssl_stapling.c:374">ngx_ssl_stapling_responder</a>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a> *staple, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *responder);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int</span> <a href="#L481" title="src/event/ngx_event_openssl_stapling.c:481">ngx_ssl_certificate_status_callback</a>(<a href="ngx_event_openssl.h.html#L54" title="src/event/ngx_event_openssl.h:54">ngx_ssl_conn_t</a> *ssl_conn,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L528" title="src/event/ngx_event_openssl_stapling.c:528">ngx_ssl_stapling_update</a>(<a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a> *staple);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L567" title="src/event/ngx_event_openssl_stapling.c:567">ngx_ssl_stapling_ocsp_handler</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span> <a href="#L755" title="src/event/ngx_event_openssl_stapling.c:755">ngx_ssl_stapling_time</a>(ASN1_GENERALIZEDTIME *asn1time);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L789" title="src/event/ngx_event_openssl_stapling.c:789">ngx_ssl_stapling_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *<a href="#L804" title="src/event/ngx_event_openssl_stapling.c:804">ngx_ssl_ocsp_start</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L843" title="src/event/ngx_event_openssl_stapling.c:843">ngx_ssl_ocsp_done</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L868" title="src/event/ngx_event_openssl_stapling.c:868">ngx_ssl_ocsp_request</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L917" title="src/event/ngx_event_openssl_stapling.c:917">ngx_ssl_ocsp_resolve_handler</a>(<a href="../core/ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *resolve);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1003" title="src/event/ngx_event_openssl_stapling.c:1003">ngx_ssl_ocsp_connect</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1048" title="src/event/ngx_event_openssl_stapling.c:1048">ngx_ssl_ocsp_write_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *wev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1101" title="src/event/ngx_event_openssl_stapling.c:1101">ngx_ssl_ocsp_read_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1177" title="src/event/ngx_event_openssl_stapling.c:1177">ngx_ssl_ocsp_dummy_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1185" title="src/event/ngx_event_openssl_stapling.c:1185">ngx_ssl_ocsp_create_request</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1303" title="src/event/ngx_event_openssl_stapling.c:1303">ngx_ssl_ocsp_process_status_line</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1335" title="src/event/ngx_event_openssl_stapling.c:1335">ngx_ssl_ocsp_parse_status_line</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1536" title="src/event/ngx_event_openssl_stapling.c:1536">ngx_ssl_ocsp_process_headers</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1609" title="src/event/ngx_event_openssl_stapling.c:1609">ngx_ssl_ocsp_parse_header_line</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1796" title="src/event/ngx_event_openssl_stapling.c:1796">ngx_ssl_ocsp_process_body</a>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1811" title="src/event/ngx_event_openssl_stapling.c:1811">ngx_ssl_ocsp_log_error</a>(<a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L124">&#x200c;</a><span class="linkable">ngx_ssl_stapling</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *file,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *responder, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> verify)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; *cert;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cert = SSL_CTX_get_ex_data(ssl-&gt;ctx, <a href="ngx_event_openssl.c.html#L107" title="src/event/ngx_event_openssl.c:107">ngx_ssl_certificate_index</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cert;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cert = X509_get_ex_data(cert, <a href="ngx_event_openssl.c.html#L108" title="src/event/ngx_event_openssl.c:108">ngx_ssl_next_certificate_index</a>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L147" title="src/event/ngx_event_openssl_stapling.c:147">ngx_ssl_stapling_certificate</a>(cf, ssl, cert, file, responder, verify)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SSL_CTX_set_tlsext_status_cb(ssl-&gt;ctx, <a href="#L481" title="src/event/ngx_event_openssl_stapling.c:481">ngx_ssl_certificate_status_callback</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L147">&#x200c;</a><span class="linkable">ngx_ssl_stapling_certificate</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl, X509 *cert,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *file, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *responder, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> verify)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.h.html#L32" title="src/core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a>&nbsp; *staple;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; staple = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (staple == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="../core/ngx_palloc.c.html#L315" title="src/core/ngx_palloc.c:315">ngx_pool_cleanup_add</a>(cf-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L789" title="src/event/ngx_event_openssl_stapling.c:789">ngx_ssl_stapling_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = staple;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (X509_set_ex_data(cert, <a href="ngx_event_openssl.c.html#L109" title="src/event/ngx_event_openssl.c:109">ngx_ssl_stapling_index</a>, staple) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;X509_set_ex_data() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; staple-&gt;ssl_ctx = ssl-&gt;ctx;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;timeout = <span class="Constant">60000</span>;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;verify = verify;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;cert = cert;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file-&gt;len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* use OCSP response from the file */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L212" title="src/event/ngx_event_openssl_stapling.c:212">ngx_ssl_stapling_file</a>(cf, ssl, staple, file) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L279" title="src/event/ngx_event_openssl_stapling.c:279">ngx_ssl_stapling_issuer</a>(cf, ssl, staple);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L374" title="src/event/ngx_event_openssl_stapling.c:374">ngx_ssl_stapling_responder</a>(cf, ssl, staple, responder);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L212">&#x200c;</a><span class="linkable">ngx_ssl_stapling_file</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a> *staple, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *file)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; BIO&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *bio;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *buf;<br/></li>
<li>&nbsp; &nbsp; OCSP_RESPONSE&nbsp; *response;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L845" title="src/core/ngx_conf_file.c:845">ngx_conf_full_name</a>(cf-&gt;cycle, file, <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; bio = BIO_new_file((<span class="Type">char</span> *) file-&gt;data, <span class="Constant">&quot;r&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (bio == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;BIO_new_file(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; response = d2i_OCSP_RESPONSE_bio(bio, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (response == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;d2i_OCSP_RESPONSE_bio(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; BIO_free(bio);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = i2d_OCSP_RESPONSE(response, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;i2d_OCSP_RESPONSE(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = <a href="../os/win32/ngx_alloc.c.html#L17" title="src/os/win32/ngx_alloc.c:17">ngx_alloc</a>(len, ssl-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = buf;<br/></li>
<li>&nbsp; &nbsp; len = i2d_OCSP_RESPONSE(response, &amp;p);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;i2d_OCSP_RESPONSE(</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">) failed&quot;</span>, file-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(buf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; OCSP_RESPONSE_free(response);<br/></li>
<li>&nbsp; &nbsp; BIO_free(bio);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; staple-&gt;staple.data = buf;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;staple.len = len;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;valid = <a href="../os/win32/ngx_win32_config.h.html#L204" title="src/os/win32/ngx_win32_config.h:204">NGX_MAX_TIME_T_VALUE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; OCSP_RESPONSE_free(response);<br/></li>
<li>&nbsp; &nbsp; BIO_free(bio);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L279">&#x200c;</a><span class="linkable">ngx_ssl_stapling_issuer</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a> *staple)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, n, rc;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cert, *issuer;<br/></li>
<li>&nbsp; &nbsp; X509_STORE&nbsp; &nbsp; &nbsp; *store;<br/></li>
<li>&nbsp; &nbsp; X509_STORE_CTX&nbsp; *store_ctx;<br/></li>
<li>&nbsp; &nbsp; STACK_OF(X509)&nbsp; *chain;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = staple-&gt;cert;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_SELECT_CURRENT_CERT<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* OpenSSL 1.0.2+ */<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_select_current_cert(ssl-&gt;ctx, cert);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_GET_EXTRA_CHAIN_CERTS<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* OpenSSL 1.0.1+ */<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_get_extra_chain_certs(ssl-&gt;ctx, &amp;chain);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; chain = ssl-&gt;ctx-&gt;extra_certs;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; n = sk_X509_num(chain);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL get issuer: </span><span class="Special">%d</span><span class="Constant"> extra certs&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; issuer = sk_X509_value(chain, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (X509_check_issued(issuer, cert) == X509_V_OK) {<br/></li>
<li><span class="PreProc">#if <a href="ngx_event_openssl.h.html#L37" title="src/event/ngx_event_openssl.h:37">OPENSSL_VERSION_NUMBER</a> &gt;= </span><span class="Constant">0x10100001L<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; X509_up_ref(issuer);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CRYPTO_add(&amp;issuer-&gt;references, <span class="Constant">1</span>, CRYPTO_LOCK_X509);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL get issuer: found </span><span class="Special">%p</span><span class="Constant"> in extra certs&quot;</span>, issuer);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; staple-&gt;issuer = issuer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; store = SSL_CTX_get_cert_store(ssl-&gt;ctx);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (store == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_get_cert_store() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; store_ctx = X509_STORE_CTX_new();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (store_ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;X509_STORE_CTX_new() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (X509_STORE_CTX_init(store_ctx, store, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;X509_STORE_CTX_init() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_STORE_CTX_free(store_ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = X509_STORE_CTX_get1_issuer(&amp;issuer, store_ctx, cert);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;X509_STORE_CTX_get1_issuer() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_STORE_CTX_free(store_ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="src/core/ngx_log.h:21">NGX_LOG_WARN</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">ssl_stapling</span><span class="Special">\&quot;</span><span class="Constant"> ignored, issuer certificate not found&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_STORE_CTX_free(store_ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; X509_STORE_CTX_free(store_ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL get issuer: found </span><span class="Special">%p</span><span class="Constant"> in cert store&quot;</span>, issuer);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; staple-&gt;issuer = issuer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L374">&#x200c;</a><span class="linkable">ngx_ssl_stapling_responder</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a> *staple, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *responder)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_inet.h.html#L104" title="src/core/ngx_inet.h:104">ngx_url_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *s;<br/></li>
<li>&nbsp; &nbsp; STACK_OF(OPENSSL_STRING)&nbsp; *aia;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (responder-&gt;len == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* extract OCSP responder URL from certificate */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aia = X509_get1_ocsp(staple-&gt;cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (aia == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="src/core/ngx_log.h:21">NGX_LOG_WARN</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">ssl_stapling</span><span class="Special">\&quot;</span><span class="Constant"> ignored, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no OCSP responder URL in the certificate&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if <a href="ngx_event_openssl.h.html#L37" title="src/event/ngx_event_openssl.h:37">OPENSSL_VERSION_NUMBER</a> &gt;= </span><span class="Constant">0x10000000L<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; s = sk_OPENSSL_STRING_value(aia, <span class="Constant">0</span>);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; s = sk_value(aia, <span class="Constant">0</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="src/core/ngx_log.h:21">NGX_LOG_WARN</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">ssl_stapling</span><span class="Special">\&quot;</span><span class="Constant"> ignored, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no OCSP responder URL in the certificate&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; X509_email_free(aia);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; responder-&gt;len = <a href="../core/ngx_string.h.html#L61" title="src/core/ngx_string.h:61">ngx_strlen</a>(s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; responder-&gt;data = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool, responder-&gt;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (responder-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; X509_email_free(aia);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(responder-&gt;data, s, responder-&gt;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_email_free(aia);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;u, <span class="Statement">sizeof</span>(<a href="../core/ngx_inet.h.html#L104" title="src/core/ngx_inet.h:104">ngx_url_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u.url = *responder;<br/></li>
<li>&nbsp; &nbsp; u.default_port = <span class="Constant">80</span>;<br/></li>
<li>&nbsp; &nbsp; u.uri_part = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u.url.len &gt; <span class="Constant">7<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(u.url.data, (u_char *) <span class="Constant">&quot;http://&quot;</span>, <span class="Constant">7</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u.url.len -= <span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u.url.data += <span class="Constant">7</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="src/core/ngx_log.h:21">NGX_LOG_WARN</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">ssl_stapling</span><span class="Special">\&quot;</span><span class="Constant"> ignored, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid URL prefix in OCSP responder </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;u.url);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_inet.c.html#L591" title="src/core/ngx_inet.c:591">ngx_parse_url</a>(cf-&gt;pool, &amp;u) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u.err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="src/core/ngx_log.h:21">NGX_LOG_WARN</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">ssl_stapling</span><span class="Special">\&quot;</span><span class="Constant"> ignored, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> in OCSP responder </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, u.err, &amp;u.url);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; staple-&gt;addrs = u.addrs;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;host = u.host;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;uri = u.uri;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;port = u.port;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (staple-&gt;uri.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L42" title="src/core/ngx_string.h:42">ngx_str_set</a>(&amp;staple-&gt;uri, <span class="Constant">&quot;/&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L461">&#x200c;</a><span class="linkable">ngx_ssl_stapling_resolver</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *resolver, <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a> resolver_timeout)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a>&nbsp; *staple;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cert = SSL_CTX_get_ex_data(ssl-&gt;ctx, <a href="ngx_event_openssl.c.html#L107" title="src/event/ngx_event_openssl.c:107">ngx_ssl_certificate_index</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cert;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cert = X509_get_ex_data(cert, <a href="ngx_event_openssl.c.html#L108" title="src/event/ngx_event_openssl.c:108">ngx_ssl_next_certificate_index</a>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; staple = X509_get_ex_data(cert, <a href="ngx_event_openssl.c.html#L109" title="src/event/ngx_event_openssl.c:109">ngx_ssl_stapling_index</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; staple-&gt;resolver = resolver;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; staple-&gt;resolver_timeout = resolver_timeout;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L481">&#x200c;</a></span><span class="linkable">ngx_ssl_certificate_status_callback</span>(<a href="ngx_event_openssl.h.html#L54" title="src/event/ngx_event_openssl.h:54">ngx_ssl_conn_t</a> *ssl_conn, <span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a>&nbsp; *staple;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="ngx_event_openssl.h.html#L175" title="src/event/ngx_event_openssl.h:175">ngx_ssl_get_connection</a>(ssl_conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL certificate status callback&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = SSL_TLSEXT_ERR_NOACK;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cert = SSL_get_certificate(ssl_conn);<br/></li>
<li>&nbsp; &nbsp; staple = X509_get_ex_data(cert, <a href="ngx_event_openssl.c.html#L109" title="src/event/ngx_event_openssl.c:109">ngx_ssl_stapling_index</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (staple == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (staple-&gt;staple.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; staple-&gt;valid &gt;= <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>())<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we have to copy ocsp response as OpenSSL will free it by itself */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = OPENSSL_malloc(staple-&gt;staple.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;OPENSSL_malloc() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> SSL_TLSEXT_ERR_NOACK;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(p, staple-&gt;staple.data, staple-&gt;staple.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_set_tlsext_status_ocsp_resp(ssl_conn, p, staple-&gt;staple.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = SSL_TLSEXT_ERR_OK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L528" title="src/event/ngx_event_openssl_stapling.c:528">ngx_ssl_stapling_update</a>(staple);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L528">&#x200c;</a></span><span class="linkable">ngx_ssl_stapling_update</span>(<a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a> *staple)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (staple-&gt;host.len == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || staple-&gt;loading || staple-&gt;refresh &gt;= <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>())<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; staple-&gt;loading = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="#L804" title="src/event/ngx_event_openssl_stapling.c:804">ngx_ssl_ocsp_start</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;cert = staple-&gt;cert;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;issuer = staple-&gt;issuer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;addrs = staple-&gt;addrs;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;host = staple-&gt;host;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;uri = staple-&gt;uri;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;port = staple-&gt;port;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;timeout = staple-&gt;timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;resolver = staple-&gt;resolver;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;resolver_timeout = staple-&gt;resolver_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;handler = <a href="#L567" title="src/event/ngx_event_openssl_stapling.c:567">ngx_ssl_stapling_ocsp_handler</a>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;data = staple;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L868" title="src/event/ngx_event_openssl_stapling.c:868">ngx_ssl_ocsp_request</a>(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L567">&#x200c;</a></span><span class="linkable">ngx_ssl_stapling_ocsp_handler</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#if <a href="ngx_event_openssl.h.html#L37" title="src/event/ngx_event_openssl.h:37">OPENSSL_VERSION_NUMBER</a> &gt;= </span><span class="Constant">0x0090707fL<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; now, valid;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; response;<br/></li>
<li>&nbsp; &nbsp; X509_STORE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *store;<br/></li>
<li>&nbsp; &nbsp; STACK_OF(X509)&nbsp; &nbsp; &nbsp; &nbsp; *chain;<br/></li>
<li>&nbsp; &nbsp; OCSP_CERTID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *id;<br/></li>
<li>&nbsp; &nbsp; OCSP_RESPONSE&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ocsp;<br/></li>
<li>&nbsp; &nbsp; OCSP_BASICRESP&nbsp; &nbsp; &nbsp; &nbsp; *basic;<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a>&nbsp; &nbsp; *staple;<br/></li>
<li>&nbsp; &nbsp; ASN1_GENERALIZEDTIME&nbsp; *thisupdate, *nextupdate;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; staple = ctx-&gt;data;<br/></li>
<li>&nbsp; &nbsp; now = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li>&nbsp; &nbsp; ocsp = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; basic = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; id = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;code != <span class="Constant">200</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* check the response */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; len = ctx-&gt;response-&gt;last - ctx-&gt;response-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; p = ctx-&gt;response-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ocsp = d2i_OCSP_RESPONSE(<span class="Constant">NULL</span>, &amp;p, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ocsp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;d2i_OCSP_RESPONSE() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = OCSP_response_status(ocsp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != OCSP_RESPONSE_STATUS_SUCCESSFUL) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP response not successful (</span><span class="Special">%d</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n, OCSP_response_status_str(n));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; basic = OCSP_response_get1_basic(ocsp);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (basic == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP_response_get1_basic() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; store = SSL_CTX_get_cert_store(staple-&gt;ssl_ctx);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (store == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;SSL_CTX_get_cert_store() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_SELECT_CURRENT_CERT<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* OpenSSL 1.0.2+ */<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_select_current_cert(staple-&gt;ssl_ctx, ctx-&gt;cert);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_GET_EXTRA_CHAIN_CERTS<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* OpenSSL 1.0.1+ */<br/></li>
<li></span>&nbsp; &nbsp; SSL_CTX_get_extra_chain_certs(staple-&gt;ssl_ctx, &amp;chain);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; chain = staple-&gt;ssl_ctx-&gt;extra_certs;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (OCSP_basic_verify(basic, chain, store,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; staple-&gt;verify ? OCSP_TRUSTOTHER : OCSP_NOVERIFY)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP_basic_verify() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; id = OCSP_cert_to_id(<span class="Constant">NULL</span>, ctx-&gt;cert, ctx-&gt;issuer);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (id == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP_cert_to_id() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (OCSP_resp_find_status(basic, id, &amp;n, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;thisupdate, &amp;nextupdate)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;certificate status not found in the OCSP response&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n != V_OCSP_CERTSTATUS_GOOD) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;certificate status </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> in the OCSP response&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OCSP_cert_status_str(n));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (OCSP_check_validity(thisupdate, nextupdate, <span class="Constant">300</span>, -<span class="Constant">1</span>) != <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP_check_validity() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nextupdate) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; valid = <a href="#L755" title="src/event/ngx_event_openssl_stapling.c:755">ngx_ssl_stapling_time</a>(nextupdate);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid == (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid nextUpdate time in certificate status&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; valid = <a href="../os/win32/ngx_win32_config.h.html#L204" title="src/os/win32/ngx_win32_config.h:204">NGX_MAX_TIME_T_VALUE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; OCSP_CERTID_free(id);<br/></li>
<li>&nbsp; &nbsp; OCSP_BASICRESP_free(basic);<br/></li>
<li>&nbsp; &nbsp; OCSP_RESPONSE_free(ocsp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; id = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; basic = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; ocsp = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* copy the response to memory not in ctx-&gt;pool */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; response.len = len;<br/></li>
<li>&nbsp; &nbsp; response.data = <a href="../os/win32/ngx_alloc.c.html#L17" title="src/os/win32/ngx_alloc.c:17">ngx_alloc</a>(response.len, ctx-&gt;log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (response.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(response.data, ctx-&gt;response-&gt;pos, response.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp response, </span><span class="Special">%s</span><span class="Constant">, </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OCSP_cert_status_str(n), response.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (staple-&gt;staple.data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(staple-&gt;staple.data);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; staple-&gt;staple = response;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;valid = valid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * refresh before the response <a href="../http/modules/ngx_http_userid_filter_module.c.html#L76" title="src/http/modules/ngx_http_userid_filter_module.c:76">expires</a>,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * but not earlier than in 5 minutes, and at least in an hour<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; staple-&gt;loading = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;refresh = <a href="../core/ngx_core.h.html#L101" title="src/core/ngx_core.h:101">ngx_max</a>(<a href="../core/ngx_core.h.html#L102" title="src/core/ngx_core.h:102">ngx_min</a>(valid - <span class="Constant">300</span>, now + <span class="Constant">3600</span>), now + <span class="Constant">300</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L843" title="src/event/ngx_event_openssl_stapling.c:843">ngx_ssl_ocsp_done</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">error</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; staple-&gt;loading = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; staple-&gt;refresh = now + <span class="Constant">300</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (id) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; OCSP_CERTID_free(id);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (basic) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; OCSP_BASICRESP_free(basic);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ocsp) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; OCSP_RESPONSE_free(ocsp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L843" title="src/event/ngx_event_openssl_stapling.c:843">ngx_ssl_ocsp_done</a>(ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a><br/></li>
<li><a id="L755">&#x200c;</a></span><span class="linkable">ngx_ssl_stapling_time</span>(ASN1_GENERALIZEDTIME *asn1time)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp;&nbsp; time;<br/></li>
<li>&nbsp; &nbsp; BIO&nbsp; &nbsp;&nbsp; *bio;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * OpenSSL doesn't provide a way to convert ASN1_GENERALIZEDTIME<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * into <a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a>.&nbsp; To do this, we use ASN1_GENERALIZEDTIME_print(),<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * which uses the &quot;MMM DD HH:MM:SS YYYY [GMT]&quot; format (e.g.,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * &quot;Feb&nbsp; 3 00:55:52 2015 GMT&quot;), and parse the result.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; bio = BIO_new(BIO_s_mem());<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (bio == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* fake weekday prepended to match C asctime() format */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; BIO_write(bio, <span class="Constant">&quot;Tue &quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;Tue &quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; ASN1_GENERALIZEDTIME_print(bio, asn1time);<br/></li>
<li>&nbsp; &nbsp; len = BIO_get_mem_data(bio, &amp;value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; time = <a href="../core/ngx_parse_time.c.html#L15" title="src/core/ngx_parse_time.c:15">ngx_parse_http_time</a>(value, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; BIO_free(bio);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> time;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L789">&#x200c;</a></span><span class="linkable">ngx_ssl_stapling_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="src/event/ngx_event_openssl_stapling.c:39">ngx_ssl_stapling_t</a>&nbsp; *staple = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (staple-&gt;issuer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509_free(staple-&gt;issuer);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (staple-&gt;staple.data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(staple-&gt;staple.data);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *<br/></li>
<li><a id="L804">&#x200c;</a><span class="linkable">ngx_ssl_ocsp_start</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *log;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *pool;<br/></li>
<li>&nbsp; &nbsp; <a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool = <a href="../core/ngx_palloc.c.html#L20" title="src/core/ngx_palloc.c:20">ngx_create_pool</a>(<span class="Constant">2048</span>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(pool, <span class="Statement">sizeof</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (log == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;pool = pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *log = *ctx-&gt;pool-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;pool-&gt;log = log;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;log = log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log-&gt;handler = <a href="#L1811" title="src/event/ngx_event_openssl_stapling.c:1811">ngx_ssl_ocsp_log_error</a>;<br/></li>
<li>&nbsp; &nbsp; log-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; log-&gt;action = <span class="Constant">&quot;requesting certificate status&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ctx;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L843">&#x200c;</a></span><span class="linkable">ngx_ssl_ocsp_done</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp done&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;peer.connection) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(ctx-&gt;peer.connection);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(ctx-&gt;pool);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L857">&#x200c;</a></span><span class="linkable">ngx_ssl_ocsp_error</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp error&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;code = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L868">&#x200c;</a></span><span class="linkable">ngx_ssl_ocsp_request</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a>&nbsp; *resolve, temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp request&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1185" title="src/event/ngx_event_openssl_stapling.c:1185">ngx_ssl_ocsp_create_request</a>(ctx) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;resolver) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* resolve OCSP responder hostname */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp.name = ctx-&gt;host;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resolve = <a href="../core/ngx_resolver.c.html#L364" title="src/core/ngx_resolver.c:364">ngx_resolve_start</a>(ctx-&gt;resolver, &amp;temp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (resolve == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (resolve == <a href="../core/ngx_resolver.h.html#L35" title="src/core/ngx_resolver.h:35">NGX_NO_RESOLVER</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="src/core/ngx_log.h:21">NGX_LOG_WARN</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no resolver defined to resolve %V&quot;</span>, &amp;ctx-&gt;host);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> connect;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resolve-&gt;name = ctx-&gt;host;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resolve-&gt;handler = <a href="#L917" title="src/event/ngx_event_openssl_stapling.c:917">ngx_ssl_ocsp_resolve_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resolve-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resolve-&gt;timeout = ctx-&gt;resolver_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_resolver.c.html#L403" title="src/core/ngx_resolver.c:403">ngx_resolve_name</a>(resolve) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">connect</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1003" title="src/event/ngx_event_openssl_stapling.c:1003">ngx_ssl_ocsp_connect</a>(ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L917">&#x200c;</a></span><span class="linkable">ngx_ssl_ocsp_resolve_handler</span>(<a href="../core/ngx_resolver.h.html#L56" title="src/core/ngx_resolver.h:56">ngx_resolver_ctx_t</a> *resolve)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx = resolve-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L20" title="src/os/win32/ngx_socket.h:20">socklen_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; socklen;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr&nbsp; *sockaddr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp resolve handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (resolve-&gt;state) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;%V could not be resolved (</span><span class="Special">%i</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;resolve-&gt;name, resolve-&gt;state,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_resolver.c.html#L4323" title="src/core/ngx_resolver.c:4323">ngx_resolver_strerror</a>(resolve-&gt;state));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; text[<a href="../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>];<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; addr.data = text;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; resolve-&gt;naddrs; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; addr.len = <a href="../core/ngx_inet.c.html#L181" title="src/core/ngx_inet.c:181">ngx_sock_ntop</a>(resolve-&gt;addrs[i].sockaddr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; resolve-&gt;addrs[i].socklen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; text, <a href="../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;name was resolved to %V&quot;</span>, &amp;addr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;naddrs = resolve-&gt;naddrs;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;addrs = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(ctx-&gt;pool, ctx-&gt;naddrs * <span class="Statement">sizeof</span>(<a href="../core/ngx_inet.h.html#L77" title="src/core/ngx_inet.h:77">ngx_addr_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;addrs == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; resolve-&gt;naddrs; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; socklen = resolve-&gt;addrs[i].socklen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sockaddr = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(ctx-&gt;pool, socklen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sockaddr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(sockaddr, resolve-&gt;addrs[i].sockaddr, socklen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_inet.c.html#L1373" title="src/core/ngx_inet.c:1373">ngx_inet_set_port</a>(sockaddr, ctx-&gt;port);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs[i].sockaddr = sockaddr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs[i].socklen = socklen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(ctx-&gt;pool, <a href="../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="../core/ngx_inet.c.html#L181" title="src/core/ngx_inet.c:181">ngx_sock_ntop</a>(sockaddr, socklen, p, <a href="../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs[i].name.len = len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;addrs[i].name.data = p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_resolver.c.html#L483" title="src/core/ngx_resolver.c:483">ngx_resolve_name_done</a>(resolve);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1003" title="src/event/ngx_event_openssl_stapling.c:1003">ngx_ssl_ocsp_connect</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_resolver.c.html#L483" title="src/core/ngx_resolver.c:483">ngx_resolve_name_done</a>(resolve);<br/></li>
<li>&nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1003">&#x200c;</a></span><span class="linkable">ngx_ssl_ocsp_connect</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp connect&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: use all ip addresses */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.sockaddr = ctx-&gt;addrs[<span class="Constant">0</span>].sockaddr;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.socklen = ctx-&gt;addrs[<span class="Constant">0</span>].socklen;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.name = &amp;ctx-&gt;addrs[<span class="Constant">0</span>].name;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.get = <a href="ngx_event_connect.c.html#L406" title="src/event/ngx_event_connect.c:406">ngx_event_get_peer</a>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.log = ctx-&gt;log;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.log_error = NGX_ERROR_ERR;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="ngx_event_connect.c.html#L21" title="src/event/ngx_event_connect.c:21">ngx_event_connect_peer</a>(&amp;ctx-&gt;peer);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp connect peer done&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> || rc == <a href="../core/ngx_core.h.html#L39" title="src/core/ngx_core.h:39">NGX_BUSY</a> || rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.connection-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.connection-&gt;pool = ctx-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.connection-&gt;read-&gt;handler = <a href="#L1101" title="src/event/ngx_event_openssl_stapling.c:1101">ngx_ssl_ocsp_read_handler</a>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;peer.connection-&gt;write-&gt;handler = <a href="#L1048" title="src/event/ngx_event_openssl_stapling.c:1048">ngx_ssl_ocsp_write_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;process = <a href="#L1303" title="src/event/ngx_event_openssl_stapling.c:1303">ngx_ssl_ocsp_process_status_line</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(ctx-&gt;peer.connection-&gt;read, ctx-&gt;timeout);<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(ctx-&gt;peer.connection-&gt;write, ctx-&gt;timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1048" title="src/event/ngx_event_openssl_stapling.c:1048">ngx_ssl_ocsp_write_handler</a>(ctx-&gt;peer.connection-&gt;write);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1048">&#x200c;</a></span><span class="linkable">ngx_ssl_ocsp_write_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *wev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n, size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = wev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; ctx = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, wev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp write handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, wev-&gt;log, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP responder timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = ctx-&gt;request-&gt;last - ctx-&gt;request-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="ngx_event.h.html#L422" title="src/event/ngx_event.h:422">ngx_send</a>(c, ctx-&gt;request-&gt;pos, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;request-&gt;pos += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;handler = <a href="#L1177" title="src/event/ngx_event_openssl_stapling.c:1177">ngx_ssl_ocsp_dummy_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(wev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L332" title="src/event/ngx_event.c:332">ngx_handle_write_event</a>(wev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(wev, ctx-&gt;timeout);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1101">&#x200c;</a></span><span class="linkable">ngx_ssl_ocsp_read_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n, size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a>&nbsp; &nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; ctx = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, rev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp read handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, rev-&gt;log, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP responder timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;response == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;response = <a href="../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(ctx-&gt;pool, <span class="Constant">16384</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;response == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = ctx-&gt;response-&gt;end - ctx-&gt;response-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="ngx_event.h.html#L419" title="src/event/ngx_event.h:419">ngx_recv</a>(c, ctx-&gt;response-&gt;last, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;response-&gt;last += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = ctx-&gt;process(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;done = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = ctx-&gt;process(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L40" title="src/core/ngx_core.h:40">NGX_DONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ctx-&gt;handler() was called */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP responder prematurely closed connection&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L857" title="src/event/ngx_event_openssl_stapling.c:857">ngx_ssl_ocsp_error</a>(ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1177">&#x200c;</a></span><span class="linkable">ngx_ssl_ocsp_dummy_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp dummy handler&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1185">&#x200c;</a><span class="linkable">ngx_ssl_ocsp_create_request</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L156" title="src/os/win32/ngx_win32_config.h:156">uintptr_t</a></span>&nbsp; &nbsp; &nbsp; escape;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; binary, base64;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; OCSP_CERTID&nbsp;&nbsp; *id;<br/></li>
<li>&nbsp; &nbsp; OCSP_REQUEST&nbsp; *ocsp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ocsp = OCSP_REQUEST_new();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ocsp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP_REQUEST_new() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; id = OCSP_cert_to_id(<span class="Constant">NULL</span>, ctx-&gt;cert, ctx-&gt;issuer);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (id == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP_cert_to_id() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (OCSP_request_add0_id(ocsp, id) == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP_request_add0_id() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; OCSP_CERTID_free(id);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = i2d_OCSP_REQUEST(ocsp, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;i2d_OCSP_REQUEST() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; binary.len = len;<br/></li>
<li>&nbsp; &nbsp; binary.data = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(ctx-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (binary.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = binary.data;<br/></li>
<li>&nbsp; &nbsp; len = i2d_OCSP_REQUEST(ocsp, &amp;p);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_event_openssl.c.html#L2137" title="src/event/ngx_event_openssl.c:2137">ngx_ssl_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;i2d_OCSP_REQUEST() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; base64.len = <a href="../core/ngx_string.h.html#L182" title="src/core/ngx_string.h:182">ngx_base64_encoded_length</a>(binary.len);<br/></li>
<li>&nbsp; &nbsp; base64.data = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(ctx-&gt;pool, base64.len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (base64.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1122" title="src/core/ngx_string.c:1122">ngx_encode_base64</a>(&amp;base64, &amp;binary);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; escape = <a href="../core/ngx_string.c.html#L1425" title="src/core/ngx_string.c:1425">ngx_escape_uri</a>(<span class="Constant">NULL</span>, base64.data, base64.len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L197" title="src/core/ngx_string.h:197">NGX_ESCAPE_URI_COMPONENT</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp request length %z, escape </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; base64.len, (<span class="Type">int</span>) escape);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;<a href="../core/ngx_sha1.c.html#L144" title="src/core/ngx_sha1.c:144">GET</a> &quot;</span>) - <span class="Constant">1</span> + ctx-&gt;uri.len + <span class="Statement">sizeof</span>(<span class="Constant">&quot;/&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + base64.len + <span class="Constant">2</span> * escape + <span class="Statement">sizeof</span>(<span class="Constant">&quot; HTTP/1.0&quot;</span> <a href="../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<span class="Constant">&quot;Host: &quot;</span>) - <span class="Constant">1</span> + ctx-&gt;host.len + <span class="Statement">sizeof</span>(<a href="../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<a href="../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = <a href="../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(ctx-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = b-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;<a href="../core/ngx_sha1.c.html#L144" title="src/core/ngx_sha1.c:144">GET</a> &quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;<a href="../core/ngx_sha1.c.html#L144" title="src/core/ngx_sha1.c:144">GET</a> &quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, ctx-&gt;uri.data, ctx-&gt;uri.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;uri.data[ctx-&gt;uri.len - <span class="Constant">1</span>] != <span class="Constant">'/'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">'/'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (escape == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, base64.data, base64.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = (u_char *) <a href="../core/ngx_string.c.html#L1425" title="src/core/ngx_string.c:1425">ngx_escape_uri</a>(p, base64.data, base64.len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.h.html#L197" title="src/core/ngx_string.h:197">NGX_ESCAPE_URI_COMPONENT</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot; HTTP/1.0&quot;</span> <a href="../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>, <span class="Statement">sizeof</span>(<span class="Constant">&quot; HTTP/1.0&quot;</span> <a href="../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;Host: &quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;Host: &quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, ctx-&gt;host.data, ctx-&gt;host.len);<br/></li>
<li>&nbsp; &nbsp; *p++ = <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>; *p++ = <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* add &quot;\r\n&quot; at the header end */<br/></li>
<li></span>&nbsp; &nbsp; *p++ = <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>; *p++ = <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last = p;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;request = b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; OCSP_REQUEST_free(ocsp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; OCSP_REQUEST_free(ocsp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1303">&#x200c;</a><span class="linkable">ngx_ssl_ocsp_process_status_line</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L1335" title="src/event/ngx_event_openssl_stapling.c:1335">ngx_ssl_ocsp_parse_status_line</a>(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li><span class="PreProc">#if 0<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, 0,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &quot;ssl ocsp status line \&quot;%*s\&quot;&quot;,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;response-&gt;pos - ctx-&gt;response-&gt;start,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;response-&gt;start);<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;process = <a href="#L1536" title="src/event/ngx_event_openssl_stapling.c:1536">ngx_ssl_ocsp_process_headers</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> ctx-&gt;process(ctx);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP responder sent invalid response&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1335">&#x200c;</a><span class="linkable">ngx_ssl_ocsp_parse_status_line</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; ch;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">enum</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_start = <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_H,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_HT,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_HTT,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_HTTP,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_first_major_digit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_major_digit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_first_minor_digit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_minor_digit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_status,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_space_after_status,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_status_text,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_almost_done<br/></li>
<li>&nbsp; &nbsp; } state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp process status line&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; state = ctx-&gt;state;<br/></li>
<li>&nbsp; &nbsp; b = ctx-&gt;response;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = b-&gt;pos; p &lt; b-&gt;last; p++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ch = *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (state) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* &quot;HTTP/&quot; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_start:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'<a href="../core/ngx_md5.c.html#L124" title="src/core/ngx_md5.c:124">H</a>'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_H;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_H:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'T'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_HT;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_HT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'T'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_HTT;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_HTT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'P'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_HTTP;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_HTTP:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'/'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_first_major_digit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the first digit of major HTTP version */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_first_major_digit:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch &lt; <span class="Constant">'1'</span> || ch &gt; <span class="Constant">'9'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_major_digit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the major HTTP version or dot */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_major_digit:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_first_minor_digit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch &lt; <span class="Constant">'0'</span> || ch &gt; <span class="Constant">'9'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the first digit of minor HTTP version */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_first_minor_digit:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch &lt; <span class="Constant">'0'</span> || ch &gt; <span class="Constant">'9'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_minor_digit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the minor HTTP version or the end of the request line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_minor_digit:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">' '</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_status;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch &lt; <span class="Constant">'0'</span> || ch &gt; <span class="Constant">'9'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* HTTP status code */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_status:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">' '</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch &lt; <span class="Constant">'0'</span> || ch &gt; <span class="Constant">'9'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;code = ctx-&gt;code * <span class="Constant">10</span> + ch - <span class="Constant">'0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++ctx-&gt;count == <span class="Constant">3</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_space_after_status;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* space or end of line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_space_after_status:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">' '</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_status_text;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'.'</span>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* IIS may send 403.1, 403.2, etc */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_status_text;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_almost_done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* any text until end of line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_status_text:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_almost_done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* end of status line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_almost_done:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;pos = p;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; b-&gt;pos = p + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = sw_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1536">&#x200c;</a><span class="linkable">ngx_ssl_ocsp_process_headers</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp process headers&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L1609" title="src/event/ngx_event_openssl_stapling.c:1609">ngx_ssl_ocsp_parse_header_line</a>(ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L148" title="src/core/ngx_log.h:148">ngx_log_debug4</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp header </span><span class="Special">\&quot;%*s</span><span class="Constant">: </span><span class="Special">%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;header_name_end - ctx-&gt;header_name_start,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;header_name_start,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;header_end - ctx-&gt;header_start,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ctx-&gt;header_start);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = ctx-&gt;header_name_end - ctx-&gt;header_name_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Statement">sizeof</span>(<span class="Constant">&quot;Content-Type&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(ctx-&gt;header_name_start,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (u_char *) <span class="Constant">&quot;Content-Type&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<span class="Constant">&quot;Content-Type&quot;</span>) - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = ctx-&gt;header_end - ctx-&gt;header_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len != <span class="Statement">sizeof</span>(<span class="Constant">&quot;application/ocsp-response&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(ctx-&gt;header_start,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (u_char *) <span class="Constant">&quot;application/ocsp-response&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<span class="Constant">&quot;application/ocsp-response&quot;</span>) - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP responder sent invalid &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">Content-Type</span><span class="Special">\&quot;</span><span class="Constant"> header: </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end - ctx-&gt;header_start,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment">: honor Content-Length */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L40" title="src/core/ngx_core.h:40">NGX_DONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;OCSP responder sent invalid response&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;process = <a href="#L1796" title="src/event/ngx_event_openssl_stapling.c:1796">ngx_ssl_ocsp_process_body</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ctx-&gt;process(ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1609">&#x200c;</a><span class="linkable">ngx_ssl_ocsp_parse_header_line</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; c, ch, *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">enum</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_start = <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_space_before_value,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_value,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_space_after_value,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_almost_done,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_header_almost_done<br/></li>
<li>&nbsp; &nbsp; } state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; state = ctx-&gt;state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = ctx-&gt;response-&gt;pos; p &lt; ctx-&gt;response-&gt;last; p++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ch = *p;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if 0<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, 0,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &quot;s:%d in:'%02Xd:%c'&quot;, state, ch, ch);<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (state) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* first char */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_start:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_header_almost_done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> header_done;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_name_start = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = (u_char) (ch | <span class="Constant">0x20</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c &gt;= <span class="Constant">'a'</span> &amp;&amp; c &lt;= <span class="Constant">'z'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch &gt;= <span class="Constant">'0'</span> &amp;&amp; ch &lt;= <span class="Constant">'9'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* header name */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_name:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = (u_char) (ch | <span class="Constant">0x20</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c &gt;= <span class="Constant">'a'</span> &amp;&amp; c &lt;= <span class="Constant">'z'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">':'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_name_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_space_before_value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <span class="Constant">'-'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch &gt;= <span class="Constant">'0'</span> &amp;&amp; ch &lt;= <span class="Constant">'9'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_name_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_start = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_almost_done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch == <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_name_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_start = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* space* before header value */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_space_before_value:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">' '</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_start = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_almost_done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_start = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_start = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* header value */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_value:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">' '</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_space_after_value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_almost_done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;header_end = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* space* before end of header line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_space_after_value:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">' '</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_almost_done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* end of header line */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_almost_done:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* end of header */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> sw_header_almost_done:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> header_done;<br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;response-&gt;pos = p;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;response-&gt;pos = p + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = sw_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">header_done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;response-&gt;pos = p + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;state = sw_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L40" title="src/core/ngx_core.h:40">NGX_DONE</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1796">&#x200c;</a><span class="linkable">ngx_ssl_ocsp_process_body</span>(<a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L29" title="src/core/ngx_log.h:29">NGX_LOG_DEBUG_EVENT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;ssl ocsp process body&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;done) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;handler(ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L40" title="src/core/ngx_core.h:40">NGX_DONE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1811">&#x200c;</a><span class="linkable">ngx_ssl_ocsp_log_error</span>(<a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="#L42" title="src/event/ngx_event_openssl_stapling.c:42">ngx_ssl_ocsp_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (log-&gt;action) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot; while </span><span class="Special">%s</span><span class="Constant">&quot;</span>, log-&gt;action);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = log-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(p, len, <span class="Constant">&quot;, responder: %V&quot;</span>, &amp;ctx-&gt;host);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1837">&#x200c;</a><span class="linkable">ngx_ssl_stapling</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *file,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *responder, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> verify)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L21" title="src/core/ngx_log.h:21">NGX_LOG_WARN</a>, ssl-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">ssl_stapling</span><span class="Special">\&quot;</span><span class="Constant"> ignored, not supported&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1847">&#x200c;</a><span class="linkable">ngx_ssl_stapling_resolver</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="ngx_event_openssl.h.html#L61" title="src/event/ngx_event_openssl.h:61">ngx_ssl_t</a> *ssl,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_resolver.h.html#L40" title="src/core/ngx_resolver.h:40">ngx_resolver_t</a> *resolver, <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a> resolver_timeout)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
