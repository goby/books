<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/http/v2/ngx_http_v2.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

  <h1>src/http/v2/ngx_http_v2.c - Nginx 1.11.2</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L185">ngx_http_v2_frame_states</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L4235">ngx_http_v2_adjust_windows</a></li>
<li><a href="#L3919">ngx_http_v2_close_stream</a></li>
<li><a href="#L4049">ngx_http_v2_close_stream_handler</a></li>
<li><a href="#L2326">ngx_http_v2_connection_error</a></li>
<li><a href="#L3311">ngx_http_v2_construct_cookie_header</a></li>
<li><a href="#L3241">ngx_http_v2_construct_request_line</a></li>
<li><a href="#L3282">ngx_http_v2_cookie</a></li>
<li><a href="#L2659">ngx_http_v2_create_stream</a></li>
<li><a href="#L3674">ngx_http_v2_filter_request_body</a></li>
<li><a href="#L4159">ngx_http_v2_finalize_connection</a></li>
<li><a href="#L2640">ngx_http_v2_frame_handler</a></li>
<li><a href="#L2838">ngx_http_v2_get_closed_node</a></li>
<li><a href="#L2575">ngx_http_v2_get_frame</a></li>
<li><a href="#L2793">ngx_http_v2_get_node_by_id</a></li>
<li><a href="#L590">ngx_http_v2_handle_connection</a></li>
<li><a href="#L4074">ngx_http_v2_handle_connection_handler</a></li>
<li><a href="#L1663">ngx_http_v2_handle_continuation</a></li>
<li><a href="#L4102">ngx_http_v2_idle_handler</a></li>
<li><a href="#L203">ngx_http_v2_init</a></li>
<li><a href="#L4388">ngx_http_v2_node_children_update</a></li>
<li><a href="#L3196">ngx_http_v2_parse_authority</a></li>
<li><a href="#L2343">ngx_http_v2_parse_int</a></li>
<li><a href="#L3077">ngx_http_v2_parse_method</a></li>
<li><a href="#L3037">ngx_http_v2_parse_path</a></li>
<li><a href="#L3172">ngx_http_v2_parse_scheme</a></li>
<li><a href="#L4408">ngx_http_v2_pool_cleanup</a></li>
<li><a href="#L3589">ngx_http_v2_process_request_body</a></li>
<li><a href="#L2988">ngx_http_v2_pseudo_header</a></li>
<li><a href="#L3765">ngx_http_v2_read_client_request_body_handler</a></li>
<li><a href="#L301">ngx_http_v2_read_handler</a></li>
<li><a href="#L3436">ngx_http_v2_read_request_body</a></li>
<li><a href="#L3797">ngx_http_v2_read_unbuffered_request_body</a></li>
<li><a href="#L3401">ngx_http_v2_run_request</a></li>
<li><a href="#L2548">ngx_http_v2_send_goaway</a></li>
<li><a href="#L453">ngx_http_v2_send_output_queue</a></li>
<li><a href="#L2520">ngx_http_v2_send_rst_stream</a></li>
<li><a href="#L2399">ngx_http_v2_send_settings</a></li>
<li><a href="#L2492">ngx_http_v2_send_window_update</a></li>
<li><a href="#L4297">ngx_http_v2_set_dependency</a></li>
<li><a href="#L2474">ngx_http_v2_settings_frame_handler</a></li>
<li><a href="#L2221">ngx_http_v2_state_complete</a></li>
<li><a href="#L2210">ngx_http_v2_state_continuation</a></li>
<li><a href="#L754">ngx_http_v2_state_data</a></li>
<li><a href="#L1326">ngx_http_v2_state_field_huff</a></li>
<li><a href="#L1239">ngx_http_v2_state_field_len</a></li>
<li><a href="#L1381">ngx_http_v2_state_field_raw</a></li>
<li><a href="#L1426">ngx_http_v2_state_field_skip</a></li>
<li><a href="#L2052">ngx_http_v2_state_goaway</a></li>
<li><a href="#L719">ngx_http_v2_state_head</a></li>
<li><a href="#L1139">ngx_http_v2_state_header_block</a></li>
<li><a href="#L1626">ngx_http_v2_state_header_complete</a></li>
<li><a href="#L966">ngx_http_v2_state_headers</a></li>
<li><a href="#L2304">ngx_http_v2_state_headers_save</a></li>
<li><a href="#L2010">ngx_http_v2_state_ping</a></li>
<li><a href="#L671">ngx_http_v2_state_preface</a></li>
<li><a href="#L693">ngx_http_v2_state_preface_end</a></li>
<li><a href="#L1725">ngx_http_v2_state_priority</a></li>
<li><a href="#L1468">ngx_http_v2_state_process_header</a></li>
<li><a href="#L650">ngx_http_v2_state_proxy_protocol</a></li>
<li><a href="#L1999">ngx_http_v2_state_push_promise</a></li>
<li><a href="#L884">ngx_http_v2_state_read_data</a></li>
<li><a href="#L1818">ngx_http_v2_state_rst_stream</a></li>
<li><a href="#L2275">ngx_http_v2_state_save</a></li>
<li><a href="#L1900">ngx_http_v2_state_settings</a></li>
<li><a href="#L1933">ngx_http_v2_state_settings_params</a></li>
<li><a href="#L2253">ngx_http_v2_state_skip</a></li>
<li><a href="#L2242">ngx_http_v2_state_skip_padded</a></li>
<li><a href="#L2089">ngx_http_v2_state_window_update</a></li>
<li><a href="#L3889">ngx_http_v2_terminate_stream</a></li>
<li><a href="#L2919">ngx_http_v2_validate_header</a></li>
<li><a href="#L392">ngx_http_v2_write_handler</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L23">NGX_HTTP_V2_CANCEL</a></li>
<li><a href="#L24">NGX_HTTP_V2_COMP_ERROR</a></li>
<li><a href="#L25">NGX_HTTP_V2_CONNECT_ERROR</a></li>
<li><a href="#L49">NGX_HTTP_V2_DEFAULT_FRAME_SIZE</a></li>
<li><a href="#L26">NGX_HTTP_V2_ENHANCE_YOUR_CALM</a></li>
<li><a href="#L18">NGX_HTTP_V2_FLOW_CTRL_ERROR</a></li>
<li><a href="#L47">NGX_HTTP_V2_FRAME_BUFFER_SIZE</a></li>
<li><a href="#L198">NGX_HTTP_V2_FRAME_STATES</a></li>
<li><a href="#L34">NGX_HTTP_V2_GOAWAY_SIZE</a></li>
<li><a href="#L42">NGX_HTTP_V2_HEADER_TABLE_SIZE_SETTING</a></li>
<li><a href="#L28">NGX_HTTP_V2_HTTP_1_1_REQUIRED</a></li>
<li><a href="#L27">NGX_HTTP_V2_INADEQUATE_SECURITY</a></li>
<li><a href="#L44">NGX_HTTP_V2_INIT_WINDOW_SIZE_SETTING</a></li>
<li><a href="#L17">NGX_HTTP_V2_INTERNAL_ERROR</a></li>
<li><a href="#L45">NGX_HTTP_V2_MAX_FRAME_SIZE_SETTING</a></li>
<li><a href="#L43">NGX_HTTP_V2_MAX_STREAMS_SETTING</a></li>
<li><a href="#L15">NGX_HTTP_V2_NO_ERROR</a></li>
<li><a href="#L33">NGX_HTTP_V2_PING_SIZE</a></li>
<li><a href="#L32">NGX_HTTP_V2_PRIORITY_SIZE</a></li>
<li><a href="#L16">NGX_HTTP_V2_PROTOCOL_ERROR</a></li>
<li><a href="#L22">NGX_HTTP_V2_REFUSED_STREAM</a></li>
<li><a href="#L51">NGX_HTTP_V2_ROOT</a></li>
<li><a href="#L31">NGX_HTTP_V2_RST_STREAM_SIZE</a></li>
<li><a href="#L39">NGX_HTTP_V2_SETTINGS_PARAM_SIZE</a></li>
<li><a href="#L19">NGX_HTTP_V2_SETTINGS_TIMEOUT</a></li>
<li><a href="#L21">NGX_HTTP_V2_SIZE_ERROR</a></li>
<li><a href="#L20">NGX_HTTP_V2_STREAM_CLOSED</a></li>
<li><a href="#L37">NGX_HTTP_V2_STREAM_ID_SIZE</a></li>
<li><a href="#L35">NGX_HTTP_V2_WINDOW_UPDATE_SIZE</a></li>
<li><a href="#L129">ngx_http_v2_index</a></li>
<li><a href="#L128">ngx_http_v2_index_size</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> * Copyright (C) Valentin V. Bartenev<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;<a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* errors */<br/></li>
<li><a id="L15">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_NO_ERROR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x0<br/></li>
<li><a id="L16">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_PROTOCOL_ERROR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x1<br/></li>
<li><a id="L17">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_INTERNAL_ERROR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x2<br/></li>
<li><a id="L18">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_FLOW_CTRL_ERROR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x3<br/></li>
<li><a id="L19">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_SETTINGS_TIMEOUT</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x4<br/></li>
<li><a id="L20">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STREAM_CLOSED</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x5<br/></li>
<li><a id="L21">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_SIZE_ERROR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x6<br/></li>
<li><a id="L22">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_REFUSED_STREAM</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x7<br/></li>
<li><a id="L23">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_CANCEL</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x8<br/></li>
<li><a id="L24">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_COMP_ERROR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x9<br/></li>
<li><a id="L25">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_CONNECT_ERROR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0xa<br/></li>
<li><a id="L26">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_ENHANCE_YOUR_CALM</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0xb<br/></li>
<li><a id="L27">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_INADEQUATE_SECURITY</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0xc<br/></li>
<li><a id="L28">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_HTTP_1_1_REQUIRED</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0xd<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* frame sizes */<br/></li>
<li><a id="L31">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_RST_STREAM_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">4<br/></li>
<li><a id="L32">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_PRIORITY_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">5<br/></li>
<li><a id="L33">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_PING_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">8<br/></li>
<li><a id="L34">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_GOAWAY_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">8<br/></li>
<li><a id="L35">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_WINDOW_UPDATE_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">4<br/></li>
<li></span><br/></li>
<li><a id="L37">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STREAM_ID_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">4<br/></li>
<li></span><br/></li>
<li><a id="L39">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_SETTINGS_PARAM_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">6<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* settings fields */<br/></li>
<li><a id="L42">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_HEADER_TABLE_SIZE_SETTING</span>&nbsp; &nbsp; </span><span class="Constant">0x1<br/></li>
<li><a id="L43">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_MAX_STREAMS_SETTING</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x3<br/></li>
<li><a id="L44">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_INIT_WINDOW_SIZE_SETTING</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">0x4<br/></li>
<li><a id="L45">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_MAX_FRAME_SIZE_SETTING</span>&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x5<br/></li>
<li></span><br/></li>
<li><a id="L47">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_FRAME_BUFFER_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">24<br/></li>
<li></span><br/></li>
<li><a id="L49">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_DEFAULT_FRAME_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="Constant">1</span><span class="PreProc"> &lt;&lt; </span><span class="Constant">14</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L51">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_ROOT</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (</span><span class="Type">void</span><span class="PreProc"> *) -</span><span class="Constant">1<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L301" title="src/http/v2/ngx_http_v2.c:301">ngx_http_v2_read_handler</a>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L392" title="src/http/v2/ngx_http_v2.c:392">ngx_http_v2_write_handler</a>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *wev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L590" title="src/http/v2/ngx_http_v2.c:590">ngx_http_v2_handle_connection</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<a href="#L650" title="src/http/v2/ngx_http_v2.c:650">ngx_http_v2_state_proxy_protocol</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L671" title="src/http/v2/ngx_http_v2.c:671">ngx_http_v2_state_preface</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L693" title="src/http/v2/ngx_http_v2.c:693">ngx_http_v2_state_preface_end</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L719" title="src/http/v2/ngx_http_v2.c:719">ngx_http_v2_state_head</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L754" title="src/http/v2/ngx_http_v2.c:754">ngx_http_v2_state_data</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L884" title="src/http/v2/ngx_http_v2.c:884">ngx_http_v2_state_read_data</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L966" title="src/http/v2/ngx_http_v2.c:966">ngx_http_v2_state_headers</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1139" title="src/http/v2/ngx_http_v2.c:1139">ngx_http_v2_state_header_block</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1239" title="src/http/v2/ngx_http_v2.c:1239">ngx_http_v2_state_field_len</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1326" title="src/http/v2/ngx_http_v2.c:1326">ngx_http_v2_state_field_huff</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1381" title="src/http/v2/ngx_http_v2.c:1381">ngx_http_v2_state_field_raw</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1426" title="src/http/v2/ngx_http_v2.c:1426">ngx_http_v2_state_field_skip</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1468" title="src/http/v2/ngx_http_v2.c:1468">ngx_http_v2_state_process_header</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1626" title="src/http/v2/ngx_http_v2.c:1626">ngx_http_v2_state_header_complete</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1663" title="src/http/v2/ngx_http_v2.c:1663">ngx_http_v2_handle_continuation</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end, <a href="ngx_http_v2.h.html#L58" title="src/http/v2/ngx_http_v2.h:58">ngx_http_v2_handler_pt</a> handler);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1725" title="src/http/v2/ngx_http_v2.c:1725">ngx_http_v2_state_priority</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1818" title="src/http/v2/ngx_http_v2.c:1818">ngx_http_v2_state_rst_stream</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1900" title="src/http/v2/ngx_http_v2.c:1900">ngx_http_v2_state_settings</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1933" title="src/http/v2/ngx_http_v2.c:1933">ngx_http_v2_state_settings_params</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1999" title="src/http/v2/ngx_http_v2.c:1999">ngx_http_v2_state_push_promise</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2010" title="src/http/v2/ngx_http_v2.c:2010">ngx_http_v2_state_ping</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2052" title="src/http/v2/ngx_http_v2.c:2052">ngx_http_v2_state_goaway</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2089" title="src/http/v2/ngx_http_v2.c:2089">ngx_http_v2_state_window_update</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2210" title="src/http/v2/ngx_http_v2.c:2210">ngx_http_v2_state_continuation</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2242" title="src/http/v2/ngx_http_v2.c:2242">ngx_http_v2_state_skip_padded</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2253" title="src/http/v2/ngx_http_v2.c:2253">ngx_http_v2_state_skip</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end, <a href="ngx_http_v2.h.html#L58" title="src/http/v2/ngx_http_v2.h:58">ngx_http_v2_handler_pt</a> handler);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2304" title="src/http/v2/ngx_http_v2.c:2304">ngx_http_v2_state_headers_save</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, u_char *end, <a href="ngx_http_v2.h.html#L58" title="src/http/v2/ngx_http_v2.h:58">ngx_http_v2_handler_pt</a> handler);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> err);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2343" title="src/http/v2/ngx_http_v2.c:2343">ngx_http_v2_parse_int</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; u_char **pos, u_char *end, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> prefix);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *<a href="#L2659" title="src/http/v2/ngx_http_v2.c:2659">ngx_http_v2_create_stream</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c);<br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a> *<a href="#L2793" title="src/http/v2/ngx_http_v2.c:2793">ngx_http_v2_get_node_by_id</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> sid, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> alloc);<br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a> *<a href="#L2838" title="src/http/v2/ngx_http_v2.c:2838">ngx_http_v2_get_closed_node</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c);<br/></li>
<li><a id="L128">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_http_v2_index_size</span>(h2scf)&nbsp; (h2scf-&gt;streams_index_mask + </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li><a id="L129">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_http_v2_index</span>(h2scf, sid)&nbsp; ((sid &gt;&gt; </span><span class="Constant">1</span><span class="PreProc">) &amp; h2scf-&gt;streams_index_mask)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2399" title="src/http/v2/ngx_http_v2.c:2399">ngx_http_v2_send_settings</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ack);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2474" title="src/http/v2/ngx_http_v2.c:2474">ngx_http_v2_settings_frame_handler</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2492" title="src/http/v2/ngx_http_v2.c:2492">ngx_http_v2_send_window_update</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> sid, <span class="Type">size_t</span> window);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2520" title="src/http/v2/ngx_http_v2.c:2520">ngx_http_v2_send_rst_stream</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> sid, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> status);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *<a href="#L2575" title="src/http/v2/ngx_http_v2.c:2575">ngx_http_v2_get_frame</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <span class="Type">size_t</span> length, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> type,<br/></li>
<li>&nbsp; &nbsp; u_char flags, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> sid);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2640" title="src/http/v2/ngx_http_v2.c:2640">ngx_http_v2_frame_handler</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2919" title="src/http/v2/ngx_http_v2.c:2919">ngx_http_v2_validate_header</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2988" title="src/http/v2/ngx_http_v2.c:2988">ngx_http_v2_pseudo_header</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3037" title="src/http/v2/ngx_http_v2.c:3037">ngx_http_v2_parse_path</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3077" title="src/http/v2/ngx_http_v2.c:3077">ngx_http_v2_parse_method</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3172" title="src/http/v2/ngx_http_v2.c:3172">ngx_http_v2_parse_scheme</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3196" title="src/http/v2/ngx_http_v2.c:3196">ngx_http_v2_parse_authority</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3241" title="src/http/v2/ngx_http_v2.c:3241">ngx_http_v2_construct_request_line</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3282" title="src/http/v2/ngx_http_v2.c:3282">ngx_http_v2_cookie</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3311" title="src/http/v2/ngx_http_v2.c:3311">ngx_http_v2_construct_cookie_header</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3401" title="src/http/v2/ngx_http_v2.c:3401">ngx_http_v2_run_request</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3589" title="src/http/v2/ngx_http_v2.c:3589">ngx_http_v2_process_request_body</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; u_char *pos, <span class="Type">size_t</span> size, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> last);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3674" title="src/http/v2/ngx_http_v2.c:3674">ngx_http_v2_filter_request_body</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3765" title="src/http/v2/ngx_http_v2.c:3765">ngx_http_v2_read_client_request_body_handler</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3889" title="src/http/v2/ngx_http_v2.c:3889">ngx_http_v2_terminate_stream</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> status);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4049" title="src/http/v2/ngx_http_v2.c:4049">ngx_http_v2_close_stream_handler</a>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4074" title="src/http/v2/ngx_http_v2.c:4074">ngx_http_v2_handle_connection_handler</a>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4102" title="src/http/v2/ngx_http_v2.c:4102">ngx_http_v2_idle_handler</a>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> status);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L4235" title="src/http/v2/ngx_http_v2.c:4235">ngx_http_v2_adjust_windows</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span> delta);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4297" title="src/http/v2/ngx_http_v2.c:4297">ngx_http_v2_set_dependency</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a> *node, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> depend, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> exclusive);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4388" title="src/http/v2/ngx_http_v2.c:4388">ngx_http_v2_node_children_update</a>(<a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a> *node);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4408" title="src/http/v2/ngx_http_v2.c:4408">ngx_http_v2_pool_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L185">&#x200c;</a><span class="Type">static</span> <a href="ngx_http_v2.h.html#L58" title="src/http/v2/ngx_http_v2.h:58">ngx_http_v2_handler_pt</a> <span class="linkable">ngx_http_v2_frame_states</span>[] = {<br/></li>
<li>&nbsp; &nbsp; <a href="#L754" title="src/http/v2/ngx_http_v2.c:754">ngx_http_v2_state_data</a>,<br/></li>
<li>&nbsp; &nbsp; <a href="#L966" title="src/http/v2/ngx_http_v2.c:966">ngx_http_v2_state_headers</a>,<br/></li>
<li>&nbsp; &nbsp; <a href="#L1725" title="src/http/v2/ngx_http_v2.c:1725">ngx_http_v2_state_priority</a>,<br/></li>
<li>&nbsp; &nbsp; <a href="#L1818" title="src/http/v2/ngx_http_v2.c:1818">ngx_http_v2_state_rst_stream</a>,<br/></li>
<li>&nbsp; &nbsp; <a href="#L1900" title="src/http/v2/ngx_http_v2.c:1900">ngx_http_v2_state_settings</a>,<br/></li>
<li>&nbsp; &nbsp; <a href="#L1999" title="src/http/v2/ngx_http_v2.c:1999">ngx_http_v2_state_push_promise</a>,<br/></li>
<li>&nbsp; &nbsp; <a href="#L2010" title="src/http/v2/ngx_http_v2.c:2010">ngx_http_v2_state_ping</a>,<br/></li>
<li>&nbsp; &nbsp; <a href="#L2052" title="src/http/v2/ngx_http_v2.c:2052">ngx_http_v2_state_goaway</a>,<br/></li>
<li>&nbsp; &nbsp; <a href="#L2089" title="src/http/v2/ngx_http_v2.c:2089">ngx_http_v2_state_window_update</a>,<br/></li>
<li>&nbsp; &nbsp; <a href="#L2210" title="src/http/v2/ngx_http_v2.c:2210">ngx_http_v2_state_continuation</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><a id="L198">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_FRAME_STATES</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; (</span><span class="Statement">sizeof</span><span class="PreProc">(<a href="#L185" title="src/http/v2/ngx_http_v2.c:185">ngx_http_v2_frame_states</a>) / </span><span class="Statement">sizeof</span><span class="PreProc">(<a href="ngx_http_v2.h.html#L58" title="src/http/v2/ngx_http_v2.h:58">ngx_http_v2_handler_pt</a>))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L203">&#x200c;</a></span><span class="linkable">ngx_http_v2_init</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_palloc.h.html#L32" title="src/core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; &nbsp;&nbsp; *hc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; &nbsp; *h2scf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L20" title="src/http/v2/ngx_http_v2_module.h:20">ngx_http_v2_main_conf_t</a>&nbsp;&nbsp; *h2mcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; hc = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;init http2 connection&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;processing HTTP/2 connection&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2mcf = <a href="../ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(hc-&gt;conf_ctx, <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2mcf-&gt;recv_buffer == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2mcf-&gt;recv_buffer = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(<a href="../../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2mcf-&gt;recv_buffer_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h2mcf-&gt;recv_buffer == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(c-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;connection = c;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;http_connection = hc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;send_window = <a href="ngx_http_v2.h.html#L50" title="src/http/v2/ngx_http_v2.h:50">NGX_HTTP_V2_DEFAULT_WINDOW</a>;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;recv_window = <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;init_window = <a href="ngx_http_v2.h.html#L50" title="src/http/v2/ngx_http_v2.h:50">NGX_HTTP_V2_DEFAULT_WINDOW</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;frame_size = <a href="#L49" title="src/http/v2/ngx_http_v2.c:49">NGX_HTTP_V2_DEFAULT_FRAME_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(hc-&gt;conf_ctx, <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;pool = <a href="../../core/ngx_palloc.c.html#L20" title="src/core/ngx_palloc.c:20">ngx_create_pool</a>(h2scf-&gt;pool_size, h2c-&gt;connection-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="../../core/ngx_palloc.c.html#L315" title="src/core/ngx_palloc.c:315">ngx_pool_cleanup_add</a>(c-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L4408" title="src/http/v2/ngx_http_v2.c:4408">ngx_http_v2_pool_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;streams_index = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(c-&gt;pool, <a href="#L128" title="src/http/v2/ngx_http_v2.c:128">ngx_http_v2_index_size</a>(h2scf)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * <span class="Statement">sizeof</span>(<a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a> *));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;streams_index == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2399" title="src/http/v2/ngx_http_v2.c:2399">ngx_http_v2_send_settings</a>(h2c, <span class="Constant">0</span>) == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2492" title="src/http/v2/ngx_http_v2.c:2492">ngx_http_v2_send_window_update</a>(h2c, <span class="Constant">0</span>, <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; - <a href="ngx_http_v2.h.html#L50" title="src/http/v2/ngx_http_v2.h:50">NGX_HTTP_V2_DEFAULT_WINDOW</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.handler = hc-&gt;proxy_protocol ? <a href="#L650" title="src/http/v2/ngx_http_v2.c:650">ngx_http_v2_state_proxy_protocol</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : <a href="#L671" title="src/http/v2/ngx_http_v2.c:671">ngx_http_v2_state_preface</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;h2c-&gt;waiting);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;h2c-&gt;posted);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;h2c-&gt;dependencies);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;h2c-&gt;closed);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;data = h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler = <a href="#L301" title="src/http/v2/ngx_http_v2.c:301">ngx_http_v2_read_handler</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L392" title="src/http/v2/ngx_http_v2.c:392">ngx_http_v2_write_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L301" title="src/http/v2/ngx_http_v2.c:301">ngx_http_v2_read_handler</a>(rev);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L301">&#x200c;</a></span><span class="linkable">ngx_http_v2_read_handler</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p, *end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; available;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L20" title="src/http/v2/ngx_http_v2_module.h:20">ngx_http_v2_main_conf_t</a>&nbsp;&nbsp; *h2mcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; h2c = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <a href="../../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http2 read handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;blocked = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2mcf = <a href="../ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; available = h2mcf-&gt;recv_buffer_size - <span class="Constant">2</span> * <a href="ngx_http_v2.h.html#L19" title="src/http/v2/ngx_http_v2.h:19">NGX_HTTP_V2_STATE_BUFFER_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = h2mcf-&gt;recv_buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(p, h2c-&gt;state.buffer, <a href="ngx_http_v2.h.html#L19" title="src/http/v2/ngx_http_v2.h:19">NGX_HTTP_V2_STATE_BUFFER_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end = p + h2c-&gt;state.buffer_used;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = c-&gt;recv(c, end, available);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span> &amp;&amp; (h2c-&gt;state.incomplete || h2c-&gt;processing)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client prematurely closed connection&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span> || n == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.buffer_used = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.incomplete = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = h2c-&gt;state.handler(h2c, p, end);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (p != end);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (rev-&gt;ready);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;last_out &amp;&amp; <a href="#L453" title="src/http/v2/ngx_http_v2.c:453">ngx_http_v2_send_output_queue</a>(h2c) == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;blocked = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;processing) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(rev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L590" title="src/http/v2/ngx_http_v2.c:590">ngx_http_v2_handle_connection</a>(h2c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L392">&#x200c;</a></span><span class="linkable">ngx_http_v2_write_handler</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *wev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = wev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; h2c = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 write event timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http2 write handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;blocked = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L453" title="src/http/v2/ngx_http_v2.c:453">ngx_http_v2_send_output_queue</a>(h2c);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (!<a href="../../core/ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;h2c-&gt;posted)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="../../core/ngx_queue.h.html#L50" title="src/core/ngx_queue.h:50">ngx_queue_head</a>(&amp;h2c-&gt;posted);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream = <a href="../../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;handled = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;run http2 stream </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, stream-&gt;node-&gt;id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev = stream-&gt;request-&gt;connection-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;active = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;handler(wev);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;blocked = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L590" title="src/http/v2/ngx_http_v2.c:590">ngx_http_v2_handle_connection</a>(h2c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L453">&#x200c;</a><span class="linkable">ngx_http_v2_send_output_queue</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp;&nbsp; *out, *frame, *fn;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = h2c-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev = c-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; out = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (frame = h2c-&gt;last_out; frame; frame = fn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;last-&gt;next = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = frame-&gt;first;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fn = frame-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;next = out;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L148" title="src/core/ngx_log.h:148">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 frame out: </span><span class="Special">%p</span><span class="Constant"> sid:</span><span class="Special">%u</span><span class="Constant">i bl:</span><span class="Special">%d</span><span class="Constant"> len:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; out, out-&gt;stream ? out-&gt;stream-&gt;node-&gt;id : <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; out-&gt;blocked, out-&gt;length);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = c-&gt;send_chain(c, cl, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <a href="../../core/ngx_buf.h.html#L131" title="src/core/ngx_buf.h:131">NGX_CHAIN_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../event/ngx_event.c.html#L332" title="src/event/ngx_event.c:332">ngx_handle_write_event</a>(wev, clcf-&gt;send_lowat) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;tcp_nopush == NGX_TCP_NOPUSH_SET) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/win32/ngx_socket.c.html#L31" title="src/os/win32/ngx_socket.c:31">ngx_tcp_push</a>(c-&gt;fd) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, <a href="../../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>, <a href="../../os/win32/ngx_socket.h.html#L204" title="src/os/win32/ngx_socket.h:204">ngx_tcp_push_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;tcp_nopush = NGX_TCP_NOPUSH_UNSET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay = <a href="../../os/win32/ngx_win32_init.c.html#L18" title="src/os/win32/ngx_win32_init.c:18">ngx_tcp_nodelay_and_tcp_nopush</a> ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tcp_nodelay<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; clcf-&gt;tcp_nodelay<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; c-&gt;tcp_nodelay == NGX_TCP_NODELAY_UNSET)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;tcp_nodelay&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (setsockopt(c-&gt;fd, IPPROTO_TCP, TCP_NODELAY,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">const</span> <span class="Type">void</span> *) &amp;tcp_nodelay, <span class="Statement">sizeof</span>(<span class="Type">int</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li><span class="PreProc">#if (NGX_SOLARIS)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Solaris returns EINVAL if a socket has been shut down */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log_error = NGX_ERROR_IGNORE_EINVAL;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, <a href="../../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;setsockopt(TCP_NODELAY) failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log_error = NGX_ERROR_INFO;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;tcp_nodelay = NGX_TCP_NODELAY_SET;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(wev, clcf-&gt;send_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(wev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( <span class="Comment">/* void */</span> ; out; out = fn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fn = out-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (out-&gt;handler(h2c, out) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;blocked = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L148" title="src/core/ngx_log.h:148">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 frame sent: </span><span class="Special">%p</span><span class="Constant"> sid:</span><span class="Special">%u</span><span class="Constant">i bl:</span><span class="Special">%d</span><span class="Constant"> len:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; out, out-&gt;stream ? out-&gt;stream-&gt;node-&gt;id : <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; out-&gt;blocked, out-&gt;length);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( <span class="Comment">/* void */</span> ; out; out = fn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fn = out-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;next = frame;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame = out;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;last_out = frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">error</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!h2c-&gt;blocked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(wev, &amp;<a href="../../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L590">&#x200c;</a></span><span class="linkable">ngx_http_v2_handle_connection</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; *h2scf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;last_out || h2c-&gt;processing) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = h2c-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;buffered) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.incomplete) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(c-&gt;read, h2scf-&gt;recv_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../os/win32/ngx_process_cycle.c.html#L38" title="src/os/win32/ngx_process_cycle.c:38">ngx_terminate</a> || <a href="../../os/win32/ngx_process_cycle.c.html#L42" title="src/os/win32/ngx_process_cycle.c:42">ngx_exiting</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(h2c-&gt;pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;pool = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;free_frames = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;free_fake_connections = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event_openssl.c.html#L1872" title="src/event/ngx_event_openssl.c:1872">ngx_ssl_free_buffer</a>(c);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c-&gt;destroyed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;idle = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="../ngx_http_request.c.html#L3311" title="src/http/ngx_http_request.c:3311">ngx_http_empty_handler</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L4102" title="src/http/v2/ngx_http_v2.c:4102">ngx_http_v2_idle_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(c-&gt;write);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(c-&gt;read, h2scf-&gt;idle_timeout);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L650">&#x200c;</a><span class="linkable">ngx_http_v2_state_proxy_protocol</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a>&nbsp; *log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log = h2c-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; log-&gt;action = <span class="Constant">&quot;reading PROXY protocol&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos = <a href="../../core/ngx_proxy_protocol.c.html#L13" title="src/core/ngx_proxy_protocol.c:13">ngx_proxy_protocol_read</a>(h2c-&gt;connection, pos, end);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log-&gt;action = <span class="Constant">&quot;processing HTTP/2 connection&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pos == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L671" title="src/http/v2/ngx_http_v2.c:671">ngx_http_v2_state_preface</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L671">&#x200c;</a><span class="linkable">ngx_http_v2_state_preface</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> u_char preface[] = <span class="Constant">&quot;PRI * HTTP/2.0</span><span class="Special">\r\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (end - pos) &lt; <span class="Statement">sizeof</span>(preface) - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end, <a href="#L671" title="src/http/v2/ngx_http_v2.c:671">ngx_http_v2_state_preface</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(pos, preface, <span class="Statement">sizeof</span>(preface) - <span class="Constant">1</span>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid http2 connection preface </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(preface) - <span class="Constant">1</span>, pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L693" title="src/http/v2/ngx_http_v2.c:693">ngx_http_v2_state_preface_end</a>(h2c, pos + <span class="Statement">sizeof</span>(preface) - <span class="Constant">1</span>, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L693">&#x200c;</a><span class="linkable">ngx_http_v2_state_preface_end</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> u_char preface[] = <span class="Constant">&quot;</span><span class="Special">\r\n</span><span class="Constant">SM</span><span class="Special">\r\n\r\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (end - pos) &lt; <span class="Statement">sizeof</span>(preface) - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L693" title="src/http/v2/ngx_http_v2.c:693">ngx_http_v2_state_preface_end</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(pos, preface, <span class="Statement">sizeof</span>(preface) - <span class="Constant">1</span>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid http2 connection preface </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(preface) - <span class="Constant">1</span>, pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 preface verified&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L719" title="src/http/v2/ngx_http_v2.c:719">ngx_http_v2_state_head</a>(h2c, pos + <span class="Statement">sizeof</span>(preface) - <span class="Constant">1</span>, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L719">&#x200c;</a><span class="linkable">ngx_http_v2_state_head</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos, u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp; &nbsp; head;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; type;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end - pos &lt; <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end, <a href="#L719" title="src/http/v2/ngx_http_v2.c:719">ngx_http_v2_state_head</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; head = <a href="ngx_http_v2.h.html#L295" title="src/http/v2/ngx_http_v2.h:295">ngx_http_v2_parse_uint32</a>(pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.length = <a href="ngx_http_v2.h.html#L305" title="src/http/v2/ngx_http_v2.h:305">ngx_http_v2_parse_length</a>(head);<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.flags = pos[<span class="Constant">4</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.sid = <a href="ngx_http_v2.h.html#L307" title="src/http/v2/ngx_http_v2.h:307">ngx_http_v2_parse_sid</a>(&amp;pos[<span class="Constant">5</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos += <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; type = <a href="ngx_http_v2.h.html#L306" title="src/http/v2/ngx_http_v2.h:306">ngx_http_v2_parse_type</a>(head);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L148" title="src/core/ngx_log.h:148">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;process http2 frame type:</span><span class="Special">%u</span><span class="Constant">i f:</span><span class="Special">%X</span><span class="Constant">d l:</span><span class="Special">%u</span><span class="Constant">z sid:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, h2c-&gt;state.flags, h2c-&gt;state.length, h2c-&gt;state.sid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (type &gt;= <a href="#L198" title="src/http/v2/ngx_http_v2.c:198">NGX_HTTP_V2_FRAME_STATES</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 frame with unknown type </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, type);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2253" title="src/http/v2/ngx_http_v2.c:2253">ngx_http_v2_state_skip</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L185" title="src/http/v2/ngx_http_v2.c:185">ngx_http_v2_frame_states</a>[type](h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L754">&#x200c;</a><span class="linkable">ngx_http_v2_state_data</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos, u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; *stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L46" title="src/http/v2/ngx_http_v2.h:46">NGX_HTTP_V2_PADDED_FLAG</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent padded DATA frame &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with incorrect length: 0&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (end - pos == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L754" title="src/http/v2/ngx_http_v2.c:754">ngx_http_v2_state_data</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.padding = *pos++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.padding &gt; h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent padded DATA frame &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with incorrect length: </span><span class="Special">%u</span><span class="Constant">z, padding: </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length, h2c-&gt;state.padding);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length -= h2c-&gt;state.padding;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 DATA frame&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length &gt; h2c-&gt;recv_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client violated connection flow control: &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;received DATA frame length </span><span class="Special">%u</span><span class="Constant">z, available window </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length, h2c-&gt;recv_window);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L18" title="src/http/v2/ngx_http_v2.c:18">NGX_HTTP_V2_FLOW_CTRL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;recv_window -= h2c-&gt;state.length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;recv_window &lt; <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a> / <span class="Constant">4</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2492" title="src/http/v2/ngx_http_v2.c:2492">ngx_http_v2_send_window_update</a>(h2c, <span class="Constant">0</span>, <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; - h2c-&gt;recv_window)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;recv_window = <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = <a href="#L2793" title="src/http/v2/ngx_http_v2.c:2793">ngx_http_v2_get_node_by_id</a>(h2c, h2c-&gt;state.sid, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span> || node-&gt;stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;unknown http2 stream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2242" title="src/http/v2/ngx_http_v2.c:2242">ngx_http_v2_state_skip_padded</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = node-&gt;stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length &gt; stream-&gt;recv_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client violated flow control for stream </span><span class="Special">%u</span><span class="Constant">i: &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;received DATA frame length </span><span class="Special">%u</span><span class="Constant">z, available window </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node-&gt;id, h2c-&gt;state.length, stream-&gt;recv_window);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3889" title="src/http/v2/ngx_http_v2.c:3889">ngx_http_v2_terminate_stream</a>(h2c, stream,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L18" title="src/http/v2/ngx_http_v2.c:18">NGX_HTTP_V2_FLOW_CTRL_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2242" title="src/http/v2/ngx_http_v2.c:2242">ngx_http_v2_state_skip_padded</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;recv_window -= h2c-&gt;state.length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;no_flow_control<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; stream-&gt;recv_window &lt; <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a> / <span class="Constant">4</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2492" title="src/http/v2/ngx_http_v2.c:2492">ngx_http_v2_send_window_update</a>(h2c, node-&gt;id,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; - stream-&gt;recv_window)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;recv_window = <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;in_closed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent DATA frame for half-closed stream </span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node-&gt;id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3889" title="src/http/v2/ngx_http_v2.c:3889">ngx_http_v2_terminate_stream</a>(h2c, stream,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L20" title="src/http/v2/ngx_http_v2.c:20">NGX_HTTP_V2_STREAM_CLOSED</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2242" title="src/http/v2/ngx_http_v2.c:2242">ngx_http_v2_state_skip_padded</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.stream = stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L884" title="src/http/v2/ngx_http_v2.c:884">ngx_http_v2_state_read_data</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L884">&#x200c;</a><span class="linkable">ngx_http_v2_state_read_data</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; *h2scf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = h2c-&gt;state.stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2242" title="src/http/v2/ngx_http_v2.c:2242">ngx_http_v2_state_skip_padded</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;skip_data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;skipping http2 DATA frame&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2242" title="src/http/v2/ngx_http_v2.c:2242">ngx_http_v2_state_skip_padded</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = end - pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt;= h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = h2c-&gt;state.length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;in_closed&nbsp; = h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L44" title="src/http/v2/ngx_http_v2.h:44">NGX_HTTP_V2_END_STREAM_FLAG</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = stream-&gt;request;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L3589" title="src/http/v2/ngx_http_v2.c:3589">ngx_http_v2_process_request_body</a>(r, pos, size, stream-&gt;in_closed);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = stream-&gt;preread;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf = <a href="../../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(r-&gt;pool, h2scf-&gt;preread_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;preread = buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &gt; (<span class="Type">size_t</span>) (buf-&gt;end - buf-&gt;last)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;http2 preread buffer overflow&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(buf-&gt;last, pos, size);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos += size;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.length -= size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L884" title="src/http/v2/ngx_http_v2.c:884">ngx_http_v2_state_read_data</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.padding) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2242" title="src/http/v2/ngx_http_v2.c:2242">ngx_http_v2_state_skip_padded</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L966">&#x200c;</a><span class="linkable">ngx_http_v2_state_headers</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; padded, priority, depend, dependency, excl, weight;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; status;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; &nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; *h2scf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; padded = h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L46" title="src/http/v2/ngx_http_v2.h:46">NGX_HTTP_V2_PADDED_FLAG</a>;<br/></li>
<li>&nbsp; &nbsp; priority = h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L47" title="src/http/v2/ngx_http_v2.h:47">NGX_HTTP_V2_PRIORITY_FLAG</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (padded) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (priority) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size += <span class="Statement">sizeof</span>(<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>) + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length &lt; size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent HEADERS frame with incorrect length </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length == size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent HEADERS frame with empty header block&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (end - pos) &lt; size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L966" title="src/http/v2/ngx_http_v2.c:966">ngx_http_v2_state_headers</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.length -= size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (padded) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.padding = *pos++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.padding &gt; h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent padded HEADERS frame &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with incorrect length: </span><span class="Special">%u</span><span class="Constant">z, padding: </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length, h2c-&gt;state.padding);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length -= h2c-&gt;state.padding;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; depend = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; excl = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; weight = <span class="Constant">16</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (priority) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dependency = <a href="ngx_http_v2.h.html#L295" title="src/http/v2/ngx_http_v2.h:295">ngx_http_v2_parse_uint32</a>(pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; depend = dependency &amp; <span class="Constant">0x7fffffff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; excl = dependency &gt;&gt; <span class="Constant">31</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; weight = pos[<span class="Constant">4</span>] + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos += <span class="Statement">sizeof</span>(<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>) + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L148" title="src/core/ngx_log.h:148">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 HEADERS frame sid:</span><span class="Special">%u</span><span class="Constant">i on </span><span class="Special">%u</span><span class="Constant">i excl:</span><span class="Special">%u</span><span class="Constant">i weight:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h2c-&gt;state.sid, depend, excl, weight);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.sid % <span class="Constant">2</span> == <span class="Constant">0</span> || h2c-&gt;state.sid &lt;= h2c-&gt;last_sid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent HEADERS frame with incorrect identifier &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%u</span><span class="Constant">i, the last was </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, h2c-&gt;state.sid, h2c-&gt;last_sid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;last_sid = h2c-&gt;state.sid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.pool = <a href="../../core/ngx_palloc.c.html#L20" title="src/core/ngx_palloc.c:20">ngx_create_pool</a>(<span class="Constant">1024</span>, h2c-&gt;connection-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (depend == h2c-&gt;state.sid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent HEADERS frame for stream </span><span class="Special">%u</span><span class="Constant">i &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with incorrect dependency&quot;</span>, h2c-&gt;state.sid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> rst_stream;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.header_limit = h2scf-&gt;max_header_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;processing &gt;= h2scf-&gt;concurrent_streams) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;concurrent streams exceeded </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, h2c-&gt;processing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L22" title="src/http/v2/ngx_http_v2.c:22">NGX_HTTP_V2_REFUSED_STREAM</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> rst_stream;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!h2c-&gt;settings_ack<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; !(h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L44" title="src/http/v2/ngx_http_v2.h:44">NGX_HTTP_V2_END_STREAM_FLAG</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; h2scf-&gt;preread_size &lt; <a href="ngx_http_v2.h.html#L50" title="src/http/v2/ngx_http_v2.h:50">NGX_HTTP_V2_DEFAULT_WINDOW</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent stream with data &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;before settings were acknowledged&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L22" title="src/http/v2/ngx_http_v2.c:22">NGX_HTTP_V2_REFUSED_STREAM</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> rst_stream;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = <a href="#L2793" title="src/http/v2/ngx_http_v2.c:2793">ngx_http_v2_get_node_by_id</a>(h2c, h2c-&gt;state.sid, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;parent) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;node-&gt;reuse);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;closed_nodes--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = <a href="#L2659" title="src/http/v2/ngx_http_v2.c:2659">ngx_http_v2_create_stream</a>(h2c);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.stream = stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;pool = h2c-&gt;state.pool;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.keep_pool = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;request-&gt;request_length = h2c-&gt;state.length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;in_closed = h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L44" title="src/http/v2/ngx_http_v2.h:44">NGX_HTTP_V2_END_STREAM_FLAG</a>;<br/></li>
<li>&nbsp; &nbsp; stream-&gt;node = node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;stream = stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (priority || node-&gt;parent == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node-&gt;weight = weight;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4297" title="src/http/v2/ngx_http_v2.c:4297">ngx_http_v2_set_dependency</a>(h2c, node, depend, excl);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1139" title="src/http/v2/ngx_http_v2.c:1139">ngx_http_v2_state_header_block</a>(h2c, pos, end);<br/></li>
<li><br/></li>
<li><span class="Statement">rst_stream</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2520" title="src/http/v2/ngx_http_v2.c:2520">ngx_http_v2_send_rst_stream</a>(h2c, h2c-&gt;state.sid, status) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1139" title="src/http/v2/ngx_http_v2.c:1139">ngx_http_v2_state_header_block</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1139">&#x200c;</a><span class="linkable">ngx_http_v2_state_header_block</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; ch;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp;&nbsp; value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; indexed, size_update, prefix;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end - pos &lt; <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2304" title="src/http/v2/ngx_http_v2.c:2304">ngx_http_v2_state_headers_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1139" title="src/http/v2/ngx_http_v2.c:1139">ngx_http_v2_state_header_block</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L45" title="src/http/v2/ngx_http_v2.h:45">NGX_HTTP_V2_END_HEADERS_FLAG</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; h2c-&gt;state.length &lt; <a href="ngx_http_v2.h.html#L23" title="src/http/v2/ngx_http_v2.h:23">NGX_HTTP_V2_INT_OCTETS</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1663" title="src/http/v2/ngx_http_v2.c:1663">ngx_http_v2_handle_continuation</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1139" title="src/http/v2/ngx_http_v2.c:1139">ngx_http_v2_state_header_block</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size_update = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; indexed = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ch = *pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ch &gt;= (<span class="Constant">1</span> &lt;&lt; <span class="Constant">7</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* indexed header field */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; indexed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prefix = <a href="ngx_http_v2.h.html#L289" title="src/http/v2/ngx_http_v2.h:289">ngx_http_v2_prefix</a>(<span class="Constant">7</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (ch &gt;= (<span class="Constant">1</span> &lt;&lt; <span class="Constant">6</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* literal header field with incremental indexing */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.index = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prefix = <a href="ngx_http_v2.h.html#L289" title="src/http/v2/ngx_http_v2.h:289">ngx_http_v2_prefix</a>(<span class="Constant">6</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (ch &gt;= (<span class="Constant">1</span> &lt;&lt; <span class="Constant">5</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* dynamic table size update */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; size_update = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prefix = <a href="ngx_http_v2.h.html#L289" title="src/http/v2/ngx_http_v2.h:289">ngx_http_v2_prefix</a>(<span class="Constant">5</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (ch &gt;= (<span class="Constant">1</span> &lt;&lt; <span class="Constant">4</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* literal header field never indexed */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; prefix = <a href="ngx_http_v2.h.html#L289" title="src/http/v2/ngx_http_v2.h:289">ngx_http_v2_prefix</a>(<span class="Constant">4</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* literal header field without indexing */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; prefix = <a href="ngx_http_v2.h.html#L289" title="src/http/v2/ngx_http_v2.h:289">ngx_http_v2_prefix</a>(<span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = <a href="#L2343" title="src/http/v2/ngx_http_v2.c:2343">ngx_http_v2_parse_int</a>(h2c, &amp;pos, end, prefix);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (value &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (value == <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2304" title="src/http/v2/ngx_http_v2.c:2304">ngx_http_v2_state_headers_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1139" title="src/http/v2/ngx_http_v2.c:1139">ngx_http_v2_state_header_block</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (value == <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent header block with too long </span><span class="Special">%s</span><span class="Constant"> value&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_update ? <span class="Constant">&quot;size update&quot;</span> : <span class="Constant">&quot;header index&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L24" title="src/http/v2/ngx_http_v2.c:24">NGX_HTTP_V2_COMP_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent header block with incorrect length&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (indexed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_v2_table.c.html#L90" title="src/http/v2/ngx_http_v2_table.c:90">ngx_http_v2_get_indexed_header</a>(h2c, value, <span class="Constant">0</span>) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L24" title="src/http/v2/ngx_http_v2.c:24">NGX_HTTP_V2_COMP_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1468" title="src/http/v2/ngx_http_v2.c:1468">ngx_http_v2_state_process_header</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size_update) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_v2_table.c.html#L322" title="src/http/v2/ngx_http_v2_table.c:322">ngx_http_v2_table_size</a>(h2c, value) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L24" title="src/http/v2/ngx_http_v2.c:24">NGX_HTTP_V2_COMP_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1626" title="src/http/v2/ngx_http_v2.c:1626">ngx_http_v2_state_header_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (value == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.parse_name = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="ngx_http_v2_table.c.html#L90" title="src/http/v2/ngx_http_v2_table.c:90">ngx_http_v2_get_indexed_header</a>(h2c, value, <span class="Constant">1</span>) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L24" title="src/http/v2/ngx_http_v2.c:24">NGX_HTTP_V2_COMP_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.parse_value = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1239" title="src/http/v2/ngx_http_v2.c:1239">ngx_http_v2_state_field_len</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1239">&#x200c;</a><span class="linkable">ngx_http_v2_state_field_len</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; alloc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; huff;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; *h2scf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L45" title="src/http/v2/ngx_http_v2.h:45">NGX_HTTP_V2_END_HEADERS_FLAG</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; h2c-&gt;state.length &lt; <a href="ngx_http_v2.h.html#L23" title="src/http/v2/ngx_http_v2.h:23">NGX_HTTP_V2_INT_OCTETS</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1663" title="src/http/v2/ngx_http_v2.c:1663">ngx_http_v2_handle_continuation</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1239" title="src/http/v2/ngx_http_v2.c:1239">ngx_http_v2_state_field_len</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length &lt; <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent header block with incorrect length&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end - pos &lt; <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2304" title="src/http/v2/ngx_http_v2.c:2304">ngx_http_v2_state_headers_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1239" title="src/http/v2/ngx_http_v2.c:1239">ngx_http_v2_state_field_len</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; huff = *pos &gt;&gt; <span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; len = <a href="#L2343" title="src/http/v2/ngx_http_v2.c:2343">ngx_http_v2_parse_int</a>(h2c, &amp;pos, end, <a href="ngx_http_v2.h.html#L289" title="src/http/v2/ngx_http_v2.h:289">ngx_http_v2_prefix</a>(<span class="Constant">7</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2304" title="src/http/v2/ngx_http_v2.c:2304">ngx_http_v2_state_headers_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1239" title="src/http/v2/ngx_http_v2.c:1239">ngx_http_v2_state_field_len</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent header field with too long length value&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L24" title="src/http/v2/ngx_http_v2.c:24">NGX_HTTP_V2_COMP_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent header block with incorrect length&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 hpack </span><span class="Special">%s</span><span class="Constant"> string length: </span><span class="Special">%i</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; huff ? <span class="Constant">&quot;encoded&quot;</span> : <span class="Constant">&quot;raw&quot;</span>, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) len &gt; h2scf-&gt;max_field_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client exceeded http2_max_field_size limit&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L26" title="src/http/v2/ngx_http_v2.c:26">NGX_HTTP_V2_ENHANCE_YOUR_CALM</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.field_rest = len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.stream == <span class="Constant">NULL</span> &amp;&amp; !h2c-&gt;state.index) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1426" title="src/http/v2/ngx_http_v2.c:1426">ngx_http_v2_state_field_skip</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; alloc = (huff ? len * <span class="Constant">8</span> / <span class="Constant">5</span> : len) + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.field_start = <a href="../../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(h2c-&gt;state.pool, alloc);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.field_start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.field_end = h2c-&gt;state.field_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (huff) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1326" title="src/http/v2/ngx_http_v2.c:1326">ngx_http_v2_state_field_huff</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1381" title="src/http/v2/ngx_http_v2.c:1381">ngx_http_v2_state_field_raw</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1326">&#x200c;</a><span class="linkable">ngx_http_v2_state_field_huff</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = end - pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; h2c-&gt;state.field_rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = h2c-&gt;state.field_rest;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = h2c-&gt;state.length;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.length -= size;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.field_rest -= size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_v2_huff_decode.c.html#L2643" title="src/http/v2/ngx_http_v2_huff_decode.c:2643">ngx_http_v2_huff_decode</a>(&amp;h2c-&gt;state.field_state, pos, size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;h2c-&gt;state.field_end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.field_rest == <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;connection-&gt;log)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid encoded header field&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L24" title="src/http/v2/ngx_http_v2.c:24">NGX_HTTP_V2_COMP_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos += size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.field_rest == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *h2c-&gt;state.field_end = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1468" title="src/http/v2/ngx_http_v2.c:1468">ngx_http_v2_state_process_header</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2304" title="src/http/v2/ngx_http_v2.c:2304">ngx_http_v2_state_headers_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1326" title="src/http/v2/ngx_http_v2.c:1326">ngx_http_v2_state_field_huff</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L45" title="src/http/v2/ngx_http_v2.h:45">NGX_HTTP_V2_END_HEADERS_FLAG</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent header field with incorrect length&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1663" title="src/http/v2/ngx_http_v2.c:1663">ngx_http_v2_handle_continuation</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1326" title="src/http/v2/ngx_http_v2.c:1326">ngx_http_v2_state_field_huff</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1381">&#x200c;</a><span class="linkable">ngx_http_v2_state_field_raw</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = end - pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; h2c-&gt;state.field_rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = h2c-&gt;state.field_rest;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = h2c-&gt;state.length;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.length -= size;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.field_rest -= size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.field_end = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(h2c-&gt;state.field_end, pos, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos += size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.field_rest == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *h2c-&gt;state.field_end = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1468" title="src/http/v2/ngx_http_v2.c:1468">ngx_http_v2_state_process_header</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2304" title="src/http/v2/ngx_http_v2.c:2304">ngx_http_v2_state_headers_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1381" title="src/http/v2/ngx_http_v2.c:1381">ngx_http_v2_state_field_raw</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L45" title="src/http/v2/ngx_http_v2.h:45">NGX_HTTP_V2_END_HEADERS_FLAG</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent header field with incorrect length&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1663" title="src/http/v2/ngx_http_v2.c:1663">ngx_http_v2_handle_continuation</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1381" title="src/http/v2/ngx_http_v2.c:1381">ngx_http_v2_state_field_raw</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1426">&#x200c;</a><span class="linkable">ngx_http_v2_state_field_skip</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = end - pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; h2c-&gt;state.field_rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = h2c-&gt;state.field_rest;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = h2c-&gt;state.length;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.length -= size;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.field_rest -= size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos += size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.field_rest == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1468" title="src/http/v2/ngx_http_v2.c:1468">ngx_http_v2_state_process_header</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1426" title="src/http/v2/ngx_http_v2.c:1426">ngx_http_v2_state_field_skip</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L45" title="src/http/v2/ngx_http_v2.h:45">NGX_HTTP_V2_END_HEADERS_FLAG</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent header field with incorrect length&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1663" title="src/http/v2/ngx_http_v2.c:1663">ngx_http_v2_handle_continuation</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1426" title="src/http/v2/ngx_http_v2.c:1426">ngx_http_v2_state_field_skip</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1468">&#x200c;</a><span class="linkable">ngx_http_v2_state_process_header</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L165" title="src/http/ngx_http_request.h:165">ngx_http_header_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *hh;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *header;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp;&nbsp; *cscf;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L178" title="src/http/ngx_http_core_module.h:178">ngx_http_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> cookie = <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;cookie&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; header = &amp;h2c-&gt;state.header;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.parse_name) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.parse_name = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; header-&gt;name.len = h2c-&gt;state.field_end - h2c-&gt;state.field_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; header-&gt;name.data = h2c-&gt;state.field_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1239" title="src/http/v2/ngx_http_v2.c:1239">ngx_http_v2_state_field_len</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.parse_value) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.parse_value = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; header-&gt;value.len = h2c-&gt;state.field_end - h2c-&gt;state.field_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; header-&gt;value.data = h2c-&gt;state.field_start;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = header-&gt;name.len + header-&gt;value.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &gt; h2c-&gt;state.header_limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client exceeded http2_max_header_size limit&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L26" title="src/http/v2/ngx_http_v2.c:26">NGX_HTTP_V2_ENHANCE_YOUR_CALM</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.header_limit -= len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.index) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_v2_table.c.html#L175" title="src/http/v2/ngx_http_v2_table.c:175">ngx_http_v2_add_header</a>(h2c, header) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.index = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1626" title="src/http/v2/ngx_http_v2.c:1626">ngx_http_v2_state_header_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = h2c-&gt;state.stream-&gt;request;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> Optimization: validate headers while parsing. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2919" title="src/http/v2/ngx_http_v2.c:2919">ngx_http_v2_validate_header</a>(r, header) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3889" title="src/http/v2/ngx_http_v2.c:3889">ngx_http_v2_terminate_stream</a>(h2c, h2c-&gt;state.stream,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (header-&gt;name.data[<span class="Constant">0</span>] == <span class="Constant">':'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L2988" title="src/http/v2/ngx_http_v2.c:2988">ngx_http_v2_pseudo_header</a>(r, header);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1626" title="src/http/v2/ngx_http_v2.c:1626">ngx_http_v2_state_header_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L42" title="src/core/ngx_core.h:42">NGX_ABORT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3889" title="src/http/v2/ngx_http_v2.c:3889">ngx_http_v2_terminate_stream</a>(h2c, h2c-&gt;state.stream,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;invalid_header) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cscf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cscf-&gt;ignore_invalid_headers) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid header: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;header-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1626" title="src/http/v2/ngx_http_v2.c:1626">ngx_http_v2_state_header_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (header-&gt;name.len == cookie.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(header-&gt;name.data, cookie.data, cookie.len) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3282" title="src/http/v2/ngx_http_v2.c:3282">ngx_http_v2_cookie</a>(r, header) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1626" title="src/http/v2/ngx_http_v2.c:1626">ngx_http_v2_state_header_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h = <a href="../../core/ngx_list.c.html#L31" title="src/core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_in.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;key.len = header-&gt;name.len;<br/></li>
<li>&nbsp; &nbsp; h-&gt;key.data = header-&gt;name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> Optimization: precalculate hash and handler for indexed headers. */<br/></li>
<li></span>&nbsp; &nbsp; h-&gt;hash = <a href="../../core/ngx_hash.c.html#L611" title="src/core/ngx_hash.c:611">ngx_hash_key</a>(h-&gt;key.data, h-&gt;key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;value.len = header-&gt;value.len;<br/></li>
<li>&nbsp; &nbsp; h-&gt;value.data = header-&gt;value.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;lowcase_key = h-&gt;key.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="../ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hh = <a href="../../core/ngx_hash.c.html#L13" title="src/core/ngx_hash.c:13">ngx_hash_find</a>(&amp;cmcf-&gt;headers_in_hash, h-&gt;hash,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h-&gt;lowcase_key, h-&gt;key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hh &amp;&amp; hh-&gt;handler(r, h, hh-&gt;offset) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 http header: </span><span class="Special">\&quot;</span><span class="Constant">%V: %V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;h-&gt;key, &amp;h-&gt;value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1626" title="src/http/v2/ngx_http_v2.c:1626">ngx_http_v2_state_header_complete</a>(h2c, pos, end);<br/></li>
<li><br/></li>
<li><span class="Statement">error</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.stream = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1626" title="src/http/v2/ngx_http_v2.c:1626">ngx_http_v2_state_header_complete</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1626">&#x200c;</a><span class="linkable">ngx_http_v2_state_header_complete</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; *stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.handler = <a href="#L1139" title="src/http/v2/ngx_http_v2.c:1139">ngx_http_v2_state_header_block</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> pos;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!(h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L45" title="src/http/v2/ngx_http_v2.h:45">NGX_HTTP_V2_END_HEADERS_FLAG</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1663" title="src/http/v2/ngx_http_v2.c:1663">ngx_http_v2_handle_continuation</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1626" title="src/http/v2/ngx_http_v2.c:1626">ngx_http_v2_state_header_complete</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = h2c-&gt;state.stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3401" title="src/http/v2/ngx_http_v2.c:3401">ngx_http_v2_run_request</a>(stream-&gt;request);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!h2c-&gt;state.keep_pool) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(h2c-&gt;state.pool);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.pool = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.keep_pool = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.padding) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2242" title="src/http/v2/ngx_http_v2.c:2242">ngx_http_v2_state_skip_padded</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1663">&#x200c;</a><span class="linkable">ngx_http_v2_handle_continuation</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end, <a href="ngx_http_v2.h.html#L58" title="src/http/v2/ngx_http_v2.h:58">ngx_http_v2_handler_pt</a> handler)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp;&nbsp; len, skip;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp;&nbsp; head;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = h2c-&gt;state.length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.padding &amp;&amp; (<span class="Type">size_t</span>) (end - pos) &gt; len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; skip = <a href="../../core/ngx_core.h.html#L102" title="src/core/ngx_core.h:102">ngx_min</a>(h2c-&gt;state.padding, (end - pos) - len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.padding -= skip;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos += skip;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L139" title="src/core/ngx_string.h:139">ngx_memmove</a>(pos, p, len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (end - pos) &lt; len + <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2304" title="src/http/v2/ngx_http_v2.c:2304">ngx_http_v2_state_headers_save</a>(h2c, pos, end, handler);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = pos + len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; head = <a href="ngx_http_v2.h.html#L295" title="src/http/v2/ngx_http_v2.h:295">ngx_http_v2_parse_uint32</a>(p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_v2.h.html#L306" title="src/http/v2/ngx_http_v2.h:306">ngx_http_v2_parse_type</a>(head) != <a href="ngx_http_v2.h.html#L39" title="src/http/v2/ngx_http_v2.h:39">NGX_HTTP_V2_CONTINUATION_FRAME</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;client sent inappropriate frame while CONTINUATION was expected&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.flags |= p[<span class="Constant">4</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.sid != <a href="ngx_http_v2.h.html#L307" title="src/http/v2/ngx_http_v2.h:307">ngx_http_v2_parse_sid</a>(&amp;p[<span class="Constant">5</span>])) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent CONTINUATION frame with incorrect identifier&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = pos;<br/></li>
<li>&nbsp; &nbsp; pos += <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(pos, p, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <a href="ngx_http_v2.h.html#L305" title="src/http/v2/ngx_http_v2.h:305">ngx_http_v2_parse_length</a>(head);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.length += len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.stream-&gt;request-&gt;request_length += len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.handler = handler;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> pos;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1725">&#x200c;</a><span class="linkable">ngx_http_v2_state_priority</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; depend, dependency, excl, weight;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; *node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length != <a href="#L32" title="src/http/v2/ngx_http_v2.c:32">NGX_HTTP_V2_PRIORITY_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent PRIORITY frame with incorrect length </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end - pos &lt; <a href="#L32" title="src/http/v2/ngx_http_v2.c:32">NGX_HTTP_V2_PRIORITY_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1725" title="src/http/v2/ngx_http_v2.c:1725">ngx_http_v2_state_priority</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dependency = <a href="ngx_http_v2.h.html#L295" title="src/http/v2/ngx_http_v2.h:295">ngx_http_v2_parse_uint32</a>(pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; depend = dependency &amp; <span class="Constant">0x7fffffff</span>;<br/></li>
<li>&nbsp; &nbsp; excl = dependency &gt;&gt; <span class="Constant">31</span>;<br/></li>
<li>&nbsp; &nbsp; weight = pos[<span class="Constant">4</span>] + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos += <a href="#L32" title="src/http/v2/ngx_http_v2.c:32">NGX_HTTP_V2_PRIORITY_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L148" title="src/core/ngx_log.h:148">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 PRIORITY frame sid:</span><span class="Special">%u</span><span class="Constant">i on </span><span class="Special">%u</span><span class="Constant">i excl:</span><span class="Special">%u</span><span class="Constant">i weight:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h2c-&gt;state.sid, depend, excl, weight);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.sid == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent PRIORITY frame with incorrect identifier&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (depend == h2c-&gt;state.sid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent PRIORITY frame for stream </span><span class="Special">%u</span><span class="Constant">i &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with incorrect dependency&quot;</span>, h2c-&gt;state.sid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = <a href="#L2793" title="src/http/v2/ngx_http_v2.c:2793">ngx_http_v2_get_node_by_id</a>(h2c, h2c-&gt;state.sid, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node &amp;&amp; node-&gt;stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3889" title="src/http/v2/ngx_http_v2.c:3889">ngx_http_v2_terminate_stream</a>(h2c, node-&gt;stream,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2520" title="src/http/v2/ngx_http_v2.c:2520">ngx_http_v2_send_rst_stream</a>(h2c, h2c-&gt;state.sid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = <a href="#L2793" title="src/http/v2/ngx_http_v2.c:2793">ngx_http_v2_get_node_by_id</a>(h2c, h2c-&gt;state.sid, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;weight = weight;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;parent == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;closed_nodes++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;node-&gt;reuse);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L43" title="src/core/ngx_queue.h:43">ngx_queue_insert_tail</a>(&amp;h2c-&gt;closed, &amp;node-&gt;reuse);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4297" title="src/http/v2/ngx_http_v2.c:4297">ngx_http_v2_set_dependency</a>(h2c, node, depend, excl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1818">&#x200c;</a><span class="linkable">ngx_http_v2_state_rst_stream</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; status;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ev;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; *fc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; *stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length != <a href="#L31" title="src/http/v2/ngx_http_v2.c:31">NGX_HTTP_V2_RST_STREAM_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent RST_STREAM frame with incorrect length </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end - pos &lt; <a href="#L31" title="src/http/v2/ngx_http_v2.c:31">NGX_HTTP_V2_RST_STREAM_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1818" title="src/http/v2/ngx_http_v2.c:1818">ngx_http_v2_state_rst_stream</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; status = <a href="ngx_http_v2.h.html#L295" title="src/http/v2/ngx_http_v2.h:295">ngx_http_v2_parse_uint32</a>(pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos += <a href="#L31" title="src/http/v2/ngx_http_v2.c:31">NGX_HTTP_V2_RST_STREAM_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 RST_STREAM frame, sid:</span><span class="Special">%u</span><span class="Constant">i status:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h2c-&gt;state.sid, status);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.sid == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent RST_STREAM frame with incorrect identifier&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = <a href="#L2793" title="src/http/v2/ngx_http_v2.c:2793">ngx_http_v2_get_node_by_id</a>(h2c, h2c-&gt;state.sid, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span> || node-&gt;stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unknown http2 stream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = node-&gt;stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;in_closed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; stream-&gt;out_closed = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc = stream-&gt;request-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (status) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L23" title="src/http/v2/ngx_http_v2.c:23">NGX_HTTP_V2_CANCEL</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client canceled stream </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, h2c-&gt;state.sid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client terminated stream </span><span class="Special">%u</span><span class="Constant">i due to internal error&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.sid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client terminated stream </span><span class="Special">%u</span><span class="Constant">i with status </span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.sid, status);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ev = fc-&gt;read;<br/></li>
<li>&nbsp; &nbsp; ev-&gt;handler(ev);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1900">&#x200c;</a><span class="linkable">ngx_http_v2_state_settings</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.flags == <a href="ngx_http_v2.h.html#L43" title="src/http/v2/ngx_http_v2.h:43">NGX_HTTP_V2_ACK_FLAG</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent SETTINGS frame with the ACK flag &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;and nonzero length&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;settings_ack = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length % <a href="#L39" title="src/http/v2/ngx_http_v2.c:39">NGX_HTTP_V2_SETTINGS_PARAM_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent SETTINGS frame with incorrect length </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2399" title="src/http/v2/ngx_http_v2.c:2399">ngx_http_v2_send_settings</a>(h2c, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1933" title="src/http/v2/ngx_http_v2.c:1933">ngx_http_v2_state_settings_params</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1933">&#x200c;</a><span class="linkable">ngx_http_v2_state_settings_params</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; id, value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (end - pos &lt; <a href="#L39" title="src/http/v2/ngx_http_v2.c:39">NGX_HTTP_V2_SETTINGS_PARAM_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1933" title="src/http/v2/ngx_http_v2.c:1933">ngx_http_v2_state_settings_params</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length -= <a href="#L39" title="src/http/v2/ngx_http_v2.c:39">NGX_HTTP_V2_SETTINGS_PARAM_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; id = <a href="ngx_http_v2.h.html#L294" title="src/http/v2/ngx_http_v2.h:294">ngx_http_v2_parse_uint16</a>(pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; value = <a href="ngx_http_v2.h.html#L295" title="src/http/v2/ngx_http_v2.h:295">ngx_http_v2_parse_uint32</a>(&amp;pos[<span class="Constant">2</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (id) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="#L44" title="src/http/v2/ngx_http_v2.c:44">NGX_HTTP_V2_INIT_WINDOW_SIZE_SETTING</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (value &gt; <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent SETTINGS frame with incorrect &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;INITIAL_WINDOW_SIZE value </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L18" title="src/http/v2/ngx_http_v2.c:18">NGX_HTTP_V2_FLOW_CTRL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L4235" title="src/http/v2/ngx_http_v2.c:4235">ngx_http_v2_adjust_windows</a>(h2c, value - h2c-&gt;init_window)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;init_window = value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="#L45" title="src/http/v2/ngx_http_v2.c:45">NGX_HTTP_V2_MAX_FRAME_SIZE_SETTING</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (value &gt; <a href="ngx_http_v2.h.html#L21" title="src/http/v2/ngx_http_v2.h:21">NGX_HTTP_V2_MAX_FRAME_SIZE</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || value &lt; <a href="#L49" title="src/http/v2/ngx_http_v2.c:49">NGX_HTTP_V2_DEFAULT_FRAME_SIZE</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent SETTINGS frame with incorrect &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;MAX_FRAME_SIZE value </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;frame_size = value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos += <a href="#L39" title="src/http/v2/ngx_http_v2.c:39">NGX_HTTP_V2_SETTINGS_PARAM_SIZE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1999">&#x200c;</a><span class="linkable">ngx_http_v2_state_push_promise</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent PUSH_PROMISE frame&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2010">&#x200c;</a><span class="linkable">ngx_http_v2_state_ping</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos, u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp; *frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length != <a href="#L33" title="src/http/v2/ngx_http_v2.c:33">NGX_HTTP_V2_PING_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent PING frame with incorrect length </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end - pos &lt; <a href="#L33" title="src/http/v2/ngx_http_v2.c:33">NGX_HTTP_V2_PING_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end, <a href="#L2010" title="src/http/v2/ngx_http_v2.c:2010">ngx_http_v2_state_ping</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 PING frame, flags: </span><span class="Special">%u</span><span class="Constant">d&quot;</span>, h2c-&gt;state.flags);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.flags &amp; <a href="ngx_http_v2.h.html#L43" title="src/http/v2/ngx_http_v2.h:43">NGX_HTTP_V2_ACK_FLAG</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2253" title="src/http/v2/ngx_http_v2.c:2253">ngx_http_v2_state_skip</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = <a href="#L2575" title="src/http/v2/ngx_http_v2.c:2575">ngx_http_v2_get_frame</a>(h2c, <a href="#L33" title="src/http/v2/ngx_http_v2.c:33">NGX_HTTP_V2_PING_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L36" title="src/http/v2/ngx_http_v2.h:36">NGX_HTTP_V2_PING_FRAME</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L43" title="src/http/v2/ngx_http_v2.h:43">NGX_HTTP_V2_ACK_FLAG</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = frame-&gt;first-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(buf-&gt;last, pos, <a href="#L33" title="src/http/v2/ngx_http_v2.c:33">NGX_HTTP_V2_PING_SIZE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L247" title="src/http/v2/ngx_http_v2.h:247">ngx_http_v2_queue_blocked_frame</a>(h2c, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos + <a href="#L33" title="src/http/v2/ngx_http_v2.c:33">NGX_HTTP_V2_PING_SIZE</a>, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2052">&#x200c;</a><span class="linkable">ngx_http_v2_state_goaway</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; last_sid, error;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length &lt; <a href="#L34" title="src/http/v2/ngx_http_v2.c:34">NGX_HTTP_V2_GOAWAY_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent GOAWAY frame &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with incorrect length </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, h2c-&gt;state.length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end - pos &lt; <a href="#L34" title="src/http/v2/ngx_http_v2.c:34">NGX_HTTP_V2_GOAWAY_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end, <a href="#L2052" title="src/http/v2/ngx_http_v2.c:2052">ngx_http_v2_state_goaway</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; h2c-&gt;state.length -= <a href="#L34" title="src/http/v2/ngx_http_v2.c:34">NGX_HTTP_V2_GOAWAY_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last_sid = <a href="ngx_http_v2.h.html#L307" title="src/http/v2/ngx_http_v2.h:307">ngx_http_v2_parse_sid</a>(pos);<br/></li>
<li>&nbsp; &nbsp; error = <a href="ngx_http_v2.h.html#L295" title="src/http/v2/ngx_http_v2.h:295">ngx_http_v2_parse_uint32</a>(&amp;pos[<span class="Constant">4</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos += <a href="#L34" title="src/http/v2/ngx_http_v2.c:34">NGX_HTTP_V2_GOAWAY_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 GOAWAY frame: last sid </span><span class="Special">%u</span><span class="Constant">i, error </span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; last_sid, error);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2253" title="src/http/v2/ngx_http_v2.c:2253">ngx_http_v2_state_skip</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2089">&#x200c;</a><span class="linkable">ngx_http_v2_state_window_update</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; window;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; *stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length != <a href="#L35" title="src/http/v2/ngx_http_v2.c:35">NGX_HTTP_V2_WINDOW_UPDATE_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent WINDOW_UPDATE frame &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with incorrect length </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, h2c-&gt;state.length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L21" title="src/http/v2/ngx_http_v2.c:21">NGX_HTTP_V2_SIZE_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end - pos &lt; <a href="#L35" title="src/http/v2/ngx_http_v2.c:35">NGX_HTTP_V2_WINDOW_UPDATE_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2089" title="src/http/v2/ngx_http_v2.c:2089">ngx_http_v2_state_window_update</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; window = <a href="ngx_http_v2.h.html#L308" title="src/http/v2/ngx_http_v2.h:308">ngx_http_v2_parse_window</a>(pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pos += <a href="#L35" title="src/http/v2/ngx_http_v2.c:35">NGX_HTTP_V2_WINDOW_UPDATE_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 WINDOW_UPDATE frame sid:</span><span class="Special">%u</span><span class="Constant">i window:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h2c-&gt;state.sid, window);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.sid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = <a href="#L2793" title="src/http/v2/ngx_http_v2.c:2793">ngx_http_v2_get_node_by_id</a>(h2c, h2c-&gt;state.sid, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span> || node-&gt;stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;unknown http2 stream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream = node-&gt;stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (window &gt; (<span class="Type">size_t</span>) (<a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a> - stream-&gt;send_window)) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client violated flow control for stream </span><span class="Special">%u</span><span class="Constant">i: &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;received WINDOW_UPDATE frame &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with window increment </span><span class="Special">%u</span><span class="Constant">z &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;not allowed for window %z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.sid, window, stream-&gt;send_window);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3889" title="src/http/v2/ngx_http_v2.c:3889">ngx_http_v2_terminate_stream</a>(h2c, stream,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L18" title="src/http/v2/ngx_http_v2.c:18">NGX_HTTP_V2_FLOW_CTRL_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;send_window += window;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;exhausted) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;exhausted = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev = stream-&gt;request-&gt;connection-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;active = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;handler(wev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (window &gt; <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a> - h2c-&gt;send_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client violated connection flow control: &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;received WINDOW_UPDATE frame &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;with window increment </span><span class="Special">%u</span><span class="Constant">z &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;not allowed for window </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; window, h2c-&gt;send_window);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L18" title="src/http/v2/ngx_http_v2.c:18">NGX_HTTP_V2_FLOW_CTRL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;send_window += window;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (!<a href="../../core/ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;h2c-&gt;waiting)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="../../core/ngx_queue.h.html#L50" title="src/core/ngx_queue.h:50">ngx_queue_head</a>(&amp;h2c-&gt;waiting);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream = <a href="../../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;handled = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev = stream-&gt;request-&gt;connection-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;active = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;handler(wev);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;send_window == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2210">&#x200c;</a><span class="linkable">ngx_http_v2_state_continuation</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent unexpected CONTINUATION frame&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2221">&#x200c;</a><span class="linkable">ngx_http_v2_state_complete</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 frame complete pos:</span><span class="Special">%p</span><span class="Constant"> end:</span><span class="Special">%p</span><span class="Constant">&quot;</span>, pos, end);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pos &gt; end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;receive buffer overrun&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.stream = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.handler = <a href="#L719" title="src/http/v2/ngx_http_v2.c:719">ngx_http_v2_state_head</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> pos;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2242">&#x200c;</a><span class="linkable">ngx_http_v2_state_skip_padded</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.length += h2c-&gt;state.padding;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.padding = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2253" title="src/http/v2/ngx_http_v2.c:2253">ngx_http_v2_state_skip</a>(h2c, pos, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2253">&#x200c;</a><span class="linkable">ngx_http_v2_state_skip</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos, u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = end - pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &lt; h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 frame skip </span><span class="Special">%u</span><span class="Constant">z of </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, size, h2c-&gt;state.length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length -= size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, end, end, <a href="#L2253" title="src/http/v2/ngx_http_v2.c:2253">ngx_http_v2_state_skip</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 frame skip </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, h2c-&gt;state.length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2221" title="src/http/v2/ngx_http_v2.c:2221">ngx_http_v2_state_complete</a>(h2c, pos + h2c-&gt;state.length, end);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2275">&#x200c;</a><span class="linkable">ngx_http_v2_state_save</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos, u_char *end,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L58" title="src/http/v2/ngx_http_v2.h:58">ngx_http_v2_handler_pt</a> handler)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 frame state save pos:</span><span class="Special">%p</span><span class="Constant"> end:</span><span class="Special">%p</span><span class="Constant"> handler:</span><span class="Special">%p</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pos, end, handler);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = end - pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; <a href="ngx_http_v2.h.html#L19" title="src/http/v2/ngx_http_v2.h:19">NGX_HTTP_V2_STATE_BUFFER_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;state buffer overflow: </span><span class="Special">%u</span><span class="Constant">z bytes required&quot;</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2326" title="src/http/v2/ngx_http_v2.c:2326">ngx_http_v2_connection_error</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(h2c-&gt;state.buffer, pos, <a href="ngx_http_v2.h.html#L19" title="src/http/v2/ngx_http_v2.h:19">NGX_HTTP_V2_STATE_BUFFER_SIZE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.buffer_used = size;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.handler = handler;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;state.incomplete = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> end;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2304">&#x200c;</a><span class="linkable">ngx_http_v2_state_headers_save</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end, <a href="ngx_http_v2.h.html#L58" title="src/http/v2/ngx_http_v2.h:58">ngx_http_v2_handler_pt</a> handler)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rev;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r = h2c-&gt;state.stream-&gt;request;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev = r-&gt;connection-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!rev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, cscf-&gt;client_header_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2275" title="src/http/v2/ngx_http_v2.c:2275">ngx_http_v2_state_save</a>(h2c, pos, end, handler);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L2326">&#x200c;</a><span class="linkable">ngx_http_v2_connection_error</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> err)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 state connection error&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (err == <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../os/win32/ngx_process.h.html#L58" title="src/os/win32/ngx_process.h:58">ngx_debug_point</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, err);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2343">&#x200c;</a><span class="linkable">ngx_http_v2_parse_int</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, u_char **pos, u_char *end,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> prefix)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; *start, *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; value, octet, shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start = *pos;<br/></li>
<li>&nbsp; &nbsp; p = start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = *p++ &amp; prefix;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (value != prefix) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.length == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> value;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end - start &gt; <a href="ngx_http_v2.h.html#L23" title="src/http/v2/ngx_http_v2.h:23">NGX_HTTP_V2_INT_OCTETS</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; end = start + <a href="ngx_http_v2.h.html#L23" title="src/http/v2/ngx_http_v2.h:23">NGX_HTTP_V2_INT_OCTETS</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (shift = <span class="Constant">0</span>; p != end; shift += <span class="Constant">7</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; octet = *p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; value += (octet &amp; <span class="Constant">0x7f</span>) &lt;&lt; shift;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (octet &lt; <span class="Constant">128</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (p - start) &gt; h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.length -= p - start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *pos = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (end - start) &gt;= h2c-&gt;state.length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (end == start + <a href="ngx_http_v2.h.html#L23" title="src/http/v2/ngx_http_v2.h:23">NGX_HTTP_V2_INT_OCTETS</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2399">&#x200c;</a><span class="linkable">ngx_http_v2_send_settings</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> ack)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cl;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp;&nbsp; *h2scf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp; *frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 send SETTINGS frame ack:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, ack);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(h2c-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(h2c-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = ack ? <span class="Constant">0</span> : (<span class="Statement">sizeof</span>(<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L134" title="src/os/win32/ngx_win32_config.h:134">uint16_t</a></span>) + <span class="Statement">sizeof</span>(<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>)) * <span class="Constant">3</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = <a href="../../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(h2c-&gt;pool, <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a> + len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf = buf;<br/></li>
<li>&nbsp; &nbsp; cl-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame-&gt;first = cl;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;last = cl;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;handler = <a href="#L2474" title="src/http/v2/ngx_http_v2.c:2474">ngx_http_v2_settings_frame_handler</a>;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;stream = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; frame-&gt;length = len;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; frame-&gt;blocked = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L337" title="src/http/v2/ngx_http_v2.h:337">ngx_http_v2_write_len_and_type</a>(buf-&gt;last, len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2.h.html#L34" title="src/http/v2/ngx_http_v2.h:34">NGX_HTTP_V2_SETTINGS_FRAME</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *buf-&gt;last++ = ack ? <a href="ngx_http_v2.h.html#L43" title="src/http/v2/ngx_http_v2.h:43">NGX_HTTP_V2_ACK_FLAG</a> : <a href="ngx_http_v2.h.html#L42" title="src/http/v2/ngx_http_v2.h:42">NGX_HTTP_V2_NO_FLAG</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L340" title="src/http/v2/ngx_http_v2.h:340">ngx_http_v2_write_sid</a>(buf-&gt;last, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!ack) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L318" title="src/http/v2/ngx_http_v2.h:318">ngx_http_v2_write_uint16</a>(buf-&gt;last,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L43" title="src/http/v2/ngx_http_v2.c:43">NGX_HTTP_V2_MAX_STREAMS_SETTING</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L319" title="src/http/v2/ngx_http_v2.h:319">ngx_http_v2_write_uint32</a>(buf-&gt;last,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h2scf-&gt;concurrent_streams);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L318" title="src/http/v2/ngx_http_v2.h:318">ngx_http_v2_write_uint16</a>(buf-&gt;last,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L44" title="src/http/v2/ngx_http_v2.c:44">NGX_HTTP_V2_INIT_WINDOW_SIZE_SETTING</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L319" title="src/http/v2/ngx_http_v2.h:319">ngx_http_v2_write_uint32</a>(buf-&gt;last, h2scf-&gt;preread_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L318" title="src/http/v2/ngx_http_v2.h:318">ngx_http_v2_write_uint16</a>(buf-&gt;last,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L45" title="src/http/v2/ngx_http_v2.c:45">NGX_HTTP_V2_MAX_FRAME_SIZE_SETTING</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L319" title="src/http/v2/ngx_http_v2.h:319">ngx_http_v2_write_uint32</a>(buf-&gt;last,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2.h.html#L21" title="src/http/v2/ngx_http_v2.h:21">NGX_HTTP_V2_MAX_FRAME_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L247" title="src/http/v2/ngx_http_v2.h:247">ngx_http_v2_queue_blocked_frame</a>(h2c, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2474">&#x200c;</a><span class="linkable">ngx_http_v2_settings_frame_handler</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = frame-&gt;first-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;pos != buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L157" title="src/core/ngx_buf.h:157">ngx_free_chain</a>(h2c-&gt;pool, frame-&gt;first);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2492">&#x200c;</a><span class="linkable">ngx_http_v2_send_window_update</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> sid,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> window)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp; *frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 send WINDOW_UPDATE frame sid:</span><span class="Special">%u</span><span class="Constant">i, window:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sid, window);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = <a href="#L2575" title="src/http/v2/ngx_http_v2.c:2575">ngx_http_v2_get_frame</a>(h2c, <a href="#L35" title="src/http/v2/ngx_http_v2.c:35">NGX_HTTP_V2_WINDOW_UPDATE_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L38" title="src/http/v2/ngx_http_v2.h:38">NGX_HTTP_V2_WINDOW_UPDATE_FRAME</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L42" title="src/http/v2/ngx_http_v2.h:42">NGX_HTTP_V2_NO_FLAG</a>, sid);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = frame-&gt;first-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L319" title="src/http/v2/ngx_http_v2.h:319">ngx_http_v2_write_uint32</a>(buf-&gt;last, window);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L247" title="src/http/v2/ngx_http_v2.h:247">ngx_http_v2_queue_blocked_frame</a>(h2c, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2520">&#x200c;</a><span class="linkable">ngx_http_v2_send_rst_stream</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> sid,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> status)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp; *frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 send RST_STREAM frame sid:</span><span class="Special">%u</span><span class="Constant">i, status:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sid, status);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = <a href="#L2575" title="src/http/v2/ngx_http_v2.c:2575">ngx_http_v2_get_frame</a>(h2c, <a href="#L31" title="src/http/v2/ngx_http_v2.c:31">NGX_HTTP_V2_RST_STREAM_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L33" title="src/http/v2/ngx_http_v2.h:33">NGX_HTTP_V2_RST_STREAM_FRAME</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L42" title="src/http/v2/ngx_http_v2.h:42">NGX_HTTP_V2_NO_FLAG</a>, sid);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = frame-&gt;first-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L319" title="src/http/v2/ngx_http_v2.h:319">ngx_http_v2_write_uint32</a>(buf-&gt;last, status);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L247" title="src/http/v2/ngx_http_v2.h:247">ngx_http_v2_queue_blocked_frame</a>(h2c, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2548">&#x200c;</a><span class="linkable">ngx_http_v2_send_goaway</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> status)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp; *frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 send GOAWAY frame, status:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>, status);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = <a href="#L2575" title="src/http/v2/ngx_http_v2.c:2575">ngx_http_v2_get_frame</a>(h2c, <a href="#L34" title="src/http/v2/ngx_http_v2.c:34">NGX_HTTP_V2_GOAWAY_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L37" title="src/http/v2/ngx_http_v2.h:37">NGX_HTTP_V2_GOAWAY_FRAME</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L42" title="src/http/v2/ngx_http_v2.h:42">NGX_HTTP_V2_NO_FLAG</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = frame-&gt;first-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L340" title="src/http/v2/ngx_http_v2.h:340">ngx_http_v2_write_sid</a>(buf-&gt;last, h2c-&gt;last_sid);<br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L319" title="src/http/v2/ngx_http_v2.h:319">ngx_http_v2_write_uint32</a>(buf-&gt;last, status);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L247" title="src/http/v2/ngx_http_v2.h:247">ngx_http_v2_queue_blocked_frame</a>(h2c, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *<br/></li>
<li><a id="L2575">&#x200c;</a><span class="linkable">ngx_http_v2_get_frame</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <span class="Type">size_t</span> length,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> type, u_char flags, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> sid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *pool;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp; *frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = h2c-&gt;free_frames;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;free_frames = frame-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = frame-&gt;first-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = buf-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;blocked = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pool = h2c-&gt;pool ? h2c-&gt;pool : h2c-&gt;connection-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(pool, <span class="Statement">sizeof</span>(<a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;first = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame-&gt;first == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = <a href="../../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(pool, <a href="#L47" title="src/http/v2/ngx_http_v2.c:47">NGX_HTTP_V2_FRAME_BUFFER_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;first-&gt;buf = buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;last = frame-&gt;first;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;handler = <a href="#L2640" title="src/http/v2/ngx_http_v2.c:2640">ngx_http_v2_frame_handler</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (length &gt; <a href="#L47" title="src/http/v2/ngx_http_v2.c:47">NGX_HTTP_V2_FRAME_BUFFER_SIZE</a> - <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;requested control frame is too large: </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, length);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame-&gt;length = length;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L337" title="src/http/v2/ngx_http_v2.h:337">ngx_http_v2_write_len_and_type</a>(buf-&gt;pos, length, type);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *buf-&gt;last++ = flags;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L340" title="src/http/v2/ngx_http_v2.h:340">ngx_http_v2_write_sid</a>(buf-&gt;last, sid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> frame;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2640">&#x200c;</a><span class="linkable">ngx_http_v2_frame_handler</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = frame-&gt;first-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;pos != buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame-&gt;next = h2c-&gt;free_frames;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;free_frames = frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *<br/></li>
<li><a id="L2659">&#x200c;</a><span class="linkable">ngx_http_v2_create_stream</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *log;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rev, *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *fc;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L20" title="src/http/ngx_http.h:20">ngx_http_log_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; &nbsp; *h2scf;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc = h2c-&gt;free_fake_connections;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fc) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;free_fake_connections = fc-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev = fc-&gt;read;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev = fc-&gt;write;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; log = fc-&gt;log;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = log-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(h2c-&gt;pool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fc == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(h2c-&gt;pool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rev == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(h2c-&gt;pool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (wev == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; log = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(h2c-&gt;pool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (log == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(h2c-&gt;pool, <span class="Statement">sizeof</span>(<a href="../ngx_http.h.html#L20" title="src/http/ngx_http.h:20">ngx_http_log_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;connection = fc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;request = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;current_request = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(log, h2c-&gt;connection-&gt;log, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; log-&gt;action = <span class="Constant">&quot;reading client request headers&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(rev, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev-&gt;data = fc;<br/></li>
<li>&nbsp; &nbsp; rev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler = <a href="#L4049" title="src/http/v2/ngx_http_v2.c:4049">ngx_http_v2_close_stream_handler</a>;<br/></li>
<li>&nbsp; &nbsp; rev-&gt;log = log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(wev, rev, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev-&gt;write = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(fc, h2c-&gt;connection, <span class="Statement">sizeof</span>(<a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc-&gt;data = h2c-&gt;http_connection;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;read = rev;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;write = wev;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;sent = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;log = log;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;buffered = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;sndlowat = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;tcp_nodelay = NGX_TCP_NODELAY_DISABLED;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = <a href="../ngx_http_request.c.html#L509" title="src/http/ngx_http_request.c:509">ngx_http_create_request</a>(fc);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L42" title="src/core/ngx_string.h:42">ngx_str_set</a>(&amp;r-&gt;http_protocol, <span class="Constant">&quot;HTTP/2.0&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;http_version = <a href="../ngx_http_request.h.html#L26" title="src/http/ngx_http_request.h:26">NGX_HTTP_VERSION_20</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;valid_location = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc-&gt;data = r;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;connection-&gt;requests++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;header_in = <a href="../../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(r-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cscf-&gt;client_header_buffer_size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;header_in == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3433" title="src/http/ngx_http_request.c:3433">ngx_http_free_request</a>(r, <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_list.h.html#L37" title="src/core/ngx_list.h:37">ngx_list_init</a>(&amp;r-&gt;headers_in.headers, r-&gt;pool, <span class="Constant">20</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="../../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3433" title="src/http/ngx_http_request.c:3433">ngx_http_free_request</a>(r, <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_in.connection_type = <a href="../ngx_http_request.h.html#L45" title="src/http/ngx_http_request.h:45">NGX_HTTP_CONNECTION_CLOSE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3433" title="src/http/ngx_http_request.c:3433">ngx_http_free_request</a>(r, <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;stream = stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;request = r;<br/></li>
<li>&nbsp; &nbsp; stream-&gt;connection = h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;send_window = h2c-&gt;init_window;<br/></li>
<li>&nbsp; &nbsp; stream-&gt;recv_window = h2scf-&gt;preread_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;processing++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> stream;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a> *<br/></li>
<li><a id="L2793">&#x200c;</a><span class="linkable">ngx_http_v2_get_node_by_id</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> sid,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> alloc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; index;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; &nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; *h2scf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; index = <a href="#L129" title="src/http/v2/ngx_http_v2.c:129">ngx_http_v2_index</a>(h2scf, sid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (node = h2c-&gt;streams_index[index]; node; node = node-&gt;index) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;id == sid) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> node;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!alloc) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;closed_nodes &lt; <span class="Constant">32</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(h2c-&gt;connection-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = <a href="#L2838" title="src/http/v2/ngx_http_v2.c:2838">ngx_http_v2_get_closed_node</a>(h2c);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;id = sid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;node-&gt;children);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;index = h2c-&gt;streams_index[index];<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;streams_index[index] = node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> node;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a> *<br/></li>
<li><a id="L2838">&#x200c;</a><span class="linkable">ngx_http_v2_get_closed_node</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; weight;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q, *children;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; &nbsp; &nbsp; *node, **next, *n, *parent, *child;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; *h2scf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;closed_nodes--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; q = <a href="../../core/ngx_queue.h.html#L50" title="src/core/ngx_queue.h:50">ngx_queue_head</a>(&amp;h2c-&gt;closed);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = <a href="../../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>, reuse);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; next = &amp;h2c-&gt;streams_index[<a href="#L129" title="src/http/v2/ngx_http_v2.c:129">ngx_http_v2_index</a>(h2scf, node-&gt;id)];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = *next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == node) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *next = n-&gt;index;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; next = &amp;n-&gt;index;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;node-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; weight = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../../core/ngx_queue.h.html#L50" title="src/core/ngx_queue.h:50">ngx_queue_head</a>(&amp;node-&gt;children);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../../core/ngx_queue.h.html#L58" title="src/core/ngx_queue.h:58">ngx_queue_sentinel</a>(&amp;node-&gt;children);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../../core/ngx_queue.h.html#L62" title="src/core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; child = <a href="../../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>, queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; weight += child-&gt;weight;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; parent = node-&gt;parent;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../../core/ngx_queue.h.html#L50" title="src/core/ngx_queue.h:50">ngx_queue_head</a>(&amp;node-&gt;children);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../../core/ngx_queue.h.html#L58" title="src/core/ngx_queue.h:58">ngx_queue_sentinel</a>(&amp;node-&gt;children);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../../core/ngx_queue.h.html#L62" title="src/core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; child = <a href="../../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>, queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; child-&gt;parent = parent;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; child-&gt;weight = node-&gt;weight * child-&gt;weight / weight;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (child-&gt;weight == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; child-&gt;weight = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (parent == <a href="#L51" title="src/http/v2/ngx_http_v2.c:51">NGX_HTTP_V2_ROOT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node-&gt;rank = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node-&gt;rel_weight = <span class="Constant">1.0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; children = &amp;h2c-&gt;dependencies;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node-&gt;rank = parent-&gt;rank;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node-&gt;rel_weight = parent-&gt;rel_weight;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; children = &amp;parent-&gt;children;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4388" title="src/http/v2/ngx_http_v2.c:4388">ngx_http_v2_node_children_update</a>(node);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L96" title="src/core/ngx_queue.h:96">ngx_queue_add</a>(children, &amp;node-&gt;children);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(node, <span class="Statement">sizeof</span>(<a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> node;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2919">&#x200c;</a><span class="linkable">ngx_http_v2_validate_header</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ch;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (header-&gt;name.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;invalid_header = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = (header-&gt;name.data[<span class="Constant">0</span>] == <span class="Constant">':'</span>); i != header-&gt;name.len; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ch = header-&gt;name.data[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((ch &gt;= <span class="Constant">'a'</span> &amp;&amp; ch &lt;= <span class="Constant">'z'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || (ch == <span class="Constant">'-'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || (ch &gt;= <span class="Constant">'0'</span> &amp;&amp; ch &lt;= <span class="Constant">'9'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || (ch == <span class="Constant">'_'</span> &amp;&amp; cscf-&gt;underscores_in_headers))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Special">'\0'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">':'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid header name: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;header-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch &gt;= <span class="Constant">'A'</span> &amp;&amp; ch &lt;= <span class="Constant">'Z'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid header name: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;header-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;invalid_header = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i != header-&gt;value.len; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ch = header-&gt;value.data[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Special">'\0'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent header </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> with &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid value: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;header-&gt;name, &amp;header-&gt;value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2988">&#x200c;</a><span class="linkable">ngx_http_v2_pseudo_header</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; header-&gt;name.len--;<br/></li>
<li>&nbsp; &nbsp; header-&gt;name.data++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (header-&gt;name.len) {<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">4</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(header-&gt;name.data, <span class="Constant">&quot;path&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;path&quot;</span>) - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L3037" title="src/http/v2/ngx_http_v2.c:3037">ngx_http_v2_parse_path</a>(r, header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">6</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(header-&gt;name.data, <span class="Constant">&quot;method&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;method&quot;</span>) - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L3077" title="src/http/v2/ngx_http_v2.c:3077">ngx_http_v2_parse_method</a>(r, header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(header-&gt;name.data, <span class="Constant">&quot;scheme&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;scheme&quot;</span>) - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L3172" title="src/http/v2/ngx_http_v2.c:3172">ngx_http_v2_parse_scheme</a>(r, header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">9</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(header-&gt;name.data, <span class="Constant">&quot;authority&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;authority&quot;</span>) - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L3196" title="src/http/v2/ngx_http_v2.c:3196">ngx_http_v2_parse_authority</a>(r, header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent unknown pseudo header </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;header-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3037">&#x200c;</a><span class="linkable">ngx_http_v2_parse_path</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;unparsed_uri.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent duplicate :path header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (header-&gt;value.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent empty :path header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;uri_start = header-&gt;value.data;<br/></li>
<li>&nbsp; &nbsp; r-&gt;uri_end = header-&gt;value.data + header-&gt;value.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_parse.c.html#L1104" title="src/http/ngx_http_parse.c:1104">ngx_http_parse_uri</a>(r) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid :path header: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;header-&gt;value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_request.c.html#L1067" title="src/http/ngx_http_request.c:1067">ngx_http_process_request_uri</a>(r) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * request has been finalized already<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * in <a href="../ngx_http_request.c.html#L1067" title="src/http/ngx_http_request.c:1067">ngx_http_process_request_uri</a>()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L42" title="src/core/ngx_core.h:42">NGX_ABORT</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3077">&#x200c;</a><span class="linkable">ngx_http_v2_parse_method</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; k, len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> u_char&nbsp; *p, *m;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * This array takes less than 256 sequential bytes,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * and if typical CPU cache line size is 64 bytes,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * it is prefetched for 4 load operations.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> u_char&nbsp; &nbsp; &nbsp; method[<span class="Constant">11</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value;<br/></li>
<li>&nbsp; &nbsp; } tests[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">3</span>, <span class="Constant">&quot;<a href="../../core/ngx_sha1.c.html#L144" title="src/core/ngx_sha1.c:144">GET</a>&quot;</span>,&nbsp; &nbsp; &nbsp;&nbsp; <a href="../ngx_http_request.h.html#L29" title="src/http/ngx_http_request.h:29">NGX_HTTP_GET</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">4</span>, <span class="Constant">&quot;POST&quot;</span>,&nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L31" title="src/http/ngx_http_request.h:31">NGX_HTTP_POST</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">4</span>, <span class="Constant">&quot;HEAD&quot;</span>,&nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L30" title="src/http/ngx_http_request.h:30">NGX_HTTP_HEAD</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">7</span>, <span class="Constant">&quot;OPTIONS&quot;</span>,&nbsp;&nbsp; <a href="../ngx_http_request.h.html#L37" title="src/http/ngx_http_request.h:37">NGX_HTTP_OPTIONS</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">8</span>, <span class="Constant">&quot;PROPFIND&quot;</span>,&nbsp; <a href="../ngx_http_request.h.html#L38" title="src/http/ngx_http_request.h:38">NGX_HTTP_PROPFIND</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">3</span>, <span class="Constant">&quot;PUT&quot;</span>,&nbsp; &nbsp; &nbsp;&nbsp; <a href="../ngx_http_request.h.html#L32" title="src/http/ngx_http_request.h:32">NGX_HTTP_PUT</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">5</span>, <span class="Constant">&quot;MKCOL&quot;</span>,&nbsp; &nbsp;&nbsp; <a href="../ngx_http_request.h.html#L34" title="src/http/ngx_http_request.h:34">NGX_HTTP_MKCOL</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">6</span>, <span class="Constant">&quot;DELETE&quot;</span>,&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L33" title="src/http/ngx_http_request.h:33">NGX_HTTP_DELETE</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">4</span>, <span class="Constant">&quot;COPY&quot;</span>,&nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L35" title="src/http/ngx_http_request.h:35">NGX_HTTP_COPY</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">4</span>, <span class="Constant">&quot;MOVE&quot;</span>,&nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L36" title="src/http/ngx_http_request.h:36">NGX_HTTP_MOVE</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">9</span>, <span class="Constant">&quot;PROPPATCH&quot;</span>, <a href="../ngx_http_request.h.html#L39" title="src/http/ngx_http_request.h:39">NGX_HTTP_PROPPATCH</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">4</span>, <span class="Constant">&quot;LOCK&quot;</span>,&nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L40" title="src/http/ngx_http_request.h:40">NGX_HTTP_LOCK</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">6</span>, <span class="Constant">&quot;UNLOCK&quot;</span>,&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L41" title="src/http/ngx_http_request.h:41">NGX_HTTP_UNLOCK</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">5</span>, <span class="Constant">&quot;PATCH&quot;</span>,&nbsp; &nbsp;&nbsp; <a href="../ngx_http_request.h.html#L42" title="src/http/ngx_http_request.h:42">NGX_HTTP_PATCH</a> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">5</span>, <span class="Constant">&quot;TRACE&quot;</span>,&nbsp; &nbsp;&nbsp; <a href="../ngx_http_request.h.html#L43" title="src/http/ngx_http_request.h:43">NGX_HTTP_TRACE</a> }<br/></li>
<li>&nbsp; &nbsp; }, *test;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;method_name.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent duplicate :method header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (header-&gt;value.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent empty :method header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;method_name.len = header-&gt;value.len;<br/></li>
<li>&nbsp; &nbsp; r-&gt;method_name.data = header-&gt;value.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = r-&gt;method_name.len;<br/></li>
<li>&nbsp; &nbsp; n = <span class="Statement">sizeof</span>(tests) / <span class="Statement">sizeof</span>(tests[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; test = tests;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == test-&gt;len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = r-&gt;method_name.data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m = test-&gt;method;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k = len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p++ != *m++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">while</span> (--k);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;method = test-&gt;value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">next</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; test++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (--n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = r-&gt;method_name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((*p &lt; <span class="Constant">'A'</span> || *p &gt; <span class="Constant">'Z'</span>) &amp;&amp; *p != <span class="Constant">'_'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid method: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;r-&gt;method_name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (--len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3172">&#x200c;</a><span class="linkable">ngx_http_v2_parse_scheme</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;schema_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent duplicate :schema header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (header-&gt;value.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent empty :schema header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;schema_start = header-&gt;value.data;<br/></li>
<li>&nbsp; &nbsp; r-&gt;schema_end = header-&gt;value.data + header-&gt;value.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3196">&#x200c;</a><span class="linkable">ngx_http_v2_parse_authority</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L165" title="src/http/ngx_http_request.h:165">ngx_http_header_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *hh;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L178" title="src/http/ngx_http_core_module.h:178">ngx_http_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> host = <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;host&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h = <a href="../../core/ngx_list.c.html#L31" title="src/core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_in.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;hash = <a href="../../core/ngx_hash.c.html#L611" title="src/core/ngx_hash.c:611">ngx_hash_key</a>(host.data, host.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;key.len = host.len;<br/></li>
<li>&nbsp; &nbsp; h-&gt;key.data = host.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;value.len = header-&gt;value.len;<br/></li>
<li>&nbsp; &nbsp; h-&gt;value.data = header-&gt;value.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;lowcase_key = host.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="../ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hh = <a href="../../core/ngx_hash.c.html#L13" title="src/core/ngx_hash.c:13">ngx_hash_find</a>(&amp;cmcf-&gt;headers_in_hash, h-&gt;hash,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h-&gt;lowcase_key, h-&gt;key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hh == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hh-&gt;handler(r, h, hh-&gt;offset) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * request has been finalized already<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * in <a href="../ngx_http_request.c.html#L1613" title="src/http/ngx_http_request.c:1613">ngx_http_process_host</a>()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L42" title="src/core/ngx_core.h:42">NGX_ABORT</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3241">&#x200c;</a><span class="linkable">ngx_http_v2_construct_request_line</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> u_char ending[] = <span class="Constant">&quot; HTTP/2.0&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;method_name.len == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;unparsed_uri.len == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="../ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;request_line.len = r-&gt;method_name.len + <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + r-&gt;unparsed_uri.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(ending) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(r-&gt;pool, r-&gt;request_line.len + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3919" title="src/http/v2/ngx_http_v2.c:3919">ngx_http_v2_close_stream</a>(r-&gt;stream, <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;request_line.data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, r-&gt;method_name.data, r-&gt;method_name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p++ = <span class="Constant">' '</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, r-&gt;unparsed_uri.data, r-&gt;unparsed_uri.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(p, ending, <span class="Statement">sizeof</span>(ending));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 http request line: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;request_line);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3282">&#x200c;</a><span class="linkable">ngx_http_v2_cookie</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_v2.h.html#L65" title="src/http/v2/ngx_http_v2.h:65">ngx_http_v2_header_t</a> *header)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; *val;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; *cookies;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cookies = r-&gt;stream-&gt;cookies;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cookies == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cookies = <a href="../../core/ngx_array.c.html#L13" title="src/core/ngx_array.c:13">ngx_array_create</a>(r-&gt;pool, <span class="Constant">2</span>, <span class="Statement">sizeof</span>(<a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cookies == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;stream-&gt;cookies = cookies;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = <a href="../../core/ngx_array.c.html#L48" title="src/core/ngx_array.c:48">ngx_array_push</a>(cookies);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val-&gt;len = header-&gt;value.len;<br/></li>
<li>&nbsp; &nbsp; val-&gt;data = header-&gt;value.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3311">&#x200c;</a><span class="linkable">ngx_http_v2_construct_cookie_header</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buf, *p, *end;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *vals;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cookies;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L165" title="src/http/ngx_http_request.h:165">ngx_http_header_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *hh;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L178" title="src/http/ngx_http_core_module.h:178">ngx_http_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> cookie = <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;cookie&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cookies = r-&gt;stream-&gt;cookies;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cookies == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; vals = cookies-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += vals[i].len + <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (++i != cookies-&gt;nelts);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len -= <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = <a href="../../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(r-&gt;pool, len + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3919" title="src/http/v2/ngx_http_v2.c:3919">ngx_http_v2_close_stream</a>(r-&gt;stream, <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = buf;<br/></li>
<li>&nbsp; &nbsp; end = buf + len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; <span class="Comment">/* void */</span> ; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, vals[i].data, vals[i].len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">';'</span>; *p++ = <span class="Constant">' '</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h = <a href="../../core/ngx_list.c.html#L31" title="src/core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_in.headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3919" title="src/http/v2/ngx_http_v2.c:3919">ngx_http_v2_close_stream</a>(r-&gt;stream, <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;hash = <a href="../../core/ngx_hash.c.html#L611" title="src/core/ngx_hash.c:611">ngx_hash_key</a>(cookie.data, cookie.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;key.len = cookie.len;<br/></li>
<li>&nbsp; &nbsp; h-&gt;key.data = cookie.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;value.len = len;<br/></li>
<li>&nbsp; &nbsp; h-&gt;value.data = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;lowcase_key = cookie.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="../ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hh = <a href="../../core/ngx_hash.c.html#L13" title="src/core/ngx_hash.c:13">ngx_hash_find</a>(&amp;cmcf-&gt;headers_in_hash, h-&gt;hash,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h-&gt;lowcase_key, h-&gt;key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hh == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3919" title="src/http/v2/ngx_http_v2.c:3919">ngx_http_v2_close_stream</a>(r-&gt;stream, <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hh-&gt;handler(r, h, hh-&gt;offset) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * request has been finalized already<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * in <a href="../ngx_http_request.c.html#L1742" title="src/http/ngx_http_request.c:1742">ngx_http_process_multi_header_lines</a>()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3401">&#x200c;</a></span><span class="linkable">ngx_http_v2_run_request</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3241" title="src/http/v2/ngx_http_v2.c:3241">ngx_http_v2_construct_request_line</a>(r) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3311" title="src/http/v2/ngx_http_v2.c:3311">ngx_http_v2_construct_cookie_header</a>(r) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;http_state = NGX_HTTP_PROCESS_REQUEST_STATE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_request.c.html#L1771" title="src/http/ngx_http_request.c:1771">ngx_http_process_request_header</a>(r) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length_n &gt; <span class="Constant">0</span> &amp;&amp; r-&gt;stream-&gt;in_closed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client prematurely closed stream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="../ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length_n == -<span class="Constant">1</span> &amp;&amp; !r-&gt;stream-&gt;in_closed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.chunked = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.c.html#L1841" title="src/http/ngx_http_request.c:1841">ngx_http_process_request</a>(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3436">&#x200c;</a><span class="linkable">ngx_http_v2_read_request_body</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L282" title="src/http/ngx_http_request.h:282">ngx_http_client_body_handler_pt</a> post_handler)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; &nbsp; *h2scf;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L296" title="src/http/ngx_http_request.h:296">ngx_http_request_body_t</a>&nbsp;&nbsp; *rb;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = r-&gt;stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;skip_data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_body_no_buffering = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; post_handler(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../ngx_http_request.h.html#L296" title="src/http/ngx_http_request.h:296">ngx_http_request_body_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * set by <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>():<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;bufs = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;buf = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;received = 0;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;free = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; rb-&gt;busy = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rb-&gt;rest = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; rb-&gt;post_handler = post_handler;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;request_body = rb;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li>&nbsp; &nbsp; clcf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = r-&gt;headers_in.content_length_n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body_no_buffering &amp;&amp; !stream-&gt;in_closed) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &lt; <span class="Constant">0</span> || len &gt; (<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) clcf-&gt;client_body_buffer_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = clcf-&gt;client_body_buffer_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We need a room to store data up to the stream's initial window size,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * at least until this window will be exhausted.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &lt; (<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) h2scf-&gt;preread_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = h2scf-&gt;preread_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &gt; <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;buf = <a href="../../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(r-&gt;pool, (<span class="Type">size_t</span>) len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (len &gt;= <span class="Constant">0</span> &amp;&amp; len &lt;= (<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) clcf-&gt;client_body_buffer_size<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; !r-&gt;request_body_in_file_only)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;buf = <a href="../../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(r-&gt;pool, (<span class="Type">size_t</span>) len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;buf = <a href="../../core/ngx_buf.h.html#L154" title="src/core/ngx_buf.h:154">ngx_calloc_buf</a>(r-&gt;pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;buf != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;buf-&gt;sync = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = stream-&gt;preread;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;in_closed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_body_no_buffering = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L3589" title="src/http/v2/ngx_http_v2.c:3589">ngx_http_v2_process_request_body</a>(r, buf-&gt;pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last - buf-&gt;pos, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L281" title="src/core/ngx_palloc.c:281">ngx_pfree</a>(r-&gt;pool, buf-&gt;start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L3589" title="src/http/v2/ngx_http_v2.c:3589">ngx_http_v2_process_request_body</a>(r, <span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L3589" title="src/http/v2/ngx_http_v2.c:3589">ngx_http_v2_process_request_body</a>(r, buf-&gt;pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last - buf-&gt;pos, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L281" title="src/core/ngx_palloc.c:281">ngx_pfree</a>(r-&gt;pool, buf-&gt;start);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body_no_buffering) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = (<span class="Type">size_t</span>) len - h2scf-&gt;preread_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;no_flow_control = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a> - stream-&gt;recv_window;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2492" title="src/http/v2/ngx_http_v2.c:2492">ngx_http_v2_send_window_update</a>(stream-&gt;connection,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;node-&gt;id, size)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c = stream-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!h2c-&gt;blocked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L453" title="src/http/v2/ngx_http_v2.c:453">ngx_http_v2_send_output_queue</a>(h2c) == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;recv_window += size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(r-&gt;connection-&gt;read, clcf-&gt;client_body_timeout);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="#L3765" title="src/http/v2/ngx_http_v2.c:3765">ngx_http_v2_read_client_request_body_handler</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler = <a href="../ngx_http_request.c.html#L3320" title="src/http/ngx_http_request.c:3320">ngx_http_request_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3589">&#x200c;</a><span class="linkable">ngx_http_v2_process_request_body</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> size, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> last)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *fc;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L296" title="src/http/ngx_http_request.h:296">ngx_http_request_body_t</a>&nbsp;&nbsp; *rb;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; rb = r-&gt;request_body;<br/></li>
<li>&nbsp; &nbsp; buf = rb-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;sync) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = buf-&gt;start = pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = buf-&gt;end = pos + size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &gt; (<span class="Type">size_t</span>) (buf-&gt;end - buf-&gt;last)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client intended to send body data &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;larger than declared&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(buf-&gt;last, pos, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;rest = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fc-&gt;read-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(fc-&gt;read);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body_no_buffering) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(fc-&gt;read, &amp;<a href="../../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L3674" title="src/http/v2/ngx_http_v2.c:3674">ngx_http_v2_filter_request_body</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;sync) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* prevent reusing this buffer in the upstream module */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;buf = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.chunked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n = rb-&gt;received;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;read_event_handler = <a href="../ngx_http_request.c.html#L2710" title="src/http/ngx_http_request.c:2710">ngx_http_block_reading</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;post_handler(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(fc-&gt;read, clcf-&gt;client_body_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body_no_buffering) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(fc-&gt;read, &amp;<a href="../../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;sync) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L3674" title="src/http/v2/ngx_http_v2.c:3674">ngx_http_v2_filter_request_body</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3674">&#x200c;</a><span class="linkable">ngx_http_v2_filter_request_body</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b, *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L296" title="src/http/ngx_http_request.h:296">ngx_http_request_body_t</a>&nbsp;&nbsp; *rb;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rb = r-&gt;request_body;<br/></li>
<li>&nbsp; &nbsp; buf = rb-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;pos == buf-&gt;last &amp;&amp; rb-&gt;rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> update;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L156" title="src/core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(r-&gt;pool, &amp;rb-&gt;free);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(b, <span class="Statement">sizeof</span>(<a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;pos != buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_length += buf-&gt;last - buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;received += buf-&gt;last - buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length_n != -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rb-&gt;received &gt; r-&gt;headers_in.content_length_n) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client intended to send body data &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;larger than declared&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clcf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;client_max_body_size<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; rb-&gt;received &gt; clcf-&gt;client_max_body_size)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client intended to send too large chunked body: &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">%O</span><span class="Constant"> bytes&quot;</span>, rb-&gt;received);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L94" title="src/http/ngx_http_request.h:94">NGX_HTTP_REQUEST_ENTITY_TOO_LARGE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = b-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = b-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!rb-&gt;rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length_n != -<span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_in.content_length_n != rb-&gt;received)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client prematurely closed stream: &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;only </span><span class="Special">%O</span><span class="Constant"> out of </span><span class="Special">%O</span><span class="Constant"> bytes of request body received&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rb-&gt;received, r-&gt;headers_in.content_length_n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;tag = (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L3674" title="src/http/v2/ngx_http_v2.c:3674">ngx_http_v2_filter_request_body</a>;<br/></li>
<li>&nbsp; &nbsp; b-&gt;flush = r-&gt;request_body_no_buffering;<br/></li>
<li><br/></li>
<li><span class="Statement">update</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../ngx_http.c.html#L75" title="src/http/ngx_http.c:75">ngx_http_top_request_body_filter</a>(r, cl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.c.html#L184" title="src/core/ngx_buf.c:184">ngx_chain_update_chains</a>(r-&gt;pool, &amp;rb-&gt;free, &amp;rb-&gt;busy, &amp;cl,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L3674" title="src/http/v2/ngx_http_v2.c:3674">ngx_http_v2_filter_request_body</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3765">&#x200c;</a></span><span class="linkable">ngx_http_v2_read_client_request_body_handler</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; *fc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 read client request body handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fc-&gt;read-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, fc-&gt;log, <a href="../../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="../ngx_http_request.h.html#L90" title="src/http/ngx_http_request.h:90">NGX_HTTP_REQUEST_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fc-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client prematurely closed stream&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="../ngx_http_request.h.html#L127" title="src/http/ngx_http_request.h:127">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3797">&#x200c;</a><span class="linkable">ngx_http_v2_read_unbuffered_request_body</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; window;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *fc;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = r-&gt;stream;<br/></li>
<li>&nbsp; &nbsp; fc = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fc-&gt;read-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;recv_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L90" title="src/http/ngx_http_request.h:90">NGX_HTTP_REQUEST_TIME_OUT</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;read-&gt;timedout = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fc-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L3674" title="src/http/v2/ngx_http_v2.c:3674">ngx_http_v2_filter_request_body</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;request_body-&gt;rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_body-&gt;busy != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = r-&gt;request_body-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;pos = buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = buf-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; window = buf-&gt;end - buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; h2c = stream-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.stream == stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; window -= h2c-&gt;state.length;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (window &lt;= stream-&gt;recv_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (window &lt; stream-&gt;recv_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;http2 negative window update&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2492" title="src/http/v2/ngx_http_v2.c:2492">ngx_http_v2_send_window_update</a>(h2c, stream-&gt;node-&gt;id,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; window - stream-&gt;recv_window)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L453" title="src/http/v2/ngx_http_v2.c:453">ngx_http_v2_send_output_queue</a>(h2c) == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;recv_window == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(fc-&gt;read, clcf-&gt;client_body_timeout);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;recv_window = window;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3889">&#x200c;</a><span class="linkable">ngx_http_v2_terminate_stream</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> status)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *rev;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; *fc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;rst_sent) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2520" title="src/http/v2/ngx_http_v2.c:2520">ngx_http_v2_send_rst_stream</a>(h2c, stream-&gt;node-&gt;id, status)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;rst_sent = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; stream-&gt;skip_data = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc = stream-&gt;request-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev = fc-&gt;read;<br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler(rev);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L3919">&#x200c;</a></span><span class="linkable">ngx_http_v2_close_stream</span>(<a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream, <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> rc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *pool;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ev;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *fc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c = stream-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; node = stream-&gt;node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 close stream </span><span class="Special">%u</span><span class="Constant">i, queued </span><span class="Special">%u</span><span class="Constant">i, processing </span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; node-&gt;id, stream-&gt;queued, h2c-&gt;processing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc = stream-&gt;request-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;queued) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;handler = <a href="#L4049" title="src/http/v2/ngx_http_v2.c:4049">ngx_http_v2_close_stream_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;read-&gt;handler = <a href="../ngx_http_request.c.html#L3311" title="src/http/ngx_http_request.c:3311">ngx_http_empty_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!stream-&gt;rst_sent &amp;&amp; !h2c-&gt;connection-&gt;error) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!stream-&gt;out_closed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2520" title="src/http/v2/ngx_http_v2.c:2520">ngx_http_v2_send_rst_stream</a>(h2c, node-&gt;id,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;timedout ? <a href="#L16" title="src/http/v2/ngx_http_v2.c:16">NGX_HTTP_V2_PROTOCOL_ERROR</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;connection-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (!stream-&gt;in_closed) {<br/></li>
<li><span class="PreProc">#if 0<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (<a href="#L2520" title="src/http/v2/ngx_http_v2.c:2520">ngx_http_v2_send_rst_stream</a>(h2c, node-&gt;id, <a href="#L15" title="src/http/v2/ngx_http_v2.c:15">NGX_HTTP_V2_NO_ERROR</a>)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;connection-&gt;error = 1;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li></span><span class="cCppOutElse">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * At the time of writing at least the latest versions of Chrome<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * do not properly handle RST_STREAM with NO_ERROR status.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * See: https://bugs.chromium.org/p/chromium/issues/detail?id=603182<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * As a workaround, the stream window is maximized before closing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the stream.&nbsp; This allows a client to send up to 2 GB of data<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * before getting blocked on flow control.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li><span class="cCppOutElse">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">if</span><span class="cCppOutElse"> (stream-&gt;recv_window &lt; <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a><br/></li>
<li></span><span class="cCppOutElse">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="#L2492" title="src/http/v2/ngx_http_v2.c:2492">ngx_http_v2_send_window_update</a>(h2c, node-&gt;id,<br/></li>
<li></span><span class="cCppOutElse">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a><br/></li>
<li></span><span class="cCppOutElse">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - stream-&gt;recv_window)<br/></li>
<li></span><span class="cCppOutElse">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li></span><span class="cCppOutElse">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li></span><span class="cCppOutElse">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;connection-&gt;error = </span><span class="Constant">1</span><span class="cCppOutElse">;<br/></li>
<li></span><span class="cCppOutElse">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.stream == stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.stream = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;stream = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L43" title="src/core/ngx_queue.h:43">ngx_queue_insert_tail</a>(&amp;h2c-&gt;closed, &amp;node-&gt;reuse);<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;closed_nodes++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * This pool keeps decoded request headers which can be used by log phase<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * handlers in <a href="../ngx_http_request.c.html#L3433" title="src/http/ngx_http_request.c:3433">ngx_http_free_request</a>().<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The pointer is stored into local variable because the stream object<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * will be destroyed after a call to <a href="../ngx_http_request.c.html#L3433" title="src/http/ngx_http_request.c:3433">ngx_http_free_request</a>().<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; pool = stream-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3433" title="src/http/ngx_http_request.c:3433">ngx_http_free_request</a>(stream-&gt;request, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pool != h2c-&gt;state.pool) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* pool will be destroyed when the complete header is parsed */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;state.keep_pool = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ev = fc-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(ev);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;posted) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event_posted.h.html#L31" title="src/event/ngx_event_posted.h:31">ngx_delete_posted_event</a>(ev);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ev = fc-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(ev);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;posted) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../event/ngx_event_posted.h.html#L31" title="src/event/ngx_event_posted.h:31">ngx_delete_posted_event</a>(ev);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc-&gt;data = h2c-&gt;free_fake_connections;<br/></li>
<li>&nbsp; &nbsp; h2c-&gt;free_fake_connections = fc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;processing--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;processing || h2c-&gt;blocked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ev = h2c-&gt;connection-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ev-&gt;handler = <a href="#L4074" title="src/http/v2/ngx_http_v2.c:4074">ngx_http_v2_handle_connection_handler</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(ev, &amp;<a href="../../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4049">&#x200c;</a></span><span class="linkable">ngx_http_v2_close_stream_handler</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; *fc;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; r = fc-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 close stream handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, fc-&gt;log, <a href="../../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3919" title="src/http/v2/ngx_http_v2.c:3919">ngx_http_v2_close_stream</a>(r-&gt;stream, <a href="../ngx_http_request.h.html#L90" title="src/http/ngx_http_request.h:90">NGX_HTTP_REQUEST_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3919" title="src/http/v2/ngx_http_v2.c:3919">ngx_http_v2_close_stream</a>(r-&gt;stream, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4074">&#x200c;</a></span><span class="linkable">ngx_http_v2_handle_connection_handler</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, rev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 handle connection handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler = <a href="#L301" title="src/http/v2/ngx_http_v2.c:301">ngx_http_v2_read_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L301" title="src/http/v2/ngx_http_v2.c:301">ngx_http_v2_read_handler</a>(rev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; h2c = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;last_out &amp;&amp; <a href="#L453" title="src/http/v2/ngx_http_v2.c:453">ngx_http_v2_send_output_queue</a>(h2c) == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L590" title="src/http/v2/ngx_http_v2.c:590">ngx_http_v2_handle_connection</a>(c-&gt;data);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4102">&#x200c;</a></span><span class="linkable">ngx_http_v2_idle_handler</span>(<a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; &nbsp; *h2scf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; h2c = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http2 idle handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout || c-&gt;close) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, <a href="#L15" title="src/http/v2/ngx_http_v2.c:15">NGX_HTTP_V2_NO_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_KQUEUE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../../event/ngx_event.h.html#L225" title="src/event/ngx_event.h:225">NGX_USE_KQUEUE_EVENT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;pending_eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;handler = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, rev-&gt;kq_errno,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;kevent() reported that client %V closed &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;idle connection&quot;</span>, &amp;c-&gt;addr_text);<br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;no_send_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c-&gt;destroyed = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;idle = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;pool = <a href="../../core/ngx_palloc.c.html#L20" title="src/core/ngx_palloc.c:20">ngx_create_pool</a>(h2scf-&gt;pool_size, h2c-&gt;connection-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4159" title="src/http/v2/ngx_http_v2.c:4159">ngx_http_v2_finalize_connection</a>(h2c, <a href="#L17" title="src/http/v2/ngx_http_v2.c:17">NGX_HTTP_V2_INTERNAL_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L392" title="src/http/v2/ngx_http_v2.c:392">ngx_http_v2_write_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler = <a href="#L301" title="src/http/v2/ngx_http_v2.c:301">ngx_http_v2_read_handler</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L301" title="src/http/v2/ngx_http_v2.c:301">ngx_http_v2_read_handler</a>(rev);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4159">&#x200c;</a></span><span class="linkable">ngx_http_v2_finalize_connection</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> status)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ev;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *c, *fc;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; &nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; *h2scf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = h2c-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;blocked = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;error &amp;&amp; <a href="#L2548" title="src/http/v2/ngx_http_v2.c:2548">ngx_http_v2_send_goaway</a>(h2c, status) != <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L453" title="src/http/v2/ngx_http_v2.c:453">ngx_http_v2_send_output_queue</a>(h2c);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!h2c-&gt;processing) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="../ngx_http_request.c.html#L3311" title="src/http/ngx_http_request.c:3311">ngx_http_empty_handler</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="../ngx_http_request.c.html#L3311" title="src/http/ngx_http_request.c:3311">ngx_http_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;last_out = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L128" title="src/http/v2/ngx_http_v2.c:128">ngx_http_v2_index_size</a>(h2scf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; size; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (node = h2c-&gt;streams_index[i]; node; node = node-&gt;index) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream = node-&gt;stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;handled = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = stream-&gt;request;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fc = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;queued) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;queued = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ev = fc-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ev = fc-&gt;read;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ev-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ev-&gt;handler(ev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;blocked = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;processing) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.c.html#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L4235">&#x200c;</a><span class="linkable">ngx_http_v2_adjust_windows</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span> delta)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; &nbsp; &nbsp; *node;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L32" title="src/http/v2/ngx_http_v2_module.h:32">ngx_http_v2_srv_conf_t</a>&nbsp; *h2scf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2scf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(h2c-&gt;http_connection-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L128" title="src/http/v2/ngx_http_v2.c:128">ngx_http_v2_index_size</a>(h2scf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; size; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (node = h2c-&gt;streams_index[i]; node; node = node-&gt;index) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream = node-&gt;stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (delta &gt; <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; stream-&gt;send_window<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &gt; (<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>) (<a href="ngx_http_v2.h.html#L49" title="src/http/v2/ngx_http_v2.h:49">NGX_HTTP_V2_MAX_WINDOW</a> - delta))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3889" title="src/http/v2/ngx_http_v2.c:3889">ngx_http_v2_terminate_stream</a>(h2c, stream,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L18" title="src/http/v2/ngx_http_v2.c:18">NGX_HTTP_V2_FLOW_CTRL_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;send_window += delta;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2:</span><span class="Special">%u</span><span class="Constant">i adjusted window: %z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; node-&gt;id, stream-&gt;send_window);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;send_window &gt; <span class="Constant">0</span> &amp;&amp; stream-&gt;exhausted) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;exhausted = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev = stream-&gt;request-&gt;connection-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;active = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;ready = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;handler(wev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4297">&#x200c;</a></span><span class="linkable">ngx_http_v2_set_dependency</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a> *node, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> depend, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> exclusive)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *children, *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; *parent, *child, *next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; parent = depend ? <a href="#L2793" title="src/http/v2/ngx_http_v2.c:2793">ngx_http_v2_get_node_by_id</a>(h2c, depend, <span class="Constant">0</span>) : <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (parent == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; parent = <a href="#L51" title="src/http/v2/ngx_http_v2.c:51">NGX_HTTP_V2_ROOT</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (depend != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exclusive = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node-&gt;rank = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node-&gt;rel_weight = (<span class="Constant">1.0</span> / <span class="Constant">256</span>) * node-&gt;weight;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; children = &amp;h2c-&gt;dependencies;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;parent != <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (next = parent-&gt;parent;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; next != <a href="#L51" title="src/http/v2/ngx_http_v2.c:51">NGX_HTTP_V2_ROOT</a> &amp;&amp; next-&gt;rank &gt;= node-&gt;rank;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; next = next-&gt;parent)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (next != node) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;parent-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L40" title="src/core/ngx_queue.h:40">ngx_queue_insert_after</a>(&amp;node-&gt;queue, &amp;parent-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; parent-&gt;parent = node-&gt;parent;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;parent == <a href="#L51" title="src/http/v2/ngx_http_v2.c:51">NGX_HTTP_V2_ROOT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; parent-&gt;rank = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; parent-&gt;rel_weight = (<span class="Constant">1.0</span> / <span class="Constant">256</span>) * parent-&gt;weight;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; parent-&gt;rank = node-&gt;parent-&gt;rank + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; parent-&gt;rel_weight = (node-&gt;parent-&gt;rel_weight / <span class="Constant">256</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * parent-&gt;weight;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!exclusive) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4388" title="src/http/v2/ngx_http_v2.c:4388">ngx_http_v2_node_children_update</a>(parent);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node-&gt;rank = parent-&gt;rank + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node-&gt;rel_weight = (parent-&gt;rel_weight / <span class="Constant">256</span>) * node-&gt;weight;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (parent-&gt;stream == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;parent-&gt;reuse);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L43" title="src/core/ngx_queue.h:43">ngx_queue_insert_tail</a>(&amp;h2c-&gt;closed, &amp;parent-&gt;reuse);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; children = &amp;parent-&gt;children;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (exclusive) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../../core/ngx_queue.h.html#L50" title="src/core/ngx_queue.h:50">ngx_queue_head</a>(children);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../../core/ngx_queue.h.html#L58" title="src/core/ngx_queue.h:58">ngx_queue_sentinel</a>(children);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../../core/ngx_queue.h.html#L62" title="src/core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; child = <a href="../../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>, queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; child-&gt;parent = node;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L96" title="src/core/ngx_queue.h:96">ngx_queue_add</a>(&amp;node-&gt;children, children);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(children);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;parent != <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;node-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L43" title="src/core/ngx_queue.h:43">ngx_queue_insert_tail</a>(children, &amp;node-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = parent;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L4388" title="src/http/v2/ngx_http_v2.c:4388">ngx_http_v2_node_children_update</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4388">&#x200c;</a></span><span class="linkable">ngx_http_v2_node_children_update</span>(<a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a> *node)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>&nbsp; *child;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../../core/ngx_queue.h.html#L50" title="src/core/ngx_queue.h:50">ngx_queue_head</a>(&amp;node-&gt;children);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../../core/ngx_queue.h.html#L58" title="src/core/ngx_queue.h:58">ngx_queue_sentinel</a>(&amp;node-&gt;children);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../../core/ngx_queue.h.html#L62" title="src/core/ngx_queue.h:62">ngx_queue_next</a>(q))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; child = <a href="../../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_http_v2.h.html#L54" title="src/http/v2/ngx_http_v2.h:54">ngx_http_v2_node_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; child-&gt;rank = node-&gt;rank + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; child-&gt;rel_weight = (node-&gt;rel_weight / <span class="Constant">256</span>) * child-&gt;weight;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4388" title="src/http/v2/ngx_http_v2.c:4388">ngx_http_v2_node_children_update</a>(child);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4408">&#x200c;</a></span><span class="linkable">ngx_http_v2_pool_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;state.pool) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(h2c-&gt;state.pool);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;pool) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(h2c-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
