<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/http/v2/ngx_http_v2_filter_module.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

  <h1>src/http/v2/ngx_http_v2_filter_module.c - Nginx 1.11.2</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L123">ngx_http_next_header_filter</a></li>
<li><a href="#L107">ngx_http_v2_filter_module</a></li>
<li><a href="#L92">ngx_http_v2_filter_module_ctx</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L647">ngx_http_v2_create_headers_frame</a></li>
<li><a href="#L1176">ngx_http_v2_data_frame_handler</a></li>
<li><a href="#L1309">ngx_http_v2_filter_cleanup</a></li>
<li><a href="#L974">ngx_http_v2_filter_get_data_frame</a></li>
<li><a href="#L941">ngx_http_v2_filter_get_shadow</a></li>
<li><a href="#L1362">ngx_http_v2_filter_init</a></li>
<li><a href="#L1050">ngx_http_v2_filter_send</a></li>
<li><a href="#L1075">ngx_http_v2_flow_control</a></li>
<li><a href="#L1269">ngx_http_v2_handle_frame</a></li>
<li><a href="#L1290">ngx_http_v2_handle_stream</a></li>
<li><a href="#L127">ngx_http_v2_header_filter</a></li>
<li><a href="#L1125">ngx_http_v2_headers_frame_handler</a></li>
<li><a href="#L750">ngx_http_v2_send_chain</a></li>
<li><a href="#L599">ngx_http_v2_string_encode</a></li>
<li><a href="#L1093">ngx_http_v2_waiting_queue</a></li>
<li><a href="#L625">ngx_http_v2_write_int</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L45">NGX_HTTP_V2_CONTENT_LENGTH_INDEX</a></li>
<li><a href="#L46">NGX_HTTP_V2_CONTENT_TYPE_INDEX</a></li>
<li><a href="#L47">NGX_HTTP_V2_DATE_INDEX</a></li>
<li><a href="#L34">NGX_HTTP_V2_ENCODE_HUFF</a></li>
<li><a href="#L33">NGX_HTTP_V2_ENCODE_RAW</a></li>
<li><a href="#L48">NGX_HTTP_V2_LAST_MODIFIED_INDEX</a></li>
<li><a href="#L49">NGX_HTTP_V2_LOCATION_INDEX</a></li>
<li><a href="#L50">NGX_HTTP_V2_SERVER_INDEX</a></li>
<li><a href="#L37">NGX_HTTP_V2_STATUS_200_INDEX</a></li>
<li><a href="#L38">NGX_HTTP_V2_STATUS_204_INDEX</a></li>
<li><a href="#L39">NGX_HTTP_V2_STATUS_206_INDEX</a></li>
<li><a href="#L40">NGX_HTTP_V2_STATUS_304_INDEX</a></li>
<li><a href="#L41">NGX_HTTP_V2_STATUS_400_INDEX</a></li>
<li><a href="#L42">NGX_HTTP_V2_STATUS_404_INDEX</a></li>
<li><a href="#L43">NGX_HTTP_V2_STATUS_500_INDEX</a></li>
<li><a href="#L36">NGX_HTTP_V2_STATUS_INDEX</a></li>
<li><a href="#L51">NGX_HTTP_V2_VARY_INDEX</a></li>
<li><a href="#L26">ngx_http_v2_inc_indexed</a></li>
<li><a href="#L25">ngx_http_v2_indexed</a></li>
<li><a href="#L20">ngx_http_v2_integer_octets</a></li>
<li><a href="#L22">ngx_http_v2_literal_size</a></li>
<li><a href="#L28">ngx_http_v2_write_name</a></li>
<li><a href="#L30">ngx_http_v2_write_value</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> * Copyright (C) Valentin V. Bartenev<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;<a href="../modules/perl/ngx_http_perl_module.h.html#L21" title="src/http/modules/perl/ngx_http_perl_module.h:21">nginx</a>.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;<a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This returns precise number of octets for values in range 0..253<br/></li>
<li></span><span class="Comment"> * and estimate number for the rest, but not smaller than required.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L20">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_http_v2_integer_octets</span>(v)&nbsp; (</span><span class="Constant">1</span><span class="PreProc"> + (v) / </span><span class="Constant">127</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L22">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_http_v2_literal_size</span>(h)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; (<a href="#L20" title="src/http/v2/ngx_http_v2_filter_module.c:20">ngx_http_v2_integer_octets</a>(</span><span class="Statement">sizeof</span><span class="PreProc">(h) - </span><span class="Constant">1</span><span class="PreProc">) + </span><span class="Statement">sizeof</span><span class="PreProc">(h) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L25">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_http_v2_indexed</span>(i)&nbsp; &nbsp; &nbsp; (</span><span class="Constant">128</span><span class="PreProc"> + (i))<br/></li>
<li><a id="L26">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_http_v2_inc_indexed</span>(i)&nbsp; (</span><span class="Constant">64</span><span class="PreProc"> + (i))<br/></li>
<li></span><br/></li>
<li><a id="L28">&#x200c;</a><span class="PreProc">#define <span class="linkable">ngx_http_v2_write_name</span>(dst, src, len, tmp)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; <a href="#L599" title="src/http/v2/ngx_http_v2_filter_module.c:599">ngx_http_v2_string_encode</a>(dst, src, len, tmp, </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li><a id="L30">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ngx_http_v2_write_value</span>(dst, src, len, tmp)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; <a href="#L599" title="src/http/v2/ngx_http_v2_filter_module.c:599">ngx_http_v2_string_encode</a>(dst, src, len, tmp, </span><span class="Constant">0</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><a id="L33">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_ENCODE_RAW</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0<br/></li>
<li><a id="L34">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_ENCODE_HUFF</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0x80<br/></li>
<li></span><br/></li>
<li><a id="L36">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STATUS_INDEX</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">8<br/></li>
<li><a id="L37">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STATUS_200_INDEX</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">8<br/></li>
<li><a id="L38">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STATUS_204_INDEX</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">9<br/></li>
<li><a id="L39">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STATUS_206_INDEX</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">10<br/></li>
<li><a id="L40">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STATUS_304_INDEX</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">11<br/></li>
<li><a id="L41">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STATUS_400_INDEX</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">12<br/></li>
<li><a id="L42">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STATUS_404_INDEX</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">13<br/></li>
<li><a id="L43">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_STATUS_500_INDEX</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">14<br/></li>
<li></span><br/></li>
<li><a id="L45">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_CONTENT_LENGTH_INDEX</span>&nbsp; </span><span class="Constant">28<br/></li>
<li><a id="L46">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_CONTENT_TYPE_INDEX</span>&nbsp; &nbsp; </span><span class="Constant">31<br/></li>
<li><a id="L47">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_DATE_INDEX</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">33<br/></li>
<li><a id="L48">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_LAST_MODIFIED_INDEX</span>&nbsp;&nbsp; </span><span class="Constant">44<br/></li>
<li><a id="L49">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_LOCATION_INDEX</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">46<br/></li>
<li><a id="L50">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_SERVER_INDEX</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">54<br/></li>
<li><a id="L51">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_V2_VARY_INDEX</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">59<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<a href="#L599" title="src/http/v2/ngx_http_v2_filter_module.c:599">ngx_http_v2_string_encode</a>(u_char *dst, u_char *src, <span class="Type">size_t</span> len,<br/></li>
<li>&nbsp; &nbsp; u_char *tmp, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> lower);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L625" title="src/http/v2/ngx_http_v2_filter_module.c:625">ngx_http_v2_write_int</a>(u_char *pos, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> prefix,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> value);<br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *<a href="#L647" title="src/http/v2/ngx_http_v2_filter_module.c:647">ngx_http_v2_create_headers_frame</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, u_char *pos, u_char *end);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<a href="#L750" title="src/http/v2/ngx_http_v2_filter_module.c:750">ngx_http_v2_send_chain</a>(<a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *fc,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in, <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span> limit);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<a href="#L941" title="src/http/v2/ngx_http_v2_filter_module.c:941">ngx_http_v2_filter_get_shadow</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream, <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *buf, <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span> offset, <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span> size);<br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *<a href="#L974" title="src/http/v2/ngx_http_v2_filter_module.c:974">ngx_http_v2_filter_get_data_frame</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream, <span class="Type">size_t</span> len, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *first,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *last);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1075" title="src/http/v2/ngx_http_v2_filter_module.c:1075">ngx_http_v2_flow_control</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1093" title="src/http/v2/ngx_http_v2_filter_module.c:1093">ngx_http_v2_waiting_queue</a>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1050" title="src/http/v2/ngx_http_v2_filter_module.c:1050">ngx_http_v2_filter_send</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *fc, <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1125" title="src/http/v2/ngx_http_v2_filter_module.c:1125">ngx_http_v2_headers_frame_handler</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1176" title="src/http/v2/ngx_http_v2_filter_module.c:1176">ngx_http_v2_data_frame_handler</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame);<br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <span class="Type">void</span> <a href="#L1269" title="src/http/v2/ngx_http_v2_filter_module.c:1269">ngx_http_v2_handle_frame</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream, <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame);<br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <span class="Type">void</span> <a href="#L1290" title="src/http/v2/ngx_http_v2_filter_module.c:1290">ngx_http_v2_handle_stream</a>(<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c, <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1309" title="src/http/v2/ngx_http_v2_filter_module.c:1309">ngx_http_v2_filter_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1362" title="src/http/v2/ngx_http_v2_filter_module.c:1362">ngx_http_v2_filter_init</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L92">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_config.h.html#L36" title="src/http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_v2_filter_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1362" title="src/http/v2/ngx_http_v2_filter_module.c:1362">ngx_http_v2_filter_init</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create <a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L107">&#x200c;</a><a href="../../core/ngx_core.h.html#L15" title="src/core/ngx_core.h:15">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_v2_filter_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_module.h.html#L230" title="src/core/ngx_module.h:230">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L92" title="src/http/v2/ngx_http_v2_filter_module.c:92">ngx_http_v2_filter_module_ctx</a>,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../ngx_http_config.h.html#L39" title="src/http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_module.h.html#L234" title="src/core/ngx_module.h:234">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L123">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_core_module.h.html#L526" title="src/http/ngx_http_core_module.h:526">ngx_http_output_header_filter_pt</a>&nbsp; <span class="linkable">ngx_http_next_header_filter</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L127">&#x200c;</a><span class="linkable">ngx_http_v2_header_filter</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; status, *pos, *start, *p, *tmp;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len, tmp_len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host, location;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, port;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_list.h.html#L16" title="src/core/ngx_list.h:16">ngx_list_part_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *part;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *header;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *fc;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_request.h.html#L327" title="src/http/ngx_http_request.h:327">ngx_http_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp;&nbsp; *frame;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; addr[<a href="../../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> u_char <a href="../modules/perl/ngx_http_perl_module.h.html#L21" title="src/http/modules/perl/ngx_http_perl_module.h:21">nginx</a>[<span class="Constant">5</span>] = <span class="Constant">&quot;</span><span class="Special">\x84\xaa\x63\x55\xe7</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="PreProc">#if (NGX_HTTP_GZIP)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> u_char accept_encoding[<span class="Constant">12</span>] =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\x8b\x84\x84\x2d\x69\x5b\x05\x44\x3c\x86\xaa\x6f</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">size_t</span> nginx_ver_len = <a href="#L22" title="src/http/v2/ngx_http_v2_filter_module.c:22">ngx_http_v2_literal_size</a>(<a href="../../core/nginx.h.html#L14" title="src/core/nginx.h:14">NGINX_VER</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> u_char nginx_ver[<a href="#L22" title="src/http/v2/ngx_http_v2_filter_module.c:22">ngx_http_v2_literal_size</a>(<a href="../../core/nginx.h.html#L14" title="src/core/nginx.h:14">NGINX_VER</a>)];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 header filter&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;header_sent) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;header_sent = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != r-&gt;<a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;method == <a href="../ngx_http_request.h.html#L30" title="src/http/ngx_http_request.h:30">NGX_HTTP_HEAD</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_only = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (r-&gt;headers_out.status) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../ngx_http_request.h.html#L72" title="src/http/ngx_http_request.h:72">NGX_HTTP_OK</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L25" title="src/http/v2/ngx_http_v2_filter_module.c:25">ngx_http_v2_indexed</a>(<a href="#L37" title="src/http/v2/ngx_http_v2_filter_module.c:37">NGX_HTTP_V2_STATUS_200_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../ngx_http_request.h.html#L75" title="src/http/ngx_http_request.h:75">NGX_HTTP_NO_CONTENT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_only = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L44" title="src/core/ngx_string.h:44">ngx_str_null</a>(&amp;r-&gt;headers_out.content_type);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_length = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_length_n = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.last_modified_time = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.last_modified = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L25" title="src/http/v2/ngx_http_v2_filter_module.c:25">ngx_http_v2_indexed</a>(<a href="#L38" title="src/http/v2/ngx_http_v2_filter_module.c:38">NGX_HTTP_V2_STATUS_204_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../ngx_http_request.h.html#L76" title="src/http/ngx_http_request.h:76">NGX_HTTP_PARTIAL_CONTENT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L25" title="src/http/v2/ngx_http_v2_filter_module.c:25">ngx_http_v2_indexed</a>(<a href="#L39" title="src/http/v2/ngx_http_v2_filter_module.c:39">NGX_HTTP_V2_STATUS_206_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="../ngx_http_request.h.html#L82" title="src/http/ngx_http_request.h:82">NGX_HTTP_NOT_MODIFIED</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_only = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L25" title="src/http/v2/ngx_http_v2_filter_module.c:25">ngx_http_v2_indexed</a>(<a href="#L40" title="src/http/v2/ngx_http_v2_filter_module.c:40">NGX_HTTP_V2_STATUS_304_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.last_modified_time = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.last_modified = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (r-&gt;headers_out.status) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L25" title="src/http/v2/ngx_http_v2_filter_module.c:25">ngx_http_v2_indexed</a>(<a href="#L41" title="src/http/v2/ngx_http_v2_filter_module.c:41">NGX_HTTP_V2_STATUS_400_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../ngx_http_request.h.html#L88" title="src/http/ngx_http_request.h:88">NGX_HTTP_NOT_FOUND</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L25" title="src/http/v2/ngx_http_v2_filter_module.c:25">ngx_http_v2_indexed</a>(<a href="#L42" title="src/http/v2/ngx_http_v2_filter_module.c:42">NGX_HTTP_V2_STATUS_404_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="#L25" title="src/http/v2/ngx_http_v2_filter_module.c:25">ngx_http_v2_indexed</a>(<a href="#L43" title="src/http/v2/ngx_http_v2_filter_module.c:43">NGX_HTTP_V2_STATUS_500_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = status ? <span class="Constant">1</span> : <span class="Constant">1</span> + <a href="#L22" title="src/http/v2/ngx_http_v2_filter_module.c:22">ngx_http_v2_literal_size</a>(<span class="Constant">&quot;418&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.server == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + (clcf-&gt;server_tokens ? nginx_ver_len : <span class="Statement">sizeof</span>(<a href="../modules/perl/ngx_http_perl_module.h.html#L21" title="src/http/modules/perl/ngx_http_perl_module.h:21">nginx</a>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.date == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + <a href="#L22" title="src/http/v2/ngx_http_v2_filter_module.c:22">ngx_http_v2_literal_size</a>(<span class="Constant">&quot;Wed, 31 Dec 1986 18:00:00 GMT&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + <a href="ngx_http_v2.h.html#L23" title="src/http/v2/ngx_http_v2.h:23">NGX_HTTP_V2_INT_OCTETS</a> + r-&gt;headers_out.content_type.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type_len == r-&gt;headers_out.content_type.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.charset.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Statement">sizeof</span>(<span class="Constant">&quot;; charset=&quot;</span>) - <span class="Constant">1</span> + r-&gt;headers_out.charset.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_length == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.content_length_n &gt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + <a href="#L20" title="src/http/v2/ngx_http_v2_filter_module.c:20">ngx_http_v2_integer_octets</a>(<a href="../../os/win32/ngx_win32_config.h.html#L218" title="src/os/win32/ngx_win32_config.h:218">NGX_OFF_T_LEN</a>) + <a href="../../os/win32/ngx_win32_config.h.html#L218" title="src/os/win32/ngx_win32_config.h:218">NGX_OFF_T_LEN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.last_modified == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.last_modified_time != -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + <a href="#L22" title="src/http/v2/ngx_http_v2_filter_module.c:22">ngx_http_v2_literal_size</a>(<span class="Constant">&quot;Wed, 31 Dec 1986 18:00:00 GMT&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.location &amp;&amp; r-&gt;headers_out.location-&gt;value.len) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.location-&gt;value.data[<span class="Constant">0</span>] == <span class="Constant">'/'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;server_name_in_redirect) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf = <a href="../ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="../ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host = cscf-&gt;server_name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (r-&gt;headers_in.server.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host = r-&gt;headers_in.server;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host.len = <a href="../../core/ngx_inet.h.html#L23" title="src/core/ngx_inet.h:23">NGX_SOCKADDR_STRLEN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host.data = addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_connection.c.html#L1276" title="src/core/ngx_connection.c:1276">ngx_connection_local_sockaddr</a>(fc, &amp;host, <span class="Constant">0</span>) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = <a href="../../core/ngx_inet.c.html#L1345" title="src/core/ngx_inet.c:1345">ngx_inet_get_port</a>(fc-&gt;local_sockaddr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; location.len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;https://&quot;</span>) - <span class="Constant">1</span> + host.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + r-&gt;headers_out.location-&gt;value.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;port_in_redirect) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fc-&gt;ssl)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = (port == <span class="Constant">443</span>) ? <span class="Constant">0</span> : port;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = (port == <span class="Constant">80</span>) ? <span class="Constant">0</span> : port;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (port) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; location.len += <span class="Statement">sizeof</span>(<span class="Constant">&quot;:65535&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; location.data = <a href="../../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(r-&gt;pool, location.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (location.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(location.data, <span class="Constant">&quot;http&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;http&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fc-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">'s'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">':'</span>; *p++ = <span class="Constant">'/'</span>; *p++ = <span class="Constant">'/'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, host.data, host.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (port) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(p, <span class="Constant">&quot;:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, port);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, r-&gt;headers_out.location-&gt;value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location-&gt;value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* update r-&gt;headers_out.location-&gt;value for possible logging */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location-&gt;value.len = p - location.data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location-&gt;value.data = location.data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L42" title="src/core/ngx_string.h:42">ngx_str_set</a>(&amp;r-&gt;headers_out.location-&gt;key, <span class="Constant">&quot;Location&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location-&gt;hash = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + <a href="ngx_http_v2.h.html#L23" title="src/http/v2/ngx_http_v2.h:23">NGX_HTTP_V2_INT_OCTETS</a> + r-&gt;headers_out.location-&gt;value.len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tmp_len = len;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_GZIP)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;gzip_vary) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;gzip_vary) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + <span class="Statement">sizeof</span>(accept_encoding);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;gzip_vary = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; part = &amp;r-&gt;headers_out.headers.part;<br/></li>
<li>&nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; <span class="Comment">/* void */</span>; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt;= part-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (part-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; part = part-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].hash == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].key.len &gt; <a href="ngx_http_v2.h.html#L24" title="src/http/v2/ngx_http_v2.h:24">NGX_HTTP_V2_MAX_FIELD</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;too long response header name: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;header[i].key);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].value.len &gt; <a href="ngx_http_v2.h.html#L24" title="src/http/v2/ngx_http_v2.h:24">NGX_HTTP_V2_MAX_FIELD</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;too long response header value: </span><span class="Special">\&quot;</span><span class="Constant">%V: %V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;header[i].key, &amp;header[i].value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span> + <a href="ngx_http_v2.h.html#L23" title="src/http/v2/ngx_http_v2.h:23">NGX_HTTP_V2_INT_OCTETS</a> + header[i].key.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <a href="ngx_http_v2.h.html#L23" title="src/http/v2/ngx_http_v2.h:23">NGX_HTTP_V2_INT_OCTETS</a> + header[i].value.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].key.len &gt; tmp_len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp_len = header[i].key.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].value.len &gt; tmp_len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp_len = header[i].value.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tmp = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(r-&gt;pool, tmp_len);<br/></li>
<li>&nbsp; &nbsp; pos = <a href="../../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pos == <span class="Constant">NULL</span> || tmp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; start = pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 output header: </span><span class="Special">\&quot;</span><span class="Constant">:status: </span><span class="Special">%03u</span><span class="Constant">i</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; r-&gt;headers_out.status);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (status) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = status;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <a href="#L26" title="src/http/v2/ngx_http_v2_filter_module.c:26">ngx_http_v2_inc_indexed</a>(<a href="#L36" title="src/http/v2/ngx_http_v2_filter_module.c:36">NGX_HTTP_V2_STATUS_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <a href="#L33" title="src/http/v2/ngx_http_v2_filter_module.c:33">NGX_HTTP_V2_ENCODE_RAW</a> | <span class="Constant">3</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="../../core/ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(pos, <span class="Constant">&quot;</span><span class="Special">%03u</span><span class="Constant">i&quot;</span>, r-&gt;headers_out.status);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.server == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 output header: </span><span class="Special">\&quot;</span><span class="Constant">server: </span><span class="Special">%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; clcf-&gt;server_tokens ? <a href="../../core/nginx.h.html#L14" title="src/core/nginx.h:14">NGINX_VER</a> : <span class="Constant">&quot;<a href="../modules/perl/ngx_http_perl_module.h.html#L21" title="src/http/modules/perl/ngx_http_perl_module.h:21">nginx</a>&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <a href="#L26" title="src/http/v2/ngx_http_v2_filter_module.c:26">ngx_http_v2_inc_indexed</a>(<a href="#L50" title="src/http/v2/ngx_http_v2_filter_module.c:50">NGX_HTTP_V2_SERVER_INDEX</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;server_tokens) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nginx_ver[<span class="Constant">0</span>] == <span class="Special">'\0'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="#L30" title="src/http/v2/ngx_http_v2_filter_module.c:30">ngx_http_v2_write_value</a>(nginx_ver, (u_char *) <a href="../../core/nginx.h.html#L14" title="src/core/nginx.h:14">NGINX_VER</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="../../core/nginx.h.html#L14" title="src/core/nginx.h:14">NGINX_VER</a>) - <span class="Constant">1</span>, tmp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nginx_ver_len = p - nginx_ver;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(pos, nginx_ver, nginx_ver_len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(pos, <a href="../modules/perl/ngx_http_perl_module.h.html#L21" title="src/http/modules/perl/ngx_http_perl_module.h:21">nginx</a>, <span class="Statement">sizeof</span>(<a href="../modules/perl/ngx_http_perl_module.h.html#L21" title="src/http/modules/perl/ngx_http_perl_module.h:21">nginx</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.date == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 output header: </span><span class="Special">\&quot;</span><span class="Constant">date: %V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;<a href="../../core/ngx_times.c.html#L29" title="src/core/ngx_times.c:29">ngx_cached_http_time</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <a href="#L26" title="src/http/v2/ngx_http_v2_filter_module.c:26">ngx_http_v2_inc_indexed</a>(<a href="#L47" title="src/http/v2/ngx_http_v2_filter_module.c:47">NGX_HTTP_V2_DATE_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="#L30" title="src/http/v2/ngx_http_v2_filter_module.c:30">ngx_http_v2_write_value</a>(pos, <a href="../../core/ngx_times.c.html#L29" title="src/core/ngx_times.c:29">ngx_cached_http_time</a>.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_times.c.html#L29" title="src/core/ngx_times.c:29">ngx_cached_http_time</a>.len, tmp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <a href="#L26" title="src/http/v2/ngx_http_v2_filter_module.c:26">ngx_http_v2_inc_indexed</a>(<a href="#L46" title="src/http/v2/ngx_http_v2_filter_module.c:46">NGX_HTTP_V2_CONTENT_TYPE_INDEX</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type_len == r-&gt;headers_out.content_type.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.charset.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = r-&gt;headers_out.content_type.len + <span class="Statement">sizeof</span>(<span class="Constant">&quot;; charset=&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + r-&gt;headers_out.charset.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, r-&gt;headers_out.content_type.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; r-&gt;headers_out.content_type.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, <span class="Constant">&quot;; charset=&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;; charset=&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, r-&gt;headers_out.charset.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; r-&gt;headers_out.charset.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* updated r-&gt;headers_out.content_type is also needed for logging */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type.len = len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type.data = p - len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 output header: </span><span class="Special">\&quot;</span><span class="Constant">content-type: %V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;r-&gt;headers_out.content_type);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="#L30" title="src/http/v2/ngx_http_v2_filter_module.c:30">ngx_http_v2_write_value</a>(pos, r-&gt;headers_out.content_type.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type.len, tmp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_length == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.content_length_n &gt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 output header: </span><span class="Special">\&quot;</span><span class="Constant">content-length: </span><span class="Special">%O\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; r-&gt;headers_out.content_length_n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <a href="#L26" title="src/http/v2/ngx_http_v2_filter_module.c:26">ngx_http_v2_inc_indexed</a>(<a href="#L45" title="src/http/v2/ngx_http_v2_filter_module.c:45">NGX_HTTP_V2_CONTENT_LENGTH_INDEX</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="../../core/ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(pos + <span class="Constant">1</span>, <span class="Constant">&quot;</span><span class="Special">%O</span><span class="Constant">&quot;</span>, r-&gt;headers_out.content_length_n);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p = <a href="#L33" title="src/http/v2/ngx_http_v2_filter_module.c:33">NGX_HTTP_V2_ENCODE_RAW</a> | (u_char) (pos - p - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.last_modified == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.last_modified_time != -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <a href="#L26" title="src/http/v2/ngx_http_v2_filter_module.c:26">ngx_http_v2_inc_indexed</a>(<a href="#L48" title="src/http/v2/ngx_http_v2_filter_module.c:48">NGX_HTTP_V2_LAST_MODIFIED_INDEX</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_times.c.html#L255" title="src/core/ngx_times.c:255">ngx_http_time</a>(pos, r-&gt;headers_out.last_modified_time);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;Wed, 31 Dec 1986 18:00:00 GMT&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 output header: </span><span class="Special">\&quot;</span><span class="Constant">last-modified: </span><span class="Special">%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len, pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Date will always be encoded using huffman in the temporary buffer,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * so it's safe here to use src and dst pointing to the same address.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="#L30" title="src/http/v2/ngx_http_v2_filter_module.c:30">ngx_http_v2_write_value</a>(pos, pos, len, tmp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.location &amp;&amp; r-&gt;headers_out.location-&gt;value.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 output header: </span><span class="Special">\&quot;</span><span class="Constant">location: %V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;r-&gt;headers_out.location-&gt;value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <a href="#L26" title="src/http/v2/ngx_http_v2_filter_module.c:26">ngx_http_v2_inc_indexed</a>(<a href="#L49" title="src/http/v2/ngx_http_v2_filter_module.c:49">NGX_HTTP_V2_LOCATION_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="#L30" title="src/http/v2/ngx_http_v2_filter_module.c:30">ngx_http_v2_write_value</a>(pos, r-&gt;headers_out.location-&gt;value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.location-&gt;value.len, tmp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_GZIP)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;gzip_vary) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 output header: </span><span class="Special">\&quot;</span><span class="Constant">vary: Accept-Encoding</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <a href="#L26" title="src/http/v2/ngx_http_v2_filter_module.c:26">ngx_http_v2_inc_indexed</a>(<a href="#L51" title="src/http/v2/ngx_http_v2_filter_module.c:51">NGX_HTTP_V2_VARY_INDEX</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(pos, accept_encoding, <span class="Statement">sizeof</span>(accept_encoding));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; part = &amp;r-&gt;headers_out.headers.part;<br/></li>
<li>&nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; <span class="Comment">/* void */</span>; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt;= part-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (part-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; part = part-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].hash == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_DEBUG)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fc-&gt;log-&gt;log_level &amp; <a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L21" title="src/core/ngx_string.c:21">ngx_strlow</a>(tmp, header[i].key.data, header[i].key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, fc-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2 output header: </span><span class="Special">\&quot;%*s</span><span class="Constant">: %V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; header[i].key.len, tmp, &amp;header[i].value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="#L28" title="src/http/v2/ngx_http_v2_filter_module.c:28">ngx_http_v2_write_name</a>(pos, header[i].key.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; header[i].key.len, tmp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos = <a href="#L30" title="src/http/v2/ngx_http_v2_filter_module.c:30">ngx_http_v2_write_value</a>(pos, header[i].value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; header[i].value.len, tmp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = <a href="#L647" title="src/http/v2/ngx_http_v2_filter_module.c:647">ngx_http_v2_create_headers_frame</a>(r, start, pos);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L247" title="src/http/v2/ngx_http_v2.h:247">ngx_http_v2_queue_blocked_frame</a>(r-&gt;stream-&gt;connection, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="../ngx_http_core_module.c.html#L2707" title="src/http/ngx_http_core_module.c:2707">ngx_http_cleanup_add</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L1309" title="src/http/v2/ngx_http_v2_filter_module.c:1309">ngx_http_v2_filter_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = r-&gt;stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;stream-&gt;queued = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc-&gt;send_chain = <a href="#L750" title="src/http/v2/ngx_http_v2_filter_module.c:750">ngx_http_v2_send_chain</a>;<br/></li>
<li>&nbsp; &nbsp; fc-&gt;need_last_buf = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1050" title="src/http/v2/ngx_http_v2_filter_module.c:1050">ngx_http_v2_filter_send</a>(fc, r-&gt;stream);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L599">&#x200c;</a><span class="linkable">ngx_http_v2_string_encode</span>(u_char *dst, u_char *src, <span class="Type">size_t</span> len, u_char *tmp,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> lower)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; hlen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hlen = <a href="ngx_http_v2_huff_encode.c.html#L192" title="src/http/v2/ngx_http_v2_huff_encode.c:192">ngx_http_v2_huff_encode</a>(src, len, tmp, lower);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hlen &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *dst = <a href="#L34" title="src/http/v2/ngx_http_v2_filter_module.c:34">NGX_HTTP_V2_ENCODE_HUFF</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="#L625" title="src/http/v2/ngx_http_v2_filter_module.c:625">ngx_http_v2_write_int</a>(dst, <a href="ngx_http_v2.h.html#L289" title="src/http/v2/ngx_http_v2.h:289">ngx_http_v2_prefix</a>(<span class="Constant">7</span>), hlen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(dst, tmp, hlen);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *dst = <a href="#L33" title="src/http/v2/ngx_http_v2_filter_module.c:33">NGX_HTTP_V2_ENCODE_RAW</a>;<br/></li>
<li>&nbsp; &nbsp; dst = <a href="#L625" title="src/http/v2/ngx_http_v2_filter_module.c:625">ngx_http_v2_write_int</a>(dst, <a href="ngx_http_v2.h.html#L289" title="src/http/v2/ngx_http_v2.h:289">ngx_http_v2_prefix</a>(<span class="Constant">7</span>), len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lower) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L21" title="src/core/ngx_string.c:21">ngx_strlow</a>(dst, src, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> dst + len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(dst, src, len);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L625">&#x200c;</a><span class="linkable">ngx_http_v2_write_int</span>(u_char *pos, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> prefix, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> value)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (value &lt; prefix) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ |= value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> pos;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *pos++ |= prefix;<br/></li>
<li>&nbsp; &nbsp; value -= prefix;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (value &gt;= <span class="Constant">128</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *pos++ = value % <span class="Constant">128</span> + <span class="Constant">128</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; value /= <span class="Constant">128</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *pos++ = (u_char) value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> pos;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *<br/></li>
<li><a id="L647">&#x200c;</a><span class="linkable">ngx_http_v2_create_headers_frame</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, u_char *pos,<br/></li>
<li>&nbsp; &nbsp; u_char *end)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type, flags;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rest, frame_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cl, **ll;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp;&nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp; *frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = r-&gt;stream;<br/></li>
<li>&nbsp; &nbsp; rest = end - pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame-&gt;handler = <a href="#L1125" title="src/http/v2/ngx_http_v2_filter_module.c:1125">ngx_http_v2_headers_frame_handler</a>;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;stream = stream;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;length = rest;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;blocked = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;fin = r-&gt;header_only;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ll = &amp;frame-&gt;first;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; type = <a href="ngx_http_v2.h.html#L31" title="src/http/v2/ngx_http_v2.h:31">NGX_HTTP_V2_HEADERS_FRAME</a>;<br/></li>
<li>&nbsp; &nbsp; flags = r-&gt;header_only ? <a href="ngx_http_v2.h.html#L44" title="src/http/v2/ngx_http_v2.h:44">NGX_HTTP_V2_END_STREAM_FLAG</a> : <a href="ngx_http_v2.h.html#L42" title="src/http/v2/ngx_http_v2.h:42">NGX_HTTP_V2_NO_FLAG</a>;<br/></li>
<li>&nbsp; &nbsp; frame_size = stream-&gt;connection-&gt;frame_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rest &lt;= frame_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frame_size = rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flags |= <a href="ngx_http_v2.h.html#L45" title="src/http/v2/ngx_http_v2.h:45">NGX_HTTP_V2_END_HEADERS_FLAG</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = <a href="../../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(r-&gt;pool, <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = <a href="ngx_http_v2.h.html#L337" title="src/http/v2/ngx_http_v2.h:337">ngx_http_v2_write_len_and_type</a>(b-&gt;last, frame_size, type);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *b-&gt;last++ = flags;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = <a href="ngx_http_v2.h.html#L340" title="src/http/v2/ngx_http_v2.h:340">ngx_http_v2_write_sid</a>(b-&gt;last, stream-&gt;node-&gt;id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;tag = (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf = b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ll = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = <a href="../../core/ngx_buf.h.html#L154" title="src/core/ngx_buf.h:154">ngx_calloc_buf</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pos += frame_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = b-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = b-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf = b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ll = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rest -= frame_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type = <a href="ngx_http_v2.h.html#L39" title="src/http/v2/ngx_http_v2.h:39">NGX_HTTP_V2_CONTINUATION_FRAME</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flags = <a href="ngx_http_v2.h.html#L42" title="src/http/v2/ngx_http_v2.h:42">NGX_HTTP_V2_NO_FLAG</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last_buf = r-&gt;header_only;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;last = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2:</span><span class="Special">%u</span><span class="Constant">i create HEADERS frame </span><span class="Special">%p</span><span class="Constant">: len:</span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;node-&gt;id, frame, frame-&gt;length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> frame;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<br/></li>
<li><a id="L750">&#x200c;</a><span class="linkable">ngx_http_v2_send_chain</span>(<a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *fc, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in, <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span> limit)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size, offset;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rest, frame_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl, *out, **ln;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; &nbsp; &nbsp; *stream;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2_module.h.html#L37" title="src/http/v2/ngx_http_v2_module.h:37">ngx_http_v2_loc_conf_t</a>&nbsp; &nbsp; *h2lcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp;&nbsp; *frame;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = fc-&gt;data;<br/></li>
<li>&nbsp; &nbsp; stream = r-&gt;stream;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (in) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <a href="../../core/ngx_buf.h.html#L145" title="src/core/ngx_buf.h:145">ngx_buf_size</a>(in-&gt;buf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size || in-&gt;buf-&gt;last_buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; in = in-&gt;next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;queued) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;active = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;buffered &amp;= ~<a href="../../core/ngx_connection.h.html#L122" title="src/core/ngx_connection.h:122">NGX_HTTP_V2_BUFFERED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c = stream-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &amp;&amp; <a href="#L1075" title="src/http/v2/ngx_http_v2_filter_module.c:1075">ngx_http_v2_flow_control</a>(h2c, stream) == <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;active = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> in;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;buf-&gt;tag == (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L941" title="src/http/v2/ngx_http_v2_filter_module.c:941">ngx_http_v2_filter_get_shadow</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_buf.h.html#L131" title="src/core/ngx_buf.h:131">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf = in-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; in-&gt;buf = cl-&gt;buf-&gt;shadow;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset = <a href="../../core/ngx_buf.h.html#L134" title="src/core/ngx_buf.h:134">ngx_buf_in_memory</a>(in-&gt;buf)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ? (cl-&gt;buf-&gt;pos - in-&gt;buf-&gt;pos)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; : (cl-&gt;buf-&gt;file_pos - in-&gt;buf-&gt;file_pos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = stream-&gt;free_bufs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_bufs = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limit == <span class="Constant">0</span> || limit &gt; (<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) h2c-&gt;send_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit = h2c-&gt;send_window;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (limit &gt; stream-&gt;send_window) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit = (stream-&gt;send_window &gt; <span class="Constant">0</span>) ? stream-&gt;send_window : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2lcf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame_size = (h2lcf-&gt;chunk_size &lt; h2c-&gt;frame_size)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ? h2lcf-&gt;chunk_size : h2c-&gt;frame_size;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; cl = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) frame_size &gt; limit) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frame_size = (<span class="Type">size_t</span>) limit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ln = &amp;out;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rest = frame_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> ((<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) rest &gt;= size) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (offset) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="#L941" title="src/http/v2/ngx_http_v2_filter_module.c:941">ngx_http_v2_filter_get_shadow</a>(stream, in-&gt;buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offset, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_buf.h.html#L131" title="src/core/ngx_buf.h:131">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offset = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_buf.h.html#L131" title="src/core/ngx_buf.h:131">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf = in-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ln = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ln = &amp;cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rest -= (<span class="Type">size_t</span>) size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in = in-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frame_size -= rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rest = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = <a href="../../core/ngx_buf.h.html#L145" title="src/core/ngx_buf.h:145">ngx_buf_size</a>(in-&gt;buf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="#L941" title="src/http/v2/ngx_http_v2_filter_module.c:941">ngx_http_v2_filter_get_shadow</a>(stream, in-&gt;buf, offset, rest);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_buf.h.html#L131" title="src/core/ngx_buf.h:131">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;flush = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;last_buf = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ln = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offset += rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size -= rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame = <a href="#L974" title="src/http/v2/ngx_http_v2_filter_module.c:974">ngx_http_v2_filter_get_data_frame</a>(stream, frame_size, out, cl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_buf.h.html#L131" title="src/core/ngx_buf.h:131">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L221" title="src/http/v2/ngx_http_v2.h:221">ngx_http_v2_queue_frame</a>(h2c, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h2c-&gt;send_window -= frame_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;send_window -= frame_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;queued++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; limit -= frame_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (limit == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (offset) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="#L941" title="src/http/v2/ngx_http_v2_filter_module.c:941">ngx_http_v2_filter_get_shadow</a>(stream, in-&gt;buf, offset, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_buf.h.html#L131" title="src/core/ngx_buf.h:131">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; in-&gt;buf = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L157" title="src/core/ngx_buf.h:157">ngx_free_chain</a>(r-&gt;pool, cl);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1050" title="src/http/v2/ngx_http_v2_filter_module.c:1050">ngx_http_v2_filter_send</a>(fc, stream) == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_buf.h.html#L131" title="src/core/ngx_buf.h:131">NGX_CHAIN_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in &amp;&amp; <a href="#L1075" title="src/http/v2/ngx_http_v2_filter_module.c:1075">ngx_http_v2_flow_control</a>(h2c, stream) == <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;active = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> in;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<br/></li>
<li><a id="L941">&#x200c;</a><span class="linkable">ngx_http_v2_filter_get_shadow</span>(<a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream, <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *buf,<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span> offset, <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; *chunk;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; *cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L156" title="src/core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(stream-&gt;request-&gt;pool, &amp;stream-&gt;free_bufs);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; chunk = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(chunk, buf, <span class="Statement">sizeof</span>(<a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; chunk-&gt;tag = (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L941" title="src/http/v2/ngx_http_v2_filter_module.c:941">ngx_http_v2_filter_get_shadow</a>;<br/></li>
<li>&nbsp; &nbsp; chunk-&gt;shadow = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_buf.h.html#L134" title="src/core/ngx_buf.h:134">ngx_buf_in_memory</a>(chunk)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk-&gt;pos += offset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk-&gt;last = chunk-&gt;pos + size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (chunk-&gt;in_file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk-&gt;file_pos += offset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk-&gt;file_last = chunk-&gt;file_pos + size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> cl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *<br/></li>
<li><a id="L974">&#x200c;</a><span class="linkable">ngx_http_v2_filter_get_data_frame</span>(<a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> len, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *first, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *last)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flags;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cl;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp; *frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame = stream-&gt;free_frames;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_frames = frame-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(stream-&gt;request-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; flags = last-&gt;buf-&gt;last_buf ? <a href="ngx_http_v2.h.html#L44" title="src/http/v2/ngx_http_v2.h:44">NGX_HTTP_V2_END_STREAM_FLAG</a> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L148" title="src/core/ngx_log.h:148">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, stream-&gt;request-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2:</span><span class="Special">%u</span><span class="Constant">i create DATA frame </span><span class="Special">%p</span><span class="Constant">: len:</span><span class="Special">%u</span><span class="Constant">z flags:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;node-&gt;id, frame, len, (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) flags);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L156" title="src/core/ngx_buf.c:156">ngx_chain_get_free_buf</a>(stream-&gt;request-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;stream-&gt;free_frame_headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;start = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(stream-&gt;request-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;end = buf-&gt;start + <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;last = buf-&gt;end;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;tag = (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;memory = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;pos = buf-&gt;start;<br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L337" title="src/http/v2/ngx_http_v2.h:337">ngx_http_v2_write_len_and_type</a>(buf-&gt;last, len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_v2.h.html#L30" title="src/http/v2/ngx_http_v2.h:30">NGX_HTTP_V2_DATA_FRAME</a>);<br/></li>
<li>&nbsp; &nbsp; *buf-&gt;last++ = flags;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; buf-&gt;last = <a href="ngx_http_v2.h.html#L340" title="src/http/v2/ngx_http_v2.h:340">ngx_http_v2_write_sid</a>(buf-&gt;last, stream-&gt;node-&gt;id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;next = first;<br/></li>
<li>&nbsp; &nbsp; first = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last-&gt;buf-&gt;flush = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame-&gt;first = first;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;last = last;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;handler = <a href="#L1176" title="src/http/v2/ngx_http_v2_filter_module.c:1176">ngx_http_v2_data_frame_handler</a>;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;stream = stream;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;length = len;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;blocked = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; frame-&gt;fin = last-&gt;buf-&gt;last_buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> frame;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1050">&#x200c;</a><span class="linkable">ngx_http_v2_filter_send</span>(<a href="../../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *fc, <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; stream-&gt;blocked = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_v2.c.html#L453" title="src/http/v2/ngx_http_v2.c:453">ngx_http_v2_send_output_queue</a>(stream-&gt;connection) == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;blocked = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;queued) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;buffered |= <a href="../../core/ngx_connection.h.html#L122" title="src/core/ngx_connection.h:122">NGX_HTTP_V2_BUFFERED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;active = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fc-&gt;write-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fc-&gt;buffered &amp;= ~<a href="../../core/ngx_connection.h.html#L122" title="src/core/ngx_connection.h:122">NGX_HTTP_V2_BUFFERED</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1075">&#x200c;</a><span class="linkable">ngx_http_v2_flow_control</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;send_window &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;exhausted = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;send_window == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1093" title="src/http/v2/ngx_http_v2_filter_module.c:1093">ngx_http_v2_waiting_queue</a>(h2c, stream);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1093">&#x200c;</a></span><span class="linkable">ngx_http_v2_waiting_queue</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; *s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;handled) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;handled = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../../core/ngx_queue.h.html#L54" title="src/core/ngx_queue.h:54">ngx_queue_last</a>(&amp;h2c-&gt;waiting);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../../core/ngx_queue.h.html#L58" title="src/core/ngx_queue.h:58">ngx_queue_sentinel</a>(&amp;h2c-&gt;waiting);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../../core/ngx_queue.h.html#L66" title="src/core/ngx_queue.h:66">ngx_queue_prev</a>(q))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s = <a href="../../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s-&gt;node-&gt;rank &lt; stream-&gt;node-&gt;rank<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || (s-&gt;node-&gt;rank == stream-&gt;node-&gt;rank<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; s-&gt;node-&gt;rel_weight &gt;= stream-&gt;node-&gt;rel_weight))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L40" title="src/core/ngx_queue.h:40">ngx_queue_insert_after</a>(q, &amp;stream-&gt;queue);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1125">&#x200c;</a><span class="linkable">ngx_http_v2_headers_frame_handler</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl, *ln;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; *stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = frame-&gt;stream;<br/></li>
<li>&nbsp; &nbsp; cl = frame-&gt;first;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;pos != cl-&gt;buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;first = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2:</span><span class="Special">%u</span><span class="Constant">i HEADERS frame </span><span class="Special">%p</span><span class="Constant"> was sent partially&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;node-&gt;id, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ln = cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;tag == (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = stream-&gt;free_frame_headers;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_frame_headers = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = stream-&gt;free_bufs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_bufs = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == frame-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = ln;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2:</span><span class="Special">%u</span><span class="Constant">i HEADERS frame </span><span class="Special">%p</span><span class="Constant"> was sent&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;node-&gt;id, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1269" title="src/http/v2/ngx_http_v2_filter_module.c:1269">ngx_http_v2_handle_frame</a>(stream, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1290" title="src/http/v2/ngx_http_v2_filter_module.c:1290">ngx_http_v2_handle_stream</a>(h2c, stream);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1176">&#x200c;</a><span class="linkable">ngx_http_v2_data_frame_handler</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *buf;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl, *ln;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a>&nbsp; *stream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream = frame-&gt;stream;<br/></li>
<li>&nbsp; &nbsp; cl = frame-&gt;first;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;tag == (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="ngx_http_v2_module.c.html#L200" title="src/http/v2/ngx_http_v2_module.c:200">ngx_http_v2_module</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;pos != cl-&gt;buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2:</span><span class="Special">%u</span><span class="Constant">i DATA frame </span><span class="Special">%p</span><span class="Constant"> was sent partially&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;node-&gt;id, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ln = cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = stream-&gt;free_frame_headers;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_frame_headers = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == frame-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = ln;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;tag == (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L941" title="src/http/v2/ngx_http_v2_filter_module.c:941">ngx_http_v2_filter_get_shadow</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf = cl-&gt;buf-&gt;shadow;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_buf.h.html#L134" title="src/core/ngx_buf.h:134">ngx_buf_in_memory</a>(buf)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;pos = cl-&gt;buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf-&gt;in_file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;file_pos = cl-&gt;buf-&gt;file_pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_buf.h.html#L145" title="src/core/ngx_buf.h:145">ngx_buf_size</a>(cl-&gt;buf) != <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl != frame-&gt;first) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frame-&gt;first = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1290" title="src/http/v2/ngx_http_v2_filter_module.c:1290">ngx_http_v2_handle_stream</a>(h2c, stream);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2:</span><span class="Special">%u</span><span class="Constant">i DATA frame </span><span class="Special">%p</span><span class="Constant"> was sent partially&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;node-&gt;id, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ln = cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf-&gt;tag == (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L941" title="src/http/v2/ngx_http_v2_filter_module.c:941">ngx_http_v2_filter_get_shadow</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = stream-&gt;free_bufs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;free_bufs = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L157" title="src/core/ngx_buf.h:157">ngx_free_chain</a>(stream-&gt;request-&gt;pool, cl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == frame-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl = ln;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, h2c-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http2:</span><span class="Special">%u</span><span class="Constant">i DATA frame </span><span class="Special">%p</span><span class="Constant"> was sent&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stream-&gt;node-&gt;id, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;request-&gt;header_size += <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1269" title="src/http/v2/ngx_http_v2_filter_module.c:1269">ngx_http_v2_handle_frame</a>(stream, frame);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1290" title="src/http/v2/ngx_http_v2_filter_module.c:1290">ngx_http_v2_handle_stream</a>(h2c, stream);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <span class="Type">void<br/></li>
<li><a id="L1269">&#x200c;</a></span><span class="linkable">ngx_http_v2_handle_frame</span>(<a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a> *frame)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = stream-&gt;request;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;connection-&gt;sent += <a href="ngx_http_v2.h.html#L27" title="src/http/v2/ngx_http_v2.h:27">NGX_HTTP_V2_FRAME_HEADER_SIZE</a> + frame-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (frame-&gt;fin) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;out_closed = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; frame-&gt;next = stream-&gt;free_frames;<br/></li>
<li>&nbsp; &nbsp; stream-&gt;free_frames = frame;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; stream-&gt;queued--;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <span class="Type">void<br/></li>
<li><a id="L1290">&#x200c;</a></span><span class="linkable">ngx_http_v2_handle_stream</span>(<a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a> *h2c,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; *wev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;handled || stream-&gt;blocked || stream-&gt;exhausted) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev = stream-&gt;request-&gt;connection-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;handled = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L43" title="src/core/ngx_queue.h:43">ngx_queue_insert_tail</a>(&amp;h2c-&gt;posted, &amp;stream-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1309">&#x200c;</a></span><span class="linkable">ngx_http_v2_filter_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L24" title="src/http/ngx_http.h:24">ngx_http_v2_stream_t</a> *stream = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; window;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L55" title="src/http/v2/ngx_http_v2.h:55">ngx_http_v2_out_frame_t</a>&nbsp;&nbsp; *frame, **fn;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_v2.h.html#L53" title="src/http/v2/ngx_http_v2.h:53">ngx_http_v2_connection_t</a>&nbsp; *h2c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;handled) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stream-&gt;handled = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;stream-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (stream-&gt;queued == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; window = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; h2c = stream-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; fn = &amp;h2c-&gt;last_out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; frame = *fn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (frame-&gt;stream == stream &amp;&amp; !frame-&gt;blocked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *fn = frame-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; window += frame-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--stream-&gt;queued == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fn = &amp;frame-&gt;next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h2c-&gt;send_window == <span class="Constant">0</span> &amp;&amp; window &amp;&amp; !<a href="../../core/ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;h2c-&gt;waiting)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L96" title="src/core/ngx_queue.h:96">ngx_queue_add</a>(&amp;h2c-&gt;posted, &amp;h2c-&gt;waiting);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;h2c-&gt;waiting);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h2c-&gt;send_window += window;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1362">&#x200c;</a><span class="linkable">ngx_http_v2_filter_init</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a> = <a href="../ngx_http.c.html#L73" title="src/http/ngx_http.c:73">ngx_http_top_header_filter</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.c.html#L73" title="src/http/ngx_http.c:73">ngx_http_top_header_filter</a> = <a href="#L127" title="src/http/v2/ngx_http_v2_filter_module.c:127">ngx_http_v2_header_filter</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
