<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/http/modules/ngx_http_charset_filter_module.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

  <h1>src/http/modules/ngx_http_charset_filter_module.c - Nginx 1.11.2</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L126">ngx_http_charset_default_types</a></li>
<li><a href="#L137">ngx_http_charset_filter_commands</a></li>
<li><a href="#L196">ngx_http_charset_filter_module</a></li>
<li><a href="#L181">ngx_http_charset_filter_module_ctx</a></li>
<li><a href="#L213">ngx_http_next_body_filter</a></li>
<li><a href="#L212">ngx_http_next_header_filter</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L85">ngx_http_charset_conf_ctx_t</a></li>
<li><a href="#L78">ngx_http_charset_ctx_t</a></li>
<li><a href="#L60">ngx_http_charset_loc_conf_t</a></li>
<li><a href="#L50">ngx_http_charset_main_conf_t</a></li>
<li><a href="#L35">ngx_http_charset_recode_t</a></li>
<li><a href="#L29">ngx_http_charset_t</a></li>
<li><a href="#L43">ngx_http_charset_tables_t</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L1449">ngx_http_add_charset</a></li>
<li><a href="#L547">ngx_http_charset_body_filter</a></li>
<li><a href="#L1524">ngx_http_charset_create_loc_conf</a></li>
<li><a href="#L1490">ngx_http_charset_create_main_conf</a></li>
<li><a href="#L514">ngx_http_charset_ctx</a></li>
<li><a href="#L1093">ngx_http_charset_get_buf</a></li>
<li><a href="#L1127">ngx_http_charset_get_buffer</a></li>
<li><a href="#L217">ngx_http_charset_header_filter</a></li>
<li><a href="#L1307">ngx_http_charset_map</a></li>
<li><a href="#L1171">ngx_http_charset_map_block</a></li>
<li><a href="#L1549">ngx_http_charset_merge_loc_conf</a></li>
<li><a href="#L1608">ngx_http_charset_postconfiguration</a></li>
<li><a href="#L652">ngx_http_charset_recode</a></li>
<li><a href="#L685">ngx_http_charset_recode_from_utf8</a></li>
<li><a href="#L966">ngx_http_charset_recode_to_utf8</a></li>
<li><a href="#L317">ngx_http_destination_charset</a></li>
<li><a href="#L465">ngx_http_get_charset</a></li>
<li><a href="#L385">ngx_http_main_request_charset</a></li>
<li><a href="#L491">ngx_http_set_charset</a></li>
<li><a href="#L1397">ngx_http_set_charset_slot</a></li>
<li><a href="#L422">ngx_http_source_charset</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L20">NGX_HTML_ENTITY_LEN</a></li>
<li><a href="#L13">NGX_HTTP_CHARSET_OFF</a></li>
<li><a href="#L15">NGX_HTTP_CHARSET_VAR</a></li>
<li><a href="#L14">NGX_HTTP_NO_CHARSET</a></li>
<li><a href="#L18">NGX_UTF_LEN</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L13">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_CHARSET_OFF</span>&nbsp; &nbsp; -</span><span class="Constant">2<br/></li>
<li><a id="L14">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_NO_CHARSET</span>&nbsp; &nbsp;&nbsp; -</span><span class="Constant">3<br/></li>
<li><a id="L15">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_CHARSET_VAR</span>&nbsp; &nbsp; </span><span class="Constant">0x10000<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* 1 byte length and up to 3 bytes for the UTF-8 encoding of the UCS-2 */<br/></li>
<li><a id="L18">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_UTF_LEN</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">4<br/></li>
<li></span><br/></li>
<li><a id="L20">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTML_ENTITY_LEN</span>&nbsp; &nbsp;&nbsp; (</span><span class="Statement">sizeof</span><span class="PreProc">(</span><span class="Constant">&quot;&amp;#1114111;&quot;</span><span class="PreProc">) - </span><span class="Constant">1</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **tables;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; length:<span class="Constant">16</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; utf8:<span class="Constant">1</span>;<br/></li>
<li><a id="L29">&#x200c;</a>} <span class="linkable">ngx_http_charset_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; src;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; dst;<br/></li>
<li><a id="L35">&#x200c;</a>} <span class="linkable">ngx_http_charset_recode_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; src;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; dst;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *src2dst;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *dst2src;<br/></li>
<li><a id="L43">&#x200c;</a>} <span class="linkable">ngx_http_charset_tables_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; charsets;&nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a> */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tables;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* <a href="#L43" title="src/http/modules/ngx_http_charset_filter_module.c:43">ngx_http_charset_tables_t</a> */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; recodes;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="#L35" title="src/http/modules/ngx_http_charset_filter_module.c:35">ngx_http_charset_recode_t</a> */<br/></li>
<li><a id="L50">&#x200c;</a></span>} <span class="linkable">ngx_http_charset_main_conf_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; charset;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; source_charset;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L80" title="src/core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; override_charset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_hash.h.html#L26" title="src/core/ngx_hash.h:26">ngx_hash_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; types;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *types_keys;<br/></li>
<li><a id="L60">&#x200c;</a>} <span class="linkable">ngx_http_charset_loc_conf_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *table;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; charset;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; charset_name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *busy;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *free_bufs;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *free_buffers;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; saved_len;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; saved[<a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; length:<span class="Constant">16</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from_utf8:<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to_utf8:<span class="Constant">1</span>;<br/></li>
<li><a id="L78">&#x200c;</a>} <span class="linkable">ngx_http_charset_ctx_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="#L43" title="src/http/modules/ngx_http_charset_filter_module.c:43">ngx_http_charset_tables_t</a>&nbsp; *table;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *charset;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; characters;<br/></li>
<li><a id="L85">&#x200c;</a>} <span class="linkable">ngx_http_charset_conf_ctx_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L317" title="src/http/modules/ngx_http_charset_filter_module.c:317">ngx_http_destination_charset</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L385" title="src/http/modules/ngx_http_charset_filter_module.c:385">ngx_http_main_request_charset</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L422" title="src/http/modules/ngx_http_charset_filter_module.c:422">ngx_http_source_charset</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L465" title="src/http/modules/ngx_http_charset_filter_module.c:465">ngx_http_get_charset</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <span class="Type">void</span> <a href="#L491" title="src/http/modules/ngx_http_charset_filter_module.c:491">ngx_http_set_charset</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *charset);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L514" title="src/http/modules/ngx_http_charset_filter_module.c:514">ngx_http_charset_ctx</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a> *charsets, <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> charset, <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> source_charset);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> <a href="#L652" title="src/http/modules/ngx_http_charset_filter_module.c:652">ngx_http_charset_recode</a>(<a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *b, u_char *table);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<a href="#L685" title="src/http/modules/ngx_http_charset_filter_module.c:685">ngx_http_charset_recode_from_utf8</a>(<a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *buf, <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<a href="#L966" title="src/http/modules/ngx_http_charset_filter_module.c:966">ngx_http_charset_recode_to_utf8</a>(<a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *buf, <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a> *ctx);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<a href="#L1093" title="src/http/modules/ngx_http_charset_filter_module.c:1093">ngx_http_charset_get_buf</a>(<a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool,<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<a href="#L1127" title="src/http/modules/ngx_http_charset_filter_module.c:1127">ngx_http_charset_get_buffer</a>(<a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool,<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a> *ctx, <span class="Type">size_t</span> size);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1171" title="src/http/modules/ngx_http_charset_filter_module.c:1171">ngx_http_charset_map_block</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1307" title="src/http/modules/ngx_http_charset_filter_module.c:1307">ngx_http_charset_map</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *dummy,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1397" title="src/http/modules/ngx_http_charset_filter_module.c:1397">ngx_http_set_charset_slot</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1449" title="src/http/modules/ngx_http_charset_filter_module.c:1449">ngx_http_add_charset</a>(<a href="../../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a> *charsets, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L1490" title="src/http/modules/ngx_http_charset_filter_module.c:1490">ngx_http_charset_create_main_conf</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L1524" title="src/http/modules/ngx_http_charset_filter_module.c:1524">ngx_http_charset_create_loc_conf</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1549" title="src/http/modules/ngx_http_charset_filter_module.c:1549">ngx_http_charset_merge_loc_conf</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *parent, <span class="Type">void</span> *child);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1608" title="src/http/modules/ngx_http_charset_filter_module.c:1608">ngx_http_charset_postconfiguration</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L126">&#x200c;</a><a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; <span class="linkable">ngx_http_charset_default_types</span>[] = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;text/html&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;text/xml&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;text/plain&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;text/vnd.wap.wml&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;application/javascript&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;application/rss+xml&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L41" title="src/core/ngx_string.h:41">ngx_null_string</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L137">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a>&nbsp; <span class="linkable">ngx_http_charset_filter_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;charset&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="src/http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<a href="../ngx_http_config.h.html#L46" title="src/http/ngx_http_config.h:46">NGX_HTTP_LIF_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L1397" title="src/http/modules/ngx_http_charset_filter_module.c:1397">ngx_http_set_charset_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a>, charset),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;source_charset&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="src/http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<a href="../ngx_http_config.h.html#L46" title="src/http/ngx_http_config.h:46">NGX_HTTP_LIF_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L1397" title="src/http/modules/ngx_http_charset_filter_module.c:1397">ngx_http_set_charset_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a>, source_charset),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;override_charset&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="src/http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<a href="../ngx_http_config.h.html#L46" title="src/http/ngx_http_config.h:46">NGX_HTTP_LIF_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L44" title="src/core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L984" title="src/core/ngx_conf_file.c:984">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a>, override_charset),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;charset_types&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="src/http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L46" title="src/core/ngx_conf_file.h:46">NGX_CONF_1MORE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http.c.html#L1914" title="src/http/ngx_http.c:1914">ngx_http_types_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a>, types_keys),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &amp;<a href="#L126" title="src/http/modules/ngx_http_charset_filter_module.c:126">ngx_http_charset_default_types</a>[<span class="Constant">0</span>] },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;charset_map&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L43" title="src/core/ngx_conf_file.h:43">NGX_CONF_BLOCK</a>|<a href="../../core/ngx_conf_file.h.html#L24" title="src/core/ngx_conf_file.h:24">NGX_CONF_TAKE2</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L1171" title="src/http/modules/ngx_http_charset_filter_module.c:1171">ngx_http_charset_map_block</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L50" title="src/http/ngx_http_config.h:50">NGX_HTTP_MAIN_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L86" title="src/core/ngx_conf_file.h:86">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L181">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_config.h.html#L36" title="src/http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_charset_filter_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1608" title="src/http/modules/ngx_http_charset_filter_module.c:1608">ngx_http_charset_postconfiguration</a>,&nbsp; &nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1490" title="src/http/modules/ngx_http_charset_filter_module.c:1490">ngx_http_charset_create_main_conf</a>,&nbsp; &nbsp;&nbsp; <span class="Comment">/* create <a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1524" title="src/http/modules/ngx_http_charset_filter_module.c:1524">ngx_http_charset_create_loc_conf</a>,&nbsp; &nbsp; &nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1549" title="src/http/modules/ngx_http_charset_filter_module.c:1549">ngx_http_charset_merge_loc_conf</a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L196">&#x200c;</a><a href="../../core/ngx_core.h.html#L15" title="src/core/ngx_core.h:15">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_charset_filter_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_module.h.html#L230" title="src/core/ngx_module.h:230">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L181" title="src/http/modules/ngx_http_charset_filter_module.c:181">ngx_http_charset_filter_module_ctx</a>,&nbsp;&nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L137" title="src/http/modules/ngx_http_charset_filter_module.c:137">ngx_http_charset_filter_commands</a>,&nbsp; &nbsp; &nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../ngx_http_config.h.html#L39" title="src/http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_module.h.html#L234" title="src/core/ngx_module.h:234">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L212">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_core_module.h.html#L526" title="src/http/ngx_http_core_module.h:526">ngx_http_output_header_filter_pt</a>&nbsp; <span class="linkable">ngx_http_next_header_filter</span>;<br/></li>
<li><a id="L213">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_core_module.h.html#L527" title="src/http/ngx_http_core_module.h:527">ngx_http_output_body_filter_pt</a>&nbsp; &nbsp; <span class="linkable">ngx_http_next_body_filter</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L217">&#x200c;</a><span class="linkable">ngx_http_charset_header_filter</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; charset, source_charset;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst, src;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *charsets;<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>&nbsp; *mcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r == r-&gt;<a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; charset = <a href="#L317" title="src/http/modules/ngx_http_charset_filter_module.c:317">ngx_http_destination_charset</a>(r, &amp;dst);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; charset = <a href="#L385" title="src/http/modules/ngx_http_charset_filter_module.c:385">ngx_http_main_request_charset</a>(r, &amp;dst);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (charset == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (charset == <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* charset: charset index or <a href="#L14" title="src/http/modules/ngx_http_charset_filter_module.c:14">NGX_HTTP_NO_CHARSET</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; source_charset = <a href="#L422" title="src/http/modules/ngx_http_charset_filter_module.c:422">ngx_http_source_charset</a>(r, &amp;src);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (source_charset == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * source_charset: charset index, <a href="#L14" title="src/http/modules/ngx_http_charset_filter_module.c:14">NGX_HTTP_NO_CHARSET</a>,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; or <a href="#L13" title="src/http/modules/ngx_http_charset_filter_module.c:13">NGX_HTTP_CHARSET_OFF</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;charset: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> &gt; </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;src, &amp;dst);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (source_charset == <a href="#L13" title="src/http/modules/ngx_http_charset_filter_module.c:13">NGX_HTTP_CHARSET_OFF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L491" title="src/http/modules/ngx_http_charset_filter_module.c:491">ngx_http_set_charset</a>(r, &amp;dst);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (charset == <a href="#L14" title="src/http/modules/ngx_http_charset_filter_module.c:14">NGX_HTTP_NO_CHARSET</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || source_charset == <a href="#L14" title="src/http/modules/ngx_http_charset_filter_module.c:14">NGX_HTTP_NO_CHARSET</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (source_charset != charset<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="../../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(dst.data, src.data, dst.len) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> no_charset_map;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L491" title="src/http/modules/ngx_http_charset_filter_module.c:491">ngx_http_set_charset</a>(r, &amp;dst);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (source_charset == charset) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type.len = r-&gt;headers_out.content_type_len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L491" title="src/http/modules/ngx_http_charset_filter_module.c:491">ngx_http_set_charset</a>(r, &amp;dst);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* source_charset != charset */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_encoding<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.content_encoding-&gt;value.len)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mcf = <a href="../ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li>&nbsp; &nbsp; charsets = mcf-&gt;charsets.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (charsets[source_charset].tables == <span class="Constant">NULL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; || charsets[source_charset].tables[charset] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> no_charset_map;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_type.len = r-&gt;headers_out.content_type_len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L491" title="src/http/modules/ngx_http_charset_filter_module.c:491">ngx_http_set_charset</a>(r, &amp;dst);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L514" title="src/http/modules/ngx_http_charset_filter_module.c:514">ngx_http_charset_ctx</a>(r, charsets, charset, source_charset);<br/></li>
<li><br/></li>
<li><span class="Statement">no_charset_map</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no </span><span class="Special">\&quot;</span><span class="Constant">charset_map</span><span class="Special">\&quot;</span><span class="Constant"> between the charsets </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> and </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;src, &amp;dst);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L317">&#x200c;</a><span class="linkable">ngx_http_destination_charset</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; charset;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *charsets;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="src/http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; &nbsp;&nbsp; *vv;<br/></li>
<li>&nbsp; &nbsp; <a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a>&nbsp;&nbsp; *mlcf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>&nbsp; *mcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.override_charset<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;headers_out.override_charset-&gt;len)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *name = *r-&gt;headers_out.override_charset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; charset = <a href="#L465" title="src/http/modules/ngx_http_charset_filter_module.c:465">ngx_http_get_charset</a>(r, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (charset != <a href="#L14" title="src/http/modules/ngx_http_charset_filter_module.c:14">NGX_HTTP_NO_CHARSET</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> charset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unknown charset </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> to override&quot;</span>, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mlcf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li>&nbsp; &nbsp; charset = mlcf-&gt;charset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (charset == <a href="#L13" title="src/http/modules/ngx_http_charset_filter_module.c:13">NGX_HTTP_CHARSET_OFF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.charset.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mlcf-&gt;override_charset == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_core_module.c.html#L1670" title="src/http/ngx_http_core_module.c:1670">ngx_http_test_content_type</a>(r, &amp;mlcf-&gt;types) == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (charset &lt; <a href="#L15" title="src/http/modules/ngx_http_charset_filter_module.c:15">NGX_HTTP_CHARSET_VAR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mcf = <a href="../ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; charsets = mcf-&gt;charsets.elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *name = charsets[charset].name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> charset;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; vv = <a href="../ngx_http_variables.c.html#L501" title="src/http/ngx_http_variables.c:501">ngx_http_get_indexed_variable</a>(r, charset - <a href="#L15" title="src/http/modules/ngx_http_charset_filter_module.c:15">NGX_HTTP_CHARSET_VAR</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (vv == <span class="Constant">NULL</span> || vv-&gt;not_found) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name-&gt;len = vv-&gt;len;<br/></li>
<li>&nbsp; &nbsp; name-&gt;data = vv-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L465" title="src/http/modules/ngx_http_charset_filter_module.c:465">ngx_http_get_charset</a>(r, name);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L385">&#x200c;</a><span class="linkable">ngx_http_main_request_charset</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *src)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; charset;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *main_charset;<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../ngx_http.h.html#L78" title="src/http/ngx_http.h:78">ngx_http_get_module_ctx</a>(r-&gt;<a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *src = ctx-&gt;charset_name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> ctx-&gt;charset;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; main_charset = &amp;r-&gt;<a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;headers_out.charset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (main_charset-&gt;len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L79" title="src/http/ngx_http.h:79">ngx_http_set_ctx</a>(r-&gt;<a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>, ctx, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; charset = <a href="#L465" title="src/http/modules/ngx_http_charset_filter_module.c:465">ngx_http_get_charset</a>(r, main_charset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;charset = charset;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;charset_name = *main_charset;<br/></li>
<li>&nbsp; &nbsp; *src = *main_charset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> charset;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L422">&#x200c;</a><span class="linkable">ngx_http_source_charset</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; charset;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *charsets;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_variables.h.html#L17" title="src/http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>&nbsp; &nbsp;&nbsp; *vv;<br/></li>
<li>&nbsp; &nbsp; <a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a>&nbsp;&nbsp; *lcf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>&nbsp; *mcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.charset.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *name = r-&gt;headers_out.charset;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L465" title="src/http/modules/ngx_http_charset_filter_module.c:465">ngx_http_get_charset</a>(r, name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lcf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; charset = lcf-&gt;source_charset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (charset == <a href="#L13" title="src/http/modules/ngx_http_charset_filter_module.c:13">NGX_HTTP_CHARSET_OFF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name-&gt;len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> charset;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (charset &lt; <a href="#L15" title="src/http/modules/ngx_http_charset_filter_module.c:15">NGX_HTTP_CHARSET_VAR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mcf = <a href="../ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; charsets = mcf-&gt;charsets.elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *name = charsets[charset].name;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> charset;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; vv = <a href="../ngx_http_variables.c.html#L501" title="src/http/ngx_http_variables.c:501">ngx_http_get_indexed_variable</a>(r, charset - <a href="#L15" title="src/http/modules/ngx_http_charset_filter_module.c:15">NGX_HTTP_CHARSET_VAR</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (vv == <span class="Constant">NULL</span> || vv-&gt;not_found) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name-&gt;len = vv-&gt;len;<br/></li>
<li>&nbsp; &nbsp; name-&gt;data = vv-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L465" title="src/http/modules/ngx_http_charset_filter_module.c:465">ngx_http_get_charset</a>(r, name);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L465">&#x200c;</a><span class="linkable">ngx_http_get_charset</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, n;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *charset;<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>&nbsp; *mcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mcf = <a href="../ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; charset = mcf-&gt;charsets.elts;<br/></li>
<li>&nbsp; &nbsp; n = mcf-&gt;charsets.nelts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (charset[i].name.len != name-&gt;len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(charset[i].name.data, name-&gt;data, name-&gt;len) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L14" title="src/http/modules/ngx_http_charset_filter_module.c:14">NGX_HTTP_NO_CHARSET</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../os/win32/ngx_win32_config.h.html#L127" title="src/os/win32/ngx_win32_config.h:127">ngx_inline</a> <span class="Type">void<br/></li>
<li><a id="L491">&#x200c;</a></span><span class="linkable">ngx_http_set_charset</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *charset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != r-&gt;<a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.status == <a href="../ngx_http_request.h.html#L79" title="src/http/ngx_http_request.h:79">NGX_HTTP_MOVED_PERMANENTLY</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;headers_out.status == <a href="../ngx_http_request.h.html#L80" title="src/http/ngx_http_request.h:80">NGX_HTTP_MOVED_TEMPORARILY</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * do not set charset for the redirect because NN 4.x<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * use this charset instead of the next page charset<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.charset.len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.charset = *charset;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L514">&#x200c;</a><span class="linkable">ngx_http_charset_ctx</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a> *charsets,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> charset, <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> source_charset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L79" title="src/http/ngx_http.h:79">ngx_http_set_ctx</a>(r, ctx, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;table = charsets[source_charset].tables[charset];<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;charset = charset;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;charset_name = charsets[charset].name;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;length = charsets[charset].length;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;from_utf8 = charsets[source_charset].utf8;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;to_utf8 = charsets[charset].utf8;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;filter_need_in_memory = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((ctx-&gt;to_utf8 || ctx-&gt;from_utf8) &amp;&amp; r == r-&gt;<a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_core_module.h.html#L554" title="src/http/ngx_http_core_module.h:554">ngx_http_clear_content_length</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;filter_need_temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L547">&#x200c;</a><span class="linkable">ngx_http_charset_body_filter</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cl, *out, **ll;<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../ngx_http.h.html#L78" title="src/http/ngx_http.h:78">ngx_http_get_module_ctx</a>(r, <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span> || ctx-&gt;table == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a>(r, in);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((ctx-&gt;to_utf8 || ctx-&gt;from_utf8) || ctx-&gt;busy) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (cl = in; cl; cl = cl-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_buf.h.html#L145" title="src/core/ngx_buf.h:145">ngx_buf_size</a>(b) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ll = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*ll == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (*ll)-&gt;buf = b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (*ll)-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;(*ll)-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;to_utf8) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ll = <a href="#L966" title="src/http/modules/ngx_http_charset_filter_module.c:966">ngx_http_charset_recode_to_utf8</a>(r-&gt;pool, b, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ll = <a href="#L685" title="src/http/modules/ngx_http_charset_filter_module.c:685">ngx_http_charset_recode_from_utf8</a>(r-&gt;pool, b, ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*ll == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (*ll) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;(*ll)-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a>(r, out);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (out) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;busy == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;busy = out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (cl = ctx-&gt;busy; cl-&gt;next; cl = cl-&gt;next) { <span class="Comment">/* void */</span> }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = out;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (ctx-&gt;busy) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = ctx-&gt;busy;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_buf.h.html#L145" title="src/core/ngx_buf.h:145">ngx_buf_size</a>(b) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;busy = cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;tag != (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;shadow) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;shadow-&gt;pos = b-&gt;shadow-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = ctx-&gt;free_buffers;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;free_buffers = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = ctx-&gt;free_bufs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;free_bufs = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cl = in; cl; cl = cl-&gt;next) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L652" title="src/http/modules/ngx_http_charset_filter_module.c:652">ngx_http_charset_recode</a>(cl-&gt;buf, ctx-&gt;table);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a>(r, in);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a><br/></li>
<li><a id="L652">&#x200c;</a><span class="linkable">ngx_http_charset_recode</span>(<a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *b, u_char *table)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p, *last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last = b-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = b-&gt;pos; p &lt; last; p++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p != table[*p]) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> recode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">recode</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p != table[*p]) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p = table[*p];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (p &lt; last);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;in_file = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<br/></li>
<li><a id="L685">&#x200c;</a><span class="linkable">ngx_http_charset_recode_from_utf8</span>(<a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool, <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *buf,<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; len, size;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; c, *p, *src, *dst, *saved, **table;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; *out, *cl, **ll;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; src = buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;saved_len == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> ( <span class="Comment">/* void */</span> ; src &lt; buf-&gt;last; src++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*src &lt; <span class="Constant">0x80</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = src - buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &gt; <span class="Constant">512</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out = <a href="#L1093" title="src/http/modules/ngx_http_charset_filter_module.c:1093">ngx_http_charset_get_buf</a>(pool, ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (out == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = out-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = buf-&gt;temporary;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;memory = buf-&gt;memory;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;mmap = buf-&gt;mmap;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;flush = buf-&gt;flush;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = src;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;buf = b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = buf-&gt;last - src;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; saved = src;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../../core/ngx_string.c.html#L1295" title="src/core/ngx_string.c:1295">ngx_utf8_decode</a>(&amp;saved, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0xfffffffe</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* incomplete UTF-8 symbol */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(ctx-&gt;saved, src, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;saved_len = size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;shadow = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> out;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = len + buf-&gt;last - src;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src = buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &lt; <a href="#L20" title="src/http/modules/ngx_http_charset_filter_module.c:20">NGX_HTML_ENTITY_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size += <a href="#L20" title="src/http/modules/ngx_http_charset_filter_module.c:20">NGX_HTML_ENTITY_LEN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="#L1127" title="src/http/modules/ngx_http_charset_filter_module.c:1127">ngx_http_charset_get_buffer</a>(pool, ctx, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (out) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;next = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst = b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> recode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (out == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;buf = buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> out;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* process incomplete UTF sequence from previous buffer */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, pool-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http charset utf saved: %z&quot;</span>, ctx-&gt;saved_len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = src;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = ctx-&gt;saved_len; i &lt; <a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;saved[i] = *p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == buf-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; saved = ctx-&gt;saved;<br/></li>
<li>&nbsp; &nbsp; n = <a href="../../core/ngx_string.c.html#L1295" title="src/core/ngx_string.c:1295">ngx_utf8_decode</a>(&amp;saved, i);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0x10000</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; table = (u_char **) ctx-&gt;table;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = table[n &gt;&gt; <span class="Constant">8</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = p[n &amp; <span class="Constant">0xff</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (n == <span class="Constant">0xfffffffe</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* incomplete UTF-8 symbol */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &lt; <a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out = <a href="#L1093" title="src/http/modules/ngx_http_charset_filter_module.c:1093">ngx_http_charset_get_buf</a>(pool, ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (out == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = out-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = buf-&gt;last;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;sync = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;shadow = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(&amp;ctx-&gt;saved[ctx-&gt;saved_len], src, i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;saved_len += i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> out;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = buf-&gt;last - buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &lt; <a href="#L20" title="src/http/modules/ngx_http_charset_filter_module.c:20">NGX_HTML_ENTITY_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size += <a href="#L20" title="src/http/modules/ngx_http_charset_filter_module.c:20">NGX_HTML_ENTITY_LEN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="#L1127" title="src/http/modules/ngx_http_charset_filter_module.c:1127">ngx_http_charset_get_buffer</a>(pool, ctx, size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; dst = b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *dst++ = c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (n == <span class="Constant">0xfffffffe</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *dst++ = <span class="Constant">'?'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, pool-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http charset invalid utf 0&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; saved = &amp;ctx-&gt;saved[<a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (n &gt; <span class="Constant">0x10ffff</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *dst++ = <span class="Constant">'?'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, pool-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http charset invalid utf 1&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="../../core/ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(dst, <span class="Constant">&quot;&amp;#</span><span class="Special">%u</span><span class="Constant">D;&quot;</span>, n);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; src += (saved - ctx-&gt;saved) - ctx-&gt;saved_len;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;saved_len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">recode</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ll = &amp;cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; table = (u_char **) ctx-&gt;table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (src &lt; buf-&gt;last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (b-&gt;end - dst) &lt; <a href="#L20" title="src/http/modules/ngx_http_charset_filter_module.c:20">NGX_HTML_ENTITY_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = buf-&gt;last - src + <a href="#L20" title="src/http/modules/ngx_http_charset_filter_module.c:20">NGX_HTML_ENTITY_LEN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="#L1127" title="src/http/modules/ngx_http_charset_filter_module.c:1127">ngx_http_charset_get_buffer</a>(pool, ctx, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ll = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst = b-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*src &lt; <span class="Constant">0x80</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dst++ = *src++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = buf-&gt;last - src;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../../core/ngx_string.c.html#L1295" title="src/core/ngx_string.c:1295">ngx_utf8_decode</a>(&amp;src, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0x10000</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = table[n &gt;&gt; <span class="Constant">8</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = p[n &amp; <span class="Constant">0xff</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dst++ = c;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="../../core/ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(dst, <span class="Constant">&quot;&amp;#</span><span class="Special">%u</span><span class="Constant">D;&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0xfffffffe</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* incomplete UTF-8 symbol */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(ctx-&gt;saved, src, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;saved_len = len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos == dst) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;sync = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0x10ffff</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dst++ = <span class="Constant">'?'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, pool-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http charset invalid utf 2&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* n &gt; 0xffff */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="../../core/ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(dst, <span class="Constant">&quot;&amp;#</span><span class="Special">%u</span><span class="Constant">D;&quot;</span>, n);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last_buf = buf-&gt;last_buf;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last_in_chain = buf-&gt;last_in_chain;<br/></li>
<li>&nbsp; &nbsp; b-&gt;flush = buf-&gt;flush;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;shadow = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> out;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<br/></li>
<li><a id="L966">&#x200c;</a><span class="linkable">ngx_http_charset_recode_to_utf8</span>(<a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool, <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *buf,<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; len, size;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp;&nbsp; *p, *src, *dst, *table;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; *out, *cl, **ll;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; table = ctx-&gt;table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (src = buf-&gt;pos; src &lt; buf-&gt;last; src++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (table[*src * <a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>] == <span class="Special">'\1'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> recode;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(pool);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (out == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out-&gt;buf = buf;<br/></li>
<li>&nbsp; &nbsp; out-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> out;<br/></li>
<li><br/></li>
<li><span class="Statement">recode</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we assume that there are about half of characters to be recoded,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * so we preallocate &quot;size / 2 + size / 2 * ctx-&gt;length&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; len = src - buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &gt; <span class="Constant">512</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = <a href="#L1093" title="src/http/modules/ngx_http_charset_filter_module.c:1093">ngx_http_charset_get_buf</a>(pool, ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (out == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = out-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = buf-&gt;temporary;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;memory = buf-&gt;memory;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;mmap = buf-&gt;mmap;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;flush = buf-&gt;flush;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = src;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;buf = b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = buf-&gt;last - src;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = size / <span class="Constant">2</span> + size / <span class="Constant">2</span> * ctx-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = buf-&gt;last - src;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = len + size / <span class="Constant">2</span> + size / <span class="Constant">2</span> * ctx-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; src = buf-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="#L1127" title="src/http/modules/ngx_http_charset_filter_module.c:1127">ngx_http_charset_get_buffer</a>(pool, ctx, size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (out) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;next = cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = cl;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ll = &amp;cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; dst = b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (src &lt; buf-&gt;last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = &amp;table[*src++ * <a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = *p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (b-&gt;end - dst) &lt; len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = buf-&gt;last - src;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = len + size / <span class="Constant">2</span> + size / <span class="Constant">2</span> * ctx-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl = <a href="#L1127" title="src/http/modules/ngx_http_charset_filter_module.c:1127">ngx_http_charset_get_buffer</a>(pool, ctx, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ll = cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ll = &amp;cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst = b-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dst++ = *p++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last_buf = buf-&gt;last_buf;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last_in_chain = buf-&gt;last_in_chain;<br/></li>
<li>&nbsp; &nbsp; b-&gt;flush = buf-&gt;flush;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;shadow = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> out;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<br/></li>
<li><a id="L1093">&#x200c;</a><span class="linkable">ngx_http_charset_get_buf</span>(<a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool, <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; *cl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = ctx-&gt;free_bufs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;free_bufs = cl-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;buf-&gt;shadow = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> cl;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(pool);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf = <a href="../../core/ngx_buf.h.html#L154" title="src/core/ngx_buf.h:154">ngx_calloc_buf</a>(pool);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf-&gt;tag = (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> cl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *<br/></li>
<li><a id="L1127">&#x200c;</a><span class="linkable">ngx_http_charset_get_buffer</span>(<a href="../../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool, <a href="#L78" title="src/http/modules/ngx_http_charset_filter_module.c:78">ngx_http_charset_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; *cl, **ll;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (ll = &amp;ctx-&gt;free_buffers, cl = ctx-&gt;free_buffers;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ll = &amp;cl-&gt;next, cl = cl-&gt;next)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) (b-&gt;end - b-&gt;start) &gt;= size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ll = cl-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cl-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;shadow = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> cl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl = <a href="../../core/ngx_buf.c.html#L48" title="src/core/ngx_buf.c:48">ngx_alloc_chain_link</a>(pool);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf = <a href="../../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(pool, size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cl-&gt;buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf-&gt;temporary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; cl-&gt;buf-&gt;tag = (<a href="../../core/ngx_buf.h.html#L16" title="src/core/ngx_buf.h:16">ngx_buf_tag_t</a>) &amp;<a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> cl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1171">&#x200c;</a><span class="linkable">ngx_http_charset_map_block</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>&nbsp; *mcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rv;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *dst2src, **pp;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; src, dst;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, n;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pvcf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *charset;<br/></li>
<li>&nbsp; &nbsp; <a href="#L43" title="src/http/modules/ngx_http_charset_filter_module.c:43">ngx_http_charset_tables_t</a>&nbsp; &nbsp; *table;<br/></li>
<li>&nbsp; &nbsp; <a href="#L85" title="src/http/modules/ngx_http_charset_filter_module.c:85">ngx_http_charset_conf_ctx_t</a>&nbsp;&nbsp; ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; src = <a href="#L1449" title="src/http/modules/ngx_http_charset_filter_module.c:1449">ngx_http_add_charset</a>(&amp;mcf-&gt;charsets, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (src == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dst = <a href="#L1449" title="src/http/modules/ngx_http_charset_filter_module.c:1449">ngx_http_add_charset</a>(&amp;mcf-&gt;charsets, &amp;value[<span class="Constant">2</span>]);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dst == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (src == dst) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">charset_map</span><span class="Special">\&quot;</span><span class="Constant"> between the same charsets &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> and </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">1</span>], &amp;value[<span class="Constant">2</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; table = mcf-&gt;tables.elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; mcf-&gt;tables.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((src == table-&gt;src &amp;&amp; dst == table-&gt;dst)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; || (src == table-&gt;dst &amp;&amp; dst == table-&gt;src))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;duplicate </span><span class="Special">\&quot;</span><span class="Constant">charset_map</span><span class="Special">\&quot;</span><span class="Constant"> between &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> and </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">1</span>], &amp;value[<span class="Constant">2</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; table = <a href="../../core/ngx_array.c.html#L48" title="src/core/ngx_array.c:48">ngx_array_push</a>(&amp;mcf-&gt;tables);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (table == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; table-&gt;src = src;<br/></li>
<li>&nbsp; &nbsp; table-&gt;dst = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.c.html#L571" title="src/core/ngx_string.c:571">ngx_strcasecmp</a>(value[<span class="Constant">2</span>].data, (u_char *) <span class="Constant">&quot;utf-8&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; table-&gt;src2dst = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Constant">256</span> * <a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (table-&gt;src2dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; table-&gt;dst2src = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Constant">256</span> * <span class="Statement">sizeof</span>(<span class="Type">void</span> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (table-&gt;dst2src == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst2src = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Constant">256</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst2src == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pp = (u_char **) &amp;table-&gt;dst2src[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pp[<span class="Constant">0</span>] = dst2src;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">128</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;table-&gt;src2dst[i * <a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p[<span class="Constant">0</span>] = <span class="Special">'\1'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p[<span class="Constant">1</span>] = (u_char) i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst2src[i] = (u_char) i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Comment">/* void */</span>; i &lt; <span class="Constant">256</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;table-&gt;src2dst[i * <a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p[<span class="Constant">0</span>] = <span class="Special">'\1'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p[<span class="Constant">1</span>] = <span class="Constant">'?'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; table-&gt;src2dst = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool, <span class="Constant">256</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (table-&gt;src2dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; table-&gt;dst2src = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool, <span class="Constant">256</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (table-&gt;dst2src == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">128</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; table-&gt;src2dst[i] = (u_char) i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; table-&gt;dst2src[i] = (u_char) i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Comment">/* void */</span>; i &lt; <span class="Constant">256</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; table-&gt;src2dst[i] = <span class="Constant">'?'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; table-&gt;dst2src[i] = <span class="Constant">'?'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; charset = mcf-&gt;charsets.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx.table = table;<br/></li>
<li>&nbsp; &nbsp; ctx.charset = &amp;charset[dst];<br/></li>
<li>&nbsp; &nbsp; ctx.characters = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pvcf = *cf;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;ctx = &amp;ctx;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;handler = <a href="#L1307" title="src/http/modules/ngx_http_charset_filter_module.c:1307">ngx_http_charset_map</a>;<br/></li>
<li>&nbsp; &nbsp; cf-&gt;handler_conf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rv = <a href="../../core/ngx_conf_file.c.html#L101" title="src/core/ngx_conf_file.c:101">ngx_conf_parse</a>(cf, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *cf = pvcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx.characters) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = ctx.charset-&gt;length;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx.charset-&gt;length /= ctx.characters;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (((n * <span class="Constant">10</span>) / ctx.characters) % <span class="Constant">10</span> &gt; <span class="Constant">4</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx.charset-&gt;length++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1307">&#x200c;</a><span class="linkable">ngx_http_charset_map</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *dummy, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *dst2src, **pp;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L132" title="src/os/win32/ngx_win32_config.h:132">uint32_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; src, dst;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="#L43" title="src/http/modules/ngx_http_charset_filter_module.c:43">ngx_http_charset_tables_t</a>&nbsp; &nbsp; *table;<br/></li>
<li>&nbsp; &nbsp; <a href="#L85" title="src/http/modules/ngx_http_charset_filter_module.c:85">ngx_http_charset_conf_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts != <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>, <span class="Constant">&quot;invalid parameters number&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; src = <a href="../../core/ngx_string.c.html#L1070" title="src/core/ngx_string.c:1070">ngx_hextoi</a>(value[<span class="Constant">0</span>].data, value[<span class="Constant">0</span>].len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (src == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> || src &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">0</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = cf-&gt;ctx;<br/></li>
<li>&nbsp; &nbsp; table = ctx-&gt;table;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;charset-&gt;utf8) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = &amp;table-&gt;src2dst[src * <a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p++ = (u_char) (value[<span class="Constant">1</span>].len / <span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; value[<span class="Constant">1</span>].len; i += <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="../../core/ngx_string.c.html#L1070" title="src/core/ngx_string.c:1070">ngx_hextoi</a>(&amp;value[<span class="Constant">1</span>].data[i], <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> || dst &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = (u_char) dst;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i /= <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;charset-&gt;length += i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;characters++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = &amp;table-&gt;src2dst[src * <a href="#L18" title="src/http/modules/ngx_http_charset_filter_module.c:18">NGX_UTF_LEN</a>] + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../../core/ngx_string.c.html#L1295" title="src/core/ngx_string.c:1295">ngx_utf8_decode</a>(&amp;p, i);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0xffff</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pp = (u_char **) &amp;table-&gt;dst2src[<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst2src = pp[n &gt;&gt; <span class="Constant">8</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst2src == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst2src = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Constant">256</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst2src == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pp[n &gt;&gt; <span class="Constant">8</span>] = dst2src;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst2src[n &amp; <span class="Constant">0xff</span>] = (u_char) src;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="../../core/ngx_string.c.html#L1070" title="src/core/ngx_string.c:1070">ngx_hextoi</a>(value[<span class="Constant">1</span>].data, value[<span class="Constant">1</span>].len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> || dst &gt; <span class="Constant">255</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; table-&gt;src2dst[src] = (u_char) dst;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; table-&gt;dst2src[dst] = (u_char) src;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1397">&#x200c;</a><span class="linkable">ngx_http_set_charset_slot</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; *p = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cp;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value, var;<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>&nbsp; *mcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cp = (<a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> *) (p + cmd-&gt;offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*cp != <a href="../../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;is duplicate&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cmd-&gt;offset == offsetof(<a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a>, charset)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[<span class="Constant">1</span>].data, <span class="Constant">&quot;off&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *cp = <a href="#L13" title="src/http/modules/ngx_http_charset_filter_module.c:13">NGX_HTTP_CHARSET_OFF</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (value[<span class="Constant">1</span>].data[<span class="Constant">0</span>] == <span class="Constant">'$'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var.len = value[<span class="Constant">1</span>].len - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; var.data = value[<span class="Constant">1</span>].data + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *cp = <a href="../ngx_http_variables.c.html#L441" title="src/http/ngx_http_variables.c:441">ngx_http_get_variable_index</a>(cf, &amp;var);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*cp == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *cp += <a href="#L15" title="src/http/modules/ngx_http_charset_filter_module.c:15">NGX_HTTP_CHARSET_VAR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mcf = <a href="../ngx_http_config.h.html#L61" title="src/http/ngx_http_config.h:61">ngx_http_conf_get_module_main_conf</a>(cf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *cp = <a href="#L1449" title="src/http/modules/ngx_http_charset_filter_module.c:1449">ngx_http_add_charset</a>(&amp;mcf-&gt;charsets, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*cp == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1449">&#x200c;</a><span class="linkable">ngx_http_add_charset</span>(<a href="../../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a> *charsets, <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = charsets-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; charsets-&gt;nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name-&gt;len != c[i].name.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.c.html#L571" title="src/core/ngx_string.c:571">ngx_strcasecmp</a>(name-&gt;data, c[i].name.data) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (i &lt; charsets-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> i;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="../../core/ngx_array.c.html#L48" title="src/core/ngx_array.c:48">ngx_array_push</a>(charsets);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;tables = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;name = *name;<br/></li>
<li>&nbsp; &nbsp; c-&gt;length = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.c.html#L571" title="src/core/ngx_string.c:571">ngx_strcasecmp</a>(name-&gt;data, (u_char *) <span class="Constant">&quot;utf-8&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;utf8 = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;utf8 = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> i;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L1490">&#x200c;</a><span class="linkable">ngx_http_charset_create_main_conf</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>&nbsp; *mcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mcf = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mcf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_array.h.html#L32" title="src/core/ngx_array.h:32">ngx_array_init</a>(&amp;mcf-&gt;charsets, cf-&gt;pool, <span class="Constant">2</span>, <span class="Statement">sizeof</span>(<a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_array.h.html#L32" title="src/core/ngx_array.h:32">ngx_array_init</a>(&amp;mcf-&gt;tables, cf-&gt;pool, <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="#L43" title="src/http/modules/ngx_http_charset_filter_module.c:43">ngx_http_charset_tables_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_array.h.html#L32" title="src/core/ngx_array.h:32">ngx_array_init</a>(&amp;mcf-&gt;recodes, cf-&gt;pool, <span class="Constant">2</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="#L35" title="src/http/modules/ngx_http_charset_filter_module.c:35">ngx_http_charset_recode_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> mcf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L1524">&#x200c;</a><span class="linkable">ngx_http_charset_create_loc_conf</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a>&nbsp; *lcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lcf = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lcf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * set by <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>():<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; lcf-&gt;types = { NULL };<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; lcf-&gt;types_keys = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; lcf-&gt;charset = <a href="../../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; lcf-&gt;source_charset = <a href="../../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; lcf-&gt;override_charset = <a href="../../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> lcf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1549">&#x200c;</a><span class="linkable">ngx_http_charset_merge_loc_conf</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent, <span class="Type">void</span> *child)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a> *prev = parent;<br/></li>
<li>&nbsp; &nbsp; <a href="#L60" title="src/http/modules/ngx_http_charset_filter_module.c:60">ngx_http_charset_loc_conf_t</a> *conf = child;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="src/http/modules/ngx_http_charset_filter_module.c:35">ngx_http_charset_recode_t</a>&nbsp; &nbsp;&nbsp; *recode;<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>&nbsp; *mcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http.c.html#L1991" title="src/http/ngx_http.c:1991">ngx_http_merge_types</a>(cf, &amp;conf-&gt;types_keys, &amp;conf-&gt;types,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;prev-&gt;types_keys, &amp;prev-&gt;types,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L126" title="src/http/modules/ngx_http_charset_filter_module.c:126">ngx_http_charset_default_types</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;override_charset, prev-&gt;override_charset, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;charset, prev-&gt;charset, <a href="#L13" title="src/http/modules/ngx_http_charset_filter_module.c:13">NGX_HTTP_CHARSET_OFF</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;source_charset, prev-&gt;source_charset,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L13" title="src/http/modules/ngx_http_charset_filter_module.c:13">NGX_HTTP_CHARSET_OFF</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;charset == <a href="#L13" title="src/http/modules/ngx_http_charset_filter_module.c:13">NGX_HTTP_CHARSET_OFF</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || conf-&gt;source_charset == <a href="#L13" title="src/http/modules/ngx_http_charset_filter_module.c:13">NGX_HTTP_CHARSET_OFF</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || conf-&gt;charset == conf-&gt;source_charset)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;source_charset &gt;= <a href="#L15" title="src/http/modules/ngx_http_charset_filter_module.c:15">NGX_HTTP_CHARSET_VAR</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || conf-&gt;charset &gt;= <a href="#L15" title="src/http/modules/ngx_http_charset_filter_module.c:15">NGX_HTTP_CHARSET_VAR</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mcf = <a href="../ngx_http_config.h.html#L61" title="src/http/ngx_http_config.h:61">ngx_http_conf_get_module_main_conf</a>(cf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li>&nbsp; &nbsp; recode = mcf-&gt;recodes.elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; mcf-&gt;recodes.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;source_charset == recode[i].src<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; conf-&gt;charset == recode[i].dst)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; recode = <a href="../../core/ngx_array.c.html#L48" title="src/core/ngx_array.c:48">ngx_array_push</a>(&amp;mcf-&gt;recodes);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (recode == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; recode-&gt;src = conf-&gt;source_charset;<br/></li>
<li>&nbsp; &nbsp; recode-&gt;dst = conf-&gt;charset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1608">&#x200c;</a><span class="linkable">ngx_http_charset_postconfiguration</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; **src, **dst;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i, t;<br/></li>
<li>&nbsp; &nbsp; <a href="#L29" title="src/http/modules/ngx_http_charset_filter_module.c:29">ngx_http_charset_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *charset;<br/></li>
<li>&nbsp; &nbsp; <a href="#L35" title="src/http/modules/ngx_http_charset_filter_module.c:35">ngx_http_charset_recode_t</a>&nbsp; &nbsp;&nbsp; *recode;<br/></li>
<li>&nbsp; &nbsp; <a href="#L43" title="src/http/modules/ngx_http_charset_filter_module.c:43">ngx_http_charset_tables_t</a>&nbsp; &nbsp;&nbsp; *tables;<br/></li>
<li>&nbsp; &nbsp; <a href="#L50" title="src/http/modules/ngx_http_charset_filter_module.c:50">ngx_http_charset_main_conf_t</a>&nbsp; *mcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mcf = <a href="../ngx_http_config.h.html#L61" title="src/http/ngx_http_config.h:61">ngx_http_conf_get_module_main_conf</a>(cf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L196" title="src/http/modules/ngx_http_charset_filter_module.c:196">ngx_http_charset_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; recode = mcf-&gt;recodes.elts;<br/></li>
<li>&nbsp; &nbsp; tables = mcf-&gt;tables.elts;<br/></li>
<li>&nbsp; &nbsp; charset = mcf-&gt;charsets.elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; mcf-&gt;recodes.nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c = recode[i].src;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (t = <span class="Constant">0</span>; t &lt; mcf-&gt;tables.nelts; t++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c == tables[t].src &amp;&amp; recode[i].dst == tables[t].dst) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c == tables[t].dst &amp;&amp; recode[i].dst == tables[t].src) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;no </span><span class="Special">\&quot;</span><span class="Constant">charset_map</span><span class="Special">\&quot;</span><span class="Constant"> between the charsets </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> and </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;charset[c].name, &amp;charset[recode[i].dst].name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">next</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (t = <span class="Constant">0</span>; t &lt; mcf-&gt;tables.nelts; t++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; src = charset[tables[t].src].tables;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (src == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(u_char *) * mcf-&gt;charsets.nelts);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (src == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; charset[tables[t].src].tables = src;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = charset[tables[t].dst].tables;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(u_char *) * mcf-&gt;charsets.nelts);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; charset[tables[t].dst].tables = dst;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; src[tables[t].dst] = tables[t].src2dst;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst[tables[t].src] = tables[t].dst2src;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a> = <a href="../ngx_http.c.html#L73" title="src/http/ngx_http.c:73">ngx_http_top_header_filter</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.c.html#L73" title="src/http/ngx_http.c:73">ngx_http_top_header_filter</a> = <a href="#L217" title="src/http/modules/ngx_http_charset_filter_module.c:217">ngx_http_charset_header_filter</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a> = <a href="../ngx_http.c.html#L74" title="src/http/ngx_http.c:74">ngx_http_top_body_filter</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.c.html#L74" title="src/http/ngx_http.c:74">ngx_http_top_body_filter</a> = <a href="#L547" title="src/http/modules/ngx_http_charset_filter_module.c:547">ngx_http_charset_body_filter</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
