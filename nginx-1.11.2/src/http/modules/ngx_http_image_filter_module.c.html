<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/http/modules/ngx_http_image_filter_module.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

  <h1>src/http/modules/ngx_http_image_filter_module.c - Nginx 1.11.2</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L117">ngx_http_image_filter_commands</a></li>
<li><a href="#L180">ngx_http_image_filter_module</a></li>
<li><a href="#L165">ngx_http_image_filter_module_ctx</a></li>
<li><a href="#L200">ngx_http_image_types</a></li>
<li><a href="#L197">ngx_http_next_body_filter</a></li>
<li><a href="#L196">ngx_http_next_header_filter</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L57">ngx_http_image_filter_conf_t</a></li>
<li><a href="#L75">ngx_http_image_filter_ctx_t</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L612">ngx_http_image_asis</a></li>
<li><a href="#L279">ngx_http_image_body_filter</a></li>
<li><a href="#L1136">ngx_http_image_cleanup</a></li>
<li><a href="#L1265">ngx_http_image_filter</a></li>
<li><a href="#L1180">ngx_http_image_filter_create_conf</a></li>
<li><a href="#L1143">ngx_http_image_filter_get_value</a></li>
<li><a href="#L1512">ngx_http_image_filter_init</a></li>
<li><a href="#L1418">ngx_http_image_filter_jpeg_quality</a></li>
<li><a href="#L1214">ngx_http_image_filter_merge_conf</a></li>
<li><a href="#L1465">ngx_http_image_filter_sharpen</a></li>
<li><a href="#L1161">ngx_http_image_filter_value</a></li>
<li><a href="#L208">ngx_http_image_header_filter</a></li>
<li><a href="#L559">ngx_http_image_json</a></li>
<li><a href="#L633">ngx_http_image_length</a></li>
<li><a href="#L1060">ngx_http_image_new</a></li>
<li><a href="#L1088">ngx_http_image_out</a></li>
<li><a href="#L505">ngx_http_image_process</a></li>
<li><a href="#L451">ngx_http_image_read</a></li>
<li><a href="#L750">ngx_http_image_resize</a></li>
<li><a href="#L388">ngx_http_image_send</a></li>
<li><a href="#L646">ngx_http_image_size</a></li>
<li><a href="#L1022">ngx_http_image_source</a></li>
<li><a href="#L411">ngx_http_image_test</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L36">NGX_HTTP_IMAGE_BUFFERED</a></li>
<li><a href="#L19">NGX_HTTP_IMAGE_CROP</a></li>
<li><a href="#L27">NGX_HTTP_IMAGE_DONE</a></li>
<li><a href="#L32">NGX_HTTP_IMAGE_GIF</a></li>
<li><a href="#L31">NGX_HTTP_IMAGE_JPEG</a></li>
<li><a href="#L30">NGX_HTTP_IMAGE_NONE</a></li>
<li><a href="#L15">NGX_HTTP_IMAGE_OFF</a></li>
<li><a href="#L26">NGX_HTTP_IMAGE_PASS</a></li>
<li><a href="#L33">NGX_HTTP_IMAGE_PNG</a></li>
<li><a href="#L25">NGX_HTTP_IMAGE_PROCESS</a></li>
<li><a href="#L24">NGX_HTTP_IMAGE_READ</a></li>
<li><a href="#L18">NGX_HTTP_IMAGE_RESIZE</a></li>
<li><a href="#L20">NGX_HTTP_IMAGE_ROTATE</a></li>
<li><a href="#L17">NGX_HTTP_IMAGE_SIZE</a></li>
<li><a href="#L23">NGX_HTTP_IMAGE_START</a></li>
<li><a href="#L16">NGX_HTTP_IMAGE_TEST</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;gd.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L15">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_OFF</span>&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">0<br/></li>
<li><a id="L16">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_TEST</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">1<br/></li>
<li><a id="L17">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_SIZE</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">2<br/></li>
<li><a id="L18">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_RESIZE</span>&nbsp; &nbsp; </span><span class="Constant">3<br/></li>
<li><a id="L19">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_CROP</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">4<br/></li>
<li><a id="L20">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_ROTATE</span>&nbsp; &nbsp; </span><span class="Constant">5<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L23">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_START</span>&nbsp; &nbsp;&nbsp; </span><span class="Constant">0<br/></li>
<li><a id="L24">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_READ</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">1<br/></li>
<li><a id="L25">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_PROCESS</span>&nbsp;&nbsp; </span><span class="Constant">2<br/></li>
<li><a id="L26">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_PASS</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">3<br/></li>
<li><a id="L27">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_DONE</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">4<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L30">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_NONE</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">0<br/></li>
<li><a id="L31">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_JPEG</span>&nbsp; &nbsp; &nbsp; </span><span class="Constant">1<br/></li>
<li><a id="L32">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_GIF</span>&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">2<br/></li>
<li><a id="L33">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_PNG</span>&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="Constant">3<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L36">&#x200c;</a><span class="PreProc">#define <span class="linkable">NGX_HTTP_IMAGE_BUFFERED</span>&nbsp; </span><span class="Constant">0x08<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; filter;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; width;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; height;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; angle;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; jpeg_quality;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; sharpen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L80" title="src/core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; transparency;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L80" title="src/core/ngx_config.h:80">ngx_flag_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; interlace;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp; *wcv;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp; *hcv;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp; *acv;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp; *jqcv;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp; *shcv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buffer_size;<br/></li>
<li><a id="L57">&#x200c;</a>} <span class="linkable">ngx_http_image_filter_conf_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct</span> {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *image;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; width;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; height;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; max_width;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; max_height;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; angle;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; phase;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; force;<br/></li>
<li><a id="L75">&#x200c;</a>} <span class="linkable">ngx_http_image_filter_ctx_t</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L388" title="src/http/modules/ngx_http_image_filter_module.c:388">ngx_http_image_send</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> <a href="#L411" title="src/http/modules/ngx_http_image_filter_module.c:411">ngx_http_image_test</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L451" title="src/http/modules/ngx_http_image_filter_module.c:451">ngx_http_image_read</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *<a href="#L505" title="src/http/modules/ngx_http_image_filter_module.c:505">ngx_http_image_process</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *<a href="#L559" title="src/http/modules/ngx_http_image_filter_module.c:559">ngx_http_image_json</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *<a href="#L612" title="src/http/modules/ngx_http_image_filter_module.c:612">ngx_http_image_asis</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L633" title="src/http/modules/ngx_http_image_filter_module.c:633">ngx_http_image_length</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *b);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L646" title="src/http/modules/ngx_http_image_filter_module.c:646">ngx_http_image_size</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *<a href="#L750" title="src/http/modules/ngx_http_image_filter_module.c:750">ngx_http_image_resize</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> gdImagePtr <a href="#L1022" title="src/http/modules/ngx_http_image_filter_module.c:1022">ngx_http_image_source</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx);<br/></li>
<li><span class="Type">static</span> gdImagePtr <a href="#L1060" title="src/http/modules/ngx_http_image_filter_module.c:1060">ngx_http_image_new</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <span class="Type">int</span> w, <span class="Type">int</span> h,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> colors);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L1088" title="src/http/modules/ngx_http_image_filter_module.c:1088">ngx_http_image_out</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> type,<br/></li>
<li>&nbsp; &nbsp; gdImagePtr img, <span class="Type">int</span> *size);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1136" title="src/http/modules/ngx_http_image_filter_module.c:1136">ngx_http_image_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> <a href="#L1143" title="src/http/modules/ngx_http_image_filter_module.c:1143">ngx_http_image_filter_get_value</a>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a> *cv, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> v);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> <a href="#L1161" title="src/http/modules/ngx_http_image_filter_module.c:1161">ngx_http_image_filter_value</a>(<a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *value);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L1180" title="src/http/modules/ngx_http_image_filter_module.c:1180">ngx_http_image_filter_create_conf</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1214" title="src/http/modules/ngx_http_image_filter_module.c:1214">ngx_http_image_filter_merge_conf</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *child);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1265" title="src/http/modules/ngx_http_image_filter_module.c:1265">ngx_http_image_filter</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1418" title="src/http/modules/ngx_http_image_filter_module.c:1418">ngx_http_image_filter_jpeg_quality</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L1465" title="src/http/modules/ngx_http_image_filter_module.c:1465">ngx_http_image_filter_sharpen</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf);<br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1512" title="src/http/modules/ngx_http_image_filter_module.c:1512">ngx_http_image_filter_init</a>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L117">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a>&nbsp; <span class="linkable">ngx_http_image_filter_commands</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;image_filter&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L38" title="src/core/ngx_conf_file.h:38">NGX_CONF_TAKE123</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L1265" title="src/http/modules/ngx_http_image_filter_module.c:1265">ngx_http_image_filter</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;image_filter_jpeg_quality&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="src/http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L1418" title="src/http/modules/ngx_http_image_filter_module.c:1418">ngx_http_image_filter_jpeg_quality</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;image_filter_sharpen&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="src/http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L1465" title="src/http/modules/ngx_http_image_filter_module.c:1465">ngx_http_image_filter_sharpen</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;image_filter_transparency&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="src/http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L44" title="src/core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L984" title="src/core/ngx_conf_file.c:984">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>, transparency),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;image_filter_interlace&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="src/http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L44" title="src/core/ngx_conf_file.h:44">NGX_CONF_FLAG</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L984" title="src/core/ngx_conf_file.c:984">ngx_conf_set_flag_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>, interlace),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;image_filter_buffer&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L41" title="src/http/ngx_http_config.h:41">NGX_HTTP_MAIN_CONF</a>|<a href="../ngx_http_config.h.html#L42" title="src/http/ngx_http_config.h:42">NGX_HTTP_SRV_CONF</a>|<a href="../ngx_http_config.h.html#L43" title="src/http/ngx_http_config.h:43">NGX_HTTP_LOC_CONF</a>|<a href="../../core/ngx_conf_file.h.html#L23" title="src/core/ngx_conf_file.h:23">NGX_CONF_TAKE1</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L1156" title="src/core/ngx_conf_file.c:1156">ngx_conf_set_size_slot</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../ngx_http_config.h.html#L52" title="src/http/ngx_http_config.h:52">NGX_HTTP_LOC_CONF_OFFSET</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; offsetof(<a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>, buffer_size),<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L86" title="src/core/ngx_conf_file.h:86">ngx_null_command</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L165">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_config.h.html#L36" title="src/http/ngx_http_config.h:36">ngx_http_module_t</a>&nbsp; <span class="linkable">ngx_http_image_filter_module_ctx</span> = {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* preconfiguration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1512" title="src/http/modules/ngx_http_image_filter_module.c:1512">ngx_http_image_filter_init</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* postconfiguration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create <a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init <a href="../../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create server configuration */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* merge server configuration */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L1180" title="src/http/modules/ngx_http_image_filter_module.c:1180">ngx_http_image_filter_create_conf</a>,&nbsp; &nbsp;&nbsp; <span class="Comment">/* create location configuration */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1214" title="src/http/modules/ngx_http_image_filter_module.c:1214">ngx_http_image_filter_merge_conf</a>&nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* merge location configuration */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L180">&#x200c;</a><a href="../../core/ngx_core.h.html#L15" title="src/core/ngx_core.h:15">ngx_module_t</a>&nbsp; <span class="linkable">ngx_http_image_filter_module</span> = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_module.h.html#L230" title="src/core/ngx_module.h:230">NGX_MODULE_V1</a>,<br/></li>
<li>&nbsp; &nbsp; &amp;<a href="#L165" title="src/http/modules/ngx_http_image_filter_module.c:165">ngx_http_image_filter_module_ctx</a>,&nbsp; &nbsp;&nbsp; <span class="Comment">/* module context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L117" title="src/http/modules/ngx_http_image_filter_module.c:117">ngx_http_image_filter_commands</a>,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* module directives */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../ngx_http_config.h.html#L39" title="src/http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* module type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init master */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init module */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* init thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit thread */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* exit master */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../core/ngx_module.h.html#L234" title="src/core/ngx_module.h:234">NGX_MODULE_V1_PADDING</a><br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L196">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_core_module.h.html#L526" title="src/http/ngx_http_core_module.h:526">ngx_http_output_header_filter_pt</a>&nbsp; <span class="linkable">ngx_http_next_header_filter</span>;<br/></li>
<li><a id="L197">&#x200c;</a><span class="Type">static</span> <a href="../ngx_http_core_module.h.html#L527" title="src/http/ngx_http_core_module.h:527">ngx_http_output_body_filter_pt</a>&nbsp; &nbsp; <span class="linkable">ngx_http_next_body_filter</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L200">&#x200c;</a><span class="Type">static</span> <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; <span class="linkable">ngx_http_image_types</span>[] = {<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;image/jpeg&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;image/gif&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;image/png&quot;</span>)<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L208">&#x200c;</a><span class="linkable">ngx_http_image_header_filter</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a>&nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.status == <a href="../ngx_http_request.h.html#L82" title="src/http/ngx_http_request.h:82">NGX_HTTP_NOT_MODIFIED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../ngx_http.h.html#L78" title="src/http/ngx_http.h:78">ngx_http_get_module_ctx</a>(r, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http.h.html#L79" title="src/http/ngx_http.h:79">ngx_http_set_ctx</a>(r, <span class="Constant">NULL</span>, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;filter == <a href="#L15" title="src/http/modules/ngx_http_image_filter_module.c:15">NGX_HTTP_IMAGE_OFF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_type.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &gt;= <span class="Statement">sizeof</span>(<span class="Constant">&quot;multipart/x-mixed-replace&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(r-&gt;headers_out.content_type.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (u_char *) <span class="Constant">&quot;multipart/x-mixed-replace&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<span class="Constant">&quot;multipart/x-mixed-replace&quot;</span>) - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;image filter: multipart/x-mixed-replace response&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.h.html#L79" title="src/http/ngx_http.h:79">ngx_http_set_ctx</a>(r, ctx, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = r-&gt;headers_out.content_length_n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len != -<span class="Constant">1</span> &amp;&amp; len &gt; (<span class="Type"><a href="../../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) conf-&gt;buffer_size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;image filter: too big response: </span><span class="Special">%O</span><span class="Constant">&quot;</span>, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_request.h.html#L96" title="src/http/ngx_http_request.h:96">NGX_HTTP_UNSUPPORTED_MEDIA_TYPE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;length = conf-&gt;buffer_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;length = (<span class="Type">size_t</span>) len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.refresh) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.refresh-&gt;hash = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;main_filter_need_in_memory = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;allow_ranges = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L279">&#x200c;</a><span class="linkable">ngx_http_image_body_filter</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ct;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out;<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a>&nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;image filter&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a>(r, in);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../ngx_http.h.html#L78" title="src/http/ngx_http.h:78">ngx_http_get_module_ctx</a>(r, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a>(r, in);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;phase) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L23" title="src/http/modules/ngx_http_image_filter_module.c:23">NGX_HTTP_IMAGE_START</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;type = <a href="#L411" title="src/http/modules/ngx_http_image_filter_module.c:411">ngx_http_image_test</a>(r, in);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; conf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;type == <a href="#L30" title="src/http/modules/ngx_http_image_filter_module.c:30">NGX_HTTP_IMAGE_NONE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;filter == <a href="#L17" title="src/http/modules/ngx_http_image_filter_module.c:17">NGX_HTTP_IMAGE_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out.buf = <a href="#L559" title="src/http/modules/ngx_http_image_filter_module.c:559">ngx_http_image_json</a>(r, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (out.buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out.next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;phase = <a href="#L27" title="src/http/modules/ngx_http_image_filter_module.c:27">NGX_HTTP_IMAGE_DONE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L388" title="src/http/modules/ngx_http_image_filter_module.c:388">ngx_http_image_send</a>(r, ctx, &amp;out);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_special_response.c.html#L489" title="src/http/ngx_http_special_response.c:489">ngx_http_filter_finalize_request</a>(r,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;<a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L96" title="src/http/ngx_http_request.h:96">NGX_HTTP_UNSUPPORTED_MEDIA_TYPE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* override content type */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ct = &amp;<a href="#L200" title="src/http/modules/ngx_http_image_filter_module.c:200">ngx_http_image_types</a>[ctx-&gt;type - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type_len = ct-&gt;len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type = *ct;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_type_lowcase = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;filter == <a href="#L16" title="src/http/modules/ngx_http_image_filter_module.c:16">NGX_HTTP_IMAGE_TEST</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;phase = <a href="#L26" title="src/http/modules/ngx_http_image_filter_module.c:26">NGX_HTTP_IMAGE_PASS</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L388" title="src/http/modules/ngx_http_image_filter_module.c:388">ngx_http_image_send</a>(r, ctx, in);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;phase = <a href="#L24" title="src/http/modules/ngx_http_image_filter_module.c:24">NGX_HTTP_IMAGE_READ</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fall through */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L24" title="src/http/modules/ngx_http_image_filter_module.c:24">NGX_HTTP_IMAGE_READ</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L451" title="src/http/modules/ngx_http_image_filter_module.c:451">ngx_http_image_read</a>(r, in);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_special_response.c.html#L489" title="src/http/ngx_http_special_response.c:489">ngx_http_filter_finalize_request</a>(r,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;<a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L96" title="src/http/ngx_http_request.h:96">NGX_HTTP_UNSUPPORTED_MEDIA_TYPE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* fall through */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L25" title="src/http/modules/ngx_http_image_filter_module.c:25">NGX_HTTP_IMAGE_PROCESS</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out.buf = <a href="#L505" title="src/http/modules/ngx_http_image_filter_module.c:505">ngx_http_image_process</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (out.buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_special_response.c.html#L489" title="src/http/ngx_http_special_response.c:489">ngx_http_filter_finalize_request</a>(r,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;<a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../ngx_http_request.h.html#L96" title="src/http/ngx_http_request.h:96">NGX_HTTP_UNSUPPORTED_MEDIA_TYPE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out.next = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;phase = <a href="#L26" title="src/http/modules/ngx_http_image_filter_module.c:26">NGX_HTTP_IMAGE_PASS</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L388" title="src/http/modules/ngx_http_image_filter_module.c:388">ngx_http_image_send</a>(r, ctx, &amp;out);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L26" title="src/http/modules/ngx_http_image_filter_module.c:26">NGX_HTTP_IMAGE_PASS</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a>(r, in);<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* <a href="#L27" title="src/http/modules/ngx_http_image_filter_module.c:27">NGX_HTTP_IMAGE_DONE</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a>(r, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> resets any pending data */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (rc == <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) ? <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> : rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L388">&#x200c;</a><span class="linkable">ngx_http_image_send</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> || rc &gt; <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a> || r-&gt;header_only) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a>(r, in);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;phase == <a href="#L27" title="src/http/modules/ngx_http_image_filter_module.c:27">NGX_HTTP_IMAGE_DONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> resets any pending data */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (rc == <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) ? <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> : rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a><br/></li>
<li><a id="L411">&#x200c;</a><span class="linkable">ngx_http_image_test</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = in-&gt;buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;buf-&gt;last - p &lt; <span class="Constant">16</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L30" title="src/http/modules/ngx_http_image_filter_module.c:30">NGX_HTTP_IMAGE_NONE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;image filter: </span><span class="Special">\&quot;%c%c\&quot;</span><span class="Constant">&quot;</span>, p[<span class="Constant">0</span>], p[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p[<span class="Constant">0</span>] == <span class="Constant">0xff</span> &amp;&amp; p[<span class="Constant">1</span>] == <span class="Constant">0xd8</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* JPEG */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L31" title="src/http/modules/ngx_http_image_filter_module.c:31">NGX_HTTP_IMAGE_JPEG</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (p[<span class="Constant">0</span>] == <span class="Constant">'<a href="../../core/ngx_md5.c.html#L123" title="src/core/ngx_md5.c:123">G</a>'</span> &amp;&amp; p[<span class="Constant">1</span>] == <span class="Constant">'<a href="../../core/ngx_md5.c.html#L125" title="src/core/ngx_md5.c:125">I</a>'</span> &amp;&amp; p[<span class="Constant">2</span>] == <span class="Constant">'<a href="../../core/ngx_md5.c.html#L122" title="src/core/ngx_md5.c:122">F</a>'</span> &amp;&amp; p[<span class="Constant">3</span>] == <span class="Constant">'8'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; p[<span class="Constant">5</span>] == <span class="Constant">'a'</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p[<span class="Constant">4</span>] == <span class="Constant">'9'</span> || p[<span class="Constant">4</span>] == <span class="Constant">'7'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* GIF */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L32" title="src/http/modules/ngx_http_image_filter_module.c:32">NGX_HTTP_IMAGE_GIF</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (p[<span class="Constant">0</span>] == <span class="Constant">0x89</span> &amp;&amp; p[<span class="Constant">1</span>] == <span class="Constant">'P'</span> &amp;&amp; p[<span class="Constant">2</span>] == <span class="Constant">'N'</span> &amp;&amp; p[<span class="Constant">3</span>] == <span class="Constant">'<a href="../../core/ngx_md5.c.html#L123" title="src/core/ngx_md5.c:123">G</a>'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; p[<span class="Constant">4</span>] == <span class="Constant">0x0d</span> &amp;&amp; p[<span class="Constant">5</span>] == <span class="Constant">0x0a</span> &amp;&amp; p[<span class="Constant">6</span>] == <span class="Constant">0x1a</span> &amp;&amp; p[<span class="Constant">7</span>] == <span class="Constant">0x0a</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* PNG */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L33" title="src/http/modules/ngx_http_image_filter_module.c:33">NGX_HTTP_IMAGE_PNG</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L30" title="src/http/modules/ngx_http_image_filter_module.c:30">NGX_HTTP_IMAGE_NONE</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L451">&#x200c;</a><span class="linkable">ngx_http_image_read</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a> *in)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size, rest;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cl;<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../ngx_http.h.html#L78" title="src/http/ngx_http.h:78">ngx_http_get_module_ctx</a>(r, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;image == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;image = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(r-&gt;pool, ctx-&gt;length);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;image == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;last = ctx-&gt;image;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = ctx-&gt;last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (cl = in; cl; cl = cl-&gt;next) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = cl-&gt;buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = b-&gt;last - b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;image buf: </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rest = ctx-&gt;image + ctx-&gt;length - p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &gt; rest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;image filter: too big response&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, b-&gt;pos, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos += size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;last_buf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;last = p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;last = p;<br/></li>
<li>&nbsp; &nbsp; r-&gt;connection-&gt;buffered |= <a href="#L36" title="src/http/modules/ngx_http_image_filter_module.c:36">NGX_HTTP_IMAGE_BUFFERED</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *<br/></li>
<li><a id="L505">&#x200c;</a><span class="linkable">ngx_http_image_process</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a>&nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;connection-&gt;buffered &amp;= ~<a href="#L36" title="src/http/modules/ngx_http_image_filter_module.c:36">NGX_HTTP_IMAGE_BUFFERED</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../ngx_http.h.html#L78" title="src/http/ngx_http.h:78">ngx_http_get_module_ctx</a>(r, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L646" title="src/http/modules/ngx_http_image_filter_module.c:646">ngx_http_image_size</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;filter == <a href="#L17" title="src/http/modules/ngx_http_image_filter_module.c:17">NGX_HTTP_IMAGE_SIZE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L559" title="src/http/modules/ngx_http_image_filter_module.c:559">ngx_http_image_json</a>(r, rc == <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a> ? ctx : <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;angle = <a href="#L1143" title="src/http/modules/ngx_http_image_filter_module.c:1143">ngx_http_image_filter_get_value</a>(r, conf-&gt;acv, conf-&gt;angle);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;filter == <a href="#L20" title="src/http/modules/ngx_http_image_filter_module.c:20">NGX_HTTP_IMAGE_ROTATE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;angle != <span class="Constant">90</span> &amp;&amp; ctx-&gt;angle != <span class="Constant">180</span> &amp;&amp; ctx-&gt;angle != <span class="Constant">270</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L750" title="src/http/modules/ngx_http_image_filter_module.c:750">ngx_http_image_resize</a>(r, ctx);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;max_width = <a href="#L1143" title="src/http/modules/ngx_http_image_filter_module.c:1143">ngx_http_image_filter_get_value</a>(r, conf-&gt;wcv, conf-&gt;width);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;max_width == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;max_height = <a href="#L1143" title="src/http/modules/ngx_http_image_filter_module.c:1143">ngx_http_image_filter_get_value</a>(r, conf-&gt;hcv,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;height);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;max_height == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; ctx-&gt;width &lt;= ctx-&gt;max_width<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; ctx-&gt;height &lt;= ctx-&gt;max_height<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; ctx-&gt;angle == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; !ctx-&gt;force)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L612" title="src/http/modules/ngx_http_image_filter_module.c:612">ngx_http_image_asis</a>(r, ctx);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L750" title="src/http/modules/ngx_http_image_filter_module.c:750">ngx_http_image_resize</a>(r, ctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *<br/></li>
<li><a id="L559">&#x200c;</a><span class="linkable">ngx_http_image_json</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;memory = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_special_response.c.html#L529" title="src/http/ngx_http_special_response.c:529">ngx_http_clean_header</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.status = <a href="../ngx_http_request.h.html#L72" title="src/http/ngx_http_request.h:72">NGX_HTTP_OK</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_type_len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;application/json&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L42" title="src/core/ngx_string.h:42">ngx_str_set</a>(&amp;r-&gt;headers_out.content_type, <span class="Constant">&quot;application/json&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_type_lowcase = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = (u_char *) <span class="Constant">&quot;{}&quot;</span> <a href="../../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;pos + <span class="Statement">sizeof</span>(<span class="Constant">&quot;{}&quot;</span> <a href="../../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L633" title="src/http/modules/ngx_http_image_filter_module.c:633">ngx_http_image_length</a>(r, b);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> b;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<span class="Constant">&quot;{ </span><span class="Special">\&quot;</span><span class="Constant">img</span><span class="Special">\&quot;</span><span class="Constant"> : &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;{ </span><span class="Special">\&quot;</span><span class="Constant">width</span><span class="Special">\&quot;</span><span class="Constant">: , </span><span class="Special">\&quot;</span><span class="Constant">height</span><span class="Special">\&quot;</span><span class="Constant">: , </span><span class="Special">\&quot;</span><span class="Constant">type</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;</span><span class="Constant">jpeg</span><span class="Special">\&quot;</span><span class="Constant"> } }&quot;</span> <a href="../../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Constant">2</span> * <a href="../../os/win32/ngx_win32_config.h.html#L200" title="src/os/win32/ngx_win32_config.h:200">NGX_SIZE_T_LEN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;pos = <a href="../../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(r-&gt;pool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last = <a href="../../core/ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(b-&gt;pos,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;{ </span><span class="Special">\&quot;</span><span class="Constant">img</span><span class="Special">\&quot;</span><span class="Constant"> : &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;{ </span><span class="Special">\&quot;</span><span class="Constant">width</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">%u</span><span class="Constant">z,&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">height</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">%u</span><span class="Constant">z,&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot; </span><span class="Special">\&quot;</span><span class="Constant">type</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> } }&quot;</span> <a href="../../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;width, ctx-&gt;height,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L200" title="src/http/modules/ngx_http_image_filter_module.c:200">ngx_http_image_types</a>[ctx-&gt;type - <span class="Constant">1</span>].data + <span class="Constant">6</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L633" title="src/http/modules/ngx_http_image_filter_module.c:633">ngx_http_image_length</a>(r, b);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> b;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *<br/></li>
<li><a id="L612">&#x200c;</a><span class="linkable">ngx_http_image_asis</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; *b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;pos = ctx-&gt;image;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last = ctx-&gt;last;<br/></li>
<li>&nbsp; &nbsp; b-&gt;memory = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L633" title="src/http/modules/ngx_http_image_filter_module.c:633">ngx_http_image_length</a>(r, b);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> b;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L633">&#x200c;</a></span><span class="linkable">ngx_http_image_length</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *b)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_length_n = b-&gt;last - b-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_out.content_length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.content_length-&gt;hash = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_length = <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L646">&#x200c;</a><span class="linkable">ngx_http_image_size</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; *p, *last;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp;&nbsp; len, app;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp;&nbsp; width, height;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = ctx-&gt;image;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;type) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L31" title="src/http/modules/ngx_http_image_filter_module.c:31">NGX_HTTP_IMAGE_JPEG</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p += <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = ctx-&gt;image + ctx-&gt;length - <span class="Constant">10</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; width = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; height = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; app = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (p &lt; last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p[<span class="Constant">0</span>] == <span class="Constant">0xff</span> &amp;&amp; p[<span class="Constant">1</span>] != <span class="Constant">0xff</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;JPEG: </span><span class="Special">%02x</span><span class="Constant">d </span><span class="Special">%02x</span><span class="Constant">d&quot;</span>, p[<span class="Constant">0</span>], p[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((*p == <span class="Constant">0xc0</span> || *p == <span class="Constant">0xc1</span> || *p == <span class="Constant">0xc2</span> || *p == <span class="Constant">0xc3<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; || *p == <span class="Constant">0xc9</span> || *p == <span class="Constant">0xca</span> || *p == <span class="Constant">0xcb</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (width == <span class="Constant">0</span> || height == <span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; width = p[<span class="Constant">6</span>] * <span class="Constant">256</span> + p[<span class="Constant">7</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; height = p[<span class="Constant">4</span>] * <span class="Constant">256</span> + p[<span class="Constant">5</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;JPEG: </span><span class="Special">%02x</span><span class="Constant">d </span><span class="Special">%02x</span><span class="Constant">d&quot;</span>, p[<span class="Constant">1</span>], p[<span class="Constant">2</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = p[<span class="Constant">1</span>] * <span class="Constant">256</span> + p[<span class="Constant">2</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p &gt;= <span class="Constant">0xe1</span> &amp;&amp; *p &lt;= <span class="Constant">0xef</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* application data, e.g., EXIF, Adobe XMP, etc. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; app += len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (width == <span class="Constant">0</span> || height == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;length / <span class="Constant">20</span> &lt; app) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* force conversion if application data consume more than 5% */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx-&gt;force = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;app data size: </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, app);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L32" title="src/http/modules/ngx_http_image_filter_module.c:32">NGX_HTTP_IMAGE_GIF</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;length &lt; <span class="Constant">10</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; width = p[<span class="Constant">7</span>] * <span class="Constant">256</span> + p[<span class="Constant">6</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; height = p[<span class="Constant">9</span>] * <span class="Constant">256</span> + p[<span class="Constant">8</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L33" title="src/http/modules/ngx_http_image_filter_module.c:33">NGX_HTTP_IMAGE_PNG</a>:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;length &lt; <span class="Constant">24</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; width = p[<span class="Constant">18</span>] * <span class="Constant">256</span> + p[<span class="Constant">19</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; height = p[<span class="Constant">22</span>] * <span class="Constant">256</span> + p[<span class="Constant">23</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;image size: </span><span class="Special">%d</span><span class="Constant"> x </span><span class="Special">%d</span><span class="Constant">&quot;</span>, (<span class="Type">int</span>) width, (<span class="Type">int</span>) height);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;width = width;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;height = height;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *<br/></li>
<li><a id="L750">&#x200c;</a><span class="linkable">ngx_http_image_resize</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sx, sy, dx, dy, ox, oy, ax, ay, size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; colors, palette, transparent, sharpen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; red, green, blue, t;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *out;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; resize;<br/></li>
<li>&nbsp; &nbsp; gdImagePtr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; src, dst;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_palloc.h.html#L32" title="src/core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; src = <a href="#L1022" title="src/http/modules/ngx_http_image_filter_module.c:1022">ngx_http_image_source</a>(r, ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (src == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sx = gdImageSX(src);<br/></li>
<li>&nbsp; &nbsp; sy = gdImageSY(src);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!ctx-&gt;force<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; ctx-&gt;angle == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) sx &lt;= ctx-&gt;max_width<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) sy &lt;= ctx-&gt;max_height)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gdImageDestroy(src);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L612" title="src/http/modules/ngx_http_image_filter_module.c:612">ngx_http_image_asis</a>(r, ctx);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; colors = gdImageColorsTotal(src);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (colors &amp;&amp; conf-&gt;transparency) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; transparent = gdImageGetTransparent(src);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (transparent != -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; palette = colors;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; red = gdImageRed(src, transparent);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; green = gdImageGreen(src, transparent);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blue = gdImageBlue(src, transparent);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> transparent;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; palette = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; transparent = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; red = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; green = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; blue = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">transparent</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; gdImageColorTransparent(src, -<span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dx = sx;<br/></li>
<li>&nbsp; &nbsp; dy = sy;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;filter == <a href="#L18" title="src/http/modules/ngx_http_image_filter_module.c:18">NGX_HTTP_IMAGE_RESIZE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) dx &gt; ctx-&gt;max_width) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy = dy * ctx-&gt;max_width / dx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy = dy ? dy : <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx = ctx-&gt;max_width;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) dy &gt; ctx-&gt;max_height) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx = dx * ctx-&gt;max_height / dy;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx = dx ? dx : <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy = ctx-&gt;max_height;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resize = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (conf-&gt;filter == <a href="#L20" title="src/http/modules/ngx_http_image_filter_module.c:20">NGX_HTTP_IMAGE_ROTATE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resize = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* <a href="#L19" title="src/http/modules/ngx_http_image_filter_module.c:19">NGX_HTTP_IMAGE_CROP</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; resize = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">double</span>) dx / dy &lt; (<span class="Type">double</span>) ctx-&gt;max_width / ctx-&gt;max_height) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) dx &gt; ctx-&gt;max_width) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy = dy * ctx-&gt;max_width / dx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy = dy ? dy : <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx = ctx-&gt;max_width;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resize = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) dy &gt; ctx-&gt;max_height) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx = dx * ctx-&gt;max_height / dy;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx = dx ? dx : <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy = ctx-&gt;max_height;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resize = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (resize) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="#L1060" title="src/http/modules/ngx_http_image_filter_module.c:1060">ngx_http_image_new</a>(r, dx, dy, palette);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageDestroy(src);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (colors == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageSaveAlpha(dst, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageAlphaBlending(dst, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gdImageCopyResampled(dst, src, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>, dx, dy, sx, sy);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (colors) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageTrueColorToPalette(dst, <span class="Constant">1</span>, <span class="Constant">256</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gdImageDestroy(src);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = src;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;angle) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; src = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ax = (dx % <span class="Constant">2</span> == <span class="Constant">0</span>) ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ay = (dy % <span class="Constant">2</span> == <span class="Constant">0</span>) ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;angle) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">90</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">270</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="#L1060" title="src/http/modules/ngx_http_image_filter_module.c:1060">ngx_http_image_new</a>(r, dy, dx, palette);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageDestroy(src);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;angle == <span class="Constant">90</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ox = dy / <span class="Constant">2</span> + ay;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oy = dx / <span class="Constant">2</span> - ax;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ox = dy / <span class="Constant">2</span> - ay;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oy = dx / <span class="Constant">2</span> + ax;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageCopyRotated(dst, src, ox, oy, <span class="Constant">0</span>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; dx + ax, dy + ay, ctx-&gt;angle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageDestroy(src);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t = dx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dx = dy;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dy = t;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">180</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="#L1060" title="src/http/modules/ngx_http_image_filter_module.c:1060">ngx_http_image_new</a>(r, dx, dy, palette);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageDestroy(src);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageCopyRotated(dst, src, dx / <span class="Constant">2</span> - ax, dy / <span class="Constant">2</span> - ay, <span class="Constant">0</span>, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; dx + ax, dy + ay, ctx-&gt;angle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageDestroy(src);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;filter == <a href="#L19" title="src/http/modules/ngx_http_image_filter_module.c:19">NGX_HTTP_IMAGE_CROP</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; src = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) dx &gt; ctx-&gt;max_width) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ox = dx - ctx-&gt;max_width;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ox = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) dy &gt; ctx-&gt;max_height) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oy = dy - ctx-&gt;max_height;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oy = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ox || oy) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst = <a href="#L1060" title="src/http/modules/ngx_http_image_filter_module.c:1060">ngx_http_image_new</a>(r, dx - ox, dy - oy, colors);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageDestroy(src);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ox /= <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oy /= <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L148" title="src/core/ngx_log.h:148">ngx_log_debug4</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;image crop: </span><span class="Special">%d</span><span class="Constant"> x </span><span class="Special">%d</span><span class="Constant"> @ </span><span class="Special">%d</span><span class="Constant"> x </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; dx, dy, ox, oy);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (colors == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageSaveAlpha(dst, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageAlphaBlending(dst, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageCopy(dst, src, <span class="Constant">0</span>, <span class="Constant">0</span>, ox, oy, dx - ox, dy - oy);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (colors) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageTrueColorToPalette(dst, <span class="Constant">1</span>, <span class="Constant">256</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gdImageDestroy(src);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (transparent != -<span class="Constant">1</span> &amp;&amp; colors) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gdImageColorTransparent(dst, gdImageColorExact(dst, red, green, blue));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sharpen = <a href="#L1143" title="src/http/modules/ngx_http_image_filter_module.c:1143">ngx_http_image_filter_get_value</a>(r, conf-&gt;shcv, conf-&gt;sharpen);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sharpen &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gdImageSharpen(dst, sharpen);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gdImageInterlace(dst, (<span class="Type">int</span>) conf-&gt;interlace);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = <a href="#L1088" title="src/http/modules/ngx_http_image_filter_module.c:1088">ngx_http_image_out</a>(r, ctx-&gt;type, dst, &amp;size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="../../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;image: </span><span class="Special">%d</span><span class="Constant"> x </span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant">&quot;</span>, sx, sy, colors);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; gdImageDestroy(dst);<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_palloc.c.html#L281" title="src/core/ngx_palloc.c:281">ngx_pfree</a>(r-&gt;pool, ctx-&gt;image);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (out == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="../../core/ngx_palloc.c.html#L315" title="src/core/ngx_palloc.c:315">ngx_pool_cleanup_add</a>(r-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gdFree(out);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; gdFree(out);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L1136" title="src/http/modules/ngx_http_image_filter_module.c:1136">ngx_http_image_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;pos = out;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last = out + size;<br/></li>
<li>&nbsp; &nbsp; b-&gt;memory = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L633" title="src/http/modules/ngx_http_image_filter_module.c:633">ngx_http_image_length</a>(r, b);<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_core_module.c.html#L1829" title="src/http/ngx_http_core_module.c:1829">ngx_http_weak_etag</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> b;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> gdImagePtr<br/></li>
<li><a id="L1022">&#x200c;</a><span class="linkable">ngx_http_image_source</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="#L75" title="src/http/modules/ngx_http_image_filter_module.c:75">ngx_http_image_filter_ctx_t</a> *ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; *failed;<br/></li>
<li>&nbsp; &nbsp; gdImagePtr&nbsp;&nbsp; img;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; img = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ctx-&gt;type) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L31" title="src/http/modules/ngx_http_image_filter_module.c:31">NGX_HTTP_IMAGE_JPEG</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; img = gdImageCreateFromJpegPtr(ctx-&gt;length, ctx-&gt;image);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; failed = <span class="Constant">&quot;gdImageCreateFromJpegPtr() failed&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L32" title="src/http/modules/ngx_http_image_filter_module.c:32">NGX_HTTP_IMAGE_GIF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; img = gdImageCreateFromGifPtr(ctx-&gt;length, ctx-&gt;image);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; failed = <span class="Constant">&quot;gdImageCreateFromGifPtr() failed&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L33" title="src/http/modules/ngx_http_image_filter_module.c:33">NGX_HTTP_IMAGE_PNG</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; img = gdImageCreateFromPngPtr(ctx-&gt;length, ctx-&gt;image);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; failed = <span class="Constant">&quot;gdImageCreateFromPngPtr() failed&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; failed = <span class="Constant">&quot;unknown image type&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (img == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>, failed);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> img;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> gdImagePtr<br/></li>
<li><a id="L1060">&#x200c;</a><span class="linkable">ngx_http_image_new</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <span class="Type">int</span> w, <span class="Type">int</span> h, <span class="Type">int</span> colors)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; gdImagePtr&nbsp; img;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (colors == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; img = gdImageCreateTrueColor(w, h);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (img == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;gdImageCreateTrueColor() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; img = gdImageCreate(w, h);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (img == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;gdImageCreate() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> img;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L1088">&#x200c;</a><span class="linkable">ngx_http_image_out</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> type, gdImagePtr img,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span> *size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *failed;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *out;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jq;<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (type) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L31" title="src/http/modules/ngx_http_image_filter_module.c:31">NGX_HTTP_IMAGE_JPEG</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; conf = <a href="../ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="#L180" title="src/http/modules/ngx_http_image_filter_module.c:180">ngx_http_image_filter_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; jq = <a href="#L1143" title="src/http/modules/ngx_http_image_filter_module.c:1143">ngx_http_image_filter_get_value</a>(r, conf-&gt;jqcv, conf-&gt;jpeg_quality);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (jq &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = gdImageJpegPtr(img, size, jq);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; failed = <span class="Constant">&quot;gdImageJpegPtr() failed&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L32" title="src/http/modules/ngx_http_image_filter_module.c:32">NGX_HTTP_IMAGE_GIF</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = gdImageGifPtr(img, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; failed = <span class="Constant">&quot;gdImageGifPtr() failed&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">case</span> <a href="#L33" title="src/http/modules/ngx_http_image_filter_module.c:33">NGX_HTTP_IMAGE_PNG</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = gdImagePngPtr(img, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; failed = <span class="Constant">&quot;gdImagePngPtr() failed&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; failed = <span class="Constant">&quot;unknown image type&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (out == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>, failed);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> out;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1136">&#x200c;</a></span><span class="linkable">ngx_http_image_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; gdFree(data);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a><br/></li>
<li><a id="L1143">&#x200c;</a><span class="linkable">ngx_http_image_filter_get_value</span>(<a href="../ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a> *cv, <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> v)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; val;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cv == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> v;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L58" title="src/http/ngx_http_script.c:58">ngx_http_complex_value</a>(r, cv, &amp;val) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1161" title="src/http/modules/ngx_http_image_filter_module.c:1161">ngx_http_image_filter_value</a>(&amp;val);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a><br/></li>
<li><a id="L1161">&#x200c;</a><span class="linkable">ngx_http_image_filter_value</span>(<a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *value)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (value-&gt;len == <span class="Constant">1</span> &amp;&amp; value-&gt;data[<span class="Constant">0</span>] == <span class="Constant">'-'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="../../core/ngx_string.c.html#L902" title="src/core/ngx_string.c:902">ngx_atoi</a>(value-&gt;data, value-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L1180">&#x200c;</a><span class="linkable">ngx_http_image_filter_create_conf</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>&nbsp; *conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; conf = <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * set by <a href="../../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>():<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;width = 0;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;height = 0;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;angle = 0;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;wcv = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;hcv = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;acv = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;jqcv = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *&nbsp; &nbsp;&nbsp; conf-&gt;shcv = NULL;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; conf-&gt;filter = <a href="../../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;jpeg_quality = <a href="../../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;sharpen = <a href="../../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;transparency = <a href="../../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;interlace = <a href="../../core/ngx_conf_file.h.html#L56" title="src/core/ngx_conf_file.h:56">NGX_CONF_UNSET</a>;<br/></li>
<li>&nbsp; &nbsp; conf-&gt;buffer_size = <a href="../../core/ngx_conf_file.h.html#L59" title="src/core/ngx_conf_file.h:59">NGX_CONF_UNSET_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> conf;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1214">&#x200c;</a><span class="linkable">ngx_http_image_filter_merge_conf</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <span class="Type">void</span> *parent, <span class="Type">void</span> *child)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a> *prev = parent;<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a> *conf = child;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;filter == <a href="../../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (prev-&gt;filter == <a href="../../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;filter = <a href="#L15" title="src/http/modules/ngx_http_image_filter_module.c:15">NGX_HTTP_IMAGE_OFF</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;filter = prev-&gt;filter;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;width = prev-&gt;width;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;height = prev-&gt;height;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;angle = prev-&gt;angle;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;wcv = prev-&gt;wcv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;hcv = prev-&gt;hcv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;acv = prev-&gt;acv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;jpeg_quality == <a href="../../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 75 is libjpeg default quality */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L215" title="src/core/ngx_conf_file.h:215">ngx_conf_merge_uint_value</a>(conf-&gt;jpeg_quality, prev-&gt;jpeg_quality, <span class="Constant">75</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;jqcv == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;jqcv = prev-&gt;jqcv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;sharpen == <a href="../../core/ngx_conf_file.h.html#L57" title="src/core/ngx_conf_file.h:57">NGX_CONF_UNSET_UINT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L215" title="src/core/ngx_conf_file.h:215">ngx_conf_merge_uint_value</a>(conf-&gt;sharpen, prev-&gt;sharpen, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (conf-&gt;shcv == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conf-&gt;shcv = prev-&gt;shcv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;transparency, prev-&gt;transparency, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L205" title="src/core/ngx_conf_file.h:205">ngx_conf_merge_value</a>(conf-&gt;interlace, prev-&gt;interlace, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.h.html#L230" title="src/core/ngx_conf_file.h:230">ngx_conf_merge_size_value</a>(conf-&gt;buffer_size, prev-&gt;buffer_size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">1</span> * <span class="Constant">1024</span> * <span class="Constant">1024</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1265">&#x200c;</a><span class="linkable">ngx_http_image_filter</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a> *imcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cv;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L82" title="src/http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>&nbsp;&nbsp; ccv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cf-&gt;args-&gt;nelts == <span class="Constant">2</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;off&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;filter = <a href="#L15" title="src/http/modules/ngx_http_image_filter_module.c:15">NGX_HTTP_IMAGE_OFF</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;test&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;filter = <a href="#L16" title="src/http/modules/ngx_http_image_filter_module.c:16">NGX_HTTP_IMAGE_TEST</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;size&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;filter = <a href="#L17" title="src/http/modules/ngx_http_image_filter_module.c:17">NGX_HTTP_IMAGE_SIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (cf-&gt;args-&gt;nelts == <span class="Constant">3</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;rotate&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (imcf-&gt;filter != <a href="#L18" title="src/http/modules/ngx_http_image_filter_module.c:18">NGX_HTTP_IMAGE_RESIZE</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; imcf-&gt;filter != <a href="#L19" title="src/http/modules/ngx_http_image_filter_module.c:19">NGX_HTTP_IMAGE_CROP</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;filter = <a href="#L20" title="src/http/modules/ngx_http_image_filter_module.c:20">NGX_HTTP_IMAGE_ROTATE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;ccv, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L82" title="src/http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ccv.cf = cf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ccv.value = &amp;value[++i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ccv.complex_value = &amp;cv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L108" title="src/http/ngx_http_script.c:108">ngx_http_compile_complex_value</a>(&amp;ccv) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cv.lengths == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1161" title="src/http/modules/ngx_http_image_filter_module.c:1161">ngx_http_image_filter_value</a>(&amp;value[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n != <span class="Constant">90</span> &amp;&amp; n != <span class="Constant">180</span> &amp;&amp; n != <span class="Constant">270</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;angle = (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;acv = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (imcf-&gt;acv == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *imcf-&gt;acv = cv;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;resize&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;filter = <a href="#L18" title="src/http/modules/ngx_http_image_filter_module.c:18">NGX_HTTP_IMAGE_RESIZE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;crop&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;filter = <a href="#L19" title="src/http/modules/ngx_http_image_filter_module.c:19">NGX_HTTP_IMAGE_CROP</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;ccv, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L82" title="src/http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ccv.cf = cf;<br/></li>
<li>&nbsp; &nbsp; ccv.value = &amp;value[++i];<br/></li>
<li>&nbsp; &nbsp; ccv.complex_value = &amp;cv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L108" title="src/http/ngx_http_script.c:108">ngx_http_compile_complex_value</a>(&amp;ccv) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cv.lengths == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1161" title="src/http/modules/ngx_http_image_filter_module.c:1161">ngx_http_image_filter_value</a>(&amp;value[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;width = (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;wcv = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (imcf-&gt;wcv == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *imcf-&gt;wcv = cv;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;ccv, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L82" title="src/http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ccv.cf = cf;<br/></li>
<li>&nbsp; &nbsp; ccv.value = &amp;value[++i];<br/></li>
<li>&nbsp; &nbsp; ccv.complex_value = &amp;cv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L108" title="src/http/ngx_http_script.c:108">ngx_http_compile_complex_value</a>(&amp;ccv) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cv.lengths == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1161" title="src/http/modules/ngx_http_image_filter_module.c:1161">ngx_http_image_filter_value</a>(&amp;value[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;height = (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;hcv = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (imcf-&gt;hcv == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *imcf-&gt;hcv = cv;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>, <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;value[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1418">&#x200c;</a><span class="linkable">ngx_http_image_filter_jpeg_quality</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a> *imcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cv;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L82" title="src/http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>&nbsp;&nbsp; ccv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;ccv, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L82" title="src/http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ccv.cf = cf;<br/></li>
<li>&nbsp; &nbsp; ccv.value = &amp;value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; ccv.complex_value = &amp;cv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L108" title="src/http/ngx_http_script.c:108">ngx_http_compile_complex_value</a>(&amp;ccv) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cv.lengths == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1161" title="src/http/modules/ngx_http_image_filter_module.c:1161">ngx_http_image_filter_value</a>(&amp;value[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;jpeg_quality = (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;jqcv = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (imcf-&gt;jqcv == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *imcf-&gt;jqcv = cv;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1465">&#x200c;</a><span class="linkable">ngx_http_image_filter_sharpen</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L57" title="src/http/modules/ngx_http_image_filter_module.c:57">ngx_http_image_filter_conf_t</a> *imcf = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; cv;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_script.h.html#L82" title="src/http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>&nbsp;&nbsp; ccv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;ccv, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L82" title="src/http/ngx_http_script.h:82">ngx_http_compile_complex_value_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ccv.cf = cf;<br/></li>
<li>&nbsp; &nbsp; ccv.value = &amp;value[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; ccv.complex_value = &amp;cv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../ngx_http_script.c.html#L108" title="src/http/ngx_http_script.c:108">ngx_http_compile_complex_value</a>(&amp;ccv) != <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cv.lengths == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1161" title="src/http/modules/ngx_http_image_filter_module.c:1161">ngx_http_image_filter_value</a>(&amp;value[<span class="Constant">1</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[<span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;sharpen = (<a href="../../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; imcf-&gt;shcv = <a href="../../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="../ngx_http_script.h.html#L71" title="src/http/ngx_http_script.h:71">ngx_http_complex_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (imcf-&gt;shcv == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *imcf-&gt;shcv = cv;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1512">&#x200c;</a><span class="linkable">ngx_http_image_filter_init</span>(<a href="../../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../v2/ngx_http_v2_filter_module.c.html#L123" title="src/http/v2/ngx_http_v2_filter_module.c:123">ngx_http_next_header_filter</a> = <a href="../ngx_http.c.html#L73" title="src/http/ngx_http.c:73">ngx_http_top_header_filter</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.c.html#L73" title="src/http/ngx_http.c:73">ngx_http_top_header_filter</a> = <a href="#L208" title="src/http/modules/ngx_http_image_filter_module.c:208">ngx_http_image_header_filter</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http_copy_filter_module.c.html#L83" title="src/http/ngx_http_copy_filter_module.c:83">ngx_http_next_body_filter</a> = <a href="../ngx_http.c.html#L74" title="src/http/ngx_http.c:74">ngx_http_top_body_filter</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../ngx_http.c.html#L74" title="src/http/ngx_http.c:74">ngx_http_top_body_filter</a> = <a href="#L279" title="src/http/modules/ngx_http_image_filter_module.c:279">ngx_http_image_body_filter</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
