<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/http/ngx_http_request.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>src/http/ngx_http_request.c - Nginx 1.11.2</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L68">ngx_http_client_errors</a></li>
<li><a href="#L81">ngx_http_headers_in</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L1429">ngx_http_alloc_large_header_buffer</a></li>
<li><a href="#L2710">ngx_http_block_reading</a></li>
<li><a href="#L3539">ngx_http_close_connection</a></li>
<li><a href="#L3400">ngx_http_close_request</a></li>
<li><a href="#L509">ngx_http_create_request</a></li>
<li><a href="#L3311">ngx_http_empty_handler</a></li>
<li><a href="#L2524">ngx_http_finalize_connection</a></li>
<li><a href="#L2264">ngx_http_finalize_request</a></li>
<li><a href="#L2097">ngx_http_find_virtual_server</a></li>
<li><a href="#L3433">ngx_http_free_request</a></li>
<li><a href="#L200">ngx_http_init_connection</a></li>
<li><a href="#L3079">ngx_http_keepalive_handler</a></li>
<li><a href="#L3255">ngx_http_lingering_close_handler</a></li>
<li><a href="#L3572">ngx_http_log_error</a></li>
<li><a href="#L3604">ngx_http_log_error_handler</a></li>
<li><a href="#L3521">ngx_http_log_request</a></li>
<li><a href="#L3363">ngx_http_post_action</a></li>
<li><a href="#L2241">ngx_http_post_request</a></li>
<li><a href="#L1654">ngx_http_process_connection</a></li>
<li><a href="#L1573">ngx_http_process_header_line</a></li>
<li><a href="#L1613">ngx_http_process_host</a></li>
<li><a href="#L1742">ngx_http_process_multi_header_lines</a></li>
<li><a href="#L1841">ngx_http_process_request</a></li>
<li><a href="#L1771">ngx_http_process_request_header</a></li>
<li><a href="#L1184">ngx_http_process_request_headers</a></li>
<li><a href="#L919">ngx_http_process_request_line</a></li>
<li><a href="#L1067">ngx_http_process_request_uri</a></li>
<li><a href="#L1589">ngx_http_process_unique_header_line</a></li>
<li><a href="#L1669">ngx_http_process_user_agent</a></li>
<li><a href="#L1372">ngx_http_read_request_header</a></li>
<li><a href="#L3320">ngx_http_request_empty_handler</a></li>
<li><a href="#L2700">ngx_http_request_finalizer</a></li>
<li><a href="#L2183">ngx_http_request_handler</a></li>
<li><a href="#L2208">ngx_http_run_posted_requests</a></li>
<li><a href="#L3330">ngx_http_send_special</a></li>
<li><a href="#L2847">ngx_http_set_keepalive</a></li>
<li><a href="#L3210">ngx_http_set_lingering_close</a></li>
<li><a href="#L2014">ngx_http_set_virtual_server</a></li>
<li><a href="#L2582">ngx_http_set_write_handler</a></li>
<li><a href="#L622">ngx_http_ssl_handshake</a></li>
<li><a href="#L758">ngx_http_ssl_handshake_handler</a></li>
<li><a href="#L827">ngx_http_ssl_servername</a></li>
<li><a href="#L2512">ngx_http_terminate_handler</a></li>
<li><a href="#L2464">ngx_http_terminate_request</a></li>
<li><a href="#L2728">ngx_http_test_reading</a></li>
<li><a href="#L1923">ngx_http_validate_host</a></li>
<li><a href="#L379">ngx_http_wait_request_handler</a></li>
<li><a href="#L2615">ngx_http_writer</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http_probe.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L379" title="src/http/ngx_http_request.c:379">ngx_http_wait_request_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L919" title="src/http/ngx_http_request.c:919">ngx_http_process_request_line</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1184" title="src/http/ngx_http_request.c:1184">ngx_http_process_request_headers</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span> <a href="#L1372" title="src/http/ngx_http_request.c:1372">ngx_http_read_request_header</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1429" title="src/http/ngx_http_request.c:1429">ngx_http_alloc_large_header_buffer</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> request_line);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1742" title="src/http/ngx_http_request.c:1742">ngx_http_process_multi_header_lines</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1613" title="src/http/ngx_http_request.c:1613">ngx_http_process_host</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1654" title="src/http/ngx_http_request.c:1654">ngx_http_process_connection</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1669" title="src/http/ngx_http_request.c:1669">ngx_http_process_user_agent</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1923" title="src/http/ngx_http_request.c:1923">ngx_http_validate_host</a>(<a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *host, <a href="../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> alloc);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2014" title="src/http/ngx_http_request.c:2014">ngx_http_set_virtual_server</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *host);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2097" title="src/http/ngx_http_request.c:2097">ngx_http_find_virtual_server</a>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L228" title="src/http/ngx_http_core_module.h:228">ngx_http_virtual_names_t</a> *virtual_names, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *host,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a> **cscfp);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2183" title="src/http/ngx_http_request.c:2183">ngx_http_request_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2464" title="src/http/ngx_http_request.c:2464">ngx_http_terminate_request</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> rc);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2512" title="src/http/ngx_http_request.c:2512">ngx_http_terminate_handler</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2524" title="src/http/ngx_http_request.c:2524">ngx_http_finalize_connection</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2582" title="src/http/ngx_http_request.c:2582">ngx_http_set_write_handler</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2615" title="src/http/ngx_http_request.c:2615">ngx_http_writer</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2700" title="src/http/ngx_http_request.c:2700">ngx_http_request_finalizer</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2847" title="src/http/ngx_http_request.c:2847">ngx_http_set_keepalive</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3079" title="src/http/ngx_http_request.c:3079">ngx_http_keepalive_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3210" title="src/http/ngx_http_request.c:3210">ngx_http_set_lingering_close</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3255" title="src/http/ngx_http_request.c:3255">ngx_http_lingering_close_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L3363" title="src/http/ngx_http_request.c:3363">ngx_http_post_action</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> error);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L3521" title="src/http/ngx_http_request.c:3521">ngx_http_log_request</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<a href="#L3572" title="src/http/ngx_http_request.c:3572">ngx_http_log_error</a>(<a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len);<br/></li>
<li><span class="Type">static</span> u_char *<a href="#L3604" title="src/http/ngx_http_request.c:3604">ngx_http_log_error_handler</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *sr, u_char *buf, <span class="Type">size_t</span> len);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void</span> <a href="#L622" title="src/http/ngx_http_request.c:622">ngx_http_ssl_handshake</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L758" title="src/http/ngx_http_request.c:758">ngx_http_ssl_handshake_handler</a>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L68">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span> *<span class="linkable">ngx_http_client_errors</span>[] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="ngx_http_request.h.html#L55" title="src/http/ngx_http_request.h:55">NGX_HTTP_PARSE_INVALID_METHOD</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">&quot;client sent invalid method&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="ngx_http_request.h.html#L56" title="src/http/ngx_http_request.h:56">NGX_HTTP_PARSE_INVALID_REQUEST</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">&quot;client sent invalid request&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="ngx_http_request.h.html#L57" title="src/http/ngx_http_request.h:57">NGX_HTTP_PARSE_INVALID_09_METHOD</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Constant">&quot;client sent invalid method in HTTP/0.9 request&quot;<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L81">&#x200c;</a><a href="ngx_http_request.h.html#L165" title="src/http/ngx_http_request.h:165">ngx_http_header_t</a>&nbsp; <span class="linkable">ngx_http_headers_in</span>[] = {<br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Host&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, host),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1613" title="src/http/ngx_http_request.c:1613">ngx_http_process_host</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Connection&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, connection),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1654" title="src/http/ngx_http_request.c:1654">ngx_http_process_connection</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;If-Modified-Since&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, if_modified_since),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;If-Unmodified-Since&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, if_unmodified_since),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;If-Match&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, if_match),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;If-None-Match&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, if_none_match),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;User-Agent&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, user_agent),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1669" title="src/http/ngx_http_request.c:1669">ngx_http_process_user_agent</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Referer&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, referer),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Content-Length&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, content_length),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Content-Range&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, content_range),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Content-Type&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, content_type),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Range&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, range),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;If-Range&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, if_range),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Transfer-Encoding&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, transfer_encoding),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Expect&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, expect),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Upgrade&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, upgrade),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_GZIP)<br/></li>
<li></span>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Accept-Encoding&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, accept_encoding),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Via&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, via),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Authorization&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, authorization),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1589" title="src/http/ngx_http_request.c:1589">ngx_http_process_unique_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Keep-Alive&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, keep_alive),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_X_FORWARDED_FOR)<br/></li>
<li></span>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Forwarded-For&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, x_forwarded_for),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1742" title="src/http/ngx_http_request.c:1742">ngx_http_process_multi_header_lines</a> },<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_REALIP)<br/></li>
<li></span>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;X-Real-IP&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, x_real_ip),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_HEADERS)<br/></li>
<li></span>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Accept&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, accept),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Accept-Language&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, accept_language),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_DAV)<br/></li>
<li></span>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Depth&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, depth),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Destination&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, destination),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Overwrite&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, overwrite),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Date&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, date),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1573" title="src/http/ngx_http_request.c:1573">ngx_http_process_header_line</a> },<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;Cookie&quot;</span>), offsetof(<a href="ngx_http_request.h.html#L243" title="src/http/ngx_http_request.h:243">ngx_http_headers_in_t</a>, cookies),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L1742" title="src/http/ngx_http_request.c:1742">ngx_http_process_multi_header_lines</a> },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; { <a href="../core/ngx_string.h.html#L41" title="src/core/ngx_string.h:41">ngx_null_string</a>, <span class="Constant">0</span>, <span class="Constant">NULL</span> }<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L200">&#x200c;</a></span><span class="linkable">ngx_http_init_connection</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *rev;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in&nbsp; &nbsp;&nbsp; *sin;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L267" title="src/http/ngx_http_core_module.h:267">ngx_http_port_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *port;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L250" title="src/http/ngx_http_core_module.h:250">ngx_http_in_addr_t</a>&nbsp; &nbsp;&nbsp; *addr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L20" title="src/http/ngx_http.h:20">ngx_http_log_ctx_t</a>&nbsp; &nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; *hc;<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">struct</span> sockaddr_in6&nbsp; &nbsp; *sin6;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L258" title="src/http/ngx_http_core_module.h:258">ngx_http_in6_addr_t</a>&nbsp; &nbsp; *addr6;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; hc = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(c-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;data = hc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* find the server configuration for the address:port */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; port = c-&gt;listening-&gt;servers;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (port-&gt;naddrs &gt; <span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * there are several addresses on this port and one of them<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * is an &quot;*:port&quot; wildcard so getsockname() in ngx_http_server_addr()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * is required to determine a server address<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_connection.c.html#L1276" title="src/core/ngx_connection.c:1276">ngx_connection_local_sockaddr</a>(c, <span class="Constant">NULL</span>, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (c-&gt;local_sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin6 = (<span class="Type">struct</span> sockaddr_in6 *) c-&gt;local_sockaddr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = port-&gt;addrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the last address is &quot;*&quot; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; port-&gt;naddrs - <span class="Constant">1</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(&amp;addr6[i].addr6, &amp;sin6-&gt;sin6_addr, <span class="Constant">16</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;addr_conf = &amp;addr6[i].conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sin = (<span class="Type">struct</span> sockaddr_in *) c-&gt;local_sockaddr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = port-&gt;addrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the last address is &quot;*&quot; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; port-&gt;naddrs - <span class="Constant">1</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (addr[i].addr == sin-&gt;sin_addr.s_addr) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;addr_conf = &amp;addr[i].conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (c-&gt;local_sockaddr-&gt;sa_family) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_INET6)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> AF_INET6:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr6 = port-&gt;addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;addr_conf = &amp;addr6[<span class="Constant">0</span>].conf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:</span> <span class="Comment">/* AF_INET */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr = port-&gt;addrs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;addr_conf = &amp;addr[<span class="Constant">0</span>].conf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the default server configuration for the address:port */<br/></li>
<li></span>&nbsp; &nbsp; hc-&gt;conf_ctx = hc-&gt;addr_conf-&gt;default_server-&gt;ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(c-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http.h.html#L20" title="src/http/ngx_http.h:20">ngx_http_log_ctx_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx-&gt;connection = c;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;request = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;current_request = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;connection = c-&gt;number;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;handler = <a href="#L3572" title="src/http/ngx_http_request.c:3572">ngx_http_log_error</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;data = ctx;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;waiting for request&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log_error = NGX_ERROR_INFO;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler = <a href="#L379" title="src/http/ngx_http_request.c:379">ngx_http_wait_request_handler</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L3311" title="src/http/ngx_http_request.c:3311">ngx_http_empty_handler</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_V2)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;addr_conf-&gt;http2) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;handler = <a href="v2/ngx_http_v2.c.html#L203" title="src/http/v2/ngx_http_v2.c:203">ngx_http_v2_init</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; <a href="modules/ngx_http_ssl_module.h.html#L60" title="src/http/modules/ngx_http_ssl_module.h:60">ngx_http_ssl_srv_conf_t</a>&nbsp; *sscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(hc-&gt;conf_ctx, <a href="modules/ngx_http_ssl_module.c.html#L255" title="src/http/modules/ngx_http_ssl_module.c:255">ngx_http_ssl_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sscf-&gt;enable || hc-&gt;addr_conf-&gt;ssl) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;SSL handshaking&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;addr_conf-&gt;ssl &amp;&amp; sscf-&gt;ssl.ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;no </span><span class="Special">\&quot;</span><span class="Constant">ssl_certificate</span><span class="Special">\&quot;</span><span class="Constant"> is defined &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;in server listening on SSL port&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;ssl = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;handler = <a href="#L622" title="src/http/ngx_http_request.c:622">ngx_http_ssl_handshake</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;addr_conf-&gt;proxy_protocol) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;proxy_protocol = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;reading PROXY protocol&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the deferred accept(), <a href="../event/modules/ngx_iocp_module.c.html#L101" title="src/event/modules/ngx_iocp_module.c:101">iocp</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L53" title="src/event/ngx_event.c:53">ngx_use_accept_mutex</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(rev, &amp;<a href="../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;handler(rev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, c-&gt;listening-&gt;post_accept_timeout);<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L379">&#x200c;</a></span><span class="linkable">ngx_http_wait_request_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; &nbsp;&nbsp; *hc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http wait request handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;close) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hc = c-&gt;data;<br/></li>
<li>&nbsp; &nbsp; cscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(hc-&gt;conf_ctx, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = cscf-&gt;client_header_buffer_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = c-&gt;buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = <a href="../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(c-&gt;pool, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;buffer = b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (b-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(c-&gt;pool, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;start == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = b-&gt;last + size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = c-&gt;recv(c, b-&gt;last, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!rev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, c-&gt;listening-&gt;post_accept_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We are trying to not hold c-&gt;buffer's memory for an idle connection.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_palloc.c.html#L281" title="src/core/ngx_palloc.c:281">ngx_pfree</a>(c-&gt;pool, b-&gt;start) == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client closed connection&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;proxy_protocol) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;proxy_protocol = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_proxy_protocol.c.html#L13" title="src/core/ngx_proxy_protocol.c:13">ngx_proxy_protocol_read</a>(c, b-&gt;pos, b-&gt;last);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos == b-&gt;last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;waiting for request&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(rev, &amp;<a href="../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;reading client request line&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;data = <a href="#L509" title="src/http/ngx_http_request.c:509">ngx_http_create_request</a>(c);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler = <a href="#L919" title="src/http/ngx_http_request.c:919">ngx_http_process_request_line</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L919" title="src/http/ngx_http_request.c:919">ngx_http_process_request_line</a>(rev);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *<br/></li>
<li><a id="L509">&#x200c;</a><span class="linkable">ngx_http_create_request</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *pool;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_times.h.html#L20" title="src/core/ngx_times.h:20">ngx_time_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tp;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L20" title="src/http/ngx_http.h:20">ngx_http_log_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; &nbsp; &nbsp; *hc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp;&nbsp; *cscf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp;&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L178" title="src/http/ngx_http_core_module.h:178">ngx_http_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;requests++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hc = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(hc-&gt;conf_ctx, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool = <a href="../core/ngx_palloc.c.html#L20" title="src/core/ngx_palloc.c:20">ngx_create_pool</a>(cscf-&gt;request_pool_size, c-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(pool, <span class="Statement">sizeof</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;pool = pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;http_connection = hc;<br/></li>
<li>&nbsp; &nbsp; r-&gt;signature = <a href="ngx_http_config.h.html#L39" title="src/http/ngx_http_config.h:39">NGX_HTTP_MODULE</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;connection = c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;main_conf = hc-&gt;conf_ctx-&gt;main_conf;<br/></li>
<li>&nbsp; &nbsp; r-&gt;srv_conf = hc-&gt;conf_ctx-&gt;srv_conf;<br/></li>
<li>&nbsp; &nbsp; r-&gt;loc_conf = hc-&gt;conf_ctx-&gt;loc_conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="#L2710" title="src/http/ngx_http_request.c:2710">ngx_http_block_reading</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.h.html#L199" title="src/core/ngx_connection.h:199">ngx_set_connection_log</a>(r-&gt;connection, clcf-&gt;error_log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;header_in = hc-&gt;nbusy ? hc-&gt;busy[<span class="Constant">0</span>] : c-&gt;buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_list.h.html#L37" title="src/core/ngx_list.h:37">ngx_list_init</a>(&amp;r-&gt;headers_out.headers, r-&gt;pool, <span class="Constant">20</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;ctx = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<span class="Type">void</span> *) * <a href="ngx_http.c.html#L70" title="src/http/ngx_http.c:70">ngx_http_max_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;variables = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, cmcf-&gt;variables.nelts<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * <span class="Statement">sizeof</span>(<a href="ngx_http_variables.h.html#L17" title="src/http/ngx_http_variables.h:17">ngx_http_variable_value_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;variables == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;main_filter_need_in_memory = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> = r;<br/></li>
<li>&nbsp; &nbsp; r-&gt;count = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp = <a href="../core/ngx_times.h.html#L37" title="src/core/ngx_times.h:37">ngx_timeofday</a>();<br/></li>
<li>&nbsp; &nbsp; r-&gt;start_sec = tp-&gt;sec;<br/></li>
<li>&nbsp; &nbsp; r-&gt;start_msec = tp-&gt;<a href="../event/modules/ngx_iocp_module.c.html#L103" title="src/event/modules/ngx_iocp_module.c:103">msec</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;method = <a href="ngx_http_request.h.html#L28" title="src/http/ngx_http_request.h:28">NGX_HTTP_UNKNOWN</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;http_version = <a href="ngx_http_request.h.html#L24" title="src/http/ngx_http_request.h:24">NGX_HTTP_VERSION_10</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_in.content_length_n = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_in.keep_alive_n = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.content_length_n = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_out.last_modified_time = -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;uri_changes = <a href="ngx_http_request.h.html#L12" title="src/http/ngx_http_request.h:12">NGX_HTTP_MAX_URI_CHANGES</a> + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;subrequests = <a href="ngx_http_request.h.html#L13" title="src/http/ngx_http_request.h:13">NGX_HTTP_MAX_SUBREQUESTS</a> + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;http_state = NGX_HTTP_READING_REQUEST_STATE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = c-&gt;log-&gt;data;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;request = r;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;current_request = r;<br/></li>
<li>&nbsp; &nbsp; r-&gt;log_handler = <a href="#L3604" title="src/http/ngx_http_request.c:3604">ngx_http_log_error_handler</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STAT_STUB)<br/></li>
<li></span>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L71" title="src/event/ngx_event.c:71">ngx_stat_reading</a>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; r-&gt;stat_reading = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L67" title="src/event/ngx_event.c:67">ngx_stat_requests</a>, <span class="Constant">1</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> r;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L622">&#x200c;</a></span><span class="linkable">ngx_http_ssl_handshake</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, buf[<a href="../core/ngx_proxy_protocol.h.html#L16" title="src/core/ngx_proxy_protocol.h:16">NGX_PROXY_PROTOCOL_MAX_HEADER</a> + <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; &nbsp; *hc;<br/></li>
<li>&nbsp; &nbsp; <a href="modules/ngx_http_ssl_module.h.html#L60" title="src/http/modules/ngx_http_ssl_module.h:60">ngx_http_ssl_srv_conf_t</a>&nbsp; *sscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; hc = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, rev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http check ssl handshake&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;close) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = hc-&gt;proxy_protocol ? <span class="Statement">sizeof</span>(buf) : <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = recv(c-&gt;fd, (<span class="Type">char</span> *) buf, size, MSG_PEEK);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; err = <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, rev-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http recv(): %z&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err == <a href="../os/win32/ngx_errno.h.html#L41" title="src/os/win32/ngx_errno.h:41">NGX_EAGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;ready = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!rev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, c-&gt;listening-&gt;post_accept_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, err, <span class="Constant">&quot;recv() failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;proxy_protocol) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;proxy_protocol = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_proxy_protocol.c.html#L13" title="src/core/ngx_proxy_protocol.c:13">ngx_proxy_protocol_read</a>(c, buf, buf + n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = p - buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;recv(c, buf, size) != (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>) size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;SSL handshaking&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>) size) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(rev, &amp;<a href="../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf[<span class="Constant">0</span>] = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (buf[<span class="Constant">0</span>] &amp; <span class="Constant">0x80</span> <span class="Comment">/* SSLv2 */</span> || buf[<span class="Constant">0</span>] == <span class="Constant">0x16</span> <span class="Comment">/* SSLv3/TLSv1 */</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, rev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;https ssl handshake: 0x</span><span class="Special">%02X</span><span class="Constant">d&quot;</span>, buf[<span class="Constant">0</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(hc-&gt;conf_ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="modules/ngx_http_ssl_module.c.html#L255" title="src/http/modules/ngx_http_ssl_module.c:255">ngx_http_ssl_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L1125" title="src/event/ngx_event_openssl.c:1125">ngx_ssl_create_connection</a>(&amp;sscf-&gt;ssl, c, <a href="../event/ngx_event_openssl.h.html#L135" title="src/event/ngx_event_openssl.h:135">NGX_SSL_BUFFER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../event/ngx_event_openssl.c.html#L1184" title="src/event/ngx_event_openssl.c:1184">ngx_ssl_handshake</a>(c);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!rev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, c-&gt;listening-&gt;post_accept_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;handler = <a href="#L758" title="src/http/ngx_http_request.c:758">ngx_http_ssl_handshake_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L758" title="src/http/ngx_http_request.c:758">ngx_http_ssl_handshake_handler</a>(c);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, rev-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;plain http&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;waiting for request&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;handler = <a href="#L379" title="src/http/ngx_http_request.c:379">ngx_http_wait_request_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L379" title="src/http/ngx_http_request.c:379">ngx_http_wait_request_handler</a>(rev);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;client closed connection&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L758">&#x200c;</a></span><span class="linkable">ngx_http_ssl_handshake_handler</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;handshaked) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * The majority of browsers do not send the &quot;close notify&quot; alert.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Among them are MSIE, old Mozilla, Netscape 4, Konqueror,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * and Links.&nbsp; And what is more, MSIE ignores the server's alert.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Opera and recent Mozilla send the alert.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;no_wait_shutdown = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_V2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp;&nbsp; &amp;&amp; (defined TLSEXT_TYPE_application_layer_protocol_negotiation&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; || defined TLSEXT_TYPE_next_proto_neg))<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">unsigned</span> <span class="Type">char</span>&nbsp; &nbsp; *data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; *hc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hc = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;addr_conf-&gt;http2) {<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef TLSEXT_TYPE_application_layer_protocol_negotiation<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSL_get0_alpn_selected(c-&gt;ssl-&gt;connection, &amp;data, &amp;len);<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef TLSEXT_TYPE_next_proto_neg<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSL_get0_next_proto_negotiated(c-&gt;ssl-&gt;connection, &amp;data, &amp;len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#else</span> <span class="Comment">/* TLSEXT_TYPE_next_proto_neg */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSL_get0_next_proto_negotiated(c-&gt;ssl-&gt;connection, &amp;data, &amp;len);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">2</span> &amp;&amp; data[<span class="Constant">0</span>] == <span class="Constant">'h'</span> &amp;&amp; data[<span class="Constant">1</span>] == <span class="Constant">'2'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="v2/ngx_http_v2.c.html#L203" title="src/http/v2/ngx_http_v2.c:203">ngx_http_v2_init</a>(c-&gt;read);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;waiting for request&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L379" title="src/http/ngx_http_request.c:379">ngx_http_wait_request_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* STUB: epoll edge */</span> c-&gt;write-&gt;handler = <a href="#L3311" title="src/http/ngx_http_request.c:3311">ngx_http_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L379" title="src/http/ngx_http_request.c:379">ngx_http_wait_request_handler</a>(c-&gt;read);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_SET_TLSEXT_HOSTNAME<br/></li>
<li></span><br/></li>
<li><span class="Type">int<br/></li>
<li><a id="L827">&#x200c;</a></span><span class="linkable">ngx_http_ssl_servername</span>(<a href="../event/ngx_event_openssl.h.html#L54" title="src/event/ngx_event_openssl.h:54">ngx_ssl_conn_t</a> *ssl_conn, <span class="Type">int</span> *ad, <span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *servername;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; &nbsp;&nbsp; *hc;<br/></li>
<li>&nbsp; &nbsp; <a href="modules/ngx_http_ssl_module.h.html#L60" title="src/http/modules/ngx_http_ssl_module.h:60">ngx_http_ssl_srv_conf_t</a>&nbsp;&nbsp; *sscf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; servername = SSL_get_servername(ssl_conn, TLSEXT_NAMETYPE_host_name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (servername == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> SSL_TLSEXT_ERR_NOACK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="../event/ngx_event_openssl.h.html#L175" title="src/event/ngx_event_openssl.h:175">ngx_ssl_get_connection</a>(ssl_conn);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl-&gt;renegotiation) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> SSL_TLSEXT_ERR_NOACK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;SSL server name: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, servername);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; host.len = <a href="../core/ngx_string.h.html#L61" title="src/core/ngx_string.h:61">ngx_strlen</a>(servername);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (host.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> SSL_TLSEXT_ERR_NOACK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; host.data = (u_char *) servername;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1923" title="src/http/ngx_http_request.c:1923">ngx_http_validate_host</a>(&amp;host, c-&gt;pool, <span class="Constant">1</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> SSL_TLSEXT_ERR_NOACK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hc = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2097" title="src/http/ngx_http_request.c:2097">ngx_http_find_virtual_server</a>(c, hc-&gt;addr_conf-&gt;virtual_names, &amp;host,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>, &amp;cscf)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> SSL_TLSEXT_ERR_NOACK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hc-&gt;ssl_servername = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(c-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;ssl_servername == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> SSL_TLSEXT_ERR_NOACK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *hc-&gt;ssl_servername = host;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hc-&gt;conf_ctx = cscf-&gt;ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(hc-&gt;conf_ctx, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.h.html#L199" title="src/core/ngx_connection.h:199">ngx_set_connection_log</a>(c, clcf-&gt;error_log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(hc-&gt;conf_ctx, <a href="modules/ngx_http_ssl_module.c.html#L255" title="src/http/modules/ngx_http_ssl_module.c:255">ngx_http_ssl_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (sscf-&gt;ssl.ctx) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_set_SSL_CTX(ssl_conn, sscf-&gt;ssl.ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * SSL_set_SSL_CTX() only changes certs as of 1.0.0d<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * adjust other things we care about<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_set_verify(ssl_conn, SSL_CTX_get_verify_mode(sscf-&gt;ssl.ctx),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; SSL_CTX_get_verify_callback(sscf-&gt;ssl.ctx));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_set_verify_depth(ssl_conn, SSL_CTX_get_verify_depth(sscf-&gt;ssl.ctx));<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef SSL_CTRL_CLEAR_OPTIONS<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* only in 0.9.8m+ */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; SSL_clear_options(ssl_conn, SSL_get_options(ssl_conn) &amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ~SSL_CTX_get_options(sscf-&gt;ssl.ctx));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SSL_set_options(ssl_conn, SSL_CTX_get_options(sscf-&gt;ssl.ctx));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> SSL_TLSEXT_ERR_OK;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L919">&#x200c;</a></span><span class="linkable">ngx_http_process_request_line</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc, rv;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; r = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, rev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http process request line&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L90" title="src/http/ngx_http_request.h:90">NGX_HTTP_REQUEST_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1372" title="src/http/ngx_http_request.c:1372">ngx_http_read_request_header</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a> || n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_parse.c.html#L104" title="src/http/ngx_http_parse.c:104">ngx_http_parse_request_line</a>(r, r-&gt;header_in);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the request line has been parsed successfully */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_line.len = r-&gt;request_end - r-&gt;request_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_line.data = r-&gt;request_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_length = r-&gt;header_in-&gt;pos - r-&gt;request_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http request line: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;request_line);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;method_name.len = r-&gt;method_end - r-&gt;request_start + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;method_name.data = r-&gt;request_line.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;http_protocol.data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;http_protocol.len = r-&gt;request_end - r-&gt;http_protocol.data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1067" title="src/http/ngx_http_request.c:1067">ngx_http_process_request_uri</a>(r) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;host_start &amp;&amp; r-&gt;host_end) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host.len = r-&gt;host_end - r-&gt;host_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host.data = r-&gt;host_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L1923" title="src/http/ngx_http_request.c:1923">ngx_http_validate_host</a>(&amp;host, r-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid host in request line&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2014" title="src/http/ngx_http_request.c:2014">ngx_http_set_virtual_server</a>(r, &amp;host) == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.server = host;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;http_version &lt; <a href="ngx_http_request.h.html#L24" title="src/http/ngx_http_request.h:24">NGX_HTTP_VERSION_10</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.server.len == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="#L2014" title="src/http/ngx_http_request.c:2014">ngx_http_set_virtual_server</a>(r, &amp;r-&gt;headers_in.server)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1841" title="src/http/ngx_http_request.c:1841">ngx_http_process_request</a>(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_list.h.html#L37" title="src/core/ngx_list.h:37">ngx_list_init</a>(&amp;r-&gt;headers_in.headers, r-&gt;pool, <span class="Constant">20</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;reading client request headers&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;handler = <a href="#L1184" title="src/http/ngx_http_request.c:1184">ngx_http_process_request_headers</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1184" title="src/http/ngx_http_request.c:1184">ngx_http_process_request_headers</a>(rev);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* there was error while a request line parsing */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L68" title="src/http/ngx_http_request.c:68">ngx_http_client_errors</a>[rc - <a href="ngx_http_request.h.html#L54" title="src/http/ngx_http_request.h:54">NGX_HTTP_CLIENT_ERROR</a>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>: a request line parsing is still incomplete */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;header_in-&gt;pos == r-&gt;header_in-&gt;end) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L1429" title="src/http/ngx_http_request.c:1429">ngx_http_alloc_large_header_buffer</a>(r, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_line.len = r-&gt;header_in-&gt;end - r-&gt;request_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_line.data = r-&gt;request_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent too long URI&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L95" title="src/http/ngx_http_request.h:95">NGX_HTTP_REQUEST_URI_TOO_LARGE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1067">&#x200c;</a><span class="linkable">ngx_http_process_request_uri</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;args_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;uri.len = r-&gt;args_start - <span class="Constant">1</span> - r-&gt;uri_start;<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;uri.len = r-&gt;uri_end - r-&gt;uri_start;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;complex_uri || r-&gt;quoted_uri) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;uri.data = <a href="../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(r-&gt;pool, r-&gt;uri.len + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;uri.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_parse.c.html#L1252" title="src/http/ngx_http_parse.c:1252">ngx_http_parse_complex_uri</a>(r, cscf-&gt;merge_slashes) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;uri.len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid request&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;uri.data = r-&gt;uri_start;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;unparsed_uri.len = r-&gt;uri_end - r-&gt;uri_start;<br/></li>
<li>&nbsp; &nbsp; r-&gt;unparsed_uri.data = r-&gt;uri_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;valid_unparsed_uri = r-&gt;space_in_uri ? <span class="Constant">0</span> : <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;uri_ext) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;args_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;exten.len = r-&gt;args_start - <span class="Constant">1</span> - r-&gt;uri_ext;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;exten.len = r-&gt;uri_end - r-&gt;uri_ext;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;exten.data = r-&gt;uri_ext;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;args_start &amp;&amp; r-&gt;uri_end &gt; r-&gt;args_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;args.len = r-&gt;uri_end - r-&gt;args_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;args.data = r-&gt;args_start;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_WIN32)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *p, *last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = r-&gt;uri.data;<br/></li>
<li>&nbsp; &nbsp; last = r-&gt;uri.data + r-&gt;uri.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (p &lt; last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p++ == <span class="Constant">':'</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * this check covers &quot;::$data&quot;, &quot;::$index_allocation&quot; and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * &quot;:$i30:$index_allocation&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p &lt; last &amp;&amp; *p == <span class="Constant">'$'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent unsafe win32 URI&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = r-&gt;uri.data + r-&gt;uri.len - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (p &gt; r-&gt;uri.data) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">' '</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <span class="Constant">'.'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (p != r-&gt;uri.data + r-&gt;uri.len - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;uri.len = p + <span class="Constant">1</span> - r-&gt;uri.data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_core_module.c.html#L1768" title="src/http/ngx_http_core_module.c:1768">ngx_http_set_exten</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http uri: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http args: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http exten: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;exten);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1184">&#x200c;</a></span><span class="linkable">ngx_http_process_request_headers</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc, rv;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *h;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L165" title="src/http/ngx_http_request.h:165">ngx_http_header_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *hh;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp;&nbsp; *cscf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L178" title="src/http/ngx_http_core_module.h:178">ngx_http_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; r = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, rev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http process request header line&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>, <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L90" title="src/http/ngx_http_request.h:90">NGX_HTTP_REQUEST_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;header_in-&gt;pos == r-&gt;header_in-&gt;end) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="#L1429" title="src/http/ngx_http_request.c:1429">ngx_http_alloc_large_header_buffer</a>(r, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rv == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = r-&gt;header_name_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;lingering_close = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent too large request&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.h.html#L108" title="src/http/ngx_http_request.h:108">NGX_HTTP_REQUEST_HEADER_TOO_LARGE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = r-&gt;header_in-&gt;end - p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &gt; <a href="../os/win32/ngx_event_log.c.html#L11" title="src/os/win32/ngx_event_log.c:11">NGX_MAX_ERROR_STR</a> - <span class="Constant">300</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = <a href="../os/win32/ngx_event_log.c.html#L11" title="src/os/win32/ngx_event_log.c:11">NGX_MAX_ERROR_STR</a> - <span class="Constant">300</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent too long header line: </span><span class="Special">\&quot;%*s</span><span class="Constant">...</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len, r-&gt;header_name_start);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.h.html#L108" title="src/http/ngx_http_request.h:108">NGX_HTTP_REQUEST_HEADER_TOO_LARGE</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <a href="#L1372" title="src/http/ngx_http_request.c:1372">ngx_http_read_request_header</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a> || n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the host header could change the server configuration context */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; cscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_parse.c.html#L835" title="src/http/ngx_http_parse.c:835">ngx_http_parse_header_line</a>(r, r-&gt;header_in,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf-&gt;underscores_in_headers);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_length += r-&gt;header_in-&gt;pos - r-&gt;header_name_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;invalid_header &amp;&amp; cscf-&gt;ignore_invalid_headers) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* there was error while a header line parsing */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid header line: </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_end - r-&gt;header_name_start,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_name_start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a header line has been parsed successfully */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h = <a href="../core/ngx_list.c.html#L31" title="src/core/ngx_list.c:31">ngx_list_push</a>(&amp;r-&gt;headers_in.headers);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;hash = r-&gt;header_hash;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;key.len = r-&gt;header_name_end - r-&gt;header_name_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;key.data = r-&gt;header_name_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;key.data[h-&gt;key.len] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;value.len = r-&gt;header_end - r-&gt;header_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;value.data = r-&gt;header_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;value.data[h-&gt;value.len] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h-&gt;lowcase_key = <a href="../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(r-&gt;pool, h-&gt;key.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h-&gt;lowcase_key == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (h-&gt;key.len == r-&gt;lowcase_index) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(h-&gt;lowcase_key, r-&gt;lowcase_header, h-&gt;key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L21" title="src/core/ngx_string.c:21">ngx_strlow</a>(h-&gt;lowcase_key, h-&gt;key.data, h-&gt;key.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hh = <a href="../core/ngx_hash.c.html#L13" title="src/core/ngx_hash.c:13">ngx_hash_find</a>(&amp;cmcf-&gt;headers_in_hash, h-&gt;hash,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; h-&gt;lowcase_key, h-&gt;key.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hh &amp;&amp; hh-&gt;handler(r, h, hh-&gt;offset) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_probe.h.html#L53" title="src/http/ngx_http_probe.h:53">ngx_http_probe_read_req_header_done</a>(r, h);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http header: </span><span class="Special">\&quot;</span><span class="Constant">%V: %V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;h-&gt;key, &amp;h-&gt;value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_http_request.h.html#L52" title="src/http/ngx_http_request.h:52">NGX_HTTP_PARSE_HEADER_DONE</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a whole header has been parsed successfully */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http header done&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_length += r-&gt;header_in-&gt;pos - r-&gt;header_name_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;http_state = NGX_HTTP_PROCESS_REQUEST_STATE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="#L1771" title="src/http/ngx_http_request.c:1771">ngx_http_process_request_header</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1841" title="src/http/ngx_http_request.c:1841">ngx_http_process_request</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a header line parsing is still not complete */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* rc == <a href="ngx_http_request.h.html#L59" title="src/http/ngx_http_request.h:59">NGX_HTTP_PARSE_INVALID_HEADER</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid header line&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a><br/></li>
<li><a id="L1372">&#x200c;</a></span><span class="linkable">ngx_http_read_request_header</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rev;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = r-&gt;header_in-&gt;last - r-&gt;header_in-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = c-&gt;recv(c, r-&gt;header_in-&gt;last,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_in-&gt;end - r-&gt;header_in-&gt;last);<br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!rev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, cscf-&gt;client_header_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client prematurely closed connection&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span> || n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;reading client request headers&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;header_in-&gt;last += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> n;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1429">&#x200c;</a><span class="linkable">ngx_http_alloc_large_header_buffer</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> request_line)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *old, *new;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; &nbsp;&nbsp; *hc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http alloc large header buffer&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (request_line &amp;&amp; r-&gt;state == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the client fills up the buffer with &quot;\r\n&quot; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_in-&gt;pos = r-&gt;header_in-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_in-&gt;last = r-&gt;header_in-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; old = request_line ? r-&gt;request_start : r-&gt;header_name_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;state != <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (<span class="Type">size_t</span>) (r-&gt;header_in-&gt;pos - old)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &gt;= cscf-&gt;large_client_header_buffers.size)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hc = r-&gt;http_connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;nfree) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = hc-&gt;free[--hc-&gt;nfree];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http large header free: </span><span class="Special">%p</span><span class="Constant"> </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; b-&gt;pos, b-&gt;end - b-&gt;last);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (hc-&gt;nbusy &lt; cscf-&gt;large_client_header_buffers.num) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;busy == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;busy = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(r-&gt;connection-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf-&gt;large_client_header_buffers.num * <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;busy == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b = <a href="../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(r-&gt;connection-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf-&gt;large_client_header_buffers.size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http large header alloc: </span><span class="Special">%p</span><span class="Constant"> </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; b-&gt;pos, b-&gt;end - b-&gt;last);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hc-&gt;busy[hc-&gt;nbusy++] = b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;state == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * r-&gt;state == 0 means that a header line was parsed successfully<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * and we do not need to copy incomplete header line and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * to relocate the parser header pointers<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_in = b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http large header copy: </span><span class="Special">%u</span><span class="Constant">z&quot;</span>, r-&gt;header_in-&gt;pos - old);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; new = b-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(new, old, r-&gt;header_in-&gt;pos - old);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;pos = new + (r-&gt;header_in-&gt;pos - old);<br/></li>
<li>&nbsp; &nbsp; b-&gt;last = new + (r-&gt;header_in-&gt;pos - old);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (request_line) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_start = new;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_end = new + (r-&gt;request_end - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;method_end = new + (r-&gt;method_end - old);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;uri_start = new + (r-&gt;uri_start - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;uri_end = new + (r-&gt;uri_end - old);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;schema_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;schema_start = new + (r-&gt;schema_start - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;schema_end = new + (r-&gt;schema_end - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;host_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;host_start = new + (r-&gt;host_start - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;host_end) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;host_end = new + (r-&gt;host_end - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;port_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;port_start = new + (r-&gt;port_start - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;port_end = new + (r-&gt;port_end - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;uri_ext) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;uri_ext = new + (r-&gt;uri_ext - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;args_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;args_start = new + (r-&gt;args_start - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;http_protocol.data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;http_protocol.data = new + (r-&gt;http_protocol.data - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_name_start = new;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_name_end = new + (r-&gt;header_name_end - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_start = new + (r-&gt;header_start - old);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;header_end = new + (r-&gt;header_end - old);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;header_in = b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1573">&#x200c;</a><span class="linkable">ngx_http_process_header_line</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; **ph;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ph = (<a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> **) ((<span class="Type">char</span> *) &amp;r-&gt;headers_in + offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*ph == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ph = h;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1589">&#x200c;</a><span class="linkable">ngx_http_process_unique_header_line</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; **ph;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ph = (<a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> **) ((<span class="Type">char</span> *) &amp;r-&gt;headers_in + offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*ph == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ph = h;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent duplicate header line: </span><span class="Special">\&quot;</span><span class="Constant">%V: %V</span><span class="Special">\&quot;</span><span class="Constant">, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;previous value: </span><span class="Special">\&quot;</span><span class="Constant">%V: %V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;h-&gt;key, &amp;h-&gt;value, &amp;(*ph)-&gt;key, &amp;(*ph)-&gt;value);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1613">&#x200c;</a><span class="linkable">ngx_http_process_host</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; host;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.host == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.host = h;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; host = h-&gt;value;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L1923" title="src/http/ngx_http_request.c:1923">ngx_http_validate_host</a>(&amp;host, r-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid host header&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.server.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2014" title="src/http/ngx_http_request.c:2014">ngx_http_set_virtual_server</a>(r, &amp;host) == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_in.server = host;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1654">&#x200c;</a><span class="linkable">ngx_http_process_connection</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L689" title="src/core/ngx_string.c:689">ngx_strcasestrn</a>(h-&gt;value.data, <span class="Constant">&quot;close&quot;</span>, <span class="Constant">5</span> - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.connection_type = <a href="ngx_http_request.h.html#L45" title="src/http/ngx_http_request.h:45">NGX_HTTP_CONNECTION_CLOSE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L689" title="src/core/ngx_string.c:689">ngx_strcasestrn</a>(h-&gt;value.data, <span class="Constant">&quot;keep-alive&quot;</span>, <span class="Constant">10</span> - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.connection_type = <a href="ngx_http_request.h.html#L46" title="src/http/ngx_http_request.h:46">NGX_HTTP_CONNECTION_KEEP_ALIVE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1669">&#x200c;</a><span class="linkable">ngx_http_process_user_agent</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *user_agent, *msie;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.user_agent) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;headers_in.user_agent = h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* check some widespread browsers while the header is in CPU cache */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; user_agent = h-&gt;value.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; msie = <a href="../core/ngx_string.c.html#L666" title="src/core/ngx_string.c:666">ngx_strstrn</a>(user_agent, <span class="Constant">&quot;MSIE &quot;</span>, <span class="Constant">5</span> - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (msie &amp;&amp; msie + <span class="Constant">7</span> &lt; user_agent + h-&gt;value.len) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.msie = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (msie[<span class="Constant">6</span>] == <span class="Constant">'.'</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (msie[<span class="Constant">5</span>]) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'4'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'5'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.msie6 = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'6'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L666" title="src/core/ngx_string.c:666">ngx_strstrn</a>(msie + <span class="Constant">8</span>, <span class="Constant">&quot;SV1&quot;</span>, <span class="Constant">3</span> - <span class="Constant">1</span>) == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.msie6 = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if 0<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; /* MSIE ignores the SSL &quot;close notify&quot; alert */<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; if (c-&gt;ssl) {<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;no_send_shutdown = 1;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L666" title="src/core/ngx_string.c:666">ngx_strstrn</a>(user_agent, <span class="Constant">&quot;Opera&quot;</span>, <span class="Constant">5</span> - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.opera = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.msie = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.msie6 = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;headers_in.msie &amp;&amp; !r-&gt;headers_in.opera) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L666" title="src/core/ngx_string.c:666">ngx_strstrn</a>(user_agent, <span class="Constant">&quot;Gecko/&quot;</span>, <span class="Constant">6</span> - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.gecko = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L666" title="src/core/ngx_string.c:666">ngx_strstrn</a>(user_agent, <span class="Constant">&quot;Chrome/&quot;</span>, <span class="Constant">7</span> - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.chrome = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L666" title="src/core/ngx_string.c:666">ngx_strstrn</a>(user_agent, <span class="Constant">&quot;Safari/&quot;</span>, <span class="Constant">7</span> - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; <a href="../core/ngx_string.c.html#L666" title="src/core/ngx_string.c:666">ngx_strstrn</a>(user_agent, <span class="Constant">&quot;Mac OS X&quot;</span>, <span class="Constant">8</span> - <span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.safari = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L666" title="src/core/ngx_string.c:666">ngx_strstrn</a>(user_agent, <span class="Constant">&quot;Konqueror&quot;</span>, <span class="Constant">9</span> - <span class="Constant">1</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.konqueror = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1742">&#x200c;</a><span class="linkable">ngx_http_process_multi_header_lines</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *h,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> offset)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *headers;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; **ph;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; headers = (<a href="../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a> *) ((<span class="Type">char</span> *) &amp;r-&gt;headers_in + offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (headers-&gt;elts == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="src/core/ngx_array.h:32">ngx_array_init</a>(headers, r-&gt;pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a> *))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ph = <a href="../core/ngx_array.c.html#L48" title="src/core/ngx_array.c:48">ngx_array_push</a>(headers);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ph == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ph = h;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1771">&#x200c;</a><span class="linkable">ngx_http_process_request_header</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.server.len == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="#L2014" title="src/http/ngx_http_request.c:2014">ngx_http_set_virtual_server</a>(r, &amp;r-&gt;headers_in.server)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.host == <span class="Constant">NULL</span> &amp;&amp; r-&gt;http_version &gt; <a href="ngx_http_request.h.html#L24" title="src/http/ngx_http_request.h:24">NGX_HTTP_VERSION_10</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;client sent HTTP/1.1 request without </span><span class="Special">\&quot;</span><span class="Constant">Host</span><span class="Special">\&quot;</span><span class="Constant"> header&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1014" title="src/core/ngx_string.c:1014">ngx_atoof</a>(r-&gt;headers_in.content_length-&gt;value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length-&gt;value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.content_length_n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent invalid </span><span class="Special">\&quot;</span><span class="Constant">Content-Length</span><span class="Special">\&quot;</span><span class="Constant"> header&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L85" title="src/http/ngx_http_request.h:85">NGX_HTTP_BAD_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;method == <a href="ngx_http_request.h.html#L43" title="src/http/ngx_http_request.h:43">NGX_HTTP_TRACE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent TRACE method&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L89" title="src/http/ngx_http_request.h:89">NGX_HTTP_NOT_ALLOWED</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.transfer_encoding) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.transfer_encoding-&gt;value.len == <span class="Constant">7<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(r-&gt;headers_in.transfer_encoding-&gt;value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (u_char *) <span class="Constant">&quot;chunked&quot;</span>, <span class="Constant">7</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.content_length_n = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.chunked = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (r-&gt;headers_in.transfer_encoding-&gt;value.len != <span class="Constant">8<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <a href="../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(r-&gt;headers_in.transfer_encoding-&gt;value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (u_char *) <span class="Constant">&quot;identity&quot;</span>, <span class="Constant">8</span>) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent unknown </span><span class="Special">\&quot;</span><span class="Constant">Transfer-Encoding</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;r-&gt;headers_in.transfer_encoding-&gt;value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L131" title="src/http/ngx_http_request.h:131">NGX_HTTP_NOT_IMPLEMENTED</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.connection_type == <a href="ngx_http_request.h.html#L46" title="src/http/ngx_http_request.h:46">NGX_HTTP_CONNECTION_KEEP_ALIVE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.keep_alive) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.keep_alive_n =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1042" title="src/core/ngx_string.c:1042">ngx_atotm</a>(r-&gt;headers_in.keep_alive-&gt;value.data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_in.keep_alive-&gt;value.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L1841">&#x200c;</a></span><span class="linkable">ngx_http_process_request</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;http_connection-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; X509&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cert;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="modules/ngx_http_ssl_module.h.html#L60" title="src/http/modules/ngx_http_ssl_module.h:60">ngx_http_ssl_srv_conf_t</a>&nbsp; *sscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent plain HTTP request to HTTPS port&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L117" title="src/http/ngx_http_request.h:117">NGX_HTTP_TO_HTTPS</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="modules/ngx_http_ssl_module.c.html#L255" title="src/http/modules/ngx_http_ssl_module.c:255">ngx_http_ssl_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sscf-&gt;verify) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = SSL_get_verify_result(c-&gt;ssl-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc != X509_V_OK<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (sscf-&gt;verify != <span class="Constant">3</span> || !<a href="../event/ngx_event_openssl.h.html#L180" title="src/event/ngx_event_openssl.h:180">ngx_ssl_verify_error_optional</a>(rc)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client SSL certificate verify error: (%l:</span><span class="Special">%s</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc, X509_verify_cert_error_string(rc));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_openssl.c.html#L2674" title="src/event/ngx_event_openssl.c:2674">ngx_ssl_remove_cached_session</a>(sscf-&gt;ssl.ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (SSL_get0_session(c-&gt;ssl-&gt;connection)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L110" title="src/http/ngx_http_request.h:110">NGX_HTTPS_CERT_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sscf-&gt;verify == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cert = SSL_get_peer_certificate(c-&gt;ssl-&gt;connection);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cert == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client sent no required SSL certificate&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_openssl.c.html#L2674" title="src/event/ngx_event_openssl.c:2674">ngx_ssl_remove_cached_session</a>(sscf-&gt;ssl.ctx,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (SSL_get0_session(c-&gt;ssl-&gt;connection)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L111" title="src/http/ngx_http_request.h:111">NGX_HTTPS_NO_CERT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; X509_free(cert);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(c-&gt;read);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STAT_STUB)<br/></li>
<li></span>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L71" title="src/event/ngx_event.c:71">ngx_stat_reading</a>, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; r-&gt;stat_reading = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L73" title="src/event/ngx_event.c:73">ngx_stat_writing</a>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; r-&gt;stat_writing = <span class="Constant">1</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L2183" title="src/http/ngx_http_request.c:2183">ngx_http_request_handler</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L2183" title="src/http/ngx_http_request.c:2183">ngx_http_request_handler</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="#L2710" title="src/http/ngx_http_request.c:2710">ngx_http_block_reading</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.c.html#L801" title="src/http/ngx_http_core_module.c:801">ngx_http_handler</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2208" title="src/http/ngx_http_request.c:2208">ngx_http_run_posted_requests</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1923">&#x200c;</a><span class="linkable">ngx_http_validate_host</span>(<a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *host, <a href="../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a> *pool, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> alloc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; *h, ch;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp;&nbsp; i, dot_pos, host_len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">enum</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_usual = <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_literal,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sw_rest<br/></li>
<li>&nbsp; &nbsp; } state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dot_pos = host-&gt;len;<br/></li>
<li>&nbsp; &nbsp; host_len = host-&gt;len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h = host-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; state = sw_usual;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; host-&gt;len; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ch = h[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (ch) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'.'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dot_pos == i - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dot_pos = i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">':'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state == sw_usual) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host_len = i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'['</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_literal;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">']'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (state == sw_literal) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host_len = i + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state = sw_rest;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Special">'\0'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_files.h.html#L179" title="src/os/win32/ngx_files.h:179">ngx_path_separator</a>(ch)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ch &gt;= <span class="Constant">'A'</span> &amp;&amp; ch &lt;= <span class="Constant">'Z'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alloc = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dot_pos == host_len - <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; host_len--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (host_len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (alloc) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; host-&gt;data = <a href="../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(pool, host_len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (host-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L21" title="src/core/ngx_string.c:21">ngx_strlow</a>(host-&gt;data, h, host_len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; host-&gt;len = host_len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2014">&#x200c;</a><span class="linkable">ngx_http_set_virtual_server</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *host)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; &nbsp;&nbsp; *hc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_SUPPRESS_WARN)<br/></li>
<li></span>&nbsp; &nbsp; cscf = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; hc = r-&gt;http_connection;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL &amp;&amp; defined SSL_CTRL_SET_TLSEXT_HOSTNAME)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;ssl_servername) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;ssl_servername-&gt;len == host-&gt;len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(hc-&gt;ssl_servername-&gt;data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; host-&gt;data, host-&gt;len) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;ssl_servername_regex<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="ngx_http_variables.c.html#L2409" title="src/http/ngx_http_variables.c:2409">ngx_http_regex_exec</a>(r, hc-&gt;ssl_servername_regex,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;ssl_servername) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L2097" title="src/http/ngx_http_request.c:2097">ngx_http_find_virtual_server</a>(r-&gt;connection,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;addr_conf-&gt;virtual_names,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host, r, &amp;cscf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL &amp;&amp; defined SSL_CTRL_SET_TLSEXT_HOSTNAME)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;ssl_servername) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="modules/ngx_http_ssl_module.h.html#L60" title="src/http/modules/ngx_http_ssl_module.h:60">ngx_http_ssl_srv_conf_t</a>&nbsp; *sscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf = hc-&gt;addr_conf-&gt;default_server;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(cscf-&gt;ctx, <a href="modules/ngx_http_ssl_module.c.html#L255" title="src/http/modules/ngx_http_ssl_module.c:255">ngx_http_ssl_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (sscf-&gt;verify) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client attempted to request the server name &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;different from the one that was negotiated&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L98" title="src/http/ngx_http_request.h:98">NGX_HTTP_MISDIRECTED_REQUEST</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;srv_conf = cscf-&gt;ctx-&gt;srv_conf;<br/></li>
<li>&nbsp; &nbsp; r-&gt;loc_conf = cscf-&gt;ctx-&gt;loc_conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.h.html#L199" title="src/core/ngx_connection.h:199">ngx_set_connection_log</a>(r-&gt;connection, clcf-&gt;error_log);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2097">&#x200c;</a><span class="linkable">ngx_http_find_virtual_server</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L228" title="src/http/ngx_http_core_module.h:228">ngx_http_virtual_names_t</a> *virtual_names, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *host,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a> **cscfp)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (virtual_names == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="../core/ngx_hash.c.html#L211" title="src/core/ngx_hash.c:211">ngx_hash_find_combined</a>(&amp;virtual_names-&gt;names,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_hash.c.html#L611" title="src/core/ngx_hash.c:611">ngx_hash_key</a>(host-&gt;data, host-&gt;len),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host-&gt;data, host-&gt;len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cscf) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *cscfp = cscf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_PCRE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (host-&gt;len &amp;&amp; virtual_names-&gt;nregex) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L220" title="src/http/ngx_http_core_module.h:220">ngx_http_server_name_t</a>&nbsp; *sn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sn = virtual_names-&gt;regex;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL &amp;&amp; defined SSL_CTRL_SET_TLSEXT_HOSTNAME)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; *hc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; virtual_names-&gt;nregex; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../core/ngx_regex.h.html#L52" title="src/core/ngx_regex.h:52">ngx_regex_exec</a>(sn[i].regex-&gt;regex, host, <span class="Constant">NULL</span>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_regex.h.html#L18" title="src/core/ngx_regex.h:18">NGX_REGEX_NO_MATCHED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n &gt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc = c-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;ssl_servername_regex = sn[i].regex;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cscfp = sn[i].server;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_regex.h.html#L55" title="src/core/ngx_regex.h:55">ngx_regex_exec_n</a> <span class="Constant">&quot; failed: </span><span class="Special">%i</span><span class="Constant"> &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;on </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> using </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n, host, &amp;sn[i].regex-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif</span> <span class="Comment">/* NGX_HTTP_SSL &amp;&amp; defined SSL_CTRL_SET_TLSEXT_HOSTNAME */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; virtual_names-&gt;nregex; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = <a href="ngx_http_variables.c.html#L2409" title="src/http/ngx_http_variables.c:2409">ngx_http_regex_exec</a>(r, sn[i].regex, host);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *cscfp = sn[i].server;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif</span> <span class="Comment">/* NGX_PCRE */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2183">&#x200c;</a></span><span class="linkable">ngx_http_request_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; r = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L597" title="src/http/ngx_http_request.h:597">ngx_http_set_log_request</a>(c-&gt;log, r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http run request: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ev-&gt;write) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;read_event_handler(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2208" title="src/http/ngx_http_request.c:2208">ngx_http_run_posted_requests</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L2208">&#x200c;</a></span><span class="linkable">ngx_http_run_posted_requests</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L354" title="src/http/ngx_http_request.h:354">ngx_http_posted_request_t</a>&nbsp; *pr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;destroyed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r = c-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pr = r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;posted_requests;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;posted_requests = pr-&gt;next;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r = pr-&gt;request;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request.h.html#L597" title="src/http/ngx_http_request.h:597">ngx_http_set_log_request</a>(c-&gt;log, r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http posted request: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2241">&#x200c;</a><span class="linkable">ngx_http_post_request</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http_request.h.html#L354" title="src/http/ngx_http_request.h:354">ngx_http_posted_request_t</a> *pr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L354" title="src/http/ngx_http_request.h:354">ngx_http_posted_request_t</a>&nbsp; **p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pr = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http_request.h.html#L354" title="src/http/ngx_http_request.h:354">ngx_http_posted_request_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pr == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pr-&gt;request = r;<br/></li>
<li>&nbsp; &nbsp; pr-&gt;next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (p = &amp;r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;posted_requests; *p; p = &amp;(*p)-&gt;next) { <span class="Comment">/* void */</span> }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = pr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L2264">&#x200c;</a></span><span class="linkable">ngx_http_finalize_request</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> rc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *pr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L151" title="src/core/ngx_log.h:151">ngx_log_debug5</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http finalize request: </span><span class="Special">%i</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant"> a:</span><span class="Special">%d</span><span class="Constant">, c:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc, &amp;r-&gt;uri, &amp;r-&gt;args, r == c-&gt;data, r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;count);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L40" title="src/core/ngx_core.h:40">NGX_DONE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2524" title="src/http/ngx_http_request.c:2524">ngx_http_finalize_connection</a>(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a> &amp;&amp; r-&gt;filter_finalize) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;content_handler = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler = <a href="ngx_http_core_module.c.html#L844" title="src/http/ngx_http_core_module.c:844">ngx_http_core_run_phases</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_core_module.c.html#L844" title="src/http/ngx_http_core_module.c:844">ngx_http_core_run_phases</a>(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> &amp;&amp; r-&gt;post_subrequest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_probe.h.html#L35" title="src/http/ngx_http_probe.h:35">ngx_http_probe_subrequest_post_start</a>(r, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = r-&gt;post_subrequest-&gt;handler(r, r-&gt;post_subrequest-&gt;data, rc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_probe.h.html#L38" title="src/http/ngx_http_probe.h:38">ngx_http_probe_subrequest_post_done</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || rc == <a href="ngx_http_request.h.html#L90" title="src/http/ngx_http_request.h:90">NGX_HTTP_REQUEST_TIME_OUT</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || rc == <a href="ngx_http_request.h.html#L127" title="src/http/ngx_http_request.h:127">NGX_HTTP_CLIENT_CLOSED_REQUEST</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || c-&gt;error)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3363" title="src/http/ngx_http_request.c:3363">ngx_http_post_action</a>(r) == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;blocked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L2700" title="src/http/ngx_http_request.c:2700">ngx_http_request_finalizer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2464" title="src/http/ngx_http_request.c:2464">ngx_http_terminate_request</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc &gt;= <a href="ngx_http_request.h.html#L78" title="src/http/ngx_http_request.h:78">NGX_HTTP_SPECIAL_RESPONSE</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || rc == <a href="ngx_http_request.h.html#L73" title="src/http/ngx_http_request.h:73">NGX_HTTP_CREATED</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || rc == <a href="ngx_http_request.h.html#L75" title="src/http/ngx_http_request.h:75">NGX_HTTP_NO_CONTENT</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="ngx_http_request.h.html#L104" title="src/http/ngx_http_request.h:104">NGX_HTTP_CLOSE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2464" title="src/http/ngx_http_request.c:2464">ngx_http_terminate_request</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r == r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(c-&gt;read);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(c-&gt;write);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;read-&gt;handler = <a href="#L2183" title="src/http/ngx_http_request.c:2183">ngx_http_request_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;handler = <a href="#L2183" title="src/http/ngx_http_request.c:2183">ngx_http_request_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_special_response.c.html#L376" title="src/http/ngx_http_special_response.c:376">ngx_http_special_response_handler</a>(r, rc));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;buffered || r-&gt;postponed) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_probe.h.html#L20" title="src/http/ngx_http_probe.h:20">ngx_http_probe_subrequest_finalize_writing</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2582" title="src/http/ngx_http_request.c:2582">ngx_http_set_write_handler</a>(r) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2464" title="src/http/ngx_http_request.c:2464">ngx_http_terminate_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pr = r-&gt;parent;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r == c-&gt;data) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;count--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;logged) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;log_subrequest) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3521" title="src/http/ngx_http_request.c:3521">ngx_http_log_request</a>(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;logged = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;subrequest: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant"> logged again&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;done = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pr-&gt;postponed &amp;&amp; pr-&gt;postponed-&gt;request == r) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pr-&gt;postponed = pr-&gt;postponed-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_probe.h.html#L32" title="src/http/ngx_http_probe.h:32">ngx_http_probe_subrequest_done</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;data = pr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_probe.h.html#L23" title="src/http/ngx_http_probe.h:23">ngx_http_probe_subrequest_finalize_nonactive</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http finalize non-active request: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L2700" title="src/http/ngx_http_request.c:2700">ngx_http_request_finalizer</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;waited) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;done = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_probe.h.html#L29" title="src/http/ngx_http_probe.h:29">ngx_http_probe_subrequest_wake_parent</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2241" title="src/http/ngx_http_request.c:2241">ngx_http_post_request</a>(pr, <span class="Constant">NULL</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2464" title="src/http/ngx_http_request.c:2464">ngx_http_terminate_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http wake parent request: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;pr-&gt;uri, &amp;pr-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;buffered || c-&gt;buffered || r-&gt;postponed || r-&gt;blocked) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2582" title="src/http/ngx_http_request.c:2582">ngx_http_set_write_handler</a>(r) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2464" title="src/http/ngx_http_request.c:2464">ngx_http_terminate_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != c-&gt;data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;http finalize non-active request: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;done = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L3320" title="src/http/ngx_http_request.c:3320">ngx_http_request_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!r-&gt;post_action) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_complete = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L3363" title="src/http/ngx_http_request.c:3363">ngx_http_post_action</a>(r) == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(c-&gt;read);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;write-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;write-&gt;delayed = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(c-&gt;write);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;read-&gt;eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2524" title="src/http/ngx_http_request.c:2524">ngx_http_finalize_connection</a>(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2464">&#x200c;</a></span><span class="linkable">ngx_http_terminate_request</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> rc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L327" title="src/http/ngx_http_request.h:327">ngx_http_cleanup_t</a>&nbsp; &nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; *mr;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L587" title="src/http/ngx_http_request.h:587">ngx_http_ephemeral_t</a>&nbsp; *e;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mr = r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http terminate request count:</span><span class="Special">%d</span><span class="Constant">&quot;</span>, mr-&gt;count);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc &gt; <span class="Constant">0</span> &amp;&amp; (mr-&gt;headers_out.status == <span class="Constant">0</span> || mr-&gt;connection-&gt;sent == <span class="Constant">0</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mr-&gt;headers_out.status = rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = mr-&gt;cleanup;<br/></li>
<li>&nbsp; &nbsp; mr-&gt;cleanup = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (cln) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cln-&gt;handler) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cln-&gt;handler(cln-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cln = cln-&gt;next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http terminate cleanup count:</span><span class="Special">%d</span><span class="Constant"> blk:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mr-&gt;count, mr-&gt;blocked);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mr-&gt;write_event_handler) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mr-&gt;blocked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; e = <a href="ngx_http_request.h.html#L590" title="src/http/ngx_http_request.h:590">ngx_http_ephemeral</a>(mr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mr-&gt;posted_requests = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mr-&gt;write_event_handler = <a href="#L2512" title="src/http/ngx_http_request.c:2512">ngx_http_terminate_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L2241" title="src/http/ngx_http_request.c:2241">ngx_http_post_request</a>(mr, &amp;e-&gt;terminal_posted_request);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(mr, rc);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2512">&#x200c;</a></span><span class="linkable">ngx_http_terminate_handler</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http terminate handler count:</span><span class="Special">%d</span><span class="Constant">&quot;</span>, r-&gt;count);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;count = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2524">&#x200c;</a></span><span class="linkable">ngx_http_finalize_connection</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_V2)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;count != <span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;discard_body) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;read_event_handler = <a href="ngx_http_request_body.c.html#L588" title="src/http/ngx_http_request_body.c:588">ngx_http_discarded_request_body_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(r-&gt;connection-&gt;read, clcf-&gt;lingering_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;lingering_time == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r-&gt;lingering_time = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>()<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) (clcf-&gt;lingering_time / <span class="Constant">1000</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;reading_body) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;keepalive = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;lingering_close = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../os/win32/ngx_process_cycle.c.html#L38" title="src/os/win32/ngx_process_cycle.c:38">ngx_terminate</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; !<a href="../os/win32/ngx_process_cycle.c.html#L42" title="src/os/win32/ngx_process_cycle.c:42">ngx_exiting</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; r-&gt;keepalive<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;&amp; clcf-&gt;keepalive_timeout &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2847" title="src/http/ngx_http_request.c:2847">ngx_http_set_keepalive</a>(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;lingering_close == <a href="ngx_http_core_module.h.html#L43" title="src/http/ngx_http_core_module.h:43">NGX_HTTP_LINGERING_ALWAYS</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || (clcf-&gt;lingering_close == <a href="ngx_http_core_module.h.html#L42" title="src/http/ngx_http_core_module.h:42">NGX_HTTP_LINGERING_ON</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (r-&gt;lingering_close<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;header_in-&gt;pos &lt; r-&gt;header_in-&gt;last<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || r-&gt;connection-&gt;read-&gt;ready)))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3210" title="src/http/ngx_http_request.c:3210">ngx_http_set_lingering_close</a>(r);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2582">&#x200c;</a><span class="linkable">ngx_http_set_write_handler</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;http_state = NGX_HTTP_WRITING_REQUEST_STATE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = r-&gt;discard_body ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_request_body.c.html#L588" title="src/http/ngx_http_request_body.c:588">ngx_http_discarded_request_body_handler</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2728" title="src/http/ngx_http_request.c:2728">ngx_http_test_reading</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L2615" title="src/http/ngx_http_request.c:2615">ngx_http_writer</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev = r-&gt;connection-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;ready &amp;&amp; wev-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(wev, clcf-&gt;send_timeout);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L332" title="src/event/ngx_event.c:332">ngx_handle_write_event</a>(wev, clcf-&gt;send_lowat) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2615">&#x200c;</a></span><span class="linkable">ngx_http_writer</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; wev = c-&gt;write;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, wev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http writer handler: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <a href="../os/win32/ngx_errno.h.html#L49" title="src/os/win32/ngx_errno.h:49">NGX_ETIMEDOUT</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client timed out&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;timedout = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L90" title="src/http/ngx_http_request.h:90">NGX_HTTP_REQUEST_TIME_OUT</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;timedout = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wev-&gt;delayed = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(wev, clcf-&gt;send_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L332" title="src/event/ngx_event.c:332">ngx_handle_write_event</a>(wev, clcf-&gt;send_lowat) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;delayed || r-&gt;aio) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, wev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http writer delayed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L332" title="src/event/ngx_event.c:332">ngx_handle_write_event</a>(wev, clcf-&gt;send_lowat) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="ngx_http_core_module.c.html#L1969" title="src/http/ngx_http_core_module.c:1969">ngx_http_output_filter</a>(r, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http writer output filter: </span><span class="Special">%d</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;buffered || r-&gt;postponed || (r == r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> &amp;&amp; c-&gt;buffered)) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!wev-&gt;delayed) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(wev, clcf-&gt;send_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L332" title="src/event/ngx_event.c:332">ngx_handle_write_event</a>(wev, clcf-&gt;send_lowat) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, wev-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http writer done: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L3320" title="src/http/ngx_http_request.c:3320">ngx_http_request_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, rc);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2700">&#x200c;</a></span><span class="linkable">ngx_http_request_finalizer</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http finalizer done: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L2710">&#x200c;</a></span><span class="linkable">ngx_http_block_reading</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http reading blocked&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* aio does not call this handler */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L207" title="src/event/ngx_event.h:207">NGX_USE_LEVEL_EVENT</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; r-&gt;connection-&gt;read-&gt;active)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L407" title="src/event/ngx_event.h:407">ngx_del_event</a>(r-&gt;connection-&gt;read, <a href="../event/ngx_event.h.html#L318" title="src/event/ngx_event.h:318">NGX_READ_EVENT</a>, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L2728">&#x200c;</a></span><span class="linkable">ngx_http_test_reading</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buf[<span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *rev;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http test reading&quot;</span>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_V2)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> closed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_KQUEUE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L225" title="src/event/ngx_event.h:225">NGX_USE_KQUEUE_EVENT</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!rev-&gt;pending_eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = rev-&gt;kq_errno;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> closed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_EPOLLRDHUP)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L241" title="src/event/ngx_event.h:241">NGX_USE_EPOLL_EVENT</a>) &amp;&amp; <a href="../event/modules/ngx_epoll_module.c.html#L153" title="src/event/modules/ngx_epoll_module.c:153">ngx_use_epoll_rdhup</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_socket.h.html#L20" title="src/os/win32/ngx_socket.h:20">socklen_t</a>&nbsp; len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!rev-&gt;pending_eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<a href="../os/win32/ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * BSDs and Linux return 0 and set a pending error in err<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Solaris returns -1 and sets errno<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (getsockopt(c-&gt;fd, SOL_SOCKET, SO_ERROR, (<span class="Type">void</span> *) &amp;err, &amp;len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> closed;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; n = recv(c-&gt;fd, buf, <span class="Constant">1</span>, MSG_PEEK);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> closed;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (n == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err != <a href="../os/win32/ngx_errno.h.html#L41" title="src/os/win32/ngx_errno.h:41">NGX_EAGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;eof = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;error = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> closed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* aio does not call this handler */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L207" title="src/event/ngx_event.h:207">NGX_USE_LEVEL_EVENT</a>) &amp;&amp; rev-&gt;active) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L407" title="src/event/ngx_event.h:407">ngx_del_event</a>(rev, <a href="../event/ngx_event.h.html#L318" title="src/event/ngx_event.h:318">NGX_READ_EVENT</a>, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">closed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (err) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;error = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client prematurely closed connection&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L2264" title="src/http/ngx_http_request.c:2264">ngx_http_finalize_request</a>(r, <a href="ngx_http_request.h.html#L127" title="src/http/ngx_http_request.h:127">NGX_HTTP_CLIENT_CLOSED_REQUEST</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2847">&#x200c;</a></span><span class="linkable">ngx_http_set_keepalive</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b, *f;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rev, *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L322" title="src/http/ngx_http_request.h:322">ngx_http_connection_t</a>&nbsp; &nbsp;&nbsp; *hc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;set http keepalive handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;discard_body) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;write_event_handler = <a href="#L3320" title="src/http/ngx_http_request.c:3320">ngx_http_request_empty_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;lingering_time = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) (clcf-&gt;lingering_time / <span class="Constant">1000</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, clcf-&gt;lingering_timeout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;closing request&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; hc = r-&gt;http_connection;<br/></li>
<li>&nbsp; &nbsp; b = r-&gt;header_in;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos &lt; b-&gt;last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the pipelined request */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b != c-&gt;buffer) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If the large header buffers were allocated while the previous<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * request processing then we do not use c-&gt;buffer for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the pipelined request (see <a href="#L509" title="src/http/ngx_http_request.c:509">ngx_http_create_request</a>()).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Now we would move the large header buffers to the free list.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;free == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;free = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(c-&gt;pool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cscf-&gt;large_client_header_buffers.num * <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a> *));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;free == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; hc-&gt;nbusy - <span class="Constant">1</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f = hc-&gt;busy[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;free[hc-&gt;nfree++] = f;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f-&gt;pos = f-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f-&gt;last = f-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;busy[<span class="Constant">0</span>] = b;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;nbusy = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* guard against recursive call from <a href="#L2524" title="src/http/ngx_http_request.c:2524">ngx_http_finalize_connection</a>() */<br/></li>
<li></span>&nbsp; &nbsp; r-&gt;keepalive = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3433" title="src/http/ngx_http_request.c:3433">ngx_http_free_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;data = hc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev = c-&gt;write;<br/></li>
<li>&nbsp; &nbsp; wev-&gt;handler = <a href="#L3311" title="src/http/ngx_http_request.c:3311">ngx_http_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos &lt; b-&gt;last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;pipelined request&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;reading client pipelined request line&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r = <a href="#L509" title="src/http/ngx_http_request.c:509">ngx_http_create_request</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;pipeline = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;data = r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;sent = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;destroyed = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(rev);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rev-&gt;handler = <a href="#L919" title="src/http/ngx_http_request.c:919">ngx_http_process_request_line</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(rev, &amp;<a href="../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * To keep a memory footprint as small as possible for an idle keepalive<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * connection we try to free c-&gt;buffer's memory if it was allocated outside<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the c-&gt;pool.&nbsp; The large header buffers are always allocated outside the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * c-&gt;pool and are freed too.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; b = c-&gt;buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_palloc.c.html#L281" title="src/core/ngx_palloc.c:281">ngx_pfree</a>(c-&gt;pool, b-&gt;start) == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the special note for <a href="#L3079" title="src/http/ngx_http_request.c:3079">ngx_http_keepalive_handler</a>() that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * c-&gt;buffer's memory was freed<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;start;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;hc free: </span><span class="Special">%p</span><span class="Constant"> </span><span class="Special">%i</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hc-&gt;free, hc-&gt;nfree);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;free) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; hc-&gt;nfree; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L281" title="src/core/ngx_palloc.c:281">ngx_pfree</a>(c-&gt;pool, hc-&gt;free[i]-&gt;start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;free[i] = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;nfree = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;hc busy: </span><span class="Special">%p</span><span class="Constant"> </span><span class="Special">%i</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; hc-&gt;busy, hc-&gt;nbusy);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (hc-&gt;busy) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; hc-&gt;nbusy; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L281" title="src/core/ngx_palloc.c:281">ngx_pfree</a>(c-&gt;pool, hc-&gt;busy[i]-&gt;start);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;busy[i] = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hc-&gt;nbusy = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_openssl.c.html#L1872" title="src/event/ngx_event_openssl.c:1872">ngx_ssl_free_buffer</a>(c);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler = <a href="#L3079" title="src/http/ngx_http_request.c:3079">ngx_http_keepalive_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;active &amp;&amp; (<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L207" title="src/event/ngx_event.h:207">NGX_USE_LEVEL_EVENT</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L407" title="src/event/ngx_event.h:407">ngx_del_event</a>(wev, <a href="../event/ngx_event.h.html#L319" title="src/event/ngx_event.h:319">NGX_WRITE_EVENT</a>, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;keepalive&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;tcp_nopush == NGX_TCP_NOPUSH_SET) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_socket.c.html#L31" title="src/os/win32/ngx_socket.c:31">ngx_tcp_push</a>(c-&gt;fd) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>, <a href="../os/win32/ngx_socket.h.html#L204" title="src/os/win32/ngx_socket.h:204">ngx_tcp_push_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;tcp_nopush = NGX_TCP_NOPUSH_UNSET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay = <a href="../os/win32/ngx_win32_init.c.html#L18" title="src/os/win32/ngx_win32_init.c:18">ngx_tcp_nodelay_and_tcp_nopush</a> ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tcp_nodelay = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tcp_nodelay<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; clcf-&gt;tcp_nodelay<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; c-&gt;tcp_nodelay == NGX_TCP_NODELAY_UNSET)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;tcp_nodelay&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (setsockopt(c-&gt;fd, IPPROTO_TCP, TCP_NODELAY,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">const</span> <span class="Type">void</span> *) &amp;tcp_nodelay, <span class="Statement">sizeof</span>(<span class="Type">int</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li><span class="PreProc">#if (NGX_SOLARIS)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Solaris returns EINVAL if a socket has been shut down */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log_error = NGX_ERROR_IGNORE_EINVAL;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;setsockopt(TCP_NODELAY) failed&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log_error = NGX_ERROR_INFO;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;tcp_nodelay = NGX_TCP_NODELAY_SET;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if 0<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; /* if <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> was freed then we need some other place */<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; r-&gt;http_state = NGX_HTTP_KEEPALIVE_STATE;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c-&gt;idle = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, clcf-&gt;keepalive_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event_posted.h.html#L17" title="src/event/ngx_event_posted.h:17">ngx_post_event</a>(rev, &amp;<a href="../event/ngx_event_posted.c.html#L14" title="src/event/ngx_event_posted.c:14">ngx_posted_events</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3079">&#x200c;</a></span><span class="linkable">ngx_http_keepalive_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http keepalive handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout || c-&gt;close) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_KQUEUE)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L225" title="src/event/ngx_event.h:225">NGX_USE_KQUEUE_EVENT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;pending_eof) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;log-&gt;handler = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, rev-&gt;kq_errno,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;kevent() reported that client %V closed &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;keepalive connection&quot;</span>, &amp;c-&gt;addr_text);<br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;no_send_shutdown = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; b = c-&gt;buffer;<br/></li>
<li>&nbsp; &nbsp; size = b-&gt;end - b-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * The c-&gt;buffer's memory was freed by <a href="#L2847" title="src/http/ngx_http_request.c:2847">ngx_http_set_keepalive</a>().<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * However, the c-&gt;buffer-&gt;start and c-&gt;buffer-&gt;end were not changed<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * to keep the buffer size.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = <a href="../core/ngx_palloc.c.html#L126" title="src/core/ngx_palloc.c:126">ngx_palloc</a>(c-&gt;pool, size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;pos == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;start = b-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last = b-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;end = b-&gt;pos + size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * MSIE closes a keepalive connection with RST flag<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * so we ignore ECONNRESET here.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c-&gt;log_error = NGX_ERROR_IGNORE_ECONNRESET;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_errno.h.html#L21" title="src/os/win32/ngx_errno.h:21">ngx_set_socket_errno</a>(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = c-&gt;recv(c, b-&gt;last, size);<br/></li>
<li>&nbsp; &nbsp; c-&gt;log_error = NGX_ERROR_INFO;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Like <a href="#L2847" title="src/http/ngx_http_request.c:2847">ngx_http_set_keepalive</a>() we are trying to not hold<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * c-&gt;buffer's memory for a keepalive connection.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_palloc.c.html#L281" title="src/core/ngx_palloc.c:281">ngx_pfree</a>(c-&gt;pool, b-&gt;start) == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the special note that c-&gt;buffer's memory was freed<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;pos = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;handler = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, c-&gt;log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;client %V closed keepalive connection&quot;</span>, &amp;c-&gt;addr_text);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;last += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;handler = <a href="#L3572" title="src/http/ngx_http_request.c:3572">ngx_http_log_error</a>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;log-&gt;action = <span class="Constant">&quot;reading client request line&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;idle = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1203" title="src/core/ngx_connection.c:1203">ngx_reusable_connection</a>(c, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;data = <a href="#L509" title="src/http/ngx_http_request.c:509">ngx_http_create_request</a>(c);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;sent = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;destroyed = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(rev);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler = <a href="#L919" title="src/http/ngx_http_request.c:919">ngx_http_process_request_line</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L919" title="src/http/ngx_http_request.c:919">ngx_http_process_request_line</a>(rev);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3210">&#x200c;</a></span><span class="linkable">ngx_http_set_lingering_close</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *rev, *wev;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rev = c-&gt;read;<br/></li>
<li>&nbsp; &nbsp; rev-&gt;handler = <a href="#L3255" title="src/http/ngx_http_request.c:3255">ngx_http_lingering_close_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;lingering_time = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) (clcf-&gt;lingering_time / <span class="Constant">1000</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, clcf-&gt;lingering_timeout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wev = c-&gt;write;<br/></li>
<li>&nbsp; &nbsp; wev-&gt;handler = <a href="#L3311" title="src/http/ngx_http_request.c:3311">ngx_http_empty_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wev-&gt;active &amp;&amp; (<a href="../event/ngx_event.c.html#L43" title="src/event/ngx_event.c:43">ngx_event_flags</a> &amp; <a href="../event/ngx_event.h.html#L207" title="src/event/ngx_event.h:207">NGX_USE_LEVEL_EVENT</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.h.html#L407" title="src/event/ngx_event.h:407">ngx_del_event</a>(wev, <a href="../event/ngx_event.h.html#L319" title="src/event/ngx_event.h:319">NGX_WRITE_EVENT</a>, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_socket.h.html#L34" title="src/os/win32/ngx_socket.h:34">ngx_shutdown_socket</a>(c-&gt;fd, <a href="../os/win32/ngx_socket.h.html#L16" title="src/os/win32/ngx_socket.h:16">NGX_WRITE_SHUTDOWN</a>) == -<span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1348" title="src/core/ngx_connection.c:1348">ngx_connection_error</a>(c, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../os/win32/ngx_socket.h.html#L35" title="src/os/win32/ngx_socket.h:35">ngx_shutdown_socket_n</a> <span class="Constant">&quot; failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;ready) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3255" title="src/http/ngx_http_request.c:3255">ngx_http_lingering_close_handler</a>(rev);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3255">&#x200c;</a></span><span class="linkable">ngx_http_lingering_close_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *rev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timer;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; buffer[<a href="ngx_http_request.h.html#L20" title="src/http/ngx_http_request.h:20">NGX_HTTP_LINGERING_BUFFER_SIZE</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = rev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; r = c-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http lingering close handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rev-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; timer = (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) r-&gt;lingering_time - (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../os/win32/ngx_time.h.html#L17" title="src/os/win32/ngx_time.h:17">ngx_msec_int_t</a>) timer &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">do</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = c-&gt;recv(c, buffer, <a href="ngx_http_request.h.html#L20" title="src/http/ngx_http_request.h:20">NGX_HTTP_LINGERING_BUFFER_SIZE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;lingering read: %z&quot;</span>, n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> || n == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">while</span> (rev-&gt;ready);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event.c.html#L264" title="src/event/ngx_event.c:264">ngx_handle_read_event</a>(rev, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L3400" title="src/http/ngx_http_request.c:3400">ngx_http_close_request</a>(r, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; timer *= <span class="Constant">1000</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (timer &gt; clcf-&gt;lingering_timeout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; timer = clcf-&gt;lingering_timeout;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(rev, timer);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L3311">&#x200c;</a></span><span class="linkable">ngx_http_empty_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *wev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, wev-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http empty handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L3320">&#x200c;</a></span><span class="linkable">ngx_http_request_empty_handler</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http request empty handler&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3330">&#x200c;</a><span class="linkable">ngx_http_send_special</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> flags)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp;&nbsp; out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b = <a href="../core/ngx_buf.h.html#L154" title="src/core/ngx_buf.h:154">ngx_calloc_buf</a>(r-&gt;pool);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (flags &amp; <a href="ngx_http.h.html#L133" title="src/http/ngx_http.h:133">NGX_HTTP_LAST</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (r == r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> &amp;&amp; !r-&gt;post_action) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last_buf = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;sync = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b-&gt;last_in_chain = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (flags &amp; <a href="ngx_http.h.html#L134" title="src/http/ngx_http.h:134">NGX_HTTP_FLUSH</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; b-&gt;flush = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out.buf = b;<br/></li>
<li>&nbsp; &nbsp; out.next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_core_module.c.html#L1969" title="src/http/ngx_http_core_module.c:1969">ngx_http_output_filter</a>(r, &amp;out);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L3363">&#x200c;</a><span class="linkable">ngx_http_post_action</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;post_action.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;post_action &amp;&amp; r-&gt;uri_changes == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;post action: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;clcf-&gt;post_action);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;count--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;http_version = <a href="ngx_http_request.h.html#L23" title="src/http/ngx_http_request.h:23">NGX_HTTP_VERSION_9</a>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;header_only = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;post_action = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;read_event_handler = <a href="#L2710" title="src/http/ngx_http_request.c:2710">ngx_http_block_reading</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;post_action.data[<span class="Constant">0</span>] == <span class="Constant">'/'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_core_module.c.html#L2576" title="src/http/ngx_http_core_module.c:2576">ngx_http_internal_redirect</a>(r, &amp;clcf-&gt;post_action, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_core_module.c.html#L2631" title="src/http/ngx_http_core_module.c:2631">ngx_http_named_location</a>(r, &amp;clcf-&gt;post_action);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3400">&#x200c;</a></span><span class="linkable">ngx_http_close_request</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> rc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>;<br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http request count:</span><span class="Special">%d</span><span class="Constant"> blk:</span><span class="Special">%d</span><span class="Constant">&quot;</span>, r-&gt;count, r-&gt;blocked);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;count == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;log, <span class="Constant">0</span>, <span class="Constant">&quot;http request count is zero&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;count--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;count || r-&gt;blocked) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_V2)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;stream) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="v2/ngx_http_v2.c.html#L3919" title="src/http/v2/ngx_http_v2.c:3919">ngx_http_v2_close_stream</a>(r-&gt;stream, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L3433" title="src/http/ngx_http_request.c:3433">ngx_http_free_request</a>(r, rc);<br/></li>
<li>&nbsp; &nbsp; <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L3433">&#x200c;</a></span><span class="linkable">ngx_http_free_request</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> rc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *log;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *pool;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> linger&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; linger;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L327" title="src/http/ngx_http_request.h:327">ngx_http_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L20" title="src/http/ngx_http.h:20">ngx_http_log_ctx_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *ctx;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log = r-&gt;connection-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, log, <span class="Constant">0</span>, <span class="Constant">&quot;http close request&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;pool == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <span class="Constant">0</span>, <span class="Constant">&quot;http request already closed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = r-&gt;cleanup;<br/></li>
<li>&nbsp; &nbsp; r-&gt;cleanup = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (cln) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cln-&gt;handler) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cln-&gt;handler(cln-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cln = cln-&gt;next;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_STAT_STUB)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;stat_reading) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L71" title="src/event/ngx_event.c:71">ngx_stat_reading</a>, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;stat_writing) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L73" title="src/event/ngx_event.c:73">ngx_stat_writing</a>, -<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc &gt; <span class="Constant">0</span> &amp;&amp; (r-&gt;headers_out.status == <span class="Constant">0</span> || r-&gt;connection-&gt;sent == <span class="Constant">0</span>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;headers_out.status = rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log-&gt;action = <span class="Constant">&quot;logging request&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L3521" title="src/http/ngx_http_request.c:3521">ngx_http_log_request</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log-&gt;action = <span class="Constant">&quot;closing request&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;connection-&gt;timedout) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;reset_timedout_connection) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; linger.l_onoff = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; linger.l_linger = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (setsockopt(r-&gt;connection-&gt;fd, SOL_SOCKET, SO_LINGER,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">const</span> <span class="Type">void</span> *) &amp;linger, <span class="Statement">sizeof</span>(<span class="Type">struct</span> linger)) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, log, <a href="../os/win32/ngx_errno.h.html#L20" title="src/os/win32/ngx_errno.h:20">ngx_socket_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;setsockopt(SO_LINGER) failed&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the various request strings were allocated from r-&gt;pool */<br/></li>
<li></span>&nbsp; &nbsp; ctx = log-&gt;data;<br/></li>
<li>&nbsp; &nbsp; ctx-&gt;request = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;request_line.len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;connection-&gt;destroyed = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Setting r-&gt;pool to NULL will increase probability to catch double close<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * of request since the request object is allocated from its own pool.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; pool = r-&gt;pool;<br/></li>
<li>&nbsp; &nbsp; r-&gt;pool = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(pool);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L3521">&#x200c;</a></span><span class="linkable">ngx_http_log_request</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L362" title="src/http/ngx_http_request.h:362">ngx_http_handler_pt</a>&nbsp; &nbsp; &nbsp; &nbsp; *log_handler;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L178" title="src/http/ngx_http_core_module.h:178">ngx_http_core_main_conf_t</a>&nbsp; *cmcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cmcf = <a href="ngx_http_config.h.html#L55" title="src/http/ngx_http_config.h:55">ngx_http_get_module_main_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; log_handler = cmcf-&gt;phases[NGX_HTTP_LOG_PHASE].handlers.elts;<br/></li>
<li>&nbsp; &nbsp; n = cmcf-&gt;phases[NGX_HTTP_LOG_PHASE].handlers.nelts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; n; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; log_handler[i](r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L3539">&#x200c;</a></span><span class="linkable">ngx_http_close_connection</span>(<a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L18" title="src/core/ngx_core.h:18">ngx_pool_t</a>&nbsp; *pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;close http connection: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, c-&gt;fd);<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HTTP_SSL)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;ssl) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../event/ngx_event_openssl.c.html#L1883" title="src/event/ngx_event_openssl.c:1883">ngx_ssl_shutdown</a>(c) == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;ssl-&gt;handler = <a href="#L3539" title="src/http/ngx_http_request.c:3539">ngx_http_close_connection</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_STAT_STUB)<br/></li>
<li></span>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../os/win32/ngx_atomic.h.html#L44" title="src/os/win32/ngx_atomic.h:44">ngx_atomic_fetch_add</a>(<a href="../event/ngx_event.c.html#L69" title="src/event/ngx_event.c:69">ngx_stat_active</a>, -<span class="Constant">1</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c-&gt;destroyed = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pool = c-&gt;pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_connection.c.html#L1112" title="src/core/ngx_connection.c:1112">ngx_close_connection</a>(c);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.c.html#L50" title="src/core/ngx_palloc.c:50">ngx_destroy_pool</a>(pool);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L3572">&#x200c;</a><span class="linkable">ngx_http_log_error</span>(<a href="../core/ngx_core.h.html#L20" title="src/core/ngx_core.h:20">ngx_log_t</a> *log, u_char *buf, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L20" title="src/http/ngx_http.h:20">ngx_http_log_ctx_t</a>&nbsp; *ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (log-&gt;action) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot; while </span><span class="Special">%s</span><span class="Constant">&quot;</span>, log-&gt;action);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctx = log-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot;, client: %V&quot;</span>, &amp;ctx-&gt;connection-&gt;addr_text);<br/></li>
<li>&nbsp; &nbsp; len -= p - buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ctx-&gt;request;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> r-&gt;log_handler(r, ctx-&gt;current_request, p, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(p, len, <span class="Constant">&quot;, server: %V&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;ctx-&gt;connection-&gt;listening-&gt;addr_text);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> u_char *<br/></li>
<li><a id="L3604">&#x200c;</a><span class="linkable">ngx_http_log_error_handler</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *sr,<br/></li>
<li>&nbsp; &nbsp; u_char *buf, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *uri_separator;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L17" title="src/http/ngx_http.h:17">ngx_http_upstream_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *u;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L208" title="src/http/ngx_http_core_module.h:208">ngx_http_core_srv_conf_t</a>&nbsp; *cscf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cscf = <a href="ngx_http_config.h.html#L57" title="src/http/ngx_http_config.h:57">ngx_http_get_module_srv_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot;, server: %V&quot;</span>, &amp;cscf-&gt;server_name);<br/></li>
<li>&nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; buf = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_line.data == <span class="Constant">NULL</span> &amp;&amp; r-&gt;request_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (p = r-&gt;request_start; p &lt; r-&gt;header_in-&gt;last; p++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == <a href="../core/ngx_core.h.html#L96" title="src/core/ngx_core.h:96">CR</a> || *p == <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_line.len = p - r-&gt;request_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;request_line.data = r-&gt;request_start;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;request_line.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot;, request: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;request_line);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != sr) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot;, subrequest: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;sr-&gt;uri);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u = sr-&gt;upstream;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (u &amp;&amp; u-&gt;peer.name) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uri_separator = <span class="Constant">&quot;&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_UNIX_DOMAIN)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (u-&gt;peer.sockaddr &amp;&amp; u-&gt;peer.sockaddr-&gt;sa_family == AF_UNIX) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uri_separator = <span class="Constant">&quot;:&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot;, upstream: </span><span class="Special">\&quot;</span><span class="Constant">%V%V</span><span class="Special">%s</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;u-&gt;schema, u-&gt;peer.name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; uri_separator, &amp;u-&gt;uri);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.host) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot;, host: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;r-&gt;headers_in.host-&gt;value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len -= p - buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r-&gt;headers_in.referer) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L119" title="src/core/ngx_string.c:119">ngx_snprintf</a>(buf, len, <span class="Constant">&quot;, referrer: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;r-&gt;headers_in.referer-&gt;value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf = p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> buf;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
