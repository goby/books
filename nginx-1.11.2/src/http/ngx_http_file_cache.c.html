<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>src/http/ngx_http_file_cache.c - Nginx 1.11.2</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>src/http/ngx_http_file_cache.c - Nginx 1.11.2</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L68">ngx_http_cache_status</a></li>
<li><a href="#L79">ngx_http_file_cache_key</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L718">ngx_http_cache_aio_event_handler</a></li>
<li><a href="#L1554">ngx_http_cache_send</a></li>
<li><a href="#L790">ngx_http_cache_thread_event_handler</a></li>
<li><a href="#L747">ngx_http_cache_thread_handler</a></li>
<li><a href="#L2098">ngx_http_file_cache_add</a></li>
<li><a href="#L2055">ngx_http_file_cache_add_file</a></li>
<li><a href="#L662">ngx_http_file_cache_aio_read</a></li>
<li><a href="#L1672">ngx_http_file_cache_cleanup</a></li>
<li><a href="#L197">ngx_http_file_cache_create</a></li>
<li><a href="#L227">ngx_http_file_cache_create_key</a></li>
<li><a href="#L1850">ngx_http_file_cache_delete</a></li>
<li><a href="#L2153">ngx_http_file_cache_delete_file</a></li>
<li><a href="#L815">ngx_http_file_cache_exists</a></li>
<li><a href="#L1756">ngx_http_file_cache_expire</a></li>
<li><a href="#L1693">ngx_http_file_cache_forced_expire</a></li>
<li><a href="#L1607">ngx_http_file_cache_free</a></li>
<li><a href="#L83">ngx_http_file_cache_init</a></li>
<li><a href="#L1945">ngx_http_file_cache_loader</a></li>
<li><a href="#L2043">ngx_http_file_cache_loader_sleep</a></li>
<li><a href="#L402">ngx_http_file_cache_lock</a></li>
<li><a href="#L481">ngx_http_file_cache_lock_wait</a></li>
<li><a href="#L461">ngx_http_file_cache_lock_wait_handler</a></li>
<li><a href="#L963">ngx_http_file_cache_lookup</a></li>
<li><a href="#L2030">ngx_http_file_cache_manage_directory</a></li>
<li><a href="#L1998">ngx_http_file_cache_manage_file</a></li>
<li><a href="#L1901">ngx_http_file_cache_manager</a></li>
<li><a href="#L928">ngx_http_file_cache_name</a></li>
<li><a href="#L175">ngx_http_file_cache_new</a></li>
<li><a href="#L1991">ngx_http_file_cache_noop</a></li>
<li><a href="#L264">ngx_http_file_cache_open</a></li>
<li><a href="#L1008">ngx_http_file_cache_rbtree_insert_value</a></li>
<li><a href="#L525">ngx_http_file_cache_read</a></li>
<li><a href="#L1203">ngx_http_file_cache_reopen</a></li>
<li><a href="#L1237">ngx_http_file_cache_set_header</a></li>
<li><a href="#L2204">ngx_http_file_cache_set_slot</a></li>
<li><a href="#L2168">ngx_http_file_cache_set_watermark</a></li>
<li><a href="#L1349">ngx_http_file_cache_update</a></li>
<li><a href="#L1424">ngx_http_file_cache_update_header</a></li>
<li><a href="#L1300">ngx_http_file_cache_update_variant</a></li>
<li><a href="#L2178">ngx_http_file_cache_valid</a></li>
<li><a href="#L2496">ngx_http_file_cache_valid_set_slot</a></li>
<li><a href="#L1051">ngx_http_file_cache_vary</a></li>
<li><a href="#L1100">ngx_http_file_cache_vary_header</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copyright (C) Igor Sysoev<br/></li>
<li></span><span class="Comment"> * Copyright (C) Nginx, Inc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ngx_config.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_core.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_http.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;ngx_md5.h&gt;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L402" title="src/http/ngx_http_file_cache.c:402">ngx_http_file_cache_lock</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L461" title="src/http/ngx_http_file_cache.c:461">ngx_http_file_cache_lock_wait_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L481" title="src/http/ngx_http_file_cache.c:481">ngx_http_file_cache_lock_wait</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L525" title="src/http/ngx_http_file_cache.c:525">ngx_http_file_cache_read</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span> <a href="#L662" title="src/http/ngx_http_file_cache.c:662">ngx_http_file_cache_aio_read</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c);<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_FILE_AIO)<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void</span> <a href="#L718" title="src/http/ngx_http_file_cache.c:718">ngx_http_cache_aio_event_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#if (NGX_THREADS)<br/></li>
<li></span><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L747" title="src/http/ngx_http_file_cache.c:747">ngx_http_cache_thread_handler</a>(<a href="../core/ngx_core.h.html#L29" title="src/core/ngx_core.h:29">ngx_thread_task_t</a> *task,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="src/core/ngx_core.h:23">ngx_file_t</a> *file);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L790" title="src/http/ngx_http_file_cache.c:790">ngx_http_cache_thread_event_handler</a>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L815" title="src/http/ngx_http_file_cache.c:815">ngx_http_file_cache_exists</a>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L928" title="src/http/ngx_http_file_cache.c:928">ngx_http_file_cache_name</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L60" title="src/core/ngx_file.h:60">ngx_path_t</a> *path);<br/></li>
<li><span class="Type">static</span> <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a> *<br/></li>
<li>&nbsp; &nbsp; <a href="#L963" title="src/http/ngx_http_file_cache.c:963">ngx_http_file_cache_lookup</a>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache, u_char *key);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1008" title="src/http/ngx_http_file_cache.c:1008">ngx_http_file_cache_rbtree_insert_value</a>(<a href="../core/ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="../core/ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1051" title="src/http/ngx_http_file_cache.c:1051">ngx_http_file_cache_vary</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, u_char *vary,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span> len, u_char *hash);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1100" title="src/http/ngx_http_file_cache.c:1100">ngx_http_file_cache_vary_header</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_md5.h.html#L20" title="src/core/ngx_md5.h:20">ngx_md5_t</a> *md5, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1203" title="src/http/ngx_http_file_cache.c:1203">ngx_http_file_cache_reopen</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1300" title="src/http/ngx_http_file_cache.c:1300">ngx_http_file_cache_update_variant</a>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1672" title="src/http/ngx_http_file_cache.c:1672">ngx_http_file_cache_cleanup</a>(<span class="Type">void</span> *data);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span> <a href="#L1693" title="src/http/ngx_http_file_cache.c:1693">ngx_http_file_cache_forced_expire</a>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span> <a href="#L1756" title="src/http/ngx_http_file_cache.c:1756">ngx_http_file_cache_expire</a>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1850" title="src/http/ngx_http_file_cache.c:1850">ngx_http_file_cache_delete</a>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a> *q, u_char *name);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2043" title="src/http/ngx_http_file_cache.c:2043">ngx_http_file_cache_loader_sleep</a>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1991" title="src/http/ngx_http_file_cache.c:1991">ngx_http_file_cache_noop</a>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *path);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L1998" title="src/http/ngx_http_file_cache.c:1998">ngx_http_file_cache_manage_file</a>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *path);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2030" title="src/http/ngx_http_file_cache.c:2030">ngx_http_file_cache_manage_directory</a>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *path);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2055" title="src/http/ngx_http_file_cache.c:2055">ngx_http_file_cache_add_file</a>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *path);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2098" title="src/http/ngx_http_file_cache.c:2098">ngx_http_file_cache_add</a>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache,<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c);<br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a> <a href="#L2153" title="src/http/ngx_http_file_cache.c:2153">ngx_http_file_cache_delete_file</a>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *path);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L2168" title="src/http/ngx_http_file_cache.c:2168">ngx_http_file_cache_set_watermark</a>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L68">&#x200c;</a><a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; <span class="linkable">ngx_http_cache_status</span>[] = {<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;MISS&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;BYPASS&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;EXPIRED&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;STALE&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;UPDATING&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;REVALIDATED&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L40" title="src/core/ngx_string.h:40">ngx_string</a>(<span class="Constant">&quot;HIT&quot;</span>)<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L79">&#x200c;</a><span class="Type">static</span> u_char&nbsp; <span class="linkable">ngx_http_file_cache_key</span>[] = { <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>, <span class="Constant">'K'</span>, <span class="Constant">'E'</span>, <span class="Constant">'Y'</span>, <span class="Constant">':'</span>, <span class="Constant">' '</span> };<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L83">&#x200c;</a><span class="linkable">ngx_http_file_cache_init</span>(<a href="../core/ngx_cycle.h.html#L25" title="src/core/ngx_cycle.h:25">ngx_shm_zone_t</a> *shm_zone, <span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *ocache = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = shm_zone-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ocache) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(cache-&gt;path-&gt;name.data, ocache-&gt;path-&gt;name.data) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, shm_zone-&gt;shm.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> uses the </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> cache path &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;while previously it used the </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> cache path&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;shm_zone-&gt;shm.name, &amp;cache-&gt;path-&gt;name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;ocache-&gt;path-&gt;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; <span class="Constant">3</span>; n++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;path-&gt;level[n] != ocache-&gt;path-&gt;level[n]) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, shm_zone-&gt;shm.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> had previously different levels&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;shm_zone-&gt;shm.name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;sh = ocache-&gt;sh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;shpool = ocache-&gt;shpool;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;bsize = ocache-&gt;bsize;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;max_size /= cache-&gt;bsize;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!cache-&gt;sh-&gt;cold || cache-&gt;sh-&gt;loading) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;path-&gt;loader = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;shpool = (<a href="../core/ngx_slab.h.html#L47" title="src/core/ngx_slab.h:47">ngx_slab_pool_t</a> *) shm_zone-&gt;shm.addr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (shm_zone-&gt;shm.exists) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;sh = cache-&gt;shpool-&gt;data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;bsize = <a href="../os/win32/ngx_files.c.html#L627" title="src/os/win32/ngx_files.c:627">ngx_fs_bsize</a>(cache-&gt;path-&gt;name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh = <a href="../core/ngx_slab.c.html#L141" title="src/core/ngx_slab.c:141">ngx_slab_alloc</a>(cache-&gt;shpool, <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L143" title="src/http/ngx_http_cache.h:143">ngx_http_file_cache_sh_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;sh == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;shpool-&gt;data = cache-&gt;sh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L44" title="src/core/ngx_rbtree.h:44">ngx_rbtree_init</a>(&amp;cache-&gt;sh-&gt;rbtree, &amp;cache-&gt;sh-&gt;sentinel,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1008" title="src/http/ngx_http_file_cache.c:1008">ngx_http_file_cache_rbtree_insert_value</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L24" title="src/core/ngx_queue.h:24">ngx_queue_init</a>(&amp;cache-&gt;sh-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;cold = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;loading = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;watermark = (<a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>) -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;bsize = <a href="../os/win32/ngx_files.c.html#L627" title="src/os/win32/ngx_files.c:627">ngx_fs_bsize</a>(cache-&gt;path-&gt;name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;max_size /= cache-&gt;bsize;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Statement">sizeof</span>(<span class="Constant">&quot; in cache keys zone </span><span class="Special">\&quot;\&quot;</span><span class="Constant">&quot;</span>) + shm_zone-&gt;shm.name.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;shpool-&gt;log_ctx = <a href="../core/ngx_slab.c.html#L141" title="src/core/ngx_slab.c:141">ngx_slab_alloc</a>(cache-&gt;shpool, len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;shpool-&gt;log_ctx == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L105" title="src/core/ngx_string.c:105">ngx_sprintf</a>(cache-&gt;shpool-&gt;log_ctx, <span class="Constant">&quot; in cache keys zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">%Z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;shm_zone-&gt;shm.name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;shpool-&gt;log_nomem = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L175">&#x200c;</a><span class="linkable">ngx_http_file_cache_new</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_array.h.html#L32" title="src/core/ngx_array.h:32">ngx_array_init</a>(&amp;c-&gt;keys, r-&gt;pool, <span class="Constant">4</span>, <span class="Statement">sizeof</span>(<a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>)) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;cache = c;<br/></li>
<li>&nbsp; &nbsp; c-&gt;file.log = r-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; c-&gt;file.fd = <a href="../os/win32/ngx_files.h.html#L68" title="src/os/win32/ngx_files.h:68">NGX_INVALID_FILE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L197">&#x200c;</a><span class="linkable">ngx_http_file_cache_create</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.h.html#L32" title="src/core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp;&nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li>&nbsp; &nbsp; cache = c-&gt;file_cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln = <a href="../core/ngx_palloc.c.html#L315" title="src/core/ngx_palloc.c:315">ngx_pool_cleanup_add</a>(r-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cln-&gt;handler = <a href="#L1672" title="src/http/ngx_http_file_cache.c:1672">ngx_http_file_cache_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; cln-&gt;data = c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L815" title="src/http/ngx_http_file_cache.c:815">ngx_http_file_cache_exists</a>(cache, c) == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L928" title="src/http/ngx_http_file_cache.c:928">ngx_http_file_cache_name</a>(r, cache-&gt;path) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L227">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_create_key</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *key;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_md5.h.html#L20" title="src/core/ngx_md5.h:20">ngx_md5_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; md5;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_crc32.h.html#L53" title="src/core/ngx_crc32.h:53">ngx_crc32_init</a>(c-&gt;crc32);<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L19" title="src/core/ngx_md5.c:19">ngx_md5_init</a>(&amp;md5);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; key = c-&gt;keys.elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; c-&gt;keys.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http cache key: </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;key[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len += key[i].len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_crc32.h.html#L58" title="src/core/ngx_crc32.h:58">ngx_crc32_update</a>(&amp;c-&gt;crc32, key[i].data, key[i].len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L31" title="src/core/ngx_md5.c:31">ngx_md5_update</a>(&amp;md5, key[i].data, key[i].len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;header_start = <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<a href="#L79" title="src/http/ngx_http_file_cache.c:79">ngx_http_file_cache_key</a>) + len + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_crc32.h.html#L72" title="src/core/ngx_crc32.h:72">ngx_crc32_final</a>(c-&gt;crc32);<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L62" title="src/core/ngx_md5.c:62">ngx_md5_final</a>(c-&gt;key, &amp;md5);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(c-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>, c-&gt;key, <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L264">&#x200c;</a><span class="linkable">ngx_http_file_cache_open</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc, rv;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; test;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_palloc.h.html#L32" title="src/core/ngx_palloc.h:32">ngx_pool_cleanup_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *cln;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_open_file_cache.h.html#L51" title="src/core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a>&nbsp; &nbsp; &nbsp;&nbsp; of;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; &nbsp;&nbsp; *cache;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;waiting) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;reading) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L525" title="src/http/ngx_http_file_cache.c:525">ngx_http_file_cache_read</a>(r, c);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = c-&gt;file_cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cln = <a href="../core/ngx_palloc.c.html#L315" title="src/core/ngx_palloc.c:315">ngx_pool_cleanup_add</a>(r-&gt;pool, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cln == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cln-&gt;handler = <a href="#L1672" title="src/http/ngx_http_file_cache.c:1672">ngx_http_file_cache_cleanup</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cln-&gt;data = c;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="#L815" title="src/http/ngx_http_file_cache.c:815">ngx_http_file_cache_exists</a>(cache, c);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache exists: </span><span class="Special">%i</span><span class="Constant"> e:</span><span class="Special">%d</span><span class="Constant">&quot;</span>, rc, c-&gt;exists);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_cache.h.html#L24" title="src/http/ngx_http_cache.h:24">NGX_HTTP_CACHE_SCARCE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> c-&gt;error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;temp_file = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; test = c-&gt;exists ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* rc == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; test = cache-&gt;sh-&gt;cold ? <span class="Constant">1</span> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;min_uses &gt; <span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!test) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_cache.h.html#L24" title="src/http/ngx_http_cache.h:24">NGX_HTTP_CACHE_SCARCE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="ngx_http_cache.h.html#L24" title="src/http/ngx_http_cache.h:24">NGX_HTTP_CACHE_SCARCE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;temp_file = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rv = <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L928" title="src/http/ngx_http_file_cache.c:928">ngx_http_file_cache_name</a>(r, cache-&gt;path) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!test) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;of, <span class="Statement">sizeof</span>(<a href="../core/ngx_open_file_cache.h.html#L51" title="src/core/ngx_open_file_cache.h:51">ngx_open_file_info_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; of.uniq = c-&gt;uniq;<br/></li>
<li>&nbsp; &nbsp; of.valid = clcf-&gt;open_file_cache_valid;<br/></li>
<li>&nbsp; &nbsp; of.min_uses = clcf-&gt;open_file_cache_min_uses;<br/></li>
<li>&nbsp; &nbsp; of.events = clcf-&gt;open_file_cache_events;<br/></li>
<li>&nbsp; &nbsp; of.directio = <a href="../core/ngx_open_file_cache.h.html#L16" title="src/core/ngx_open_file_cache.h:16">NGX_OPEN_FILE_DIRECTIO_OFF</a>;<br/></li>
<li>&nbsp; &nbsp; of.read_ahead = clcf-&gt;read_ahead;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_open_file_cache.c.html#L144" title="src/core/ngx_open_file_cache.c:144">ngx_open_cached_file</a>(clcf-&gt;open_file_cache, &amp;c-&gt;file.name, &amp;of, r-&gt;pool)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (of.err) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">0</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../os/win32/ngx_errno.h.html#L24" title="src/os/win32/ngx_errno.h:24">NGX_ENOENT</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <a href="../os/win32/ngx_errno.h.html#L37" title="src/os/win32/ngx_errno.h:37">NGX_ENOTDIR</a>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">default</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, of.err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L73" title="src/os/win32/ngx_files.h:73">ngx_open_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, c-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache fd: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, of.fd);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;file.fd = of.fd;<br/></li>
<li>&nbsp; &nbsp; c-&gt;file.log = r-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; c-&gt;uniq = of.uniq;<br/></li>
<li>&nbsp; &nbsp; c-&gt;length = of.size;<br/></li>
<li>&nbsp; &nbsp; c-&gt;fs_size = (of.fs_size + cache-&gt;bsize - <span class="Constant">1</span>) / cache-&gt;bsize;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;buf = <a href="../core/ngx_buf.c.html#L13" title="src/core/ngx_buf.c:13">ngx_create_temp_buf</a>(r-&gt;pool, c-&gt;body_start);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;buf == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L525" title="src/http/ngx_http_file_cache.c:525">ngx_http_file_cache_read</a>(r, c);<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rv == <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L402" title="src/http/ngx_http_file_cache.c:402">ngx_http_file_cache_lock</a>(r, c);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rv;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L402">&#x200c;</a><span class="linkable">ngx_http_file_cache_lock</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; now, timer;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; &nbsp;&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;lock) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="../core/ngx_times.c.html#L26" title="src/core/ngx_times.c:26">ngx_current_msec</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = c-&gt;file_cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; timer = c-&gt;node-&gt;lock_time - now;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;node-&gt;updating || (<a href="../os/win32/ngx_time.h.html#L17" title="src/os/win32/ngx_time.h:17">ngx_msec_int_t</a>) timer &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node-&gt;updating = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node-&gt;lock_time = now + c-&gt;lock_age;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;updating = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;lock_time = c-&gt;node-&gt;lock_time;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache lock u:</span><span class="Special">%d</span><span class="Constant"> wt:%M&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; c-&gt;updating, c-&gt;wait_time);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;updating) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;lock_timeout == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_cache.h.html#L24" title="src/http/ngx_http_cache.h:24">NGX_HTTP_CACHE_SCARCE</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;waiting = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;wait_time == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;wait_time = now + c-&gt;lock_timeout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;wait_event.handler = <a href="#L461" title="src/http/ngx_http_file_cache.c:461">ngx_http_file_cache_lock_wait_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;wait_event.data = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;wait_event.log = r-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; timer = c-&gt;wait_time - now;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(&amp;c-&gt;wait_event, (timer &gt; <span class="Constant">500</span>) ? <span class="Constant">500</span> : timer);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;blocked++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L461">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_lock_wait_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L597" title="src/http/ngx_http_request.h:597">ngx_http_set_log_request</a>(c-&gt;log, r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache wait: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L481" title="src/http/ngx_http_file_cache.c:481">ngx_http_file_cache_lock_wait</a>(r, r-&gt;cache);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.c.html#L2208" title="src/http/ngx_http_request.c:2208">ngx_http_run_posted_requests</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L481">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_lock_wait</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now, timer;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="../core/ngx_times.c.html#L26" title="src/core/ngx_times.c:26">ngx_current_msec</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; timer = c-&gt;wait_time - now;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<a href="../os/win32/ngx_time.h.html#L17" title="src/os/win32/ngx_time.h:17">ngx_msec_int_t</a>) timer &lt;= <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache lock timeout&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;lock_timeout = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> wakeup;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = c-&gt;file_cache;<br/></li>
<li>&nbsp; &nbsp; wait = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; timer = c-&gt;node-&gt;lock_time - now;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;node-&gt;updating &amp;&amp; (<a href="../os/win32/ngx_time.h.html#L17" title="src/os/win32/ngx_time.h:17">ngx_msec_int_t</a>) timer &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wait = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (wait) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L413" title="src/event/ngx_event.h:413">ngx_add_timer</a>(&amp;c-&gt;wait_event, (timer &gt; <span class="Constant">500</span>) ? <span class="Constant">500</span> : timer);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">wakeup</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; c-&gt;waiting = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;blocked--;<br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L525">&#x200c;</a><span class="linkable">ngx_http_file_cache_read</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; now;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *key;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *cache;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>&nbsp; *h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="#L662" title="src/http/ngx_http_file_cache.c:662">ngx_http_file_cache_aio_read</a>(r, c);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) n &lt; c-&gt;header_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is too small&quot;</span>, c-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h = (<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a> *) c-&gt;buf-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h-&gt;version != <a href="ngx_http_cache.h.html#L30" title="src/http/ngx_http_cache.h:30">NGX_HTTP_CACHE_VERSION</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L23" title="src/core/ngx_log.h:23">NGX_LOG_INFO</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> version mismatch&quot;</span>, c-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h-&gt;crc32 != c-&gt;crc32 || h-&gt;header_start != c-&gt;header_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> has md5 collision&quot;</span>, c-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = c-&gt;buf-&gt;pos + <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; + <span class="Statement">sizeof</span>(<a href="#L79" title="src/http/ngx_http_file_cache.c:79">ngx_http_file_cache_key</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; key = c-&gt;keys.elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; c-&gt;keys.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(p, key[i].data, key[i].len) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> has md5 collision&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p += key[i].len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) h-&gt;body_start &gt; c-&gt;body_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> has too long header&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h-&gt;vary_len &gt; <a href="ngx_http_cache.h.html#L28" title="src/http/ngx_http_cache.h:28">NGX_HTTP_CACHE_VARY_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> has incorrect vary length&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h-&gt;vary_len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1051" title="src/http/ngx_http_file_cache.c:1051">ngx_http_file_cache_vary</a>(r, h-&gt;vary, h-&gt;vary_len, c-&gt;variant);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(c-&gt;variant, h-&gt;variant, <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache vary mismatch&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1203" title="src/http/ngx_http_file_cache.c:1203">ngx_http_file_cache_reopen</a>(r, c);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;buf-&gt;last += n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;valid_sec = h-&gt;valid_sec;<br/></li>
<li>&nbsp; &nbsp; c-&gt;last_modified = h-&gt;last_modified;<br/></li>
<li>&nbsp; &nbsp; c-&gt;date = h-&gt;date;<br/></li>
<li>&nbsp; &nbsp; c-&gt;valid_msec = h-&gt;valid_msec;<br/></li>
<li>&nbsp; &nbsp; c-&gt;body_start = h-&gt;body_start;<br/></li>
<li>&nbsp; &nbsp; c-&gt;etag.len = h-&gt;etag_len;<br/></li>
<li>&nbsp; &nbsp; c-&gt;etag.data = h-&gt;etag;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;cached = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = c-&gt;file_cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;sh-&gt;cold) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;node-&gt;exists) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node-&gt;uses = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node-&gt;body_start = c-&gt;body_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node-&gt;exists = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node-&gt;uniq = c-&gt;uniq;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node-&gt;fs_size = c-&gt;fs_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;sh-&gt;size += c-&gt;fs_size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;valid_sec &lt; now) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;node-&gt;updating) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_cache.h.html#L21" title="src/http/ngx_http_cache.h:21">NGX_HTTP_CACHE_UPDATING</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node-&gt;updating = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;updating = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;lock_time = c-&gt;node-&gt;lock_time;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="ngx_http_cache.h.html#L20" title="src/http/ngx_http_cache.h:20">NGX_HTTP_CACHE_STALE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache expired: </span><span class="Special">%i</span><span class="Constant"> %T %T&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc, c-&gt;valid_sec, now);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a><br/></li>
<li><a id="L662">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_aio_read</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#if (NGX_HAVE_FILE_AIO || NGX_THREADS)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_FILE_AIO)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;aio == <a href="ngx_http_core_module.h.html#L33" title="src/http/ngx_http_core_module.h:33">NGX_HTTP_AIO_ON</a> &amp;&amp; <a href="../os/unix/ngx_files.c.html#L25" title="src/os/unix/ngx_files.c:25">ngx_file_aio</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../os/unix/ngx_linux_aio_read.c.html#L50" title="src/os/unix/ngx_linux_aio_read.c:50">ngx_file_aio_read</a>(&amp;c-&gt;file, c-&gt;buf-&gt;pos, c-&gt;body_start, <span class="Constant">0</span>, r-&gt;pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n != <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;reading = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> n;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;reading = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file.aio-&gt;data = r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file.aio-&gt;handler = <a href="#L718" title="src/http/ngx_http_file_cache.c:718">ngx_http_cache_aio_event_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;blocked++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; r-&gt;aio = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#if (NGX_THREADS)<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clcf-&gt;aio == <a href="ngx_http_core_module.h.html#L34" title="src/http/ngx_http_core_module.h:34">NGX_HTTP_AIO_THREADS</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file.thread_task = c-&gt;thread_task;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file.thread_handler = <a href="#L747" title="src/http/ngx_http_file_cache.c:747">ngx_http_cache_thread_handler</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file.thread_ctx = r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../os/unix/ngx_files.c.html#L95" title="src/os/unix/ngx_files.c:95">ngx_thread_read</a>(&amp;c-&gt;file, c-&gt;buf-&gt;pos, c-&gt;body_start, <span class="Constant">0</span>, r-&gt;pool);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;thread_task = c-&gt;file.thread_task;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;reading = (n == <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../os/win32/ngx_files.c.html#L62" title="src/os/win32/ngx_files.c:62">ngx_read_file</a>(&amp;c-&gt;file, c-&gt;buf-&gt;pos, c-&gt;body_start, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_HAVE_FILE_AIO)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L718">&#x200c;</a></span><span class="linkable">ngx_http_cache_aio_event_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L25" title="src/core/ngx_core.h:25">ngx_event_aio_t</a>&nbsp; &nbsp;&nbsp; *aio;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aio = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; r = aio-&gt;data;<br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L597" title="src/http/ngx_http_request.h:597">ngx_http_set_log_request</a>(c-&gt;log, r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache aio: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;blocked--;<br/></li>
<li>&nbsp; &nbsp; r-&gt;aio = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.c.html#L2208" title="src/http/ngx_http_request.c:2208">ngx_http_run_posted_requests</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#if (NGX_THREADS)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L747">&#x200c;</a><span class="linkable">ngx_http_cache_thread_handler</span>(<a href="../core/ngx_core.h.html#L29" title="src/core/ngx_core.h:29">ngx_thread_task_t</a> *task, <a href="../core/ngx_core.h.html#L23" title="src/core/ngx_core.h:23">ngx_file_t</a> *file)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_thread_pool.h.html#L26" title="src/core/ngx_thread_pool.h:26">ngx_thread_pool_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tp;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *r;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_core_module.h.html#L57" title="src/http/ngx_http_core_module.h:57">ngx_http_core_loc_conf_t</a>&nbsp; *clcf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = file-&gt;thread_ctx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; clcf = <a href="ngx_http_config.h.html#L58" title="src/http/ngx_http_config.h:58">ngx_http_get_module_loc_conf</a>(r, <a href="ngx_http_core_module.c.html#L781" title="src/http/ngx_http_core_module.c:781">ngx_http_core_module</a>);<br/></li>
<li>&nbsp; &nbsp; tp = clcf-&gt;thread_pool;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="ngx_http_script.c.html#L58" title="src/http/ngx_http_script.c:58">ngx_http_complex_value</a>(r, clcf-&gt;thread_pool_value, &amp;name)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tp = <a href="../core/ngx_thread_pool.c.html#L551" title="src/core/ngx_thread_pool.c:551">ngx_thread_pool_get</a>((<a href="../core/ngx_core.h.html#L17" title="src/core/ngx_core.h:17">ngx_cycle_t</a> *) <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tp == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L20" title="src/core/ngx_log.h:20">NGX_LOG_ERR</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;thread pool </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> not found&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; task-&gt;event.data = r;<br/></li>
<li>&nbsp; &nbsp; task-&gt;event.handler = <a href="#L790" title="src/http/ngx_http_file_cache.c:790">ngx_http_cache_thread_event_handler</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_thread_pool.c.html#L224" title="src/core/ngx_thread_pool.c:224">ngx_thread_task_post</a>(tp, task) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;blocked++;<br/></li>
<li>&nbsp; &nbsp; r-&gt;aio = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L790">&#x200c;</a></span><span class="linkable">ngx_http_cache_thread_event_handler</span>(<a href="../core/ngx_core.h.html#L24" title="src/core/ngx_core.h:24">ngx_event_t</a> *ev)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L26" title="src/core/ngx_core.h:26">ngx_connection_t</a>&nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a>&nbsp; *r;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r = ev-&gt;data;<br/></li>
<li>&nbsp; &nbsp; c = r-&gt;connection;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.h.html#L597" title="src/http/ngx_http_request.h:597">ngx_http_set_log_request</a>(c-&gt;log, r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache thread: </span><span class="Special">\&quot;</span><span class="Constant">%V?%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;r-&gt;uri, &amp;r-&gt;args);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>-&gt;blocked--;<br/></li>
<li>&nbsp; &nbsp; r-&gt;aio = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; r-&gt;write_event_handler(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_request.c.html#L2208" title="src/http/ngx_http_request.c:2208">ngx_http_run_posted_requests</a>(c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L815">&#x200c;</a><span class="linkable">ngx_http_file_cache_exists</span>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache, <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>&nbsp; *fcn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fcn = c-&gt;node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fcn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn = <a href="#L963" title="src/http/ngx_http_file_cache.c:963">ngx_http_file_cache_lookup</a>(cache, c-&gt;key);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fcn) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;fcn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;uses++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fcn-&gt;error) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fcn-&gt;valid_sec &lt; <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> renew;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fcn-&gt;exists || fcn-&gt;uses &gt;= c-&gt;min_uses) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;exists = fcn-&gt;exists;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fcn-&gt;body_start) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;body_start = fcn-&gt;body_start;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L38" title="src/core/ngx_core.h:38">NGX_AGAIN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fcn = <a href="../core/ngx_slab.c.html#L418" title="src/core/ngx_slab.c:418">ngx_slab_calloc_locked</a>(cache-&gt;shpool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fcn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2168" title="src/http/ngx_http_file_cache.c:2168">ngx_http_file_cache_set_watermark</a>(cache);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L1693" title="src/http/ngx_http_file_cache.c:1693">ngx_http_file_cache_forced_expire</a>(cache);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn = <a href="../core/ngx_slab.c.html#L418" title="src/core/ngx_slab.c:418">ngx_slab_calloc_locked</a>(cache-&gt;shpool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fcn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;could not allocate node</span><span class="Special">%s</span><span class="Constant">&quot;</span>, cache-&gt;shpool-&gt;log_ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> failed;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;count++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>((u_char *) &amp;fcn-&gt;node.key, c-&gt;key, <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(fcn-&gt;key, &amp;c-&gt;key[<span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>)],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a> - <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.c.html#L25" title="src/core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(&amp;cache-&gt;sh-&gt;rbtree, &amp;fcn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fcn-&gt;uses = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; fcn-&gt;count = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">renew</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fcn-&gt;valid_msec = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; fcn-&gt;error = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; fcn-&gt;exists = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; fcn-&gt;valid_sec = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; fcn-&gt;uniq = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; fcn-&gt;body_start = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; fcn-&gt;fs_size = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; fcn-&gt;expire = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + cache-&gt;inactive;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;cache-&gt;sh-&gt;queue, &amp;fcn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;uniq = fcn-&gt;uniq;<br/></li>
<li>&nbsp; &nbsp; c-&gt;error = fcn-&gt;error;<br/></li>
<li>&nbsp; &nbsp; c-&gt;node = fcn;<br/></li>
<li><br/></li>
<li><span class="Statement">failed</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L928">&#x200c;</a><span class="linkable">ngx_http_file_cache_name</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_file.h.html#L60" title="src/core/ngx_file.h:60">ngx_path_t</a> *path)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;file.name.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;file.name.len = path-&gt;name.len + <span class="Constant">1</span> + path-&gt;len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + <span class="Constant">2</span> * <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;file.name.data = <a href="../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(r-&gt;pool, c-&gt;file.name.len + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;file.name.data == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(c-&gt;file.name.data, path-&gt;name.data, path-&gt;name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = c-&gt;file.name.data + path-&gt;name.len + <span class="Constant">1</span> + path-&gt;len;<br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L1108" title="src/core/ngx_string.c:1108">ngx_hex_dump</a>(p, c-&gt;key, <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>);<br/></li>
<li>&nbsp; &nbsp; *p = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.c.html#L219" title="src/core/ngx_file.c:219">ngx_create_hashed_filename</a>(path, c-&gt;file.name.data, c-&gt;file.name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;cache file: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, c-&gt;file.name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a> *<br/></li>
<li><a id="L963">&#x200c;</a><span class="linkable">ngx_http_file_cache_lookup</span>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache, u_char *key)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; node_key;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *node, *sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>&nbsp; *fcn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>((u_char *) &amp;node_key, key, <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; node = cache-&gt;sh-&gt;rbtree.root;<br/></li>
<li>&nbsp; &nbsp; sentinel = cache-&gt;sh-&gt;rbtree.sentinel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (node != sentinel) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node_key &lt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;left;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node_key &gt; node-&gt;key) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node = node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* node_key == node-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn = (<a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a> *) node;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(&amp;key[<span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>)], fcn-&gt;key,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a> - <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> fcn;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; node = (rc &lt; <span class="Constant">0</span>) ? node-&gt;left : node-&gt;right;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not found */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1008">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_rbtree_insert_value</span>(<a href="../core/ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *temp,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *node, <a href="../core/ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a> *sentinel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L20" title="src/core/ngx_rbtree.h:20">ngx_rbtree_node_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; **p;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>&nbsp;&nbsp; *cn, *cnt;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (node-&gt;key &lt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;left;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (node-&gt;key &gt; temp-&gt;key) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = &amp;temp-&gt;right;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> { <span class="Comment">/* node-&gt;key == temp-&gt;key */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cn = (<a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a> *) node;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt = (<a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a> *) temp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (<a href="../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(cn-&gt;key, cnt-&gt;key,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a> - <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p == sentinel) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; temp = *p;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = node;<br/></li>
<li>&nbsp; &nbsp; node-&gt;parent = temp;<br/></li>
<li>&nbsp; &nbsp; node-&gt;left = sentinel;<br/></li>
<li>&nbsp; &nbsp; node-&gt;right = sentinel;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_rbtree.h.html#L59" title="src/core/ngx_rbtree.h:59">ngx_rbt_red</a>(node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1051">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_vary</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, u_char *vary, <span class="Type">size_t</span> len,<br/></li>
<li>&nbsp; &nbsp; u_char *hash)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp;&nbsp; *p, *last;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp;&nbsp; name;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_md5.h.html#L20" title="src/core/ngx_md5.h:20">ngx_md5_t</a>&nbsp;&nbsp; md5;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; buf[<a href="ngx_http_cache.h.html#L28" title="src/http/ngx_http_cache.h:28">NGX_HTTP_CACHE_VARY_LEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache vary: </span><span class="Special">\&quot;%*s\&quot;</span><span class="Constant">&quot;</span>, len, vary);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L19" title="src/core/ngx_md5.c:19">ngx_md5_init</a>(&amp;md5);<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L31" title="src/core/ngx_md5.c:31">ngx_md5_update</a>(&amp;md5, r-&gt;cache-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>, <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L21" title="src/core/ngx_string.c:21">ngx_strlow</a>(buf, vary, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = buf;<br/></li>
<li>&nbsp; &nbsp; last = buf + len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (p &lt; last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (p &lt; last &amp;&amp; (*p == <span class="Constant">' '</span> || *p == <span class="Constant">','</span>)) { p++; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (p &lt; last &amp;&amp; *p != <span class="Constant">','</span> &amp;&amp; *p != <span class="Constant">' '</span>) { p++; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; name.len = p - name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name.len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache vary: %V&quot;</span>, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L31" title="src/core/ngx_md5.c:31">ngx_md5_update</a>(&amp;md5, name.data, name.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L31" title="src/core/ngx_md5.c:31">ngx_md5_update</a>(&amp;md5, (u_char *) <span class="Constant">&quot;:&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;:&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1100" title="src/http/ngx_http_file_cache.c:1100">ngx_http_file_cache_vary_header</a>(r, &amp;md5, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L31" title="src/core/ngx_md5.c:31">ngx_md5_update</a>(&amp;md5, (u_char *) <a href="../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>, <span class="Statement">sizeof</span>(<a href="../core/ngx_core.h.html#L97" title="src/core/ngx_core.h:97">CRLF</a>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L62" title="src/core/ngx_md5.c:62">ngx_md5_final</a>(hash, &amp;md5);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1100">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_vary_header</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_md5.h.html#L20" title="src/core/ngx_md5.h:20">ngx_md5_t</a> *md5,<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p, *start, *last;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; i, multiple, normalize;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_list.h.html#L16" title="src/core/ngx_list.h:16">ngx_list_part_t</a>&nbsp; *part;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_hash.h.html#L97" title="src/core/ngx_hash.h:97">ngx_table_elt_t</a>&nbsp; *header;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; multiple = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; normalize = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name-&gt;len == <span class="Statement">sizeof</span>(<span class="Constant">&quot;Accept-Charset&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(name-&gt;data, (u_char *) <span class="Constant">&quot;Accept-Charset&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<span class="Constant">&quot;Accept-Charset&quot;</span>) - <span class="Constant">1</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; normalize = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (name-&gt;len == <span class="Statement">sizeof</span>(<span class="Constant">&quot;Accept-Encoding&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(name-&gt;data, (u_char *) <span class="Constant">&quot;Accept-Encoding&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<span class="Constant">&quot;Accept-Encoding&quot;</span>) - <span class="Constant">1</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; normalize = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (name-&gt;len == <span class="Statement">sizeof</span>(<span class="Constant">&quot;Accept-Language&quot;</span>) - <span class="Constant">1<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(name-&gt;data, (u_char *) <span class="Constant">&quot;Accept-Language&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<span class="Constant">&quot;Accept-Language&quot;</span>) - <span class="Constant">1</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; normalize = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; part = &amp;r-&gt;headers_in.headers.part;<br/></li>
<li>&nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; <span class="Comment">/* void */</span> ; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (i &gt;= part-&gt;nelts) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (part-&gt;next == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; part = part-&gt;next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; header = part-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].hash == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (header[i].key.len != name-&gt;len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.c.html#L597" title="src/core/ngx_string.c:597">ngx_strncasecmp</a>(header[i].key.data, name-&gt;data, name-&gt;len) != <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!normalize) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (multiple) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L31" title="src/core/ngx_md5.c:31">ngx_md5_update</a>(md5, (u_char *) <span class="Constant">&quot;,&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;,&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L31" title="src/core/ngx_md5.c:31">ngx_md5_update</a>(md5, header[i].value.data, header[i].value.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; multiple = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* normalize spaces */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = header[i].value.data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last = p + header[i].value.len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (p &lt; last) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (p &lt; last &amp;&amp; (*p == <span class="Constant">' '</span> || *p == <span class="Constant">','</span>)) { p++; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; start = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (p &lt; last &amp;&amp; *p != <span class="Constant">','</span> &amp;&amp; *p != <span class="Constant">' '</span>) { p++; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = p - start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (multiple) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L31" title="src/core/ngx_md5.c:31">ngx_md5_update</a>(md5, (u_char *) <span class="Constant">&quot;,&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;,&quot;</span>) - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_md5.c.html#L31" title="src/core/ngx_md5.c:31">ngx_md5_update</a>(md5, start, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; multiple = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1203">&#x200c;</a><span class="linkable">ngx_http_file_cache_reopen</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache reopen&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;secondary) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> has incorrect vary hash&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = c-&gt;file_cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;node-&gt;count--;<br/></li>
<li>&nbsp; &nbsp; c-&gt;node = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;secondary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;file.name.len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;body_start = c-&gt;buf-&gt;end - c-&gt;buf-&gt;start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(c-&gt;key, c-&gt;variant, <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L264" title="src/http/ngx_http_file_cache.c:264">ngx_http_file_cache_open</a>(r);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1237">&#x200c;</a><span class="linkable">ngx_http_file_cache_set_header</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, u_char *buf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>&nbsp; *h = (<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a> *) buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *key;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache set header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(h, <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h-&gt;version = <a href="ngx_http_cache.h.html#L30" title="src/http/ngx_http_cache.h:30">NGX_HTTP_CACHE_VERSION</a>;<br/></li>
<li>&nbsp; &nbsp; h-&gt;valid_sec = c-&gt;valid_sec;<br/></li>
<li>&nbsp; &nbsp; h-&gt;last_modified = c-&gt;last_modified;<br/></li>
<li>&nbsp; &nbsp; h-&gt;date = c-&gt;date;<br/></li>
<li>&nbsp; &nbsp; h-&gt;crc32 = c-&gt;crc32;<br/></li>
<li>&nbsp; &nbsp; h-&gt;valid_msec = (u_short) c-&gt;valid_msec;<br/></li>
<li>&nbsp; &nbsp; h-&gt;header_start = (u_short) c-&gt;header_start;<br/></li>
<li>&nbsp; &nbsp; h-&gt;body_start = (u_short) c-&gt;body_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;etag.len &lt;= <a href="ngx_http_cache.h.html#L27" title="src/http/ngx_http_cache.h:27">NGX_HTTP_CACHE_ETAG_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h-&gt;etag_len = (u_char) c-&gt;etag.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(h-&gt;etag, c-&gt;etag.data, c-&gt;etag.len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;vary.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;vary.len &gt; <a href="ngx_http_cache.h.html#L28" title="src/http/ngx_http_cache.h:28">NGX_HTTP_CACHE_VARY_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* should not happen */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;vary.len = <a href="ngx_http_cache.h.html#L28" title="src/http/ngx_http_cache.h:28">NGX_HTTP_CACHE_VARY_LEN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h-&gt;vary_len = (u_char) c-&gt;vary.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(h-&gt;vary, c-&gt;vary.data, c-&gt;vary.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1051" title="src/http/ngx_http_file_cache.c:1051">ngx_http_file_cache_vary</a>(r, c-&gt;vary.data, c-&gt;vary.len, c-&gt;variant);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(h-&gt;variant, c-&gt;variant, <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1300" title="src/http/ngx_http_file_cache.c:1300">ngx_http_file_cache_update_variant</a>(r, c) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = buf + <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, <a href="#L79" title="src/http/ngx_http_file_cache.c:79">ngx_http_file_cache_key</a>, <span class="Statement">sizeof</span>(<a href="#L79" title="src/http/ngx_http_file_cache.c:79">ngx_http_file_cache_key</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; key = c-&gt;keys.elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; c-&gt;keys.nelts; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L116" title="src/core/ngx_string.h:116">ngx_copy</a>(p, key[i].data, key[i].len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p = <a href="../core/ngx_core.h.html#L95" title="src/core/ngx_core.h:95">LF</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1300">&#x200c;</a><span class="linkable">ngx_http_file_cache_update_variant</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!c-&gt;secondary) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;vary.len<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.h.html#L144" title="src/core/ngx_string.h:144">ngx_memcmp</a>(c-&gt;variant, c-&gt;key, <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * if the variant hash doesn't match one we used as a secondary<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * cache key, switch back to the original key<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; cache = c-&gt;file_cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache <a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> key&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;node-&gt;count--;<br/></li>
<li>&nbsp; &nbsp; c-&gt;node-&gt;updating = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;node = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;file.name.len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(c-&gt;key, c-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>, <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L815" title="src/http/ngx_http_file_cache.c:815">ngx_http_file_cache_exists</a>(cache, c) == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L928" title="src/http/ngx_http_file_cache.c:928">ngx_http_file_cache_name</a>(r, cache-&gt;path) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L1349">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_update</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r, <a href="../core/ngx_file.h.html#L82" title="src/core/ngx_file.h:82">ngx_temp_file_t</a> *tf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fs_size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L18" title="src/os/win32/ngx_files.h:18">ngx_file_uniq_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; uniq;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L17" title="src/os/win32/ngx_files.h:17">ngx_file_info_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fi;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L95" title="src/core/ngx_file.h:95">ngx_ext_rename_file_t</a>&nbsp;&nbsp; ext;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;updated) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache update&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = c-&gt;file_cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;updated = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;updating = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; uniq = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; fs_size = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L142" title="src/core/ngx_log.h:142">ngx_log_debug2</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache rename: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> to </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tf-&gt;file.name.data, c-&gt;file.name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ext.access = <a href="../os/win32/ngx_files.h.html#L86" title="src/os/win32/ngx_files.h:86">NGX_FILE_OWNER_ACCESS</a>;<br/></li>
<li>&nbsp; &nbsp; ext.path_access = <a href="../os/win32/ngx_files.h.html#L86" title="src/os/win32/ngx_files.h:86">NGX_FILE_OWNER_ACCESS</a>;<br/></li>
<li>&nbsp; &nbsp; ext.time = -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ext.create_path = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ext.delete_file = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ext.log = r-&gt;connection-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="../core/ngx_file.c.html#L637" title="src/core/ngx_file.c:637">ngx_ext_rename_file</a>(&amp;tf-&gt;file.name, &amp;c-&gt;file.name, &amp;ext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_files.h.html#L140" title="src/os/win32/ngx_files.h:140">ngx_fd_info</a>(tf-&gt;file.fd, &amp;fi) == <a href="../os/win32/ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <a href="../os/win32/ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L141" title="src/os/win32/ngx_files.h:141">ngx_fd_info_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, tf-&gt;file.name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uniq = <a href="../os/win32/ngx_files.h.html#L161" title="src/os/win32/ngx_files.h:161">ngx_file_uniq</a>(&amp;fi);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fs_size = (<a href="../os/win32/ngx_files.h.html#L159" title="src/os/win32/ngx_files.h:159">ngx_file_fs_size</a>(&amp;fi) + cache-&gt;bsize - <span class="Constant">1</span>) / cache-&gt;bsize;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;node-&gt;count--;<br/></li>
<li>&nbsp; &nbsp; c-&gt;node-&gt;error = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;node-&gt;uniq = uniq;<br/></li>
<li>&nbsp; &nbsp; c-&gt;node-&gt;body_start = c-&gt;body_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;size += fs_size - c-&gt;node-&gt;fs_size;<br/></li>
<li>&nbsp; &nbsp; c-&gt;node-&gt;fs_size = fs_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node-&gt;exists = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;node-&gt;updating = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L1424">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_update_header</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_errno.h.html#L16" title="src/os/win32/ngx_errno.h:16">ngx_err_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L23" title="src/core/ngx_core.h:23">ngx_file_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L17" title="src/os/win32/ngx_files.h:17">ngx_file_info_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fi;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>&nbsp;&nbsp; h;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache update header&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;file, <span class="Statement">sizeof</span>(<a href="../core/ngx_core.h.html#L23" title="src/core/ngx_core.h:23">ngx_file_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; file.name = c-&gt;file.name;<br/></li>
<li>&nbsp; &nbsp; file.log = r-&gt;connection-&gt;log;<br/></li>
<li>&nbsp; &nbsp; file.fd = <a href="../os/win32/ngx_files.c.html#L22" title="src/os/win32/ngx_files.c:22">ngx_open_file</a>(file.name.data, <a href="../os/win32/ngx_files.h.html#L77" title="src/os/win32/ngx_files.h:77">NGX_FILE_RDWR</a>, <a href="../os/win32/ngx_files.h.html#L82" title="src/os/win32/ngx_files.h:82">NGX_FILE_OPEN</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file.fd == <a href="../os/win32/ngx_files.h.html#L68" title="src/os/win32/ngx_files.h:68">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; err = <a href="../os/win32/ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* cache file may have been deleted */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (err == <a href="../os/win32/ngx_errno.h.html#L24" title="src/os/win32/ngx_errno.h:24">NGX_ENOENT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> not found&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, err,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L73" title="src/os/win32/ngx_files.h:73">ngx_open_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * make sure cache file wasn't replaced;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * if it was, do nothing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_files.h.html#L140" title="src/os/win32/ngx_files.h:140">ngx_fd_info</a>(file.fd, &amp;fi) == <a href="../os/win32/ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <a href="../os/win32/ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L141" title="src/os/win32/ngx_files.h:141">ngx_fd_info_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;uniq != <a href="../os/win32/ngx_files.h.html#L161" title="src/os/win32/ngx_files.h:161">ngx_file_uniq</a>(&amp;fi)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || c-&gt;length != <a href="../os/win32/ngx_files.h.html#L157" title="src/os/win32/ngx_files.h:157">ngx_file_size</a>(&amp;fi))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> changed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; n = <a href="../os/win32/ngx_files.c.html#L62" title="src/os/win32/ngx_files.c:62">ngx_read_file</a>(&amp;file, (u_char *) &amp;h,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>), <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<span class="Type">size_t</span>) n != <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L247" title="src/os/win32/ngx_files.h:247">ngx_read_file_n</a> <span class="Constant">&quot; read only %z of %z from </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n, <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>), file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (h.version != <a href="ngx_http_cache.h.html#L30" title="src/http/ngx_http_cache.h:30">NGX_HTTP_CACHE_VERSION</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || h.last_modified != c-&gt;last_modified<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || h.crc32 != c-&gt;crc32<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || h.header_start != c-&gt;header_start<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || h.body_start != c-&gt;body_start)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> content changed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * update cache file header with new data,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * notably h.valid_sec and h.date<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;h, <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; h.version = <a href="ngx_http_cache.h.html#L30" title="src/http/ngx_http_cache.h:30">NGX_HTTP_CACHE_VERSION</a>;<br/></li>
<li>&nbsp; &nbsp; h.valid_sec = c-&gt;valid_sec;<br/></li>
<li>&nbsp; &nbsp; h.last_modified = c-&gt;last_modified;<br/></li>
<li>&nbsp; &nbsp; h.date = c-&gt;date;<br/></li>
<li>&nbsp; &nbsp; h.crc32 = c-&gt;crc32;<br/></li>
<li>&nbsp; &nbsp; h.valid_msec = (u_short) c-&gt;valid_msec;<br/></li>
<li>&nbsp; &nbsp; h.header_start = (u_short) c-&gt;header_start;<br/></li>
<li>&nbsp; &nbsp; h.body_start = (u_short) c-&gt;body_start;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;etag.len &lt;= <a href="ngx_http_cache.h.html#L27" title="src/http/ngx_http_cache.h:27">NGX_HTTP_CACHE_ETAG_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h.etag_len = (u_char) c-&gt;etag.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(h.etag, c-&gt;etag.data, c-&gt;etag.len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;vary.len) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;vary.len &gt; <a href="ngx_http_cache.h.html#L28" title="src/http/ngx_http_cache.h:28">NGX_HTTP_CACHE_VARY_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* should not happen */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c-&gt;vary.len = <a href="ngx_http_cache.h.html#L28" title="src/http/ngx_http_cache.h:28">NGX_HTTP_CACHE_VARY_LEN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; h.vary_len = (u_char) c-&gt;vary.len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(h.vary, c-&gt;vary.data, c-&gt;vary.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1051" title="src/http/ngx_http_file_cache.c:1051">ngx_http_file_cache_vary</a>(r, c-&gt;vary.data, c-&gt;vary.len, c-&gt;variant);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(h.variant, c-&gt;variant, <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../os/win32/ngx_files.c.html#L95" title="src/os/win32/ngx_files.c:95">ngx_write_file</a>(&amp;file, (u_char *) &amp;h,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>), <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_files.h.html#L102" title="src/os/win32/ngx_files.h:102">ngx_close_file</a>(file.fd) == <a href="../os/win32/ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, r-&gt;connection-&gt;log, <a href="../os/win32/ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L103" title="src/os/win32/ngx_files.h:103">ngx_close_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, file.name.data);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1554">&#x200c;</a><span class="linkable">ngx_http_cache_send</span>(<a href="ngx_http.h.html#L16" title="src/http/ngx_http.h:16">ngx_http_request_t</a> *r)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *b;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_core.h.html#L19" title="src/core/ngx_core.h:19">ngx_chain_t</a>&nbsp; &nbsp; &nbsp; &nbsp; out;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; *c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c = r-&gt;cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, r-&gt;connection-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache send: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, c-&gt;file.name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (r != r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a> &amp;&amp; c-&gt;length - c-&gt;body_start == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_core_module.c.html#L1947" title="src/http/ngx_http_core_module.c:1947">ngx_http_send_header</a>(r);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* we need to allocate all before the header would be sent */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; b = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_buf.h.html#L18" title="src/core/ngx_buf.h:18">ngx_buf_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;file = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(r-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_core.h.html#L23" title="src/core/ngx_core.h:23">ngx_file_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (b-&gt;file == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_request.h.html#L130" title="src/http/ngx_http_request.h:130">NGX_HTTP_INTERNAL_SERVER_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = <a href="ngx_http_core_module.c.html#L1947" title="src/http/ngx_http_core_module.c:1947">ngx_http_send_header</a>(r);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rc == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a> || rc &gt; <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a> || r-&gt;header_only) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> rc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;file_pos = c-&gt;body_start;<br/></li>
<li>&nbsp; &nbsp; b-&gt;file_last = c-&gt;length;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;in_file = (c-&gt;length - c-&gt;body_start) ? <span class="Constant">1</span>: <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last_buf = (r == r-&gt;<a href="../core/nginx.c.html#L187" title="src/core/nginx.c:187">main</a>) ? <span class="Constant">1</span>: <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; b-&gt;last_in_chain = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; b-&gt;file-&gt;fd = c-&gt;file.fd;<br/></li>
<li>&nbsp; &nbsp; b-&gt;file-&gt;name = c-&gt;file.name;<br/></li>
<li>&nbsp; &nbsp; b-&gt;file-&gt;log = r-&gt;connection-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out.buf = b;<br/></li>
<li>&nbsp; &nbsp; out.next = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ngx_http_core_module.c.html#L1969" title="src/http/ngx_http_core_module.c:1969">ngx_http_output_filter</a>(r, &amp;out);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L1607">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_free</span>(<a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c, <a href="../core/ngx_file.h.html#L82" title="src/core/ngx_file.h:82">ngx_temp_file_t</a> *tf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; &nbsp; &nbsp;&nbsp; *cache;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>&nbsp; *fcn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;updated || c-&gt;node == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = c-&gt;file_cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache free, fd: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, c-&gt;file.fd);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fcn = c-&gt;node;<br/></li>
<li>&nbsp; &nbsp; fcn-&gt;count--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;updating &amp;&amp; fcn-&gt;lock_time == c-&gt;lock_time) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;updating = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;error) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;error = c-&gt;error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;valid_sec) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;valid_sec = c-&gt;valid_sec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;valid_msec = c-&gt;valid_msec;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (!fcn-&gt;exists &amp;&amp; fcn-&gt;count == <span class="Constant">0</span> &amp;&amp; c-&gt;min_uses == <span class="Constant">1</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;fcn-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;cache-&gt;sh-&gt;rbtree, &amp;fcn-&gt;node);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L443" title="src/core/ngx_slab.c:443">ngx_slab_free_locked</a>(cache-&gt;shpool, fcn);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;sh-&gt;count--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c-&gt;node = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c-&gt;updated = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; c-&gt;updating = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;temp_file) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tf &amp;&amp; tf-&gt;file.fd != <a href="../os/win32/ngx_files.h.html#L68" title="src/os/win32/ngx_files.h:68">NGX_INVALID_FILE</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache incomplete: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tf-&gt;file.name.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_files.h.html#L122" title="src/os/win32/ngx_files.h:122">ngx_delete_file</a>(tf-&gt;file.name.data) == <a href="../os/win32/ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, c-&gt;file.log, <a href="../os/win32/ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L123" title="src/os/win32/ngx_files.h:123">ngx_delete_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tf-&gt;file.name.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;wait_event.timer_set) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../event/ngx_event.h.html#L414" title="src/event/ngx_event.h:414">ngx_del_timer</a>(&amp;c-&gt;wait_event);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1672">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_cleanup</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; *c = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;updated) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, c-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache cleanup&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c-&gt;updating) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, c-&gt;file.log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;stalled cache updating, error:</span><span class="Special">%u</span><span class="Constant">i&quot;</span>, c-&gt;error);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1607" title="src/http/ngx_http_file_cache.c:1607">ngx_http_file_cache_free</a>(c, <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a><br/></li>
<li><a id="L1693">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_forced_expire</span>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *name;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; wait;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tries;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L60" title="src/core/ngx_file.h:60">ngx_path_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *path;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>&nbsp; *fcn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache forced expire&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; path = cache-&gt;path;<br/></li>
<li>&nbsp; &nbsp; len = path-&gt;name.len + <span class="Constant">1</span> + path-&gt;len + <span class="Constant">2</span> * <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name = <a href="../os/win32/ngx_alloc.c.html#L17" title="src/os/win32/ngx_alloc.c:17">ngx_alloc</a>(len + <span class="Constant">1</span>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">10</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(name, path-&gt;name.data, path-&gt;name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; wait = <span class="Constant">10</span>;<br/></li>
<li>&nbsp; &nbsp; tries = <span class="Constant">20</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (q = <a href="../core/ngx_queue.h.html#L54" title="src/core/ngx_queue.h:54">ngx_queue_last</a>(&amp;cache-&gt;sh-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q != <a href="../core/ngx_queue.h.html#L58" title="src/core/ngx_queue.h:58">ngx_queue_sentinel</a>(&amp;cache-&gt;sh-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; q = <a href="../core/ngx_queue.h.html#L66" title="src/core/ngx_queue.h:66">ngx_queue_prev</a>(q))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn = <a href="../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L154" title="src/core/ngx_log.h:154">ngx_log_debug6</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;http file cache forced expire: #</span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%02x</span><span class="Constant">d</span><span class="Special">%02x</span><span class="Constant">d</span><span class="Special">%02x</span><span class="Constant">d</span><span class="Special">%02x</span><span class="Constant">d&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;count, fcn-&gt;exists,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;key[<span class="Constant">0</span>], fcn-&gt;key[<span class="Constant">1</span>], fcn-&gt;key[<span class="Constant">2</span>], fcn-&gt;key[<span class="Constant">3</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fcn-&gt;count == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1850" title="src/http/ngx_http_file_cache.c:1850">ngx_http_file_cache_delete</a>(cache, q, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--tries) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> wait;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a><br/></li>
<li><a id="L1756">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_expire</span>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *name, *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; now, wait;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L60" title="src/core/ngx_file.h:60">ngx_path_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *path;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *q;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>&nbsp; *fcn;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; key[<span class="Constant">2</span> * <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache expire&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; path = cache-&gt;path;<br/></li>
<li>&nbsp; &nbsp; len = path-&gt;name.len + <span class="Constant">1</span> + path-&gt;len + <span class="Constant">2</span> * <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name = <a href="../os/win32/ngx_alloc.c.html#L17" title="src/os/win32/ngx_alloc.c:17">ngx_alloc</a>(len + <span class="Constant">1</span>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">10</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(name, path-&gt;name.data, path-&gt;name.len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; now = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_process_cycle.c.html#L39" title="src/os/win32/ngx_process_cycle.c:39">ngx_quit</a> || <a href="../os/win32/ngx_process_cycle.c.html#L38" title="src/os/win32/ngx_process_cycle.c:38">ngx_terminate</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_queue.h.html#L29" title="src/core/ngx_queue.h:29">ngx_queue_empty</a>(&amp;cache-&gt;sh-&gt;queue)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait = <span class="Constant">10</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; q = <a href="../core/ngx_queue.h.html#L54" title="src/core/ngx_queue.h:54">ngx_queue_last</a>(&amp;cache-&gt;sh-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn = <a href="../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wait = fcn-&gt;expire - now;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (wait &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait = wait &gt; <span class="Constant">10</span> ? <span class="Constant">10</span> : wait;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L154" title="src/core/ngx_log.h:154">ngx_log_debug6</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache expire: #</span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%d</span><span class="Constant"> </span><span class="Special">%02x</span><span class="Constant">d</span><span class="Special">%02x</span><span class="Constant">d</span><span class="Special">%02x</span><span class="Constant">d</span><span class="Special">%02x</span><span class="Constant">d&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fcn-&gt;count, fcn-&gt;exists,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; fcn-&gt;key[<span class="Constant">0</span>], fcn-&gt;key[<span class="Constant">1</span>], fcn-&gt;key[<span class="Constant">2</span>], fcn-&gt;key[<span class="Constant">3</span>]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fcn-&gt;count == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1850" title="src/http/ngx_http_file_cache.c:1850">ngx_http_file_cache_delete</a>(cache, q, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fcn-&gt;deleting) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L1108" title="src/core/ngx_string.c:1108">ngx_hex_dump</a>(key, (u_char *) &amp;fcn-&gt;node.key,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a> - <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../core/ngx_string.c.html#L1108" title="src/core/ngx_string.c:1108">ngx_hex_dump</a>(p, fcn-&gt;key, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * abnormally exited workers may leave locked cache entries,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * and although it may be safe to remove them completely,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * we prefer to just move them to the top of the inactive queue<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;expire = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + cache-&gt;inactive;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;cache-&gt;sh-&gt;queue, &amp;fcn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;ignore long locked inactive cache entry </span><span class="Special">%*s</span><span class="Constant">, count:</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">size_t</span>) <span class="Constant">2</span> * <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>, key, fcn-&gt;count);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_alloc.h.html#L19" title="src/os/win32/ngx_alloc.h:19">ngx_free</a>(name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> wait;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1850">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_delete</span>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache, <a href="../core/ngx_queue.h.html#L16" title="src/core/ngx_queue.h:16">ngx_queue_t</a> *q,<br/></li>
<li>&nbsp; &nbsp; u_char *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L60" title="src/core/ngx_file.h:60">ngx_path_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *path;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>&nbsp; *fcn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fcn = <a href="../core/ngx_queue.h.html#L103" title="src/core/ngx_queue.h:103">ngx_queue_data</a>(q, <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>, queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fcn-&gt;exists) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;sh-&gt;size -= fcn-&gt;fs_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; path = cache-&gt;path;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = name + path-&gt;name.len + <span class="Constant">1</span> + path-&gt;len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L1108" title="src/core/ngx_string.c:1108">ngx_hex_dump</a>(p, (u_char *) &amp;fcn-&gt;node.key,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a> - <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.c.html#L1108" title="src/core/ngx_string.c:1108">ngx_hex_dump</a>(p, fcn-&gt;key, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;count++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;deleting = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = path-&gt;name.len + <span class="Constant">1</span> + path-&gt;len + <span class="Constant">2</span> * <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_file.c.html#L219" title="src/core/ngx_file.c:219">ngx_create_hashed_filename</a>(path, name, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache expire: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_files.h.html#L122" title="src/os/win32/ngx_files.h:122">ngx_delete_file</a>(name) == <a href="../os/win32/ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <a href="../os/win32/ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L123" title="src/os/win32/ngx_files.h:123">ngx_delete_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;count--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;deleting = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fcn-&gt;count == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(q);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_rbtree.c.html#L157" title="src/core/ngx_rbtree.c:157">ngx_rbtree_delete</a>(&amp;cache-&gt;sh-&gt;rbtree, &amp;fcn-&gt;node);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_slab.c.html#L443" title="src/core/ngx_slab.c:443">ngx_slab_free_locked</a>(cache-&gt;shpool, fcn);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;sh-&gt;count--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a><br/></li>
<li><a id="L1901">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_manager</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>&nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; next, wait;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; count, watermark;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; next = <a href="#L1756" title="src/http/ngx_http_file_cache.c:1756">ngx_http_file_cache_expire</a>(cache);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;last = <a href="../core/ngx_times.c.html#L26" title="src/core/ngx_times.c:26">ngx_current_msec</a>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;files = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> ( ;; ) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = cache-&gt;sh-&gt;size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; count = cache-&gt;sh-&gt;count;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; watermark = cache-&gt;sh-&gt;watermark;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L145" title="src/core/ngx_log.h:145">ngx_log_debug3</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache size: </span><span class="Special">%O</span><span class="Constant"> c:</span><span class="Special">%u</span><span class="Constant">i w:</span><span class="Special">%i</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size, count, (<a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>) watermark);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &lt; cache-&gt;max_size &amp;&amp; count &lt; watermark) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wait = <a href="#L1693" title="src/http/ngx_http_file_cache.c:1693">ngx_http_file_cache_forced_expire</a>(cache);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (wait &gt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> wait;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_process_cycle.c.html#L39" title="src/os/win32/ngx_process_cycle.c:39">ngx_quit</a> || <a href="../os/win32/ngx_process_cycle.c.html#L38" title="src/os/win32/ngx_process_cycle.c:38">ngx_terminate</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> next;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1945">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_loader</span>(<span class="Type">void</span> *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache = data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a>&nbsp; tree;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!cache-&gt;sh-&gt;cold || cache-&gt;sh-&gt;loading) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../os/win32/ngx_atomic.h.html#L29" title="src/os/win32/ngx_atomic.h:29">ngx_atomic_cmp_set</a>(&amp;cache-&gt;sh-&gt;loading, <span class="Constant">0</span>, <a href="../os/win32/ngx_process_cycle.c.html#L33" title="src/os/win32/ngx_process_cycle.c:33">ngx_pid</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L136" title="src/core/ngx_log.h:136">ngx_log_debug0</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache loader&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tree.init_handler = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; tree.file_handler = <a href="#L1998" title="src/http/ngx_http_file_cache.c:1998">ngx_http_file_cache_manage_file</a>;<br/></li>
<li>&nbsp; &nbsp; tree.pre_tree_handler = <a href="#L2030" title="src/http/ngx_http_file_cache.c:2030">ngx_http_file_cache_manage_directory</a>;<br/></li>
<li>&nbsp; &nbsp; tree.post_tree_handler = <a href="#L1991" title="src/http/ngx_http_file_cache.c:1991">ngx_http_file_cache_noop</a>;<br/></li>
<li>&nbsp; &nbsp; tree.spec_handler = <a href="#L2153" title="src/http/ngx_http_file_cache.c:2153">ngx_http_file_cache_delete_file</a>;<br/></li>
<li>&nbsp; &nbsp; tree.data = cache;<br/></li>
<li>&nbsp; &nbsp; tree.alloc = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; tree.log = <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;last = <a href="../core/ngx_times.c.html#L26" title="src/core/ngx_times.c:26">ngx_current_msec</a>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;files = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_file.c.html#L920" title="src/core/ngx_file.c:920">ngx_walk_tree</a>(&amp;tree, &amp;cache-&gt;path-&gt;name) == <a href="../core/ngx_core.h.html#L42" title="src/core/ngx_core.h:42">NGX_ABORT</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;sh-&gt;loading = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;cold = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;loading = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L22" title="src/core/ngx_log.h:22">NGX_LOG_NOTICE</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;http file cache: %V </span><span class="Special">%.3f</span><span class="Constant">M, bsize: </span><span class="Special">%u</span><span class="Constant">z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;cache-&gt;path-&gt;name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((<span class="Type">double</span>) cache-&gt;sh-&gt;size * cache-&gt;bsize) / (<span class="Constant">1024</span> * <span class="Constant">1024</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;bsize);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1991">&#x200c;</a><span class="linkable">ngx_http_file_cache_noop</span>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *path)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L1998">&#x200c;</a><span class="linkable">ngx_http_file_cache_manage_file</span>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *path)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elapsed;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = ctx-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L2055" title="src/http/ngx_http_file_cache.c:2055">ngx_http_file_cache_add_file</a>(ctx, path) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L2153" title="src/http/ngx_http_file_cache.c:2153">ngx_http_file_cache_delete_file</a>(ctx, path);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (++cache-&gt;files &gt;= cache-&gt;loader_files) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2043" title="src/http/ngx_http_file_cache.c:2043">ngx_http_file_cache_loader_sleep</a>(cache);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_times.c.html#L78" title="src/core/ngx_times.c:78">ngx_time_update</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elapsed = <a href="../core/ngx_core.h.html#L100" title="src/core/ngx_core.h:100">ngx_abs</a>((<a href="../os/win32/ngx_time.h.html#L17" title="src/os/win32/ngx_time.h:17">ngx_msec_int_t</a>) (<a href="../core/ngx_times.c.html#L26" title="src/core/ngx_times.c:26">ngx_current_msec</a> - cache-&gt;last));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache loader time elapsed: %M&quot;</span>, elapsed);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (elapsed &gt;= cache-&gt;loader_threshold) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2043" title="src/http/ngx_http_file_cache.c:2043">ngx_http_file_cache_loader_sleep</a>(cache);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (<a href="../os/win32/ngx_process_cycle.c.html#L39" title="src/os/win32/ngx_process_cycle.c:39">ngx_quit</a> || <a href="../os/win32/ngx_process_cycle.c.html#L38" title="src/os/win32/ngx_process_cycle.c:38">ngx_terminate</a>) ? <a href="../core/ngx_core.h.html#L42" title="src/core/ngx_core.h:42">NGX_ABORT</a> : <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2030">&#x200c;</a><span class="linkable">ngx_http_file_cache_manage_directory</span>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *path)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (path-&gt;len &gt;= <span class="Constant">5<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; <a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(path-&gt;data + path-&gt;len - <span class="Constant">5</span>, <span class="Constant">&quot;/temp&quot;</span>, <span class="Constant">5</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L41" title="src/core/ngx_core.h:41">NGX_DECLINED</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2043">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_loader_sleep</span>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L39" title="src/os/win32/ngx_time.h:39">ngx_msleep</a>(cache-&gt;loader_sleep);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_times.c.html#L78" title="src/core/ngx_times.c:78">ngx_time_update</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;last = <a href="../core/ngx_times.c.html#L26" title="src/core/ngx_times.c:26">ngx_current_msec</a>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;files = <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2055">&#x200c;</a><span class="linkable">ngx_http_file_cache_add_file</span>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; n;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>&nbsp; &nbsp; &nbsp; &nbsp; c;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name-&gt;len &lt; <span class="Constant">2</span> * <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ctx-&gt;size &lt; (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>) <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L131" title="src/http/ngx_http_cache.h:131">ngx_http_file_cache_header_t</a>)) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;cache file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is too small&quot;</span>, name-&gt;data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L86" title="src/core/ngx_string.h:86">ngx_memzero</a>(&amp;c, <span class="Statement">sizeof</span>(<a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a>));<br/></li>
<li>&nbsp; &nbsp; cache = ctx-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; c.length = ctx-&gt;size;<br/></li>
<li>&nbsp; &nbsp; c.fs_size = (ctx-&gt;fs_size + cache-&gt;bsize - <span class="Constant">1</span>) / cache-&gt;bsize;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = &amp;name-&gt;data[name-&gt;len - <span class="Constant">2</span> * <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n = <a href="../core/ngx_string.c.html#L1070" title="src/core/ngx_string.c:1070">ngx_hextoi</a>(p, <span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (n == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p += <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; c.key[i] = (u_char) n;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L2098" title="src/http/ngx_http_file_cache.c:2098">ngx_http_file_cache_add</a>(cache, &amp;c);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2098">&#x200c;</a><span class="linkable">ngx_http_file_cache_add</span>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache, <a href="ngx_http.h.html#L18" title="src/http/ngx_http.h:18">ngx_http_cache_t</a> *c)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>&nbsp; *fcn;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L70" title="src/core/ngx_shmtx.c:70">ngx_shmtx_lock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fcn = <a href="#L963" title="src/http/ngx_http_file_cache.c:963">ngx_http_file_cache_lookup</a>(cache, c-&gt;key);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fcn == <span class="Constant">NULL</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn = <a href="../core/ngx_slab.c.html#L418" title="src/core/ngx_slab.c:418">ngx_slab_calloc_locked</a>(cache-&gt;shpool,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L61" title="src/http/ngx_http_cache.h:61">ngx_http_file_cache_node_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fcn == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2168" title="src/http/ngx_http_file_cache.c:2168">ngx_http_file_cache_set_watermark</a>(cache);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;fail_time != <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>()) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;fail_time = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L18" title="src/core/ngx_log.h:18">NGX_LOG_ALERT</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;could not allocate node</span><span class="Special">%s</span><span class="Constant">&quot;</span>, cache-&gt;shpool-&gt;log_ctx);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;sh-&gt;count++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>((u_char *) &amp;fcn-&gt;node.key, c-&gt;key, <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(fcn-&gt;key, &amp;c-&gt;key[<span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>)],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="ngx_http_cache.h.html#L26" title="src/http/ngx_http_cache.h:26">NGX_HTTP_CACHE_KEY_LEN</a> - <span class="Statement">sizeof</span>(<a href="../core/ngx_rbtree.h.html#L16" title="src/core/ngx_rbtree.h:16">ngx_rbtree_key_t</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_rbtree.c.html#L25" title="src/core/ngx_rbtree.c:25">ngx_rbtree_insert</a>(&amp;cache-&gt;sh-&gt;rbtree, &amp;fcn-&gt;node);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;uses = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;exists = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fcn-&gt;fs_size = c-&gt;fs_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;sh-&gt;size += c-&gt;fs_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L72" title="src/core/ngx_queue.h:72">ngx_queue_remove</a>(&amp;fcn-&gt;queue);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fcn-&gt;expire = <a href="../core/ngx_times.h.html#L36" title="src/core/ngx_times.h:36">ngx_time</a>() + cache-&gt;inactive;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_queue.h.html#L33" title="src/core/ngx_queue.h:33">ngx_queue_insert_head</a>(&amp;cache-&gt;sh-&gt;queue, &amp;fcn-&gt;queue);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_shmtx.c.html#L137" title="src/core/ngx_shmtx.c:137">ngx_shmtx_unlock</a>(&amp;cache-&gt;shpool-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a><br/></li>
<li><a id="L2153">&#x200c;</a><span class="linkable">ngx_http_file_cache_delete_file</span>(<a href="../core/ngx_file.h.html#L109" title="src/core/ngx_file.h:109">ngx_tree_ctx_t</a> *ctx, <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a> *path)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, ctx-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache delete: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, path-&gt;data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../os/win32/ngx_files.h.html#L122" title="src/os/win32/ngx_files.h:122">ngx_delete_file</a>(path-&gt;data) == <a href="../os/win32/ngx_files.h.html#L69" title="src/os/win32/ngx_files.h:69">NGX_FILE_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_log.c.html#L216" title="src/core/ngx_log.c:216">ngx_log_error</a>(<a href="../core/ngx_log.h.html#L19" title="src/core/ngx_log.h:19">NGX_LOG_CRIT</a>, ctx-&gt;log, <a href="../os/win32/ngx_errno.h.html#L18" title="src/os/win32/ngx_errno.h:18">ngx_errno</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../os/win32/ngx_files.h.html#L123" title="src/os/win32/ngx_files.h:123">ngx_delete_file_n</a> <span class="Constant">&quot; </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> failed&quot;</span>, path-&gt;data);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2168">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_set_watermark</span>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a> *cache)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; cache-&gt;sh-&gt;watermark = cache-&gt;sh-&gt;count - cache-&gt;sh-&gt;count / <span class="Constant">8</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_log.h.html#L139" title="src/core/ngx_log.h:139">ngx_log_debug1</a>(<a href="../core/ngx_log.h.html#L30" title="src/core/ngx_log.h:30">NGX_LOG_DEBUG_HTTP</a>, <a href="../core/ngx_cycle.c.html#L20" title="src/core/ngx_cycle.c:20">ngx_cycle</a>-&gt;log, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;http file cache watermark: </span><span class="Special">%u</span><span class="Constant">i&quot;</span>, cache-&gt;sh-&gt;watermark);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a><br/></li>
<li><a id="L2178">&#x200c;</a></span><span class="linkable">ngx_http_file_cache_valid</span>(<a href="../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a> *cache_valid, <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a> status)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L36" title="src/http/ngx_http_cache.h:36">ngx_http_cache_valid_t</a>&nbsp; *valid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache_valid == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; valid = cache_valid-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; cache_valid-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid[i].status == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> valid[i].valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (valid[i].status == status) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> valid[i].valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">char</span> *<br/></li>
<li><a id="L2204">&#x200c;</a><span class="linkable">ngx_http_file_cache_set_slot</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd, <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; *confp = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L163" title="src/os/win32/ngx_win32_config.h:163">off_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; max_size;<br/></li>
<li>&nbsp; &nbsp; u_char&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *last, *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inactive;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L188" title="src/os/win32/ngx_win32_config.h:188">ssize_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; s, name, *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L78" title="src/core/ngx_config.h:78">ngx_int_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; loader_files;<br/></li>
<li>&nbsp; &nbsp; <a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loader_sleep, loader_threshold;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, n, use_temp_path;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *caches;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>&nbsp; *cache, **ce;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="ngx_http.h.html#L19" title="src/http/ngx_http.h:19">ngx_http_file_cache_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;path = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_file.h.html#L60" title="src/core/ngx_file.h:60">ngx_path_t</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;path == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; use_temp_path = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; inactive = <span class="Constant">600</span>;<br/></li>
<li>&nbsp; &nbsp; loader_files = <span class="Constant">100</span>;<br/></li>
<li>&nbsp; &nbsp; loader_sleep = <span class="Constant">50</span>;<br/></li>
<li>&nbsp; &nbsp; loader_threshold = <span class="Constant">200</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; name.len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; max_size = <a href="../os/win32/ngx_win32_config.h.html#L219" title="src/os/win32/ngx_win32_config.h:219">NGX_MAX_OFF_T_VALUE</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;path-&gt;name = value[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;path-&gt;name.data[cache-&gt;path-&gt;name.len - <span class="Constant">1</span>] == <span class="Constant">'/'</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;path-&gt;name.len--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_conf_file.c.html#L845" title="src/core/ngx_conf_file.c:845">ngx_conf_full_name</a>(cf-&gt;cycle, &amp;cache-&gt;path-&gt;name, <span class="Constant">0</span>) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">2</span>; i &lt; cf-&gt;args-&gt;nelts; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;levels=&quot;</span>, <span class="Constant">7</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = value[i].data + <span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last = value[i].data + value[i].len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (n = <span class="Constant">0</span>; n &lt; <span class="Constant">3</span> &amp;&amp; p &lt; last; n++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p &gt; <span class="Constant">'0'</span> &amp;&amp; *p &lt; <span class="Constant">'3'</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;path-&gt;level[n] = *p++ - <span class="Constant">'0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;path-&gt;len += cache-&gt;path-&gt;level[n] + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*p++ == <span class="Constant">':'</span> &amp;&amp; n &lt; <span class="Constant">2</span> &amp;&amp; p != last) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_levels;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> invalid_levels;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;path-&gt;len &lt; <span class="Constant">10</span> + <span class="Constant">3</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="cUserCont">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement">invalid_levels</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid </span><span class="Special">\&quot;</span><span class="Constant">levels</span><span class="Special">\&quot;</span><span class="Constant"> </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;use_temp_path=&quot;</span>, <span class="Constant">14</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(&amp;value[i].data[<span class="Constant">14</span>], <span class="Constant">&quot;on&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; use_temp_path = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(&amp;value[i].data[<span class="Constant">14</span>], <span class="Constant">&quot;off&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; use_temp_path = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid use_temp_path value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">, &quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;it must be </span><span class="Special">\&quot;</span><span class="Constant">on</span><span class="Special">\&quot;</span><span class="Constant"> or </span><span class="Special">\&quot;</span><span class="Constant">off</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;keys_zone=&quot;</span>, <span class="Constant">10</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name.data = value[i].data + <span class="Constant">10</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = (u_char *) <a href="../core/ngx_string.h.html#L63" title="src/core/ngx_string.h:63">ngx_strchr</a>(name.data, <span class="Constant">':'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name.len = p - name.data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = value[i].data + value[i].len - p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = <a href="../core/ngx_parse.c.html#L13" title="src/core/ngx_parse.c:13">ngx_parse_size</a>(&amp;s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (size &gt; <span class="Constant">8191</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid keys zone size </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;inactive=&quot;</span>, <span class="Constant">9</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = value[i].len - <span class="Constant">9</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = value[i].data + <span class="Constant">9</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inactive = <a href="../core/ngx_parse.c.html#L102" title="src/core/ngx_parse.c:102">ngx_parse_time</a>(&amp;s, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (inactive == (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid inactive value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;max_size=&quot;</span>, <span class="Constant">9</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = value[i].len - <span class="Constant">9</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = value[i].data + <span class="Constant">9</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; max_size = <a href="../core/ngx_parse.c.html#L54" title="src/core/ngx_parse.c:54">ngx_parse_offset</a>(&amp;s);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (max_size &lt; <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid max_size value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;loader_files=&quot;</span>, <span class="Constant">13</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loader_files = <a href="../core/ngx_string.c.html#L902" title="src/core/ngx_string.c:902">ngx_atoi</a>(value[i].data + <span class="Constant">13</span>, value[i].len - <span class="Constant">13</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (loader_files == <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid loader_files value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;loader_sleep=&quot;</span>, <span class="Constant">13</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = value[i].len - <span class="Constant">13</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = value[i].data + <span class="Constant">13</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loader_sleep = <a href="../core/ngx_parse.c.html#L102" title="src/core/ngx_parse.c:102">ngx_parse_time</a>(&amp;s, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (loader_sleep == (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid loader_sleep value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L53" title="src/core/ngx_string.h:53">ngx_strncmp</a>(value[i].data, <span class="Constant">&quot;loader_threshold=&quot;</span>, <span class="Constant">17</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.len = value[i].len - <span class="Constant">17</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s.data = value[i].data + <span class="Constant">17</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loader_threshold = <a href="../core/ngx_parse.c.html#L102" title="src/core/ngx_parse.c:102">ngx_parse_time</a>(&amp;s, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (loader_threshold == (<a href="../os/win32/ngx_time.h.html#L16" title="src/os/win32/ngx_time.h:16">ngx_msec_t</a>) <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid loader_threshold value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid parameter </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name.len == <span class="Constant">0</span> || size == <span class="Constant">0</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant"> must have </span><span class="Special">\&quot;</span><span class="Constant">keys_zone</span><span class="Special">\&quot;</span><span class="Constant"> parameter&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;cmd-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;path-&gt;manager = <a href="#L1901" title="src/http/ngx_http_file_cache.c:1901">ngx_http_file_cache_manager</a>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;path-&gt;loader = <a href="#L1945" title="src/http/ngx_http_file_cache.c:1945">ngx_http_file_cache_loader</a>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;path-&gt;data = cache;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;path-&gt;conf_file = cf-&gt;conf_file-&gt;file.name.data;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;path-&gt;line = cf-&gt;conf_file-&gt;line;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;loader_files = loader_files;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;loader_sleep = loader_sleep;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;loader_threshold = loader_threshold;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_file.c.html#L501" title="src/core/ngx_file.c:501">ngx_add_path</a>(cf, &amp;cache-&gt;path) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!use_temp_path) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;temp_path = <a href="../core/ngx_palloc.c.html#L301" title="src/core/ngx_palloc.c:301">ngx_pcalloc</a>(cf-&gt;pool, <span class="Statement">sizeof</span>(<a href="../core/ngx_file.h.html#L60" title="src/core/ngx_file.h:60">ngx_path_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;temp_path == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = cache-&gt;path-&gt;name.len + <span class="Statement">sizeof</span>(<span class="Constant">&quot;/temp&quot;</span>) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_palloc.c.html#L139" title="src/core/ngx_palloc.c:139">ngx_pnalloc</a>(cf-&gt;pool, len + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;temp_path-&gt;name.len = len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;temp_path-&gt;name.data = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../core/ngx_string.h.html#L93" title="src/core/ngx_string.h:93">ngx_cpymem</a>(p, cache-&gt;path-&gt;name.data, cache-&gt;path-&gt;name.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(p, <span class="Constant">&quot;/temp&quot;</span>, <span class="Statement">sizeof</span>(<span class="Constant">&quot;/temp&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_string.c.html#L1966" title="src/core/ngx_string.c:1966">ngx_memcpy</a>(&amp;cache-&gt;temp_path-&gt;level, &amp;cache-&gt;path-&gt;level,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">3</span> * <span class="Statement">sizeof</span>(<span class="Type">size_t</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;temp_path-&gt;len = cache-&gt;path-&gt;len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;temp_path-&gt;conf_file = cf-&gt;conf_file-&gt;file.name.data;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cache-&gt;temp_path-&gt;line = cf-&gt;conf_file-&gt;line;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_file.c.html#L501" title="src/core/ngx_file.c:501">ngx_add_path</a>(cf, &amp;cache-&gt;temp_path) != <a href="../core/ngx_core.h.html#L36" title="src/core/ngx_core.h:36">NGX_OK</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;shm_zone = <a href="../core/ngx_cycle.c.html#L1217" title="src/core/ngx_cycle.c:1217">ngx_shared_memory_add</a>(cf, &amp;name, size, cmd-&gt;post);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;shm_zone == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cache-&gt;shm_zone-&gt;data) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;duplicate zone </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;shm_zone-&gt;init = <a href="#L83" title="src/http/ngx_http_file_cache.c:83">ngx_http_file_cache_init</a>;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;shm_zone-&gt;data = cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cache-&gt;inactive = inactive;<br/></li>
<li>&nbsp; &nbsp; cache-&gt;max_size = max_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; caches = (<a href="../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a> *) (confp + cmd-&gt;offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ce = <a href="../core/ngx_array.c.html#L48" title="src/core/ngx_array.c:48">ngx_array_push</a>(caches);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ce == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ce = cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">char</span> *<br/></li>
<li><a id="L2496">&#x200c;</a><span class="linkable">ngx_http_file_cache_valid_set_slot</span>(<a href="../core/ngx_core.h.html#L16" title="src/core/ngx_core.h:16">ngx_conf_t</a> *cf, <a href="../core/ngx_core.h.html#L22" title="src/core/ngx_core.h:22">ngx_command_t</a> *cmd,<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span> *conf)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; *p = conf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; valid;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_string.h.html#L19" title="src/core/ngx_string.h:19">ngx_str_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *value;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i, n, status;<br/></li>
<li>&nbsp; &nbsp; <a href="../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; **a;<br/></li>
<li>&nbsp; &nbsp; <a href="ngx_http_cache.h.html#L36" title="src/http/ngx_http_cache.h:36">ngx_http_cache_valid_t</a>&nbsp;&nbsp; *v;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <a href="../core/ngx_config.h.html#L79" title="src/core/ngx_config.h:79">ngx_uint_t</a>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; statuses[] = { <span class="Constant">200</span>, <span class="Constant">301</span>, <span class="Constant">302</span> };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; a = (<a href="../core/ngx_array.h.html#L22" title="src/core/ngx_array.h:22">ngx_array_t</a> **) (p + cmd-&gt;offset);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*a == <a href="../core/ngx_conf_file.h.html#L58" title="src/core/ngx_conf_file.h:58">NGX_CONF_UNSET_PTR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *a = <a href="../core/ngx_array.c.html#L13" title="src/core/ngx_array.c:13">ngx_array_create</a>(cf-&gt;pool, <span class="Constant">1</span>, <span class="Statement">sizeof</span>(<a href="ngx_http_cache.h.html#L36" title="src/http/ngx_http_cache.h:36">ngx_http_cache_valid_t</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*a == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; value = cf-&gt;args-&gt;elts;<br/></li>
<li>&nbsp; &nbsp; n = cf-&gt;args-&gt;nelts - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; valid = <a href="../core/ngx_parse.c.html#L102" title="src/core/ngx_parse.c:102">ngx_parse_time</a>(&amp;value[n], <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (valid == (<span class="Type"><a href="../os/win32/ngx_win32_config.h.html#L68" title="src/os/win32/ngx_win32_config.h:68">time_t</a></span>) <a href="../core/ngx_core.h.html#L37" title="src/core/ngx_core.h:37">NGX_ERROR</a>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid time value </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[n]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n == <span class="Constant">1</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">3</span>; i++) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = <a href="../core/ngx_array.c.html#L48" title="src/core/ngx_array.c:48">ngx_array_push</a>(*a);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (v == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v-&gt;status = statuses[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v-&gt;valid = valid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt; n; i++) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../core/ngx_string.h.html#L57" title="src/core/ngx_string.h:57">ngx_strcmp</a>(value[i].data, <span class="Constant">&quot;any&quot;</span>) == <span class="Constant">0</span>) {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; } <span class="Statement">else</span> {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = <a href="../core/ngx_string.c.html#L902" title="src/core/ngx_string.c:902">ngx_atoi</a>(value[i].data, value[i].len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (status &lt; <span class="Constant">100</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../core/ngx_conf_file.c.html#L950" title="src/core/ngx_conf_file.c:950">ngx_conf_log_error</a>(<a href="../core/ngx_log.h.html#L17" title="src/core/ngx_log.h:17">NGX_LOG_EMERG</a>, cf, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;invalid status </span><span class="Special">\&quot;</span><span class="Constant">%V</span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>, &amp;value[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v = <a href="../core/ngx_array.c.html#L48" title="src/core/ngx_array.c:48">ngx_array_push</a>(*a);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (v == <span class="Constant">NULL</span>) {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L64" title="src/core/ngx_conf_file.h:64">NGX_CONF_ERROR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;status = status;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v-&gt;valid = valid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../core/ngx_conf_file.h.html#L63" title="src/core/ngx_conf_file.h:63">NGX_CONF_OK</a>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
